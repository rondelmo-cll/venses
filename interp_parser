:- style_check(-singleton).

append_relative(Ibar,Obl, FunctsO, FunctsOut):-
    appendrel1(Ibar,Obl, FunctsO, FunctsOut),
    !.
append_relative(Ibar,Obl, FunctsO, FunctsOut):-
    appendrel2(Ibar,Obl, FunctsO, FunctsOut),
    !.

appendrel1([],Obl, [], [appos-Body]):-
   Obl=[Fir],
   Fir=Fun-Body,
   Fun=subj,
   cl(J), J\=1,
   reverse(Body, [F-Third-_|RevBody]), 
   !.

appendrel1([],Obl, FunctsO, FunctsOut):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=ibar-Cos,
   Obl=[Fir],
   Fir=Fun-Body,
   Fun=appos,
   append([subj-Body],FunctsO, FunctsOut), 
   !.

appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=[ibar-_|Cos],
   Obl=[Fir],
   Fir=Fun-Body,
   (Fun=subj;Fun=fac;Fun=fs;Fun=fc),
   findall(Rel, on(ibar-[Rel|_],Body),Rels), Rels=[],
   reverse(Body, [F-Third|RevBody]), 
   F\=subj,
   subj_fac_compless_rel(Fun,Body,Sec, FunctsOut),
     !.

appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=ibar-[_-_-_|Cos],
   Obl=[Fir],
   Fir=Fun-Body,
   (Fun=fac;Fun=fs;Fun=fc),
    findall(Rel, on(ibar-[Rel|_],Body),Rels), Rels=[],
   append(Body, FunctsO, FunctsOut),
     !.

appendrel1(Ibar,Obl, FunctsO, FunctsOut):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=ibar-[_-_-_|Cos],
   Obl=[Fir],
   Fir=Fun-Body,
   (Fun=fac;Fun=fs;Fun=fc),
    findall(Rel, on(ibar-[Rel|_],Body),Rels), Rels\=[],
    findall(Rel, on(subj-[Rel|_],Body),Subs), Subs\=[],
   length(Subs,L), 1<L,
   reconstruct_secondary_main(Fun, Body, FunctsO, FunctsOut),
     !.


appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-[of-_-_|Cos],
   Cos\=[],
   Fu=vcomp,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   aareverse(Body, Head),
   lemmatize_dic(Head,Lem,_),
   coml_n(Lem,Subs),
   remove(subc-Sub, Subs,_),
   member(adj/Prep/_,Sub),
   (atomic(Prep),Prep=of;list(Prep),on(of,Prep)),
   append_mod_mod(Body,[Sec], FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-[of-_-_|Cos],
   Cos\=[],
   Fu\=vcomp,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   aareverse(Body,Head),
   (\+ nt(Head);nnt(Head)),
   append_mod_mod(Body,[Sec], FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel1([],Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-[P-_-_|Cos],
   prepos(P), P\=by,
   Cos\=[], Fu=obl,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body, Fun=obj,
   aareverse(Body,Head),
   check_subcn(Head,P),
   append_mod_mod(Body,[Sec], FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-[by-_-_|_],
   Fu\=vcomp,Fu\=obl,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   Fun\=obj,Fun\=subj,Fun\=obj2,Fun\=xcomp,
   append_mod_mod(Body,FunctsO, FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel1([],Obl, FunctsO, [Fu-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-[P-_-_|VP],
   prepos(P),
   VP\=[], 
   Fu=f2,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   evaluate_nominal_compls(Obl, FunctsO, NFunctsO),
   append_mod_mod(Body,NFunctsO, FunctsOut),
   check_ibar_feats_head(VP,Body),
   turn_appos_subj(Fun,Fu,Rest),
   reassert_adjunct(Fun-Body, Fu-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fu-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=f2-[f2-_|VP],
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   evaluate_nominal_compls(Obl, FunctsO, NFunctsO),
   append_mod_mod(Body,NFunctsO, FunctsOut),
   check_ibar_feats_head(VP,Body),
   turn_appos_subj(Fun,Fu,Rest),
   reassert_adjunct(Fun-Body, Fu-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fu-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=f2-[f2-_|VP],
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   remove(mod-Mod, Body, MBody),
   evaluate_nominal_compls(Obl, FunctsO, NFunctsO),
   append([mod-Mod], NFunctsO, RelMod),
   append(MBody, RelMod, FunctsOut),
   check_ibar_feats_head(VP,Mod),
   turn_appos_subj(Fun,Fu,Rest),
   reassert_adjunct(Fun-Body, Fu-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fu-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=f2-[f2-_|VP],
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   evaluate_nominal_compls(Obl, FunctsO, NFunctsO),
   append(Body, NFunctsO, FunctsOut),
   check_ibar_feats_head(VP,Body),
   turn_appos_subj(Fun,Fu,Rest),
   reassert_adjunct(Fun-Body, Fu-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fu-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Fp, Sec|Rest],
   Fp=fp-_,
   Rest=[fp-_|_],
   (Sec=[f2-[f2-_|VP]], S1=Sec;
    Sec=f2-[f2-_|VP], S1=[Sec];
    Sec=Fu-Cost, (Fu=sq;Fu=sn;Fu=subj;Fu=obl),
    findall(Rel, on(f2-[Rel|_],Cost),Rels), Rels=[],
    VP=[], S1=[mod-Cost]),
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   evaluate_nominal_compls(Obl, FunctsO, NFunctsO),
   append_mod_mod(Body,S1, FunctsOut),
   check_ibar_feats_head(VP,Body),
   turn_appos_subj(Fun,Fu,Rest),
   reassert_adjunct(Fun-Body, Fu-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fu-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Fp, Sec|Rest],
   Fp=fp-_,
   Rest\=[fp-_|_],
   Rest\=[ibar-_|_],
   Rest\=[xcomp-_|_],
   (Sec=[f2-[f2-_|VP]], S1=Sec;
    Sec=f2-[f2-_|VP], S1=[Sec];
    Sec=Fu-Cost, (Fu=sq;Fu=sn;Fu=subj;Fu=obl), VP=[], S1=[mod-Cost]),
   nth(Rest,N,ibar-_),
   3<N,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   (Fun=Fu, Fun\=subj;Fun\=Fu),
   evaluate_nominal_compls(Obl, FunctsO, NFunctsO),
   append_mod_mod(Body,S1, FunctsOut),
   check_ibar_feats_head(VP,Body),
   turn_appos_subj(Fun,Fu,Rest),
   reassert_adjunct(Fun-Body, Fu-FunctsOut),
   !.


appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=sq-[than-_-_|_],
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   append_mod_mod(Body,[Sec], FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=subj-[W-_-_|_],
   cwn(W),
   Sec=Fu-Cos,
   findall(Rel, on(ibar-[Rel|_],FunctsO),Rels), Rels\=[],
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body, (Fun=subj;Fun=sn),
   abreverse(Body, Cat),
   (Cat=nh;Cat=np;Cat=npro;Cat=n),
   FuncsOu=[mod-Cos],
   append_mod_mod(Body,FuncsOu, FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.


appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=subj-[the-_-_|_],
   Sec=Fu-Cos,
   findall(Rel, on(ibar-[Rel|_],FunctsO),Rels), Rels=[],
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body, (Fun=obl;Fun=obj),
   abreverse(Body, nh),
   FuncsOu=[mod-Cos],
   append_mod_mod(Body,FuncsOu, FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   (Sec=sn-Cost;Sec=subj-Cost),
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   check_modifier_poss(Body),
   check_modifier_poss(Cost),
   (Fun=obj;Fun=subj),
   findall(Rel, on(ibar-[Rel|_],Rest),Rels), Rels=[],
   remove(mod-Mod, Body, MBody),
   append([mod-Mod], Cost, RelMod),
   append(MBody, RelMod, FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel1(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   (Sec=sn-Cost;Sec=subj-Cost),
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   check_modifier_poss(Body),
   check_modifier_poss(Cost),
   (Fun=obj;Fun=subj),
    (abreverse(Body, nh)
        ;
     abreverse(Cost, nh)),
   append(Cost, [mod-Body], FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

aareverse(Body,Head):-
   appiattisci(Body,Bod),
   reverse(Bod,[Head-_-_|RevSec]),
   !.

turn_appos_subj(appos,subj,Rest):-
    findall(Rel, on(ibar-[Rel|_],Rest),Rels), Rels\=[],
   !.
turn_appos_subj(Fun,Fun,Rest):-!.

abreverse(Body,Cat):-
   appiattisci(Body,Bod),
   reverse(Bod, [Name-Cat-_|RevBody]),
   !.

check_modifier_poss(Body):-
   \+ on(_-pron-_, Body),
   \+ on(_-poss-_, Body),
   \+ on(_-art-_, Body),
   \+ on(_-cong-_, Body),
   !.


appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=sn-Cost,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   check_modifier_poss(Body),
   check_modifier_poss(Cost),
   (Fun=obj;Fun=subj),
   append(Body, [mod-Cost], FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=subj-Cost,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   check_modifier_poss(Body),
   check_modifier_poss(Cost),
   (Fun=obj;Fun=subj),
   findall(Rel, on(ibar-[Rel|_],Rest),Rels), Rels=[],
   (\+ on(mod-_,Cost), \+ on(f2-_,Cost),
    append(Cost, [mod-Body], FunctsOut)
    ;
    append(Body, [mod-Cost], FunctsOut)
    ),
   reassert_adjunct(Fun-Cost, Fun-FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=subj-Cost,
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   check_modifier_poss(Body),
   check_modifier_poss(Cost),
   Fun=subj,
   findall(Rel, on(ibar-[Rel|_],Rest),Rels), 
   (Rels=[];
    funcs(sem, Cl-Cl1, Avv, First), 1<Cl, Avv\=[]),
   (\+ on(mod-_,Cost), \+ on(f2-_,Cost),
    append(Cost, [mod-Body], FunctsOut)
    ;
    append(Body, [mod-Cost], FunctsOut)
    ),
   reassert_adjunct(Fun-Cost, Fun-FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=sn-Cost,
   Cost=[_-num-_],
   Obl\=[],
   Obl=[Fir],
   Fir=Fun-Body,
   Fun=obl,
   append(Body, Cost, FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel2(Ibar,Ogg, FunctsO, [Fun-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-Se,
   Ogg\=[],
   Ogg=[Fir],
   Fir=Fun-Body,
%   Sec1=f2-[f2-[nil], subj-Se],
   consistent_functions(Fu,Fun),
   verify_verb_rest_all(Rest),
   append([f2-[nil], subj-Se], Rest, FunctsOu),
   append(Body, [f2-FunctsOu], FunctsOut),
   reassert_adjunct(Fu-Se, subj-Se),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   First=f2-[nil],
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, nil, f2-[nil-_-_])),
   !.

appendrel2(Ibar,Obl, FunctsO, [appos-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-[of-_-_|_],
   Sec=Fu-Se,
   Obl\=[],
   Obl=sn-Body,
   append(Body, [mod-Se], FunctsOut),
   areverse(Body,Head),
   cl(K),
   asserta(funcs(appos, K, Head, [appos-FunctsOut])),
   !.
appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=appos-Appos,
   Obl\=[],
   Obl=[Fun-Body],
   appiattisci(Body,Bod),
   reverse(Bod,[Fu-Cost|Res]),
   atomic(Fu),
   Cost\=[],
   append(Cost, [mod-Appos], Mod),
   reverse([Fu-Mod|Res],FunctsOut),
   aareverse(Cost,Head),
   cl(K),
   asserta(funcs(Fu, K, Head, [Fu-Mod])),
   !.

appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=appos-Appos,
   Obl\=[],
   Obl=[Fun-Body],
   append(Body, [mod-Appos], FunctsOut),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, [xcomp-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Obl\=[],
   Obl=[xcomp-Appos],
   aareverse(Appos,Head),
   Sec=obl-Body,
   Body=[P-_-_|_],
   checksubcn_a(Head,P),
   append(Appos, [obl-Body], FunctsOut),
   reassert_adjunct(Fun-Appos, xcomp-FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Fp, Sec|Rest],
   Fp=fp-_,
   Sec=appos-Appos,
   Obl\=[],
   Obl=[Fun-Body],
   appiattisci(Body,Bod),
   reverse(Bod,[Fu-Cost|Res]),
   atomic(Fu),
   Cost\=[],
   append(Cost, [mod-Appos], Mod),
   reverse([Fu-Mod|Res],FunctsOut),
   aareverse(Cost,Head),
   cl(K),
   asserta(funcs(Fu, K, Head, [Fu-Mod])),
   !.

appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   FunctsO\=[],
   FunctsO=[Fp, Sec|Rest],
   Fp=fp-_,
   (Sec=adj-Adj;Sec=xadj-Adj; Sec=fs-Adj),
   Obl\=[],
   Obl=[Fun-Body],
   Fun=appos,
   findall(Rel, on(ibar-[Rel|_],Rest),Rels), Rels\=[],
   length(Rels,L), 1=<L,
   Obl1=[subj-Body],
   append(Obl1, FunctsO, FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, [subj-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[Fp, Sec|Rest],
   Fp=fp-_,
   Sec=subj-Adj,
   Obl\=[],
   Obl=[Fun-Body],
   Fun=appos,
   findall(Rel, on(ibar-[Rel|_],Rest),Rels), Rels\=[],
   length(Rels,L), 2=<L,
   findall(fp, on(fp-_,Rest),Fps), Fps\=[],
   Obl1=[subj-Body],
   Sec1=appos-Adj,
   append(Body, [mod-Adj], FunctsOut),
   reassert_adjunct(Fun-Body, subj-FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   FunctsO\=[],
   FunctsO=[Fp, Sec|Rest],
   Fp=fp-_,
   Sec=subj-Adj,
   Obl\=[],
   Obl=[Fun-Body],
   Fun=appos,
   findall(Rel, on(ibar-[Rel|_],Rest),Rels), Rels\=[],
   length(Rels,L), 2=<L,
   Obl1=[subj-Body],
   search_append([Sec], Obl1, Rest, FunctsOut),
   !.

appendrel2(Ibar,Obj, FunctsO, FunctsOut):-
   FunctsO\=[],
   Obj\=[],
   Obj=[Fun-Body],
   FunctsO=[Sec|Rest],
   Rest=[Fc-_|_], Fc\=fc,
   Sec=obl-[Prep-A-B|Cost], Prep\=by,
   extract_argsp(Ibar,Prep,OutArgs),
   extract_argsp(Body,Prep,OutArgs1),
   (OutArgs=[], OutArgs1\=[],
    append(Body, [Sec], FunctsOu),
     reassert_adjunct(Fun-Body, Fun-FunctsOu), FunctsOutt=[Fun-FunctsOu]
     ;
    OutArgs\=[],
    append(Obj, FunctsO, FunctsOutt)
    ),
    append(FunctsOutt, Rest, FunctsOut),
   !.

appendrel2([],Obj, FunctsO, FunctsOut):-
   FunctsO\=[],
   Obj\=[],
   Obj=[obl-Body],
   FunctsO=[Sec|Rest],
   (Rest=[];Rest=[Fc-_|_], Fc\=fc),
   Sec=obl-[Prep-A-B|Cost], Prep\=by,
   extract_argsp(Body,Prep,OutArgs),
   (OutArgs\=[],
    append(Body, [Sec], FunctsOu),
     reassert_adjunct(Fun-Body, Fun-FunctsOu), FunctsOutt=[Fun-FunctsOu]
     ;
    OutArgs\=[],
    append(Obj, FunctsO, FunctsOutt)
    ),
    append(FunctsOutt, Rest, FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   FunctsO=[Sec|Rest],
   (Sec=obl-[Prep-A-B|Cost];   Sec=vcomp-[Prep-A-B|Cost]),
   Obl=[Fun-Body], 
    Fun=xadj,
    extract_argsa(Body,Prep,OutArgs),
   (OutArgs\=[],
    append(Body, [Sec], FunctsOu),
     reassert_adjunct(Fun-Body, Fun-FunctsOu), FunctsOutt=[Fun-FunctsOu]
     ;
    OutArgs\=[],
    append(Obj, FunctsO, FunctsOutt)
    ),
    append(FunctsOutt, Rest, FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   FunctsO=[Sec|Rest],
   Sec=vcomp-[Past-V-sv3|Cost],
   Obl=[Fun-Body], 
   Fun=subj,
   Rest=[obj-_|Res],
   Sec1=ibar-[Past-V-ibar|Cost],
   Functs1=[Sec1|Rest],
   append(Obl, Functs1, FunctsOut),
   !.
   
appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOut|Rest]):-
   FunctsO\=[],
   FunctsO=[fc-[and-cong-fc], Sec|Rest],
   Obl\=[],
   Obl=[Fun-Body],
   Body=[Prep-A-B|Cost],
   (Fu=obl;Fu=sn;Fu=obj;Fu=subj;Fu=appos),
   Sec=Fu-[Prep-A-B|Cos],
   append(Body, [and-cong-fc, Sec], FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, [Fun-FunctsOu]):-
   FunctsO=[Sec|Rest],
   Sec=fp-_,
   Obl=[Fir],
   Fir=Fun-Body,
   (Fun=fac;Fun=fs;Fun=fc),
   append(Body, FunctsO, FunctsOu),
   !.

appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   findall(Rel, on(ibar-[Rel|_],FunctsO),Rels), Rels=[],
   Obl=[Fu-_], Fu\=subj,
   non_obl_embedding(Obl,FunctsO),
   append(Obl, FunctsO, FunctsOut),
   !.
appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   findall(Rel, on(ibar-[Rel|_],FunctsO),Rels), Rels\=[],
   Obl=[Fu-_], Fu=subj,
   append(Obl, FunctsO, FunctsOut),
   !.
appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   findall(Rel, on(vcomp-[Rel|_],FunctsO),Rels), Rels\=[],
   Obl=[Fu-_], Fu=subj,
   append(Obl, FunctsO, FunctsOut),
   !.
appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   findall(Rel, on(ibar-[Rel|_],FunctsO),Rels), Rels\=[],
   findall(Rel1, on(subj-[Rel1|_],FunctsO),Rels1), Rels1\=[],
   Obl=[Fu-_], Fu\=subj,
   append(Obl, FunctsO, FunctsOut),
   !.
appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   findall(Rel, on(ibar-[Rel|_],FunctsO),Rels), Rels\=[],
   findall(Rel1, on(xcomp-[Rel1|_],FunctsO),Rels1), Rels1\=[],
   Obl=[Fu-_], Fu\=subj,
   append(Obl, FunctsO, FunctsOut),
   !.
appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   non_obl_embedding(Obl,FunctsO),
   Obl=[Fu-_], 
   FunctsO=[Fu1-_|_],
   (Fu=ibar,Fu1\=ibar;Fu\=ibar,Fu1\=ibar;Fu1\=ibar),
   append(Obl, FunctsO, FunctsOut),
   !.
appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   findall(Rel, on(ibar-[Rel|_],FunctsO),Rels), Rels=[],
   findall(Rel1, on(ibar-[Rel|_],Obl),Rels1), Rels1=[],
   non_obl_embedding(Obl,FunctsO),
   append(Obl, FunctsO, FunctsOut),
   !.

appendrel2(Ibar,Obl, FunctsO, FunctsOut):-
   append(Obl, FunctsO, FunctsOut),
   !.

appendrel2(Ibar,FunctsOut, [], FunctsOut):-
   !.

non_obl_embedding(Obl,Funct):-
   Obl=[Fu-_],
   Funct=[Fun-Sec|_],
   (Fu\=Fun;
    Fu=Fun,
      (Fun=obl,
       Sec=F-[of-_-_|_];
       Fun\=obl)),
    !.


crea_argomen1([], CatV, Valenz, [], NArgs, [], [], []) :-
  !.

crea_argomen1([F-[]|NArgs], CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg):-
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([savv-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, AllArgs, VArgs, [Agg|AllAgg]):-
     First\=[],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     (prepos(Head), up_tipo_agg(Ruolo, Head, CatAdj);
       \+ prepos(Head),
       match_sn_adj(CatSem,Ruolo)),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,adj/adj,Ruolo,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     


crea_argomen1([subj-First|NArgs], CatV, [subj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[subj-Sec|Rest],
     Sec\=[], Rest\=[],
     on(_-nh-sn, Sec),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,sogg/subj,Ruolo,Arg),
     Mod1=Ind-Lemma-Sec,
     insert_control(Testa, NArgs, subj, Valenz, Ind, Valenza),
     crea_argomenti(Rest,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-First|NArgs], CatV, [subj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[subj-Sec|_],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/subj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     append([subj-Ruolo],Valenz,NValenz),
     crea_argomenti(NArgs,CatV, NValenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-First|NArgs],CatV, [subj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,sogg/subj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, subj, Valenz, Ind, Valenza),
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([f2-First|NArgs],CatV, [subj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,sogg/subj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, subj, Valenz, Ind, Valenza),
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([sn-First|NArgs],CatV, [subj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     verify_subj_case(First),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,sogg/subj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, subj, Valenz, Ind, Valenza),
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-[There-_-_]|NArgs],CatV, [subj-Ruolo|Valenz], Mods, Args, [Arg|AllArgs], [theme_bound/Ind|VArgs], AllAgg):-
     (There=there;There='There'),
     assign_index(Ind),
     dep_grs_rols([there-_-_],Ind,there,[],[3,_,_],[luogo],[],there,sogg/subj,theme_bound,Arg),
     insert_control(there, NArgs, subj, Valenz, Ind, Valenza),
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-First|NArgs],CatV, [adj-Ruolo|Valenz], [Mod1|Mods], Args, AllArgs, [Ruolo/Ind|VArgs], [Agg|AllAgg]):-
     First\=[],
     First\=[Head-p-_|Rest],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,subj/adj,Ruolo,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-First|NArgs],CatV, [obj-Ruolo|Valenz], [Mod1|Mods], Args, AllArgs, [Ruolo/Ind|VArgs], [Agg|AllAgg]):-
     First\=[],
     First\=[Head-p-_|Rest],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,subj/obj,Ruolo,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-First|NArgs],CatV, [iobj-_, obj-Ruolo|Valenz], [Mod1|Mods], Args, AllArgs, [Ruolo/Ind|VArgs], [Agg|AllAgg]):-
     First\=[],
     First\=[Head-p-_|Rest],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,subj/obj,Ruolo,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-First|NArgs],CatV, [xcomp-prop, subj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     (First=['It'-pers-sn]; First=[it-pers-sn]),
     NArgs\=[],
     NArgs=[obj-Sec|Res],
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,xcomp/subj,prop,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(Res,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([subj-First|NArgs],CatV, [xcomp-prop, subj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First\=['It'-pers-sn], First\=[it-pers-sn],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,sogg/subj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     append([ncomp-theme],Valenz,NValenz),
     crea_argomenti(NArgs,CatV, NValenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([obj-First|NArgs], CatV, [Funz-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     NArgs\=[],
     (NArgs=[obj-Sec|_];NArgs=[subj-Sec|_]),
     First\=[],
     on(as-ccom-sn, First),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Funz/obj2,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     append([ncomp-theme],Valenz,NValenz),
     crea_argomenti(NArgs,CatV, NValenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([obj-First|NArgs], CatV, [Funz-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[vcomp-[A-B-C], obj-Sec|Rest],
     append([A-B-C], Sec, NSec),
     append([obj-NSec],Rest, NNArgs),
     First\=[],
     on(as-ccom-sn, First),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Funz/obj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     append([ncomp-theme],Valenz,NValenz),
     crea_argomenti(NNArgs,CatV, NValenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     


crea_argomen1([obj-First|NArgs], CatV, [obj2-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     (NArgs\=[],
       (NArgs=[obj-Sec|_];NArgs=[subj-Sec|_])
        ;NArgs=[]),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obj2/obj2,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([obj-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     Valenzes\=[],
     estrai_una_valenza(obj, Valenzes, Valenzz),
     remove_valenz(obj, Valenzes,Ruolo),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obj, Valenzz, Ind, NValenza),
     crea_argomenti(NArgs,CatV, NValenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([obj-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     Valenzes\=[],
     estrai_una_valenza(xcomp, Valenzes, Valenzz),
     remove_valenz(xcomp, Valenzes,Ruolo),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obj/xcomp,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([sn-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     Valenzes\=[],
     estrai_una_valenza(obj, Valenzes, Valenzz),
     remove_valenz(obj, Valenzes,Ruolo),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obj, Valenzz, Ind, NValenza),
     crea_argomenti(NArgs,CatV, NValenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([vcomp-First|NArgs], CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     First=[A],
     NArgs=[Fun-Sec|Rest],
     Fun\=vcomp,
     A=V-_-Syn, 
     (Syn=sv3; pp_word_cat(V, pass, part, Lem)), 
     (Fun=obl;Fun=sp),
     (Valenz\=[],
      remove_index_adj(Valenz,Index,Valenza)
       ;
      find_govern(1,N,Govern,Tes),
        Tes=S-B,
      recover_head_lemm(Index,S), Valenza=Valenz
       ;
      Index=arb, Valenza=Valenz),
      Ruolo=prop,
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_contr(First, Index, Ind, Ruol, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Fun/Fun,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     (Rest=[], Valen=Valenza; 
      Rest\=[],     
      insert_control(Testa, NArgs, Fun, Valenza, Ind, Valen)),
     append_extract_newvalenz(Fun,NewVal,Valen,Valenzas),
     crea_argomenti(Rest,CatV, Valenzas, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([vcomp-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[obl-Sec|Rest],
     estrai_una_valenza(vcomp, Valenzes, Valenz),
     Valenz\=[],
     remove_index(Valenz,Index,Valen),
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_controllo(First, Index, Ind, Ruolo, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/obl,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     append_extract_newvalenz(obl,NewVal,Valen,Valenza),
     crea_argomenti(Rest,ti, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([vcomp-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[obj-Sec|Rest],
     estrai_una_valenza(vcomp, Valenzes, Valenz),
     Valenz\=[],
     remove_index(Valenz,Index,Valen),
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_controllo(First, Index, Ind, Ruolo, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     append_extract_newvalenz(obj,NewVal,Valen,Valenza),
     crea_argomenti(Rest,ti, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([vcomp-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[obl-Sec|Rest],
     estrai_una_valenza(vcomp, Valenzes, Valenz),
     Valenz\=[],
     remove_index(Valenz,Index,Valen),
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     Sec=[Prep-_-_|_],
     costruisci_semantica_controllo(First, Index, Ind, Ruolo, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/obl,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     append_extract_newvalenz(obl,NewVal,Valen,Valenza),
     crea_argomenti(Rest,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([vcomp-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     estrai_una_valenza(vcomp,Valenzes, Valenz),
     Valenz\=[],
     remove_index(Valenz,Index,Valen),
     NArgs=[Fun-Sec|Rest],
     Fun\=vcomp,
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_controllo(First, Index, Ind, Ruolo, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     append_extract_newvalenz(Fun,NewVal,Valen,Valenza),
     crea_argomenti(Rest,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([vcomp-First|NArgs], CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[Fun-Sec|Rest],
     Fun\=vcomp,
     estrai_una_valenza(vcomp,Valenzes, Valenz),
     Valenz\=[],
     remove(ncomp-theme, Valenz, Valen),
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_controllo(First, Valenz, Ind, Ruolo, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Fun/Fun,tema,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     append_extract_newvalenz(Fun,NewVal,Valen,Valenza),
     crea_argomenti(Rest,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([obl-First|NArgs],CatV, [obl-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/obl,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obl, Valenz, Ind, Valenza),
     crea_argomenti(NArgs, CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([obl-First|NArgs],CatV, [iobj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/iobj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obl, Valenz, Ind, Valenza),
     crea_argomenti(NArgs, CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([obl-First|NArgs],CatV, [obj2-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/obj2,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obl, Valenz, Ind, Valenza),
     crea_argomenti(NArgs, CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen1([spda-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/arg_mod,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obl, Valenz, Ind, Valenza),
     crea_argomenti(NArgs, CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     


find_role_obls(Head,CatSem,NCatSem,Ruolo):-
     findall(Ruolo-CatAdj,up_tipo_agg(Ruolo, Head, CatAdj),Rols),
     match_semantics_adjs(CatSem, Rols, NCatSem, Ruolo).

find_role_obls(Head,CatSem,CatSem,Ruolo):-
     up_tipo_agg(Ruolo, Head, CatSem),
     ! .
find_role_obls(Head,CatSem,CatSem,Ruolo):-
     tipo_agg(Ruolo,Head,Cats),
     ! .

crea_argomen2([], CatV, Valenz, [], NArgs, [], [], []) :-
  ! .
crea_argomen2([f3-[_-_-fp]|NArgs],CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg):-
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),
     !.     
crea_argomen2([[_-_-fp]|NArgs],CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg):-
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),
     !.     

crea_argomen2([obl-First|NArgs],CatV, [obj-Role|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_role_obls(Head,CatSem,NCatSem,Ruolo),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/obl,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obl, Valenz, Ind, Valenza),
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obl-First|NArgs],CatV, [obj2-Role|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     (var(Role), find_role_obls(Head,CatSem,NCatSem,Ruolo); nonvar(Role), Ruolo=Role),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/obl,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obl, Valenz, Ind, Valenza),
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     


crea_argomen2([obl-First|NArgs],CatV, [subj-Role|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_role_obls(Head,CatSem,NCatSem,Ruolo),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,subj/obl,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     insert_control(Testa, NArgs, obl, Valenz, Ind, Valenza),
     crea_argomenti(NArgs, CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     
   
crea_argomen2([obj-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, AllArgs, [Ruolo/Ind|VArgs], [Agg|AllAgg]):-
     First\=[],
     Valenz\=[],
     on(adj-Ruolo, Valenz),
     remove(adj-Ruolo, Valenz, Valenza),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obj/adj,Ruolo,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obj-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, AllArgs, [compar/Ind|VArgs], [Agg|AllAgg]):-
     First\=[],
     on(than-ccom-Cost, First),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     remove(than-ccom-Cost, First, Valenza),
     dep_grs_rols_obl(than,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,adj/obj,compar,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obj-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [theme/Ind|VArgs], AllAgg):-
     First\=[],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,theme,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([mod-First],CatV, Valenz, [Mod1], Args, [], [Ruolo/Ind], [Agg]):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_role_obls(Head,CatSem,NCatSem,Ruolo),
     Mod1=Ind-Lemma-Mod,
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,NCatSem,Mod,Testa,adj/mod,Ruolo,Agg),
     !.     

crea_argomen2([adj-[PPas|NArgs]],CatV, Valenz, [Mod1|Mods], Args, AllArgs, VArgs, AllAgg):-
     NArgs\=[],
     remove(mod-Mod, NArgs, NewArgs),
     (NewArgs=[Avv-avv-_],  
      PPas=V-Tag-_, 
      mcon(V, '_', PAvv), 
      mcon(PAvv, Avv, Pavv), 
      Npas=Pavv-Tag-_
      ;
      NewArgs\=[A], Npas=PPas),
     assign_funz_role([Npas],NCatV,Lem,NValenz,Feats),      
     Mod1=Ind-Lemma-Mod,
     crea_argomenti([mod-Mod], NCatV, NValenz, Mods, Args, AllArgs, VArgs, AllAgg),
     !.

crea_argomen2([fint-[Wh]|NArgs],CatV, Valenz, Mods, Args, AllArgs, VArgs, [Agg|AllAgg]):-
     NArgs\=[],
     costruisci_mods_aggs([Wh], Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     Agg=ref_ex(Ind,Lemma,Tab,Tratti,CatSem,Mod,adj/mod),
     crea_argomenti(NArgs, NCatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),
     dep_grs_rols([],Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,adj/obj,mod,Agg),
     !.

crea_argomen2([subj-First|NArgs],CatV, [ncomp-theme|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [tema/Ind|VArgs], AllAgg):-
     First\=[],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,sogg/ncomp,tema,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(RArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obj-First|NArgs],CatV-L, [Funz-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     L=0,
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV-L, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obj-First|NArgs],CatV-L, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     L=0,
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV-L, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obl-First|NArgs],CatV, [obj2-Role|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     (var(Role), find_role_obls(Head,CatSem,NCatSem,Ruolo); nonvar(Role), Ruolo=Role),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/obj2,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obl-First|NArgs],CatV, [xcomp-Role|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_role_obls(Head,CatSem,NCatSem,Ruolo),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,obl/xcomp,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obl-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     ( find_role_obls(Head,CatSem,NCatSem,Ruolo),Func=obl
      ;
      governor(N,Lem),
      iobj_ncmod(Lem,Head,Func,Ruolo)),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/Func,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([xcomp-First|NArgs],CatV, [xcomp-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,xcomp/xcomp,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([xadj-First|NArgs],CatV, [obj-Ruolo|Valenz], [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([xcomp-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     (Valenz=[], Ruolo=prop, Valenze=[];
      Valenz\=[], estrai_una_valenza(xcomp,Valenz, Valenze), Ruolo=prop;
      Ruolo=prop, Valenze=Valenz),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,xcomp/xcomp,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenze, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([sn-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     (Valenz=[], Ruolo=prop, Valenze=[];
      Valenz\=[], estrai_una_valenza(xcomp,Valenz, Valenze), Ruolo=prop;
      Ruolo=prop, Valenze=Valenz),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,xcomp/xcomp,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenze, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([vcomp-First|NArgs], CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     First=[A],
     NArgs=[Fun-Sec|Rest],
     Fun\=vcomp,
     A=V-_-Syn, 
     (Syn=sv3; pp_word_cat(V, pass, part, Lem)), 
     (Fun=obl;Fun=sp),
     (Valenz\=[],
      remove_index_adj(Valenz,Index,Valenza)
       ;
      find_govern(1,N,Govern,Tes),
        Tes=S-B,
      recover_head_lemm(Index,S), Valenza=Valenz
       ;
      Index=arb, Valenza=Valenz),
      Ruolo=prop,
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_contr(First, Index, Ind, Ruol, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Fun/Fun,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     (Rest=[], Valen=Valenza; 
      Rest\=[],     
      insert_control(Testa, NArgs, Fun, Valenza, Ind, Valen)),
     append_extract_newvalenz(Fun,NewVal,Valen,Valenzas),
     crea_argomenti(Rest,CatV, Valenzas, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([vcomp-First|NArgs], CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     First=[A],
     NArgs=[Fun-Sec|Rest],
     Fun\=vcomp,
     A=V-_-Syn, 
     (Syn=sv5; checkinger(V, Lem)), 
     (Valenz\=[],
      remove_index_adj(Valenz,Index,Valenza)
       ;
      find_govern(1,N,Govern,Tes),
        Tes=S-B,
      recover_head_lemm(Index,S), Valenza=Valenz
       ;
      Index=arb, Valenza=Valenz),
      Ruolo=prop,
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_controllo(First, Index, Ind, Ruol, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Fun/Fun,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     (Rest=[], Valen=Valenza; 
      Rest\=[],     
      insert_control(Testa, NArgs, Fun, Valenza, Ind, Valen)),
     append_extract_newvalenz(Fun,NewVal,Valen,Valenzas),
     crea_argomenti(Rest,CatV, Valenzas, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([vcomp-First|NArgs], CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Rel|VArgs], AllAgg):-
     NArgs\=[],
     NArgs=[Fun-Sec|Rest],
     Fun\=vcomp,
     (Valenz\=[],
      remove_index_adj(Valenz,Index,Valenza)
       ;
      find_govern(1,N,Govern,Tes),
        Tes=A-B,
      recover_head_lemm(Index,A), Valenza=Valenz
       ;
      Index=arb, Valenza=Valenz),
     (Valenz=[], Ruolo=result, Valenza=[];
      Valenz\=[], estrai_una_valenza(xcomp,Valenz, Valenza), Ruolo=prop;
      Ruolo=result, Valenza=Valenz),
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_controllo(First, Index, Ind, Ruol, Rel, NewVal),
     dep_grs_rols_vcomp(Rel,First,Sec,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Fun/Fun,Ruolo,Arg),
     semantica_controllo(Rel),
     Mod1=Ind-Lemma-Mod,
     (Rest=[], Valen=Valenza; 
      Rest\=[],     
      insert_control(Testa, NArgs, Fun, Valenza, Ind, Valen)),
     append_extract_newvalenz(Fun,NewVal,Valen,Valenzas),
     crea_argomenti(Rest,CatV, Valenzas, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([vcomp-First|NArgs], CatV, Valenz, Mods, Args, AllArgs, [Rel|VArgs], AllAgg):-
%     NArgs=[],
     (Valenz\=[],
      remove_index_adj(Valenz,Index,Valen)
       ;
      find_govern(1,N,Gov,Tes),
        Tes=A-B,
      recover_head_lemm(Index,A), Valen=Valenz
       ;
      Index=arb, Valen=Valenz),
     governor(N,Govern),
     costruisci_semantica_controllo(First, Index, [], Ruolo, Rel, NewVal),
     Rel=Dep-_,
     First=[Head-_-_|Rest],
     (prepos(Head),Sem=Head;Sem=nil),
     term_to_atom(xcomp-prop,Fun),
     DepGr=..[Fun,Sem,Govern,Dep],
     asserta(dgrs(N,DepGr)),
%     semantica_controllo(Rel),
     governor(N,_), 
     (N=nil, N1=1; integer(N), N1 is N+1),
     current_governor(N1,Dep),
     append_extract_newvalenz(Fun,NewVal,Valen,Valenza),
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obl-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, AllArgs, VArgs, [Agg|AllAgg]):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_role_obls(Head,CatSem,NCatSem,Ruolo),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,NCatSem,Mod,Testa,adj/obl,Ruolo,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([Funz-First|NArgs],CatV, Valenzes, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     Funz\=ibar, First\=[],
     estrai_una_valenza(Funz,Valenzes, Valenz),
     Valenz\=[],
     remove_index_adj(Valenz,Ruolo,Valenza),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Funz/Funz,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs,CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([obj-First|NArgs],CatV, Valenz, [Mod1|Mods], Args, AllArgs, [Ruolo/Ind|VArgs], [Agg|AllAgg]):-
     First\=[],
     Valenz\=[],
     nogen_member(Funz-Ruolo, Valenz),
     remove(Funz-Ruolo, Valenz, Valenza),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,ogg/obj,tema,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([], CatV, Valenz, [], NArgs, [], [], []):-!.     

crea_argomen2([obl-First|NArgs],CatV, Adj, [Mod1|Mods], Args, AllArgs, VArgs, [Agg|AllAgg]):-
     First\=[],
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,adj/obl,theme,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([f2-First|NArgs], CatV, Valenz, Mods, Args, AllArgs, VArgs, [RelClause|AllAgg]):-
   appiattisci(First,Fir),
   length(Fir,L), 1<L,
    dgrs(SentNo,DepGr),
     (DepGr=..[Out,Govern,Head-Ind,Lemma], atomic(Lemma);
      DepGr=..[Out,Govern,Lemma,Head-Ind];
       DepGr=..[Out,Govern,Head-Ind]),
    term_to_atom(Fun-_,Out),
    build_relativeclause(Ind,Head,First,RelClause,Re),
    append(Re,NArgs,NArgss),
     crea_argomenti(NArgss, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([Funz-First|NArgs], CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     Funz\=ibar,Valenz\=[],
     nogen_member(Funz-Ruolo, Valenz),
     remove(Funz-Ruolo, Valenz, Valenza),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Funz/Funz,Ruolo,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenza, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([Obl-First|NArgs],CatV, Val, [Mod1|Mods], Args, AllArgs, VArgs, [Agg|AllAgg]):-
     First\=[],
     First=[Head-_-_|Rest], 
     (Obl=obl;Obl=savv;Obl=sp;Obl=fint),
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     prepos(Head), up_tipo_agg(Ruolo, Head, CatAdj),
     dep_grs_rols_obl(Head,First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,adj/adj,Ruolo,Agg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Val, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([Funz-First|NArgs], CatV, Valenz, [Mod1|Mods], Args, [Arg|AllArgs], [Ruolo/Ind|VArgs], AllAgg):-
     appiattisci(First,Fir),
     length(Fir,L), 1=<L, Funz\=obl,Funz\=ibar,Funz\=savv,
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,Funz/obj,theme,Arg),
     Mod1=Ind-Lemma-Mod,
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     

crea_argomen2([Funz-First|NArgs], CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg):-
     crea_argomenti(NArgs, CatV, Valenz, Mods, Args, AllArgs, VArgs, AllAgg),!.     


checkinger(V, Lem):-
    stringof(List,V),
    reverse(List,[g,n,i|Verb]),
    reverse(Verb,Ver),
    stringof(Ver,Lem).
    
match_sn_adj(CatSem,Ruolo):-
     tipo_agg(Ruolo, LHead, CatAdj),
     member(C,CatSem),member(C,CatAdj),!.

prendi_ruolo_obls(Head,CatSem,Ruolo):-
     (prepos(Head), up_tipo_agg(Ruolo, Head, CatAdj);
       \+ prepos(Head),
       match_sn_adj(CatSem,Ruolo)),
      !.

assignCat_roles(ng,ncmod/poss):-!.
assignCat_roles(Cat,ncmod/attr).

verify_derivations(Pred,NewPred):-
      Pred\=NewPred,
      lemmatize_dic_v(NewPred,Lemma,R),
      Lemma\=Pred,
      (Lemma\=NewPred
       ;
       stringof([C1|ChP1],NewPred),
       stringof([C2|ChP2],Pred),C1\=C2
      ),
      !.
verify_derivations(Pred,NewPred):-
      Pred\=NewPred,
      lemmatize_dic_v(Pred,Lemma,R),
      Lemma\=NewPred,
      (Lemma\=Pred
       ;
       stringof([C1|ChP1],NewPred),
       stringof([C2|ChP2],Pred),C1\=C2
      ),
      !.
check_noun_subc(Pre,Cost-Sec,[SP-[that-P-C]|Func],FunctsOut,[]):-
    nprendi_testa(NP, Sec, Head),
    check_subcn(Head,that),
    append(Pre, Sec, Ogg),
    Func=[sn-Rest, ibar-IBar|Sints],
    append([fcomp-[that-P-C]], Func, Obl),
    append(Ogg, [fcomp-Obl], Functs),
    FunctsOut=[obl-Functs],
    cl(Cl),
    assert(ibar(false)),
    assert(passiv(off)),
    assign_ffunction(sn-Rest, Subj),
    assign_vfunction(ibar-IBar, Ibar),
    asserta(funcs(obl, Cl, Test, FunctsOut)),
    !.
check_noun_subc([],[Cost-Sec],[SP-[Prep-P-C]|Func],FunctsOut,Sints):-
    (Cost=sn;Cost\=ibar,Cost\=vcomp),
    aareverse(Sec,Head),
    check_subcn(Head,Prep),
    Func=[sn-Rest|Sints],
    append([Prep-P-C], Rest, Obl),
    append(Sec, [mod-Obl], Functs),
    FunctsOut=[Cost-Functs],
    cl(Cl),
    nprendi_testa(NP, Sec, Test),
    asserta(funcs(Cost, Cl, Test, FunctsOut)),
    !.
check_noun_subc(Pre,Cost-Sec,[SP-[Prep-P-C]|Func],FunctsOut,Sints):-
    (Cost=sn;Cost\=ibar,Cost\=vcomp),
    aareverse(Sec,Head),
    check_subcn(Head,Prep),
    append(Pre, Sec, Ogg),
    Func=[sn-Rest|Sints],
    append([Prep-P-C], Rest, Obl),
    append(Ogg, [mod-Obl], Functs),
    FunctsOut=[obl-Functs],
    cl(Cl),
    nprendi_testa(NP, Sec, Test),
    asserta(funcs(obl, Cl, Test, FunctsOut)),
    !.
up_tipo_agg(Ruolo, Head, CatAdj):-
    CatAdj\=[],CatAdj\=nil,
    tolower(Head, LHead), 
    tipo_agg(Ruolo, LHead, CatAdjs),
    nogen_member(CC,CatAdjs),
    nogen_member(CC,CatAdj).

up_tipo_agg(Ruolo, Head, CatAdj):-
    CatAdj\=[],CatAdj\=nil,
    tipo_agg(Ruolo, Head, CatAdjs),
    nogen_member(CC,CatAdjs),
    nogen_member(CC,CatAdj).

up_tipo_agg(goal, to, CatAdj):-
   nonvar(CatAdj),
   (CatAdj=[];CatAdj=nil),
   !.
up_tipo_agg(agent, by, [istituzione,umano,legale]).
up_tipo_agg(specif, of, [any]):-!.
up_tipo_agg(Ruolo, Head, CatAdj):-
    tipo_agg(Ruolo, Head, CatAdj).
up_tipo_agg(modal, Pre, [any]):-!.




build_relativeclause(Ind, Head, Body,Clause,Rest):-
   Body=[F2-Vp|VP], (F2=f2;F2=fac),
   Vp=[F2-F|Res], 
   F=[F2-Pron|_], 
   build_relativeclause(Ind, Head, Vp,Clause,Rest),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-_|VP], (F2=f2;F2=fac),
   appiattisci(VP, Vp),
   Vp=[ibar-Ibar|Resto],
   (Resto=[F2-Pron|_], Pron\=[nil];Pron=[nil]),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   current_governor(N,Lem),
   cmod_topic_assert(N,Lem,Arg,Ruolo,Head-Ind,Pron,subj),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,Resto, Valenzz, NArg,RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-Pron|VP], 
   (F2=f2;F2=fac), 
   (Pron=[A], RelC=VP; Pron\=[A], RelC=Pron),
   appiattisci(RelC, Vp),
   Vp=[f-Resto|_],
   Resto=[subj-pro|Vpp], 
   (Vpp=[ibar-Ibar|Compl], Compls=Compl;
    Vpp=[savv-Savv,ibar-Ibar|Compl], append(Compl,[savv-Savv],Compls)),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   current_governor(N,Lem),
   cmod_topic_assert(N,Lem,Arg,Ruolo,Head-Ind,Pron,subj),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,Compls, Valenzz, NArg,RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-F], 
   F2=f2,
   F=[F2-Pron|VP], 
   (Pron=[A], RelC=VP; Pron\=[A], RelC=Pron),
   appiattisci(RelC, Vp),
   Vp=[f-Resto|_],
   Resto=[subj-pro|Vpp], 
   (Vpp=[ibar-Ibar|Compl], Compls=Compl;
    Vpp=[savv-Savv,ibar-Ibar|Compl], append(Compl,[savv-Savv],Compls)),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   current_governor(N,Lem),
   cmod_topic_assert(N,Lem,Arg,Ruolo,Head-Ind,Pron,subj),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,Compls, Valenzz, NArg,RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-F], 
   F2=f2,
   F=[F2-Pron|VP], 
   (Pron=[A], RelC=VP; Pron\=[A], RelC=Pron),
   appiattisci(RelC, Vp),
   Vp=[f-Resto|_],
   (Resto=[subj-SN|Vpp];   Resto=[sn-SN|Vpp]), 
   (Vpp=[ibar-Ibar|Compl], Compls=Compl;
    Vpp=[savv-Savv,ibar-Ibar|Compl], append(Compl,[savv-Savv],Compls)),
   (Pron=[Pro-_-_];Pron=[nil], Pro=nil),
   create_pobject_rel(Pro, Fun, Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   current_governor(N,Lem),
   cmod_topic_assert(N,Lem,Arg,Ruolo,Head-Ind,Pron,Fun),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,[subj-SN|Compls], Valenzz, NArg,RefsRel, Aggs),
   append(NArg, Arg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, ArgsAdjs, []]],RestArgsAdjs):-
   Body=[F2-F], 
   F2=fac,
   F=[F2-Pron|VP], 
   appiattisci(VP, Vp),
   Vp=[f-Resto],
   (Resto=[subj-SN|Vpp];   Resto=[sn-SN|Vpp]), 
   (Vpp=[ibar-Ibar|Compl], Compls=Compl;
    Vpp=[savv-Savv,ibar-Ibar|Compl], append(Compl,[savv-Savv],Compls)),
   governor(N,L),
   N1 is N + 1,
   append([subj-SN],Compls,Clause),
   extract_clause([_-ibar-Ibar], Resto, Claus, IBar, RestFuncs, RestIbar, Adjss),
   create_clause_fac(N1, Ibar, Claus, ArgsAdjs, Mods, NArgs, Lem-Args, Neg),
   assert_verbcompl(N,Lem,Ibar),
   term_to_atom(ccomp-prop,Fun),
   DepGr=..[Fun,that,Head,Lem],
   asserta(dgrs(N, DepGr)),
   append(RestFuncs,Adjss,RestArgsAdjs),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-_|VP], (F2=f2;F2=fac),
   appiattisci(VP, Vp),
   remove(ibar-Ibar,Vp,Resto),
   (Resto=[F2-Pron|_], 
    Pron\=[nil], Pron=[A-B-C],
    (A=whom,
     create_object_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg)
     ;
     create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg)
     )
    ;
    Pron=[nil],
    create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg)),
    current_governor(N,Lem),
   assert_relative_subject(N,Pron,Head,Ind,Lem),
   governor(Cl,L),
   (remove(subj-pro,Resto,RestR);RestR=Resto), 
   create_arguments(Cl, Ind, Lem,Head,RestR, Valenz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-F22|VP], (F2=f2;F2=fac),
   (F22=[whose-_-_,SN], F2W=SN; F2W=F22),
   append(F22,VP,VP1),
   remove(ibar-Ibar,VP1,Resto),
   (Resto=[F2-Pron|_], 
    Pron\=[nil], Pron=[A-B-C],
    (A=whom,
     create_object_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg), Fun=obj
     ;
     create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg), Fun=subj
     )
    ;
    Pron=[nil],
    create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg), Fun=subj),
    current_governor(N,Lem),
   (Pron=[P-_-_];Pron=[nil]),
   (P=whose,
    assert_relative_subject(N,Pron,Head,Ind,Lem)
     ;
     P\=whose,
   cmod_topic_assert(N,Lem,Arg,Ruolo,Head-Ind,Pron,Fun)),
   governor(Cl,L),
   (remove(subj-pro,Resto,RestR);RestR=Resto), 
   create_arguments(Cl, Ind, Lem,Head,RestR, Valenz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-F22|VP], (F2=f2;F2=fac),
   (F22=[whose-_-_,SN], F2W=SN; F2W=F22),
   append(F22,VP,VP1),
   remove(f-F,VP1,VP2),
   VP2=F22,
   remove(ibar-Ibar,F,Resto),
   (VP2=[F2-Pron|_], Pron\=[nil];Pron=[nil]),
   Pron=[_|Subj],
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
    current_governor(N,Lem),
   (Pron=[P-_-_];Pron=[nil]),
   (P=whose,
    assert_relative_subject(N,Pron,Head,Ind,Lem)
     ;
     P\=whose,
   cmod_topic_assert(N,Lem,Arg,Ruolo,Head-Ind,Pron,subj)),
   governor(Cl,L),
   (remove(subj-pro,Resto,RestR);RestR=Resto),
   append([subj-Subj],RestR, RestsR),
   create_arguments(Cl, Ind, Lem,Head,RestsR, Valenz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[f2-F22|VP],
   F22=[f2-[whose-R-S,SN]|VP1],
   remove(f-F,VP1,VP2),
   remove(ibar-Ibar,F,Resto),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
    current_governor(N,Lem),
    Pron=[whose-R-S],
    assert_relative_subject(N,Pron,Head,Ind,Lem),
    SN=Fu-SN1,
    append(SN1,[mod-[Head-n-Ind]],SN2),
   append([obj-SN2],Resto, RestsR),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,RestsR, Valenz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-_|VP], (F2=f2;F2=fac),
   appiattisci(VP, Vp),
   remove(ibar-Ibar,Vp,Resto),
   Vp=[subj-SN|Resto],
   (Resto=[F2-Pron|_], Pron\=[nil];Pron=[nil]),
   create_object_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
    current_governor(N,Lem),
   assert_relative_subject(N,Pron,Head,Ind,Lem),
   governor(Cl,L),
   (remove(subj-pro,Resto,RestR);RestR=Resto), 
   create_arguments(Cl, Ind, Lem,Head,RestR, Valenz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-_|VP], F2=fac,
   appiattisci(VP, Vp),
   tensed(Tensed),
   remove(f-F,Vp,[]),
   remove(ibar-Ibar,F,Resto),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   current_governor(N,Lem),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,Resto, Valenz, Args, RefsRel, Aggs),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-_|VP], (F2=f2;F2=fac),
   appiattisci(VP, Vp),
   tensed(Tensed),
   remove(vcomp-Ibar,Vp,Resto),
   (Tensed=[];Tensed=nil;on(V-_,Tensed), on(V-_-_,Ibar)),
   (Resto=[F2-Pron|_], Pron\=[nil];Pron=[nil]),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
    current_governor(N,Lem),
   assert_relative_subject(N,Pron,Head,Ind,Lem),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,Resto, Valenz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,[Cl-[Lem-Args-Neg, RefsRel, Aggs]], []):-
   Body=[F2-F22|VP], (F2=f2;F2=fac),
   append(F22,VP,VP1),
   tensed(Tensed),
   remove(vcomp-Ibar,VP1,Resto),
   (Tensed=[];Tensed=nil;on(V-_,Tensed), on(V-_-_,Ibar)),
   (Resto=[F2-Pron|_], Pron\=[nil];Pron=[nil]),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
    current_governor(N,Lem),
   assert_relative_subject(N,Pron,Head,Ind,Lem),
   governor(Cl,L),
   create_arguments(Cl, Ind, Lem,Head,Resto, Valenz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.

build_relativeclause(Ind, Head, Body,Mods, []):-
   Body=[F2-Rest|VP], (F2=f2;F2=fac),
   (VP\=[],
    appiattisci(VP, Vp)
    ;
    appiattisci(Rest,Vp)),
   create_mods(Vp,Ind-Head,Mod),
   cl(N),
   assert_mods(N, Mod, Mods),
   !.

build_relativeclause(Ind, Head, Body,Mods, []):-
   appiattisci(Body, Vp),
   create_mods(Vp,Ind-Head,Mod),
   cl(N),
   assert_mods(N, Mod, Mods),
   !.

create_pobject_rel(Pron, Fun, Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg):-
    (Pron=which;Pron=whom;Pron=that),
     create_object_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg), Fun=obj
     ;
     Pron\=which,Pron\=whom,Pron\=that,
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     maximise_functions(Lem,[],Valenzes, Valenz),
     (remove(obl-Role, Valenz, Valenzz)
      ;
      Pro=where, Role=locat, Valenzz=Valenz;
      Pro=when, Role=temp, Valenzz=Valenz),
     Arg=[Role/Ind], Fun=obl,
     !.


create_mods([],Ind-Head,[]):-!.
create_mods([M|Vp],Ind-Head,[Ind-Head-[M]|Mod]):-
   create_mods(Vp,Ind-Head,Mod),
   !.

assert_cmod_topic(Pro,Head,Lem):-
     Lem=..[Pref,[Lemma1,Lemma2]],
     coml_n(Head,Subs),
     remove(subc-Sub, Subs,_),
     on(f/that/fcomp,Sub),
     costruisci_coord_lems(Lemma1,Pref,Lemma2,LCoord),
     term_to_atom(ccomp-prop,Fun),
     DepGr=..[Fun,Pro,Head,LCoord],
     asserta(dgrs(N,DepGr)),
     !.

assert_cmod_topic(Pro,Head,Lem):-
     coml_n(Head,Subs),
     remove(subc-Sub, Subs,_),
     on(f/that/fcomp,Sub),
     term_to_atom(ccomp-prop,Fun),
     DepGr=..[Fun,Pro,Head,Lem],
     asserta(dgrs(N,DepGr)),
     !.

assert_cmod_topic(Pro,Head,Lem):-
     Lem=..[Pref,[Lemma1,Lemma2]],
     costruisci_coord_lems(Lemma1,Pref,Lemma2,LCoord),
     term_to_atom(cmod-topic,Fun),
     DepGr=..[Fun,Pro,Head,LCoord],
     asserta(dgrs(N,DepGr)),
     !.

assert_cmod_topic(Pro,Head,Lem):-
     term_to_atom(cmod-topic,Fun),
     DepGr=..[Fun,Pro,Head,Lem],
     asserta(dgrs(N,DepGr)),
     !.

assert_relative_subject(N,Pron,Head,Ind,Lem):-
     (Head=Hea-Id, Hed=Head;
      var(Ind),Hed=Head;
      nonvar(Ind),Hed=Head-Ind),
     (Pron=[Pro-_-_];
      Pron=[Pro-_-_|_];
      Pron=[nil],Pro=nil),
     assert_cmod_topic(Pro,Head,Lem),
     !.

append_relative_subj(Ibar,Ogg, FunctsO, [Fun-FunctsOut]):-
   FunctsO\=[],
   FunctsO=[Sec|Rest],
   Sec=Fu-Se,
   Ogg\=[],
   Ogg=[Fir],
   Fir=Fun-Body,
   Fun=subj,
   consistent_functionss(Fu,Fun),
   Sec1=[f2-[nil]], 
   append([subj-Se],Ibar,Sec2),
   append(Sec1, Sec2, Rel),
   append(Body, [f2-Rel], FunctsOut),
   reassert_adjunct(Fu-Se, subj-Se),
   reassert_adjunct(Fun-Body, Fun-FunctsOut),
   First=f2-[nil],
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, nil, f2-[nil-_-_])),
   !.

subj_fac_compless_rel(subj,Body,FunctsO, FunctsOut):-
   remove(F-Third,Body,Ogg),
   append_relative_subj(FunctsO, Ogg, [F-Third], FunctsOut),
     !.

subj_fac_compless_rel(fac,Body,FunctsO, FunctsOut):-
   remove(F-Third,Body,Ogg),
   remove(fac-Fac,Ogg,Sogg),
   append_relative_subj(FunctsO, Sogg, [F-Third], FunctsOu),
   append([fac-Fac], FunctsOu, FunctsOut),
     !.

%VArgs==>[hear-[actor/arb]]

evaluate_args_arb(ArgsAdjs,VArgs):-
    ArgsAdjs\=[],
     !.
evaluate_args_arb([],VArgs):-
    VArgs\=[],
    remove(Pred-Args,VArgs,_),
    (on(_/arb,Args);
     on(Role/_,Args)),
     !.

choose_fint_type(Ibar,[how-int-fint],adj):-!.
choose_fint_type(Ibar,[what-int-fint],obj):-!.
choose_fint_type(Ibar,[who-int-fint],Func):-    
     aareverse(Ibar,W),
     (coplb(W), Func=xcomp;Func=subj),
     !.
choose_fint_type(Ibar,[where-int-fint],obl):-!.
choose_fint_type(Ibar,[when-int-fint],adj):-!.
choose_fint_type(Ibar,[_-p-_, P-int-fint],obl):-!.
    
create_clause_fac(N1, [], [], [], [], [], Lem-[], []):-!.

create_clause_fac(N, IBar, [], [], [], [], Lem-VArgs, Neg):-
     IBar\=[],
     create_subject_rel(Ind, IBar, Valenz, Valenzz, Lem-Argg-Neg),
     current_governor(N,Lem),
     on(Ruolo/_,Arg),
     assert_dep_gram_rels(subj,Ruolo,pro),
    !.

create_clause_fac(N1, IBar, [fint-First|Argss], ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg):-
    choose_fint_type(IBar,First,Func),
    (remove(ibar-Verbs,Argss,Rest),
     append([Func-First],Rest,Clause)
     ;
     append([Func-First],Argss,Clause)
     ),
    create_clause(N1, IBar, Clause, Args, Mods, NArgs, Lem-VArgs, Aggs, Neg),
    Aggs=_-Agg,
%    append([f2-First],[ibar-Verbs], Rel),
%    append([arb-f2-Rel],Mods,Modss),
    assert_mods(N1, Mods,RefMods),
    appiattisci(RefMods,RefModss),
    (Agg=nil, AllAgg=RefModss;
      list(Agg), append(RefModss,Agg,AllAgg)
      ; AllAgg=RefModss),
    appiattisci(Args,AllArgs),
    appiattisci(AllAgg,AllAggs),
    append(AllArgs,AllAggs,ArgsAdjs),
    evaluate_args_arb(ArgsAdjs,VArgs),
    !.

create_clause_fac(N1, IBar, [subj_vcomp-Subj|Argss], ArgsAdjs, Mods, NArgs, Lem-SVArgs, Neg):-
     (Argss=[obl-Sec|Rest], Args=[obl-Sec], Fun=obl;
      Argss=[obj-Sec|Rest], Args=[obj-Sec], Fun=obj;
      Argss=[subj-Sec|Rest], Args=[obj-Sec], Fun=obj),
        Sec=[Prep-_-_| Res],
        (
           prepos(Prep),
           Sem=Prep
          ;  Sem=nil
          ),
     costruisci_mods_aggs(Sec, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     costruisci_semantica_controllo(Subj, arb, Ind, Ruolo, Rel, NewVal),
     Rel=LemV-Arrs,
     current_governor(N1,LemV),
     governor(N1,Gov),
     assert_dep_gram_rels_obl(Sem, Fun, Ruolo, Lemma-Ind),
     N is N1 + 1,
     create_clause(N, IBar, Rest, Arggs, Mods, NArgs, Lem-VArgs, Aggs, Neg),
     governor(N,Govern),
     term_to_atom(subj-prop,FunctR),
     DepGr=..[FunctR,Govern,Gov],
     asserta(funcs(ibar,N1,Gov,Subj)),
     asserta(dgrs(N,DepGr)),
    append([Rel],VArgs,SVArgs),
    Aggs=_-Agg,
    assert_mods(N1, Mods,RefMods),
    appiattisci(RefMods,RefModss),
    (Agg=nil, AllAgg=RefModss;
      list(Agg), append(RefModss,Agg,AllAgg)
      ; AllAgg=RefModss),
    appiattisci(Args,AllArgs),
    appiattisci(AllAgg,AllAggs),
    append(AllArgs,AllAggs,ArgsAdjs),
    evaluate_args_arb(ArgsAdjs,VArgs),
    !.

create_clause_fac(N1, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg):-
    create_clause(N1, IBar, Clause, Args, Mods, NArgs, Lem-VArgs, Aggs, Neg),
    Aggs=_-Agg,
    assert_mods(N1, Mods,RefMods),
    appiattisci(RefMods,RefModss),
    (Agg=nil, AllAgg=RefModss;
      list(Agg), append(RefModss,Agg,AllAgg)
      ; AllAgg=RefModss),
    appiattisci(Args,AllArgs),
    appiattisci(AllAgg,AllAggs),
    append(AllArgs,AllAggs,ArgsAdjs),
    evaluate_args_arb(ArgsAdjs,VArgs),
    !.

assess_arguments(Valenze,Lem,Args,NewArgs,Valenz):-
    assess_argumens(Valenze,Lem,Args,Args1,Valenz),
    assess_obls_adjs(Lem,Args1,NewArgs),
     !.


assess_obls_adjs(Lem,Args,NewArgs):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,First\=vcomp-_,
      remove(xcomp-Arg,Args,MidArgs),
      append([subj-Arg],MidArgs,NewArgs),
      !.
assess_obls_adjs(Lem,Args,NewArgs):-
      copl(Lem),
      Args=[First|_],
      First=obl-_,
      remove(xcomp-Arg,Args,MidArgs),
      append([subj-Arg],MidArgs,NewArgs),
      !.

assess_obls_adjs(Lem,Args,Args):-
      remove(subj-Arg,Args,NewArgs),
     !.

assess_obls_adjs(Lem,Args,NewArgs):-
      remove(obl-Arg,Args,MidArgs),
      Arg=[Prep-P-_|_], P\=p,P\=pda,
      append([subj-Arg],MidArgs,NewArgs),
     !.
assess_obls_adjs(Lem,Args,Args):-!.
   
assess_argumens(Valenze,Lem,Args,NewArgs,Valenze):-
      Args=[First|NewArg],
      (First=fs-_;First=fc-_;First=fp-_;First=ibar-_),
     assess_argumens(Valenze,Lem,NewArg,NewArgs,Valenze),
    !.
assess_argumens(Valenze,Lem,Args,Args,Valenz):-
      \+ copl(Lem),
      length(Args,L),
      length(Valenze,L1),
      3 < L,
      3 < L1,
      on(vcomp-_,Args),
      on(vcomp-_,Valenze),
      nth(Args,N,vcomp-_),
      nth(Valenze,N1,vcomp-_),
      3 < N, 
      3 < N1,
      remove(vcomp-_,Valenze,Valenz),
      !.
assess_argumens(Valenze,Lem,Args,Args,Valenze):-
      Args=[First|_],
      First=subj-_,!.
assess_argumens(Valenze,Lem,Args,NewArgs,Valenze):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      ((Func=obj;Func=subj),
        remove(Func-Arg1,MidArgs,RestArgs),
        append([Func-Arg],RestArgs,NewArgs)
        ;
        remove(obj-Arg1,MidArgs,RestArgs),
        append([ncomp-Arg1],RestArgs,NewArg),
        append(NewArg,[Func-Arg],NewArgs)),
      !.
assess_argumens(Valenze,Lem,Args,NewArgs,Valenze):-
      \+ copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      ((Func=obj;Func=subj),
        remove(Func-Arg1,MidArgs,RestArgs),
        append([Func-Arg],RestArgs,NewArgs)
       ;
        append(MidArgs, [Func-Arg],NewArgs)),
      !.
assess_argumens(Valenze,Lem,Args,NewArgs,Valenze):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      append([Func-Arg],MidArgs,NewArgs),
      !.
assess_argumens(Valenze,Lem,Args,NewArgs,Valenze):-
      \+ copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      append([Func-Arg],MidArgs,NewArgs),
      !.
assess_argumens(Valenze,Lem,Args,NewArgs,Valenze):-
      Args=[First|_],
      First\=subj-_,
      First\=vcomp-_,
      remove(subj-Arg,Args,MidArgs),
      append([subj-Arg],MidArgs,NewArgs),
      !.
assess_argumens(Valenze,Lem,Args,NewArgs,Valenze):-
      \+ copl(Lem),
      Args=[First|_],
      First\=subj-_,
      First\=vcomp-_,
      remove(obj-Arg,Args,MidArgs),
      append([subj-Arg],MidArgs,NewArgs),
      !.
assess_argumens(Valenze,Lem,Args,NewArgs,Valenz):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(xcomp-Arg,Args,MidArgs),
      append([subj-Arg],MidArgs,NewArgs),
      append([subj-theme_bound],Valenze,Valenz),
      !.
assess_argumens(Valenze,Lem,Args,Args,Valenze):-!.

create_clause(N, Ibar, Args, AllArgs, Mods, RArgs, NLem-VArgs, NLem-AllAgg, Neg):-
     Ibar\=[],
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     assert_passive(Ibar,Lem),
     maximise_functions(Lem,Args,Valenzes, Valenzz),
     (
      on(Valenz,Valenzz), list(Valenz), Valenze=Valenz
      ; Valenze=Valenzz),
     length(Args,L),
     correct_lem(Lem,Args,NLem),
     current_governor(N,NLem),
     assess_arguments(Valenze,Lem,Args,NewArgs,Vale),
     crea_argomenti(NewArgs, CatV-L, Vale, Mods, RArgs, AllArgs, VArgs, AllAgg),
     !.

create_clause(N, Ibar, [First|[]], AllArgs, Mods, RArgs, Lem-VArgs, Lem-AllAgg, Neg):-
     Ibar\=[],
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     maximise_functions(Lem,First,Valenzes, Valenzz),
     (
      on(Valenz,Valenzz), list(Valenz), Valenze=Valenz
      ; Valenze=Valenzz),
     length([First],L),
     current_governor(N, Lem),
     crea_argomenti(First, CatV-L, Valenze, Mods, RArgs, AllArgs, VArgs, AllAgg),
     !.


create_clause(N, Ibar, [fc-[Cong, Adj]|Args], AllArgs, Mods, Args, nil-nil, AllAgg, Neg):-
     crea_argomenti([Adj], CatV-L, [adj-compar], Mods, RArgs, AllArgs, Vargs, AllAgg),
     !.
 
create_clause(N, Ibar, [fp-Sentence], AllArgs, Mods, RArgs, VArgs, AllAgg, Neg):-
     remove(ibar-Ibar,Sentence, [First|Args]),
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     maximise_functions(Lem,Sentence,Valenzes, Valenzz),
     (
      on(Valenz,Valenzz), list(Valenz), Valenze=Valenz
      ; Valenze=Valenzz),
     nonvar(First),
     length([First|Args],L),
     current_governor(N, Lem),
     crea_argomenti([First|Args], CatV-L, Valenze, Mods, RArgs, AllArgs, Vargs, AllAgg),
     !.

create_clause(N, Ibar, [fp-[fint-[Sentence]]], AllArgs, Mods, RArgs, VArgs, AllAgg, Neg):-
     remove(ibar-Ibar,Sentence, [First|Args]),
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     maximise_functions(Lem,Sentence,Valenzes, Valenzz),
     (
      on(Valenz,Valenzz), list(Valenz), Valenze=Valenz
      ; Valenze=Valenzz),
     nonvar(First),
     length([First|Args],L),
     current_governor(N, Lem),
     crea_argomenti([First|Args], CatV-L, Valenze, Mods, RArgs, AllArgs, Vargs, AllAgg),
     !.

create_clause(N, Ibar, [fp-[fint-[fint-[Pron]|Sentence]]], AllArgs, Mods, RArgs, VArgs, AllAgg, Neg):-
     Sentence=[ibar-Ibr|Args],
     assign_funz_roles(Ibr,CatV,Lem,Valenzes,Neg),
     maximise_functions(Lem,Args,Valenzes, Valenzz),
     (
      on(Valenz,Valenzz), list(Valenz), Valenze=Valenz
      ; Valenze=Valenzz),
     nonvar(Args),
     length([First|Args],L),
     current_governor(N, Lem),
     crea_argomenti(Args, CatV-L, Valenz, Mods, RArgs, AllArgs, Vargs, AllAgg),
     !.

create_clause(N, [], [First|Args], AllArgs, Mods, RArgs, be-VArgs, be-AllAgg, Neg):-
     crea_valenze([First|Args], Valenz),
     length([First|Args],L),
     current_governor(N, be),
     crea_argomenti([First|Args], CatV-L, Valenz, Mods, RArgs, AllArgs, VArgs, AllAgg),
     !.

create_clause(N, [], [vcomp-VComp|Args], AllArgs, Mods, RArgs, VArgs, AllAgg, Neg):-
     assign_funz_roles(VComp,CatV,Lem,Valenza,Neg),
     maximise_functions(Lem,Args,Valenza, Valenzz),
%     estrai_una_valenza(Funz,Valenzes, Valenz),
     on(Valenz,Valenzz),
     appiattisci(Args, Argg),
     length(Argg,L),
     current_governor(N, Lem),
     crea_argomenti(Argg, CatV-L, Valenz, Mods, RArgs, AllArgs, VArgs, AllAgg),
     !.

create_clause(N, Ibar, [First|Args], AllArgs, Mods, RArgs, nil-nil, nil-nil, Neg):-
     appiattisci([First|Args], Argg),
     length(Argg,L),
     assert(governor(N,be)),
     crea_argomenti(Argg, CatV-L, [], Mods, RArgs, AllArgs, Vargs, AllAgg),
     !.

prenditesta(P,W, [W], [cat=Cat, gen=Gen, pers=Pers, num=Num]):-
    filter_pron_q(W, [cat=Cat, Pred, Type, Def, num=Num], Lem),
    !.

prenditesta(P,W, [W], [cat=Cat, gen=nil, pers=Pers, num=plur]):-
    filter_pron_q(W, [cat=Cat, Pred, Type, Def], Lem),
    !.

prenditesta(P,W, [W], [cat=Cat, gen=nil, pers=Pers, num=plur]):-
    filter_pron_q(W, [cat=Cat, Pred, Type, Def, sem=Num], Lem),
    !.

prenditesta(P,W, [W], [cat=Cat, gen=Gen, pers=Pers, num=Num]):-
    filter_pron(W, [cat=Cat, Pred, Type, Pers, num=Num, gen=Gen], Lem),
    !.

prenditesta(P,W, [W], [cat=Cat, gen=Gen, pers=Pers, num=Num]):-
    filter_pers(W, [cat=Cat, Pred, Pers, num=Num, gen=Gen], Lem),
    !.

prenditesta(P,W, [Lem], [cat=Cat, gen=Gen, pers=Pers, num=sing]):-
    filter_int(W, [cat=Cat, Pred, Case, sem=Sem], Lem),
    !.

prenditesta(P,W, [W], [cat=Cat, gen=Gen, pers=Per, num=Num]):-
    filter_pos_ag(W, [cat=Cat, Pred, pers=Per, num=Num, gen=Gen], Lem),
    !.

prenditesta(W, Pro, W1, [cat=Cat, gen=Gen, pers=Pers, num=Num]):-
    filter_dim_ag(Pro, [cat=Cat, Pred, Type, num=Num], Lem),
    remove(Pro, W, Ws),
    Ws=[W1|_],
    W1\=pron,
    !.

prenditesta(W, Pro, [Pro], [cat=Cat, gen=Gen, pers=Pers, num=Num]):-
    filter_dim_ag(Pro, [cat=Cat, Pred, Type, num=Num], Lem),
    remove(Pro, W, Ws),
    Ws=[W1|_],
    !.

prenditesta(W, Pro, [LowW], [cat=Cat, gen=Gen, pers=Pers, num=Num]):-
    filter_dim_ag(Pro, [cat=Cat, Pred, Type, num=Num], Lem),
    remove(Pron, W, Ws),
    Ws=[W1|_],
    spy_lower(Pron, LowW, 1),
    LowW=Pro,
    !.

prenditesta(P,W, [W], [cat=Cat, gen=Gen, pers=Pers, num=Num]):-
    filter_pers(W, [cat=Cat, Pred, Pers, num=Num, gen=Gen], Lem),
    !.

feats_prons(poss,SCat,[umano,animato,istituzione,legale]).
feats_prons(pers,SCat,[umano,animato,istituzione,legale]).
feats_prons(Cat,[],[umano,animato,istituzione,legale]).
feats_prons(Cat,SCat,SCat):-
    SCat\=[].
feats_prons(Cat,SCat,[]).

disassert(Word,Lab,Net):-
    abolish(dism/3),
    assert(dism(Word,Lab,Net)),!.

npchunk([], OutFile):-!.
npchunk([F-Tagged|Tags], OutFile):-
    chkqun(Tagged, Tokens),
    checkuniq(Tokens, FParse, Parse),
   writedis(OuFile, Tokens, FParse, PParse), 
   nl(OutFile),
   write(OutFile, 'SENTENCE NUMBER:   '),
   write(OutFile, F),
   nl(OutFile),
   writeseq(OutFile, Parse),
   nl(OutFile),
   nl(OutFile),
   collect_np(Parse, Feats, NFeats),
   npchunk(Tags, OutFile),
   !.

multiwords(Lemmas):-
   recover_mults(Lemma),
   sort(Lemma, Lemmas),
   !.

recover_mults(Lemma):-
   findall(Word-Lemm, (sw(Word-Cat-Lems),
   Lems\=[],
   on(C-Lemm-Feats, Lems),
   list(Lemm), Lemm\=[A]), Lemma),
   !.
create_arguments(Cl, Ind, Lem,Head,[], Valenzz, [], [], []):-!.
create_arguments(Cl, Ind, Lem,Head, Args, Valenza, VArgs, AllArgs, AllAggs):-
     extract_atomic_modifiers(Ind, Head, Args,Resto,Mods),
     assert_mods(Cl, Mods, Refs),
     N is Cl + 1,
     createarguments(N, Resto, Lem,Valenza, VArgs, AllArgs, AllAgg),
     append(Refs,AllAgg,AllAggs),
     !.

createarguments(N, Resto, Lem,Valenza, VArgs, [], RelClause):-
     Resto=[f2-_|_],
     find_govern(1,N,Govern,Lemma),
     ref_funcs(Fun, Ind, Lemma, First),
     build_relativeclause(Ind,Lemma,Resto,RelClause,Re),
    !.    
createarguments(N, Resto, Lemma,Valenza, VArgs, [], AllArgsAdjs):-
     Resto=[fp-_|Rest],
     remove(IBar,Rest,Args), 
     IBar=ibar-Verbs,
     create_clause_fac(SentNo, Verbs, Args, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
    !.    
createarguments(N, Resto, Lem,Valenza, VArgs, AllArgs, AllArgsAdjs):-
     Resto=[fs-FS|Rest],
     length(Resto,L),
     (Rest=[], Functs=FS, FS1=[];Rest\=[], Functs=Rest, FS1=FS),
     findall(IBar,remove(ibar-IBar,Rest,Args),Is), Is=[], 
     crea_argomenti(Functs,t-L, [xadj-_], Mods, Args, AllArgs, VArgs, AllAgg),
     (AllArgs\=[];AllAgg\=[]),
     assert_mods(N, Mods, RefMods),
     append(RefMods,AllAgg,Adjs),
     find_govern_adj(N,Govern,Head),
     assert_gr_adj(N, Head,FS1,OutAdjs,Mods1),
     append(Mods,Mods1,Modss),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
    !.    
createarguments(N, Resto, Lem,Valenza, VArgs, AllArgs, AllArgsAdjs):-
     Resto=[fc-FC|Rest],
     length(Resto,L),
     (Rest=[], Functs=FC, FC1=[];Rest\=[], Functs=Rest, FC1=FC),
     findall(IBar,remove(ibar-IBar,Rest,Args),Is), Is=[], 
     crea_argomenti(Functs,t-L, [xadj-_], Mods, Args, AllArgs, VArgs, AllAgg),
     (AllArgs\=[];AllAgg\=[]),
     assert_mods(N, Mods, RefMods),
     append(RefMods,AllAgg,Adjs),
     find_govern_adj(N,Govern,Head),
     assert_gr_adj(N, Head,FC1,OutAdjs,Mods1),
     append(Mods,Mods1,Modss),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
    !.    

createarguments(N, Resto, Lemma,Valenza, VArgs, AllArgss, AllArgsAdjs):-
     (remove(fac-Body1, Resto, Rest);
      remove(I-[fac-Body1], Resto, Rest), integer(I)),
     remove(fac-Cong, Body1, ClauseRest),
     extract_clause(IBars, ClauseRest, Clause, IBar, RestFuncs, RestIbar,Adjs),
     SentNo is N + 1,
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss2, AllArgss,AllAggss],
     assert_gr_adj(N, Lem,Adjs,OutAdjs,Mods1),
     (Rest\=nil, append(Rest, RestFuncs, RestF); RestF=RestFuncs),
     (RestF=[], Modss=Mods;
      RestF\=[],crea_argomenti(RestF,t-L, Valenza, Mod, Args, AllArgs, VArgss, AllAgg),
      (AllArgs\=[];AllAgg\=[]),
       append(Mods,Mod,Modss)),
     append(Modss,Mods1,Modss2),
     assert_mods(N, Modss, RefMods),
     append(AllArgs,ArgsAdjs,AllArgss),
     append(RefMods,AllAgg,AllAggs),
     append(OutAdjs,AllAggs,AllAggss),
     !.     

createarguments(N, Resto, Lem,Valenza, VArgs, AllArgss, Clauses):-
     (remove(fac-Body1, Resto, Rest);
      remove(I-[fac-Body1], Resto, Rest), integer(I)),
     remove(fac-Cong, Body1, ClauseRest),
      N1 is N + 1,
      splitsentences(N1, [], Body1, Clauses),
      crea_argomenti(ClauseRest,t-L, Valenza, Mod, Args, AllArgs, VArgss, AllAgg),
      (AllArgs\=[];AllAgg\=[]),
     assert_mods(N, Mods, RefMods),
     append(RefMods,AllAgg,AllAggs),
     append(AllAggs,AllArgs,AllArgss),
     !.     
createarguments(N, Resto, Lem,Valenze, VArgs, AllArgs, AllArgsAdjs):-
     is_list(Resto),
     length(Resto,L),
     assess_relarguments(Valenze,Lem,Resto,NewArgs,Vale),
     crea_argomenti(NewArgs,t-L, Vale, Mods, Args, AllArgs, VArgs, AllAgg),
     (AllArgs\=[];AllAgg\=[]),
     assert_mods(N, Mods, RefMods),
     append(RefMods,AllAgg,AllAggs),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, AllArgs,AllAggs],     
     !.     

createarguments(N, Resto, Lem, Valenza, VArgs, [], []).

assess_relarguments(Valenze,Lem,Args,NewArgs,Valenz):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(obj-Arg,Args,MidArgs),
      append([xcomp-Arg],MidArgs,NewArgs),
      !.

assess_relarguments(Valenz,Lem,Args,Args,Valenz).

find_govern_adj(N,Govern,Head):-
     dgrs(N0,DepGr),
     (DepGr=..[Fun,Sem,Govern-_,Head];
      DepGr=..[Fun,Govern-_,Head,Lemma];
      DepGr=..[Fun,Govern-_,Head], Fun\=det),
     Govern\='_', \+ grammw(Govern,K).

find_govern_adj(2,N,Govern,Head):-
    dgrs(No,DepGr1),
    DepGr1=..[Fun,Ind,Govern,Head], 
    term_to_atom(F-R,Fun),
    (F=obj;F=subj;F=iobj),
    !.
find_govern_adj(2,N,Govern,Head):-
    dgrs(No,DepGr1),
    DepGr1=..[Fun,Govern,Head,obj],
    term_to_atom(F-R,Fun),
    !.
find_govern_adj(2,N,Govern,Head):-
    dgrs(No,DepGr1),
    DepGr1=..[Fun,Ind,Govern,Sem,Head],
    term_to_atom(F-R,Fun),
    !.
find_govern(1,N,Govern,Head):-
     findall(Govern-Head,
      (dgrs(N,DepGr),
      (DepGr=..[Fun,Govern-_,Head,Lemma];
       DepGr=..[Fun,Govern-_,Head]),
           term_to_atom(F-R,Fun),
          F=subj), Governs),
    Governs\=[], 
% reverse(Governs,RevGov),
    on(Govern-Head,Governs),
     Govern\='_',
     (Govern\=be
     ; 
     Govern=be,Head\=it-_),
    !.
find_govern(1,N,Govern,Head):-
    dgrs(No,DepGr1),
    DepGr1=..[Fun,Govern,Head,obj],
    term_to_atom(F-R,Fun),
    !.

find_govern(2,N,Govern,Head):-
     dgrs(N,DepGr),
     (DepGr=..[Fun,Sem,Govern-_,Head,Lemma];
      DepGr=..[Fun,Govern-_,Head,Lemma];
      DepGr=..[Fun,Govern-_,Head]),
     term_to_atom(F-R,Fun),
     (F=arg_mod;F=iobj,R=benef;F=subj;F=obj),
     Govern\='_',
    !.

find_govern(2,N,Govern,Head):-
    dgrs(No,DepGr1),
    DepGr1=..[Fun,Ind,Govern,Head], 
    term_to_atom(F-R,Fun),
    (F=obj;F=subj;F=iobj),
    !.
find_govern(2,N,Govern,Head):-
    dgrs(No,DepGr1),
    DepGr1=..[Fun,Ind,Govern,Sem,Head],
    term_to_atom(F-R,Fun),
    !.

filter_roles(agente,agent).
filter_roles(tema,theme).
filter_roles(tema_aff,theme_aff).
filter_roles(tema_nonaff,theme_unaff).
filter_roles(tema_bound,theme_bound).
filter_roles(temporale,temporal).
filter_roles(esperiente,experiencer).
filter_roles(locativo,locative).
filter_roles(comitativo,comitative).
filter_roles(materia,matter).
filter_roles(Role,Role):-nonvar(Role).
filter_roles(Role,prop):-var(Role).
build_dates(savv-Avv,Obl, [sn-[Num-num-_]|Rest], [obl-FunctsO]):-
   Rest=[sa-[Year-grad-_]|NewRest],
   Avv=[Month-avv-_],
   nt(Month),
   mcon(Month,'_',Nm),
   mcon(Nm,Num,Nmn),
   mcon(Nmn,'_',Nmd),
   mcon(Nmd,Year,Date),
   Obl=[obl-Ob],
   append(Ob,[Date-num-_],FunctsO),
   !.

build_dates(savv-Avv,Obl, [Cost-Obj], [obl-FunctsO]):-
   Avv=[Head-_-_],
   nt(Head),
   Obj=[Date-num-_],
   Obl=[obl-Ob],
   append(Ob, [mod-Obj], FunctsO),
   !.
build_dates(savv-Avv,Obl, [Cost-Obj], [obl-FunctsO]):-
   Avv=[Head-_-_],
   nt(Head),
   Obj=[Date-num-_|_],
   Obl=[obl-Ob],
   append(Ob, [mod-Obj], FunctsO),
   !.

build_dates(First,Ogg, FunctsO, FunctsOut):-
   append(Ogg, FunctsO, FunctsOut),
   !.

interpr_role(where, cond).
interpr_role(if, cond).
interpr_role(while, motiv).
interpr_role(whereas, motiv).
interpr_role(in_relation_to, motiv).
interpr_role(until, cond).
interpr_role(when, cond).
interpr_role(except, cond).
interpr_role(unless, cond).
interpr_role(provided_that, cond).

subord_role(Subord, Role) :-
    genre(legal),
    interpr_role(Subord, Role), !.

subord_role(whether, hypoth).
subord_role(so, result).
subord_role(so_that, result).
subord_role(although, advers).
subord_role(but, advers).
subord_role(if, hypoth).
subord_role(as_if, hypoth).
subord_role(nevertheless, conc).
subord_role(because, cause).
subord_role(wherever, cond).
subord_role(whenever, cond).
subord_role(unless, cond).
subord_role(since, cause).
subord_role(while, temp_coinc).
subord_role(as, temp_coinc).
subord_role(quando, temp_coinc).
subord_role(when, temp_coinc).
subord_role(poi, temp_seq).
subord_role(prima, temp_prec).
subord_role(before, temp_prec).
subord_role(then, temp_seq).
subord_role(and_then, temp_seq).
subord_role(afterwards, temp_seq).
subord_role(per, purpose).
subord_role(in_so_far_as, hypoth).
subord_role(in_order_to, purpose).
subord_role(to_the_extent_that, hypoth).
subord_role(even_if, conc).
subord_role(even_though, conc).
subord_role(however, conc).
subord_role(though, conc).
subord_role(as_yet, conc).
subord_role(nonetheless, conc).
subord_role(K, Role):-
     spy_lower(K,Low,1),
     subord_role(Low, Role),
     !.
subord_role(K, motiv).

checkcosts(Sorted):-
      Sorted=savv;Sorted=sv5;Sorted=vcomp;Sorted=sv3;Sorted=sp;Sorted=spda;Sorted=sn;Sorted=sa,!.

checkcostante(Sorted):-
      Sorted=[savv-_];Sorted=[sv5-_];Sorted=[vcomp-_];Sorted=[sv3-_];Sorted=[sp-_];Sorted=[spda-_],!.

checkcostantes(Sorted,Cos):-
 findall(Cos,(
     Sorted=[savv-C|Rest], Cos=savv-C;
     Sorted=[vcomp-C|Rest], Cos=vcomp-C;
     Sorted=[sv5-C|Rest], Cos=sv5-C;
     Sorted=[sv3-C|Rest], Cos=sv3-C;
     Sorted=[sa-C|Rest], Cos=sa-C;
     Sorted=[sp-C|Rest], Cos=sp-C;
     Sorted=[spda-C|Rest], Cos=spda-C), Coss),
     Coss\=[],
     sort(Coss,Cos1),
     length(Sorted,L), 
     length(Cos1,L1), 
     (L=<2
     ;
     Res is L1 - L,
     Res=<1),
     !.

checkcostante1(Sorted):-
     Sorted=[_-[_-par-_]];Sorted=[_-[_-punt-_]];Sorted=[dirsp-[_-dirs-_]];
       Sorted=[fp-[_-dots-_]];Sorted=[fp-[_-par-_]];Sorted=[fp-[_-punt-_]],!.

checkcostante2(Cost):-
    Cost=f-[_-par-_];Cost=f-[_-punt-_];Cost=dirsp-[_-dirs-_];
    Cost=fp-[_-dots-_];Cost=fp-[_-par-_];Cost=fp-[_-punt-_],!.

notcostpunct(Cost):-
    Cost\=[_-par-_],Cost\=[_-punt-_],Cost\=[_-dirs-_],Cost\=[_-dots-_],
    Cost\=[A], Cost\=F-Sent,!.

mapftoc(NoFr, Frase, Disambs, Tags, [], Scored, And, [],[]):-!.
mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, And, [Costs|Sorted],Clauses):-
     Sorted\=[],
     checkcostante(Sorted),
    Costs=I-[F-Cost], integer(I),
    append(Sorted,Cost,Claus),
    mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, And, [I-[F-Claus]],Clauses),
    !.

mapftoc(NoFr, Frase, Disambs, Tags, [Ibar|Ibars], Scored, And, [Costs|Sorted],[Clause|Clauses]):-
     Sorted\=[],
     checkcostantes(Sorted,Cos),
     Costs=I-[F-Cost], integer(I),
    \+ on(I1-_,Sorted), integer(I1),
     append([F-Cost],Sorted,Claus),
     mapftoc(NoFr, Frase, Disambs, Tags, Ibar, Scored, And, [I-[F-Claus]],Clause),
    !.

mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, An, [Costs|Sorted],[OutAdjs,ModsAdjs]):-
     Sorted\=[],
    checkcostante1(Sorted),
    is_list(Sorted),
     length(Sorted,L), L=<2,
    Costs\=[],
     (Costs=savv-_;Costs=sp-_;Costs=spda-_),
     governor(N, Govern),
     Govern\=nil, 
     (Govern=Lem-Id, Gov=Lem;Gov=Govern),
    Ibar=[ibar-[Gov-v-_]],
    append(Ibar,[Costs|Sorted], Cost),
    parse_func(Costs, FunctsOut),
    assert_gr_adj(SentNo,Gov,FunctsOut,OutAdjs,ModsAdjs),
    writefuncscost(NoFr,Frase, FunctsOut,Cost),
    !.

mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, An, [Costs|Sorted],Clauses):-
     Sorted\=[],
     Sorted=[N-[F-FC|Rest]],
     nonvar(FC),
     FC=[fc-C, ibar-Ibar|Clause],
     C=[_-cong-_],
     Costs=N1-Sent,
     remove(subj-SN,Sent,_),
     append([subj-SN], [ibar-Ibar|Clause], Claus),
     append([fc-C], Claus, Cl),
     NewCl=[N-[F-Cl]|Costs],
     mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, An, NewCl, Clauses),
     !.

mapftoc(NoFr, Frase, Disambs, Tags, [Ibar|Ibars], Scored, An, [Costs|Sorted],[Clause|Clauses]):-
    getclause(Costs, Cost, Ncl, F, And),
    (
     governor(N, Govern)
     ;  Govern=nil
     ),
    abolish_cl,
    (And\=[],
%    And\=fc-C, 
      append([And], Cost, Ccost); And=[], Ccost=Cost; And=fc-C, Ccost=Cost),
    shallow_parsing(NoFr,Disambs, Tags, Ibar, Scored, Ccost, FunctsOut,Clause),
    writefuncscost(NoFr,Frase, FunctsOut,Ccost),
    (An=[], Ann=And; 
     And=[], Ann=An;
     An\=[], append([An],[And],Ann)),
    check_clauses_sem(F,Ncl, Govern,Clause, Ann),
    mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, And, Sorted,Clauses),
    !.

mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, An, [Costs|Sorted],Clause):-
     Sorted\=[],
    on(ibar-_,Sorted),
    Costs=sv3-_,
    abolish_cl,
    shallow_parsing(NoFr,Disambs, Tags, Ibars, Scored, [Costs|Sorted], FunctsOut,Clause),
    writefuncscost(NoFr,Frase, FunctsOut,[Costs|Sorted]),
    check_clauses_sem(F,Ncl, Govern,Clause, An),
    !.
mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, [Cost|Sorted],Clauses):-
    checkcostante2(Cost),
    mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, Cost, Sorted,Clauses),
    !.

mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, An, [Cost|Sorted],Clauses):-
    (Cost=dirsp-[A|R];Cost=fp-[A|R]),
    length([A|R],L), L<3,
    (
     governor(N, Govern)
     ;  Govern=nil
     ),
    cl(Cl),
    assert_cl,
    cl(Cl1),
    asserta(funcs(sem, Cl-Cl1, [A], Cost)),
    remove(N-Clause,Sorted, Rests),
    integer(N),
    mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, Sorted,Clauses),
    !.
mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, An, [Cost],Clauses):-
    (Cost=fs-[A],F=fs;Cost=fc-[A],F=fc),
    (
     governor(N, Govern)
     ;  Govern=nil
     ),
    cl(Cl),
    (Cl1 is Cl - 1,
     funcs(ibar, Cl1, Gov, Ibar),
     asserta(funcs(sem, Cl1-Cl, [A], Cost))
     ;
     asserta(funcs(sem, 0-Cl, [A], Cost))
     ),
    check_clauses_sem(F,Cl1, Gov,Clause, Cost),
    !.
mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, [Cost|Sorted],Clauses):-
    notcostpunct(Cost),
    mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, [cp-[Cost|Sorted]],Clauses),
    !.
mapftoc(NoFr,Frase, Disambs, Tags, [Ibar|Ibars], Scored, And, [Cost|Sorted],[Clause|Clauses]):-
    remove(N-Claus,Sorted, Rests),
    integer(N),
    append([Cost],Rests, Rest),
    getclause(Claus, SCost, Ncl, F,And),
    (
     governor(N, Govern)
     ;  Govern=nil
     ),
    abolish_cl,
    shallow_parsing(NoFr,Disambs, Tags, Ibar, Scored, SCost, FunctsOut,Clause),
    writefuncscost(NoFr,Frase, FunctsOut,Cost),
    check_clauses_sem(F,Ncl, Govern,Clause, An),
    mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, And, Rest,Clauses),
    !.

mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, [Cost|Sorted],Clauses):-
    Cost=F-Res,
     ((F=fac;F=fs;F=fc;F=dirsp), F1=F
      ;
       F\=fac,F\=fs,F\=fc,F\=dirsp,
       is_list(Sorted),
       length(Sorted,L), L=<3, F1=cp),
     Sorted\=[],
     findall(I, on(ibar-I,Sorted), Is), Is=[],
    remove(N-Clause,Sorted, Rests),
    integer(N),
    checkappend_adjs(NoFr,Frase, Disambs, Tags, Ibars, Scored, F, Cost, Sorted, Clauses),
    !.

mapftoc(NoFr,Frase, Disambs, Tags, [Ibar|Ibars], Scored, And, [Cost|Sorted],[Clause|Clauses]):-
    remove(N-Claus,Sorted, Rests),
    integer(N),
    append([Cost],Rests, Rest),
    getclause(Claus, SCost, Ncl, F,And),
    (
     governor(N, Govern)
     ;  Govern=nil
     ),
    abolish_cl,
    shallow_parsing(NoFr,Disambs, Tags, Ibar, Scored, SCost, FunctsOut,Clause),
    writefuncscost(NoFr,Frase, FunctsOut,Cost),
    check_clauses_sem(F,Ncl, Govern,Clause, An),
    mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, And, Rest,Clauses),
    !.

mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, Sorted,Clause):-
    Sorted\=[],
    abolish_cl,
    shallow_parsing(NoFr,Disambs, Tags, Ibars, Scored, Sorted, FunctsOut,Clause),
    FunctsOut\=[],Clause\=[],
    writefuncscost(NoFr,Frase, FunctsOut,Sorted),
    check_clauses_sem(F,Ncl, Govern,Clause, An),
    !.
mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, [Cost|Sorted],Clauses):-
    Cost=F-Res,
     ((F=fac;F=fs;F=fc;F=dirsp), F1=F
      ;
       F\=fac,F\=fs,F\=fc,F\=dirsp,
       is_list(Sorted),
       length(Sorted,L), 2=<L, F1=cp),
     Sorted\=[],
     findall(I, on(ibar-I,Sorted), Is), Is=[],
    remove(N-Clause,Sorted, Rests),
    (integer(N),
     checkappend_adjs(NoFr,Frase, Disambs, Tags, Ibars, Scored, F, Cost, Sorted, Clauses)
     ;
     mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, Res, Sorted,Clauses)),
    !.

mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, [Cost|Sorted],Clauses):-
    mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, Sorted,Clauses),
    !.

divide_up_clauses(DClauses):-
     extractfunctions(FunctsOu),
     collapse_vcomps(FunctsOu, FunctsOut),
     extract_ibars(Ibars,Heads),
     extract_sems(Sems),
/*     append(FunctsOut, Ibars, Alls),
     append(Alls, Sems, List),
     reverse(List, [CP|RevList]),
     sort(RevList, SortList),
     append(SortList, [CP], SortAll),
*/     
     reverse(Sems, [CP|RevList]),
     sort(RevList, SortList),
     createall_dclauses(1, SortList, Ibars, FunctsOut, DClauses),
     !.

collapse_vcomps([], []):-!.
collapse_vcomps([N-vcomp-Funct|SortList], FunctsOut):-
     SortList=[N-Fun-Func|SortL],     
     collapse_vcomps(SortL, FunctsOu),
     append(Funct, Func, VFunct),
     append([N-vcomp-VFunct], FunctsOu, FunctsOut),
     !.

collapse_vcomps([N-Fun-Funct|SortList], [N-Fun-Funct|FunctsOut]):-
     collapse_vcomps(SortList, FunctsOut),
     !.


count_args(N):-
   findall(All, funcs(Func, K, Head, [All]), 
                    Heads),
      length(Heads, N),!.

evaluate_allclauses(IBars, DClauses, L1):-
     is_list(IBars),
     length(IBars, L),
     evaluate_clauses(0, IBars, DClauses, N),
%     count_args(N1),
     (L=N, L1 = N; L1=L-N),
     !.
% evaluate_allclauses(IBars, DClauses, nil).

evaluate_clauses(N,IBars, [], N):-!.
evaluate_clauses(N1,[], [D-DClause|DClauses], H):-
    integer(D),
    N2 is N1 + 1,
    evaluate_clauses(N2, IBars, DClauses, H),!.

evaluate_clauses(N1,[Ibar|IBars], [[D-DClause]|DClauses], H):-
%    evaluate_clause(IBar, DClause, N),
    integer(D),
    N2 is N1 + 1,
    evaluate_clauses(N2, IBars, DClauses, H),!.

evaluate_clauses(N1,[Ibar|IBars], [D-DClause|DClauses], H):-
%    evaluate_clause(IBar, DClause, N),
    integer(D),
    N2 is N1 + 1,
    evaluate_clauses(N2, IBars, DClauses, H),!.
evaluate_clauses(N,IBars, [[]|DClauses], H):-
    evaluate_clauses(N, IBars, DClauses, H),!.
evaluate_clauses(N,IBars, [DClause|DClauses], H):-
    N2 is N + 1,
    evaluate_clauses(N2, IBars, DClauses, H),!.

evaluate_clause(IBar, C-DClause, N):-
     refargs(DClause,Args,Ibar),
     Args=[First|Rest],
     length(Rest, N),!.


check_ibars_structs(N, N1, Clauses, DClauses, Ibars, NClauses):-
    appiattisci(DClauses, AClauses),
    (Clauses=[],
     append_ibars(Ibars, [N-AClauses], NClauses)
     ;
     Clauses\=[], 
    appiattisci(Clauses, BClauses),
    append_ibars(Ibars, [N-AClauses, N1-BClauses], NClauses)),
    !.

check_ibars_structs2(N, N1, [], [], Ibars, []):-!.
check_ibars_structs2(N, N1, Clauses, DClauses, Ibars, NClauses):-
    appiattisci(DClauses, AClauses),
    (Clauses=[],
     append_ibars(Ibars, [N-AClauses], NClauses)
     ;
     Clauses\=[],
     (Clauses=[A], 
      appiattisci(Clauses, BClauses),
      append_ibars(Ibars, [N-AClauses, N1-BClauses], NClauses)
       ;
       Clauses=[A|B], 
       list(A),
      appiattisci(A, BCla),
      appiattisci(B, BClaus),
      N2 is N1 + 1,
      append_ibars(Ibars, [N-AClauses, N1-BCla, N2-BClaus], NClauses)
       ;
       Clauses=[A|B], 
       \+ list(A),
       append_ibars(Ibars, [N-AClauses, N1-Clauses], NClauses))
        ),
      !.

append_ibars([], [], []):-!.
append_ibars(Ibars, [], []):-!.
append_ibars(Ibars, [N-[]|BClauses], NClauses):-
        append_ibars(Ibars, BClauses, NClauses),
        !.

append_ibars(Ibars, [N-AClauses, BClauses|[]], [N-Functs]):-
        AClauses=[Fun-AFuncts|_],
        areverse(AFuncts, A),
        nonvar(A),
        A='''-'''-par-sn,
        BClauses=N1-BFuncts,
        append(AClauses, BFuncts, Functs),
        !.
append_ibars(Ibars, [N-AClauses|BClauses], [AClauses|NClauses]):-
        AClauses=[N1-Fun-Sem|List],
        N\=N1,
        append_ibars(RIbars, BClauses, NClauses),
        !.
append_ibars(Ibars, [N-AClauses|BClauses], [AClauses|NClauses]):-
        AClauses=[N1-Funcs|List],
        N\=N1,
        append_ibars(RIbars, BClauses, NClauses),
        !.
append_ibars(Ibars, [N-AClauses, BClauses], NClauses):-
        BClauses=N1-Functs,
        N\=N1,
        append(AClauses, [BClauses], NClauses),
        !.
append_ibars(Ibars, [N-AClauses|BClauses], [AClauses|NClauses]):-
        append_ibars(Ibars, BClauses, NClauses),
        !.

/*
append_ibars(Ibars, [N-AClauses|BClauses], [N-[Ibar, AClauses]|NClauses]):-
        remove(N-ibar-Ibar, Ibars, RIbars),
        append_ibars(RIbars, BClauses, NClauses),
        !.

append_ibars(Ibars, [N-AClauses|BClauses], [N-[Ibar, AClauses]|NClauses]):-
        AClauses=[N1-Fun-Sem|List],
        remove(N1-ibar-Ibar, Ibars, RIbars),
        append_ibars(RIbars, BClauses, NClauses),
        !.
append_ibars(Ibars, [N-AClauses|BClauses], [N-[Ibar, AClauses]|NClauses]):-
        AClauses=[N1-Funcs|List],
        remove(N1-ibar-Ibar, Ibars, RIbars),
        append_ibars(RIbars, BClauses, NClauses),
        !.

append_ibars(Ibars, [N-AClauses|[]], [N-[Ibar, AClauses]|NClauses]):-
        remove(N1-ibar-Ibar, Ibars, RIbars),
        append_ibars(RIbars, BClauses, NClauses),
        !.

append_ibars(Ibars, [N-AClauses, BClauses], [N-[Ibar, NClauses]]):-
        BClauses=N1-Functs,
        remove(N2-ibar-Ibar, Ibars, RIbars),
        append(AClauses, [BClauses], NClauses),
        RIbars=[],
        !.

append_ibars(Ibars, [N-AClauses, BClauses|Rest], [N-[Ibar, Functs]|NClauses]):-
        AClauses=[Fun-AFuncts|_],
        areverse(AFuncts, A),
        nonvar(A),
        A='''-'''-par-sn,
        remove(N2-ibar-Ibar, Ibars, RIbars),
        BClauses=N1-BFuncts,
        append(AClauses, BFuncts, Functs),
        append_ibars(RIbars, [N3-Rest], NClauses),
        !.

append_ibars(Ibars, [N-AClauses, BClauses|Rest], [N-[Ibar, Functs]|NClauses]):-
        BClauses=N1-Functs,
        remove(N2-ibar-Ibar, Ibars, RIbars),
        Rest=[N3-RFuncts],
        append(AClauses, RFuncts, CClauses),
        append_ibars(RIbars, [N3-CClauses], NClauses),
        !.
append_ibars([], AClauses, [1-[1-ibar-be, AClauses]]):-!.

append_ibars(Ibars, [N-AClauses|[]], [AClauses|NClauses]):-
        remove(N2-ibar-Ibar, Ibars, RIbars),
        append_ibars(RIbars, BClauses, NClauses),
        !.
append_ibars([], AClauses, [1-[1-ibar-be, AClauses]]):-!.

append_ibars([N-ibar-Ibar], [N-AClauses], [N-[Ibar, AClauses]]):-!.
*/


createall_dclauses(N, [], Ibars, [], []):-!.
createall_dclauses(N, [Nn-N1-['''.'''-punto-cp]], Ibars, [],  []):-!.

createall_dclauses(N, [N-N1-[_-_-fp]|List], Ibars, Args, [N-NClauses]):-
    createallclauses(N, Args, FunctsOut, DClauses),
    createall_dclauses(N, List, Ibars, FunctsOut, Clauses),
    (DClauses\=[],     
    check_ibars_structs(N, N1, Clauses, DClauses, Ibars, NClauses)
    ;
    DClauses=[],
    NClauses=Clauses),
    !.

createall_dclauses(N, [N-N1-Sem|List], Ibars, Args, [N-N1-Sem|NClauses]):-
    integer(N1),
    createallclauses(N1, Args, FunctsOut, DClauses),
    (DClauses\=[],     
     createall_dclauses(N1, List, Ibars, FunctsOut, Clauses)
    ;
     DClauses=[],
    createall_dclauses(N1, FunctsOut, Ibars, Rest, Clauses)),
    appiattisci(DClauses, AClauses),
    (Clauses=[],
     append_ibars(Ibars, [N-AClauses], NClauses)
     ;
     Clauses\=[], 
    appiattisci(Clauses, BClauses),
    append_ibars(Ibars, [N1-AClauses, N2-BClauses], NClauses)),
%    append([N1-AClauses], [N2-BClauses], NClauses)),
    !.

createall_dclauses(N, List, [N-ibar-Ibar|Ibars], Args, [N-ibar-Ibar|NClauses]):-
    createallclauses(N, Args, FunctsOut, DClauses),
    N1 is N + 1,
    (DClauses\=[],     
     createall_dclauses(N1, List, Ibars, FunctsOut, Clauses),
     BClause=DClauses
    ;
    DClauses=[],
    createallclauses(N1, FunctsOut, Rest, DClause),
    createall_dclauses(N2, List, Ibars, Rest, Clauses),
     BClause=DClause),
    check_ibars_structs2(N, N1, BClause, Clauses, Ibars, NClauses),
    !.

createall_dclauses(N, [N1-N2-Sem|List], Ibars, Args, NClauses):-
    integer(N2),
    createallclauses(N, Args, FunctsOut, DClauses),
    (DClauses\=[],     
     createall_dclauses(N, [N1-N2-Sem|List], Ibars, FunctsOut, Clauses), N3=N2
    ;
    DClauses=[],
    N3 is N + 1,
%    createallclauses(N, Args, FunctsOut, DClause),
     createall_dclauses(N3, [N1-N2-Sem|List], Ibars, FunctsOut, Clauses)),
     check_ibars_structs2(N, N3, Clauses, DClauses, Ibars, NClauses),
    !.

createall_dclauses(1, [], Ibars, Args, NClauses):-
    createallclauses(N1, Args, FunctsOut, DClauses),
    createall_dclauses(N1, FunctsOut, Ibars, Rest, Clauses),
    check_ibars_structs(1, N1, Clauses, DClauses, Ibars, NClauses),
    !.

createall_dclauses(N, Args, Ibars, Rest, [FFuncts|DClauses]):-
    nonvar(N),
    createallclauses(N1, Args, FunctsOut, Functs),
    (Args=[], FFuncts=[],
     createall_dclauses(N, Rest, Ibars, FF, DClauses)
     ;      
     N1 =< N, FFuncts=Functs,
     createall_dclauses(N, FunctsOut, Ibars, Rest, DClauses)
     ;
     N < N1, FFuncts=Functs,
     createall_dclauses(N1, FunctsOut, Ibars, Rest, DClauses)), 
    !.

createall_dclauses(N, Args, Ibars, Rest, DClauses):-
    var(N),
    Args=[N-Fun-Funct|_],
    createall_dclauses(N, Args, Ibars, Rest, DClauses),
    !.

createall_dclauses(N, Args, Ibars, Rest, DClauses):-
    nonvar(N),
    N1 is N +1,
    createall_dclauses(N1, Args, Ibars, Rest, DClauses),
    !.

createallclauses(N, [], [], []):-!.
createallclauses(N, [N-ibar-Funct|SortList], Rest, [[ibar-Funct]|DClauses]):-
    createallclauses(N, SortList, Rest, DClauses),!.
createallclauses(N, [N-voice-Funct|SortList], Rest, [[voice-Funct]|DClauses]):-
    createallclauses(N, SortList, Rest, DClauses),!.

createallclauses(N, [N-Fun-Funct|SortList], Rest, [Funct|DClauses]):-
    \+ integer(Fun),
    createallclauses(N, SortList, Rest, DClauses),!.

createallclauses(N, [Nn-N1-['''.'''-punto-cp]], [],  []):-!.

createallclauses(N, [N1-Fun-Funct|SortList], [N1-Fun-Funct|SortList], []):-
    \+ integer(Fun),
%    N1 is N +1,
    !.

createallclauses(N, [N1-N2-[A-B-fp]|SortList], Rest, [N1-N2-[A-B-fp]|NClauses]):-
    integer(N2),
    createallclauses(N1, SortList, Rest, NClauses),
    !.
createallclauses(N, [N1-N2-Sem|SortList], [N1-N2-Sem|SortList], [N-N1-Sem]):-
    integer(N2),
%    createallclauses(N1, SortList, FunctsOut, NClauses),
    !.
createallclauses(N, [N1-List|SortList], [N1-N2-Sem|SortList], [N-N1-Sem]):-
    createallclauses(N1, List, FunctsOut, NClauses),
    createallclauses(N, SortList, FunctsO, NClaus),
    !.

checkrelsprops([], Asserts, RelIds):-!.
checkrelsprops([Cl-[Rel-Inds-_]|Rels], Asserts, RelIds):-
    recoverinds(Cl, Rel-Inds, RelIds, Asserts),
    checkrelsprops(Rels, Asserts, RelIds),
    !.

recoverinds(Cl1, Rel-[], Ids, Asserts):-!.
recoverinds(Cl, Rel-[Role/Ind|Inds], Ids, Asserts):-
     nonvar(Ind),
     stringof(Lis,Ind),
     Lis=[c,l|_],
     on(Assert,Asserts),
     Assert=asserisci_rel(NoFr,SnX,fact(Rel,Args,Pol,univ, univ), Cl),
     on(Cl-Id,Ids),
     Fact=..[fact,Id,Rel,Args,Pol,univ, univ],
     retract(Fact),
     on(Assert1,Asserts),
     Assert1=asserisci_rel(NoFr,SnX,fact(Rel1,Argss,Pol1,univ, univ), Cl1),
     Ind=Cl1,
     on(Cl1-Id1,Ids),
     append(Args,[Role:Id1],Args1),
     Fact1=..[fact,Id,Rel,Args1,Pol,univ, univ],
     assert(Fact1),
     recoverinds(Cl, Rel-Inds, Ids, Asserts),!.
recoverinds(Cl1, Rel-[Role/Ind|Inds], Ids, Asserts):-
     recoverinds(Cl1, Rel-Inds, Ids, Asserts),!.

do_assertrels(AllRefs,SentNo, [], NewAggs, Control, Inds, []):-!.
do_assertrels(AllRefs,SentNo, Rels, NewAggs, Control, Inds, RelIds):-
   reverse(NewAggs, RNewAggs),
   assertrels(AllRefs,SentNo, Rels, NewAggs, Control, Asserts, Inds),
   reverse(Asserts, RAsserts),
   doasserts(SentNo, Rels, RAsserts, NewAggs, Control, RelIds),
   checkrelsprops(Rels, Asserts, RelIds),
   !.
do_assertrels(AllRefs,SentNo, [Rel|Rels], NewAggs, Control, Inds, RelIds):-
   do_assertrels(AllRefs,SentNo, Rels, NewAggs, Control, Inds, RelIds),
   !.

doasserts(NoFr, Rels, [[]|Asserts], Aggs, Control, Ids):-
    doasserts(NoFr, Rels, Asserts, Aggs, Control, Ids),
    !.
doasserts(NoFr, [Cl-[nil-nil-_]|Rels], [], [nil-nil|Aggs], Control, Ids):-
    doasserts(NoFr, Rels, Asserts, Aggs, Control, Ids),
    !.
doasserts(NoFr, [nil-nil-_|Rels], [], [nil-nil|Aggs], Control, Ids):-
    doasserts(NoFr, Rels, Asserts, Aggs, Control, Ids),
    !.
doasserts(NoFr, [Cl-Rell|Rels], [], [Agg|NewAggs], Control, [Cl-Id|Ids]):-
    (   
     Rell=[R-Roles-Pol]
       ;
     Rell=R-Roles-Pol),
    nonvar(Agg),
    asserisci_rel(NoFr,SnX,fact(R,[],Pol,univ, univ), Cl),
    build_aggs(NoFr, Agg, Rel, Id),
    doasserts(NoFr, Rels, Asserts, NewAggs, Control, Ids),
    !.

doasserts(NoFr, Rels, [], [Agg|NewAggs], Control, [1-Id|Ids]):-
    (   
     Rels=[R-Roles-Pol]
       ;
     Rels=R-Roles-Pol),
    nonvar(Agg),
    asserisci_rel(NoFr,SnX,fact(R,[],Pol,univ, univ), 1),
    build_aggs(NoFr, Agg, Rel, Id),
    doasserts(NoFr, Rels, Asserts, NewAggs, Control, Ids),
    !.

doasserts(SentNo, Rels, [], NewAggs, Control, []):-!.
doasserts(SentNo, Rels, [[]], NewAggs, Control, []):-!.

doasserts(SentNo, Rels, [Assert|Asserts], [Agg|NewAggs], Control, [Cl-Id|Ids]):-
    Assert=asserisci_rel(NoFr,SnX,fact(Rel,Inds,Pol,univ, univ), Cl),
    asserisci_rel(NoFr,SnX,fact(Rel,Inds,Pol,univ, univ), Id),
    build_aggs(NoFr, Agg, Rel, Id),
    doasserts(SentNo, Rels, Asserts, NewAggs, Control, Ids),
    !.

doasserts(SentNo, Rels, [Assert|Asserts], [], Control, [Cl-Id|Ids]):-
    Assert=asserisci_rel(NoFr,SnX,fact(Rel,Inds,Pol,univ, univ), Cl),
    asserisci_rel(NoFr,SnX,fact(Rel,Inds,Pol,univ, univ), Id),
    doasserts(SentNo, Rels, Asserts, [], Control, Ids),
    !.

build_rel(NoFr-Cl,Rel-Args, Pol, [], Id,Control,[]):-
   !.
build_rel(NoFr-Cl,Rel-Args, Pol, [prop:Control|Inds], Id,Control,Assert):-
   var(Control), Contr=undef,
   Assert=asserisci_rel(NoFr,SnX,fact(Rel,[prop:Contr|Inds],Pol,univ, univ), Cl),
   !.
build_rel(NoFr-Cl,Rel-Args, Pol, [prop:Control|Inds], Id,Control,Assert):-
   nonvar(Control), atomic(Control),
   Assert=asserisci_rel(NoFr,SnX,fact(Rel,[prop:Control|Inds],Pol,univ, univ), Cl),
   !.
build_rel(NoFr-Cl,Rel-Args, Pol, Inds, Id,Control,Assert):-
   Assert=asserisci_rel(NoFr,SnX,fact(Rel,Inds,Pol,univ, univ), Cl),
   !.
build_rel(SentNo,Rel-Args, Pol, [], [],Control,[]):-
   !.

build_vrel(SentNo,Rel-Args, Pol, [], [],Control):-
   !.
build_vrel(NoFr,Rel-Args, Pol, [prop:Control|Inds], Id,Control):-
   asserisci_rel(NoFr,SnX,fact(Rel,[prop:Control|Inds],Pol,univ, univ), Id),
   !.
build_vrel(NoFr,Rel-Args, Pol, Inds, Id,Control):-
   asserisci_rel(NoFr,SnX,fact(Rel,Inds,Pol,univ, univ), Id),
   !.

build_aggs(SentNo, Rel-Agg, Rel, Id):-
      build_agg(SentNo,Rel-Agg, [], Id),
      !.
build_aggs(SentNo, Aggs, Rel, Id).

build_agg(SentNo,Rel-[], [], Id):-
   !.
build_agg(SentNo,Rel-[Arg|Args], Inds, Id):-
    estrai_aggiunti(SentNo-Arg,ListMo,RefList),
    shmemothers(Args, RefList, SentNo, Id),
    build_agg(SentNo,Rel-Args, Inds, Id),
    !.

build_agg(SentNo,Rel-Arg, Inds, Id):-
    estrai_aggiunti(SentNo-Arg,ListMo,RefList),
    shmemothers(Args, RefList, SentNo, Id),
    !.

shmemothers(Args, [], NoFr, Id) :-!.
shmemothers(Args, [Altro/P|Altri], NoFr, Id) :-
   legalptopic(NoFr, Altro, SnX, Arg),
   history_crea_arg(Arg, Mods, Id),
   shasserisci_topic(NoFr, potential, Id, SnX),
   asserisci_agg(NoFr,SnX,fact(adj,[arg:AltriInd, Role:Id],1,univ, univ)),
   shmemothers(Args, Altri, NoFr, Id),
   !.
shmemothers(Args, [Altro/P|Altri], NoFr, Id) :-
   shmemothers(Args, Altri, NoFr, Id),
   !.

estrai_aggiunti(Agg,RefList,ListMo):-
     sh_sn_refs([Agg],N,List),
     sh_pesa_lista(List,LisPes),
     sh_crea_lista(LisPes,RefList,ListMo),
     !.

estrai_aggiunti(N-Agg,RefList,ListMo):-
     sh_sn_refs([Agg],N,List),
     sh_pesa_lista(List,LisPes),
     sh_crea_lista(LisPes,RefList,ListMo),
     !.

recover_type(NoFr, SnX, Top, Type):-
   topps(Type, NoFr, _, SnY, _), nonvar(SnY),
   SnY=SnX.
recover_type(NoFr, SnX, Top, Type):-
   topps(Type, NoFr, Ttop, SnY, _), var(SnY),
   Top=Ttop.

recover_type(NoFr, SnX, Top, potential).

recover_types(NoFr, SnX, Top, Type):-
   topps(Type, NoFr, _, SnY, _), nonvar(SnY),
   SnY=SnX.
recover_types(NoFr, SnX, Top, Type):-
   topps(Type, NoFr, Ttop, SnY, _), var(SnY),
   Top=Ttop.

recover_types(NoFr, SnX, Top, secondary).

topic_score(main, 4).
topic_score(expected, 3).
topic_score(secondary, 2).
topic_score(potential, 1).
topic_score(second, 3).


asserisci_proprieta_multiw(NoFr,Testa,Ref,SnX,Id):-
   nonvar(Testa), Testa\=[],
   Ref=ref_ex(SnX,Testa1,Tab,_,Gen,Num,Cats,F/Role),
   list(Testa1), Pred=Testa1,
   (Num=sing, Type=ind; Num=plur, Type=class),
   Tab=[Re, Def, Quant, Card, _, _, Class],
   Re = + ref,
   (Card=[], Card1=Quant; Card=nil, Card1=Quant; Card\=[], Card\=nil, Card1=Card),
   assert_names(NoFr,Cats,[],SnX,Pred,Card1,Quant,Num,Id,Temp, Loc),
   !.

asserisci_proprieta_multiw(NoFr,Testa,Ref,SnX,Id):-
   nonvar(Testa), Testa\=[],
   Ref=ref_ex(SnX,Testa1,Tab,_,Gen,Num,Cats,F/Role),
   list(Testa), 
   recover_description(Testa, Pred), Pred=Testa1,
   (Num=sing, Type=ind; Num=plur, Type=class),
   Tab=[Re, Def, Quant, Card, _, _, Class],
   Re = + ref,
   (Card=[], Card1=Quant; Card=nil, Card1=Quant; Card\=[], Card\=nil, Card1=Card),
   assert_names(NoFr,Cats,[],SnX,Testa,Card1,Quant,Num,Id,Temp, Loc),
   !.

asserisci_proprieta_multiw(NoFr,Testa,Ref,SnX,Id):-
   nonvar(Testa), Testa\=[],
   Ref=ref_ex(SnX,Testas,Tab,_,Gen,Num,Cats,F/Role),
   atomic(Testas),
   recover_description(Testa, Pred), Pred=Testas,
   (Num=sing, Type=ind; Num=plur, Type=class),
   Tab=[Re, Def, Quant, Card, _, _, Class],
   Re = + ref,
   (Card=[], Card1=Quant; Card=nil, Card1=Quant; Card\=[], Card\=nil, Card1=Card),
   assert_names(NoFr,Cats,[],SnX,Pred,Card1,Quant,Num,Id,Temp, Loc),
   !.

asserisci_proprieta_multiw(NoFr,Testa,Ref,SnX,Id):-
   nonvar(Testa), Testa\=[],
   Ref=ref_ex(SnX,Testas,Tab,_,Gen,Num,Cats,F/Role),
   atomic(Testas),
   recover_description(Testa, Pred), 
   list(Pred), Pred\=Testas,
   (Num=sing, Type=ind; Num=plur, Type=class),
   Tab=[Re, Def, Quant, Card, _, _, Class],
   Re = + ref,
   (Card=[], Card1=Quant; Card=nil, Card1=Quant; Card\=[], Card\=nil, Card1=Card),
   assert_names(NoFr,Cats,[],SnX,Pred,Card1,Quant,Num,Id,Temp, Loc),
   !.

asserisci_proprieta_multiw(NoFr,Testa,Ref,SnX,Id):-
   nonvar(Testa), Testa\=[],
   Ref=ref_ex(SnX,Testa,Tab,_,Gen,Num,Cats,F/Role),
   atomic(Testa),
   recover_description(Testa, Pred), Pred=Testa,
   (Num=sing, Type=ind; Num=plur, Type=class),
   Tab=[Re, Def, Quant, Card, _, _, Class],
   Re = + ref,
   (Card=[], Card1=Quant; Card=nil, Card1=Quant; Card\=[], Card\=nil, Card1=Card),
   creatert(NoFr,class,[],SnX,Testa,Card1,Quant,Num,Id,univ, univ),
   default_properties(NoFr, SnX, Cats, Pred, Id,univ, univ),
   asserisci(NoFr,SnX,fact(isa,[ind:Id,class:Pred],1,univ,univ)),
   !.

append_mod_mod(Body,FunctsO, FunctsOut):-
   remove(mod-Mod1, Body, MBody),
   remove(mod-Mod, Mod1, MBody1),
   append([mod-Mod], FunctsO, RelMod),
   append(MBody1, RelMod, FunctsOu),
   append(MBody, FunctsOu, FunctsOut),
   !.
append_mod_mod(Body,FunctsO, FunctsOut):-
   remove(obl-Mod1, Body, MBody),
   remove(mod-Mod, Mod1, MBody1),
   append([mod-Mod], FunctsO, RelMod),
   append(MBody1, RelMod, FunctsOu),
   append(MBody, FunctsOu, FunctsOut),
   !.
append_mod_mod(Body,FunctsO, FunctsOut):-
   remove(mod-Mod, Body, MBody),
   append(Mod, FunctsO, RelMod),
   append(MBody, [mod-RelMod], FunctsOut),
   !.
append_mod_mod(Body,FunctsO, FunctsOut):-
   remove(obl-Mod, Body, MBody),
   append(Mod, FunctsO, RelMod),
   append(MBody, [obl-RelMod], FunctsOut),
   !.
append_mod_mod(Body,FunctsO, FunctsOut):-
   remove(f2-Mod, Body, MBody),
   Mod=[f2-F2|VP],
   reverse(VP, [Fu-Cost|RevVP]),
   append(Cost, FunctsO, RelMo),
   reverse(RevVP,VP1),
   append(VP1, [Fu-RelMo], RelMod),
   append([f2-F2], RelMod, RelModd),
   append(MBody, RelModd, FunctsOut),
   !.

append_mod_mod(Body,FunctsO, FunctsOut):-
   append(Body, FunctsO, FunctsOut),
   !.


search_append(Obl1, Sec, Rest, FunctsOut):-
    nth(Rest, N, fp-J), N<4,
    move_subj_parent(N, Sec, Rest, Parent, Functs),
    append(Parent, Functs, FunctsO),
    append(Obl1, FunctsO, FunctsOut),
   !.

move_subj_parent(0, Sec, Rest, Parent, FunctsO):-
    append(Sec, Rest, FunctsO),
     !.
move_subj_parent(N, Sec, [A-Cos|Rest], [A-Cos|Middle], FunctsO):-
    N1 is N - 1,
    move_subj_parent(N1, Sec, Rest, Middle, FunctsO),
   !.
     
assert_cl:-
   cl(N),
   N1 is N + 1,
   abolish(cl/1),
   assert(cl(N1)),!.
assert_cl:-
   assert(cl(0)),!.


assign_all_functions([],[],[]):-!.
assign_all_functions(Sints, NFeats, FunctsOutAll):-
   assert_cl,
   filter_parentheticals(Sints,Sints1,Rest),
   (Rest=[],
    assign_functions(Sints1, NFeats2, FunctsOu)
    ;
     Rest\=[],
     assign_all_functions(Sints1, NFeats, FunctsS),
     assert_cl,
     assign_all_functions(Rest, NFeats1, FunctsO),
     append_asserts(Sints,Rest,FunctsS,FunctsO,FunctsOu),
     append(NFeats,NFeats1,NFeats2)),
   assign_all_functions(NFeats2, Feats, FunctsOut),
   (FunctsOu\=[],
   appiattisci(FunctsOu,Functs1),
   append_asserts(Sints,Rest,Functs1, FunctsOut, FunctsOutAll)
   ;
   FunctsOu=[],FunctsOutAll=FunctsOut),
   !.


end_of_clause:-
     retractall(ibar),
   assert(ibar(false)),
   assert(passiv(off)),
    !.
not_parenth(Other):-
    Other\=f-[Par-par-f],
    Other\=sn-par-'''-''',
    Other\=f3-Par,
    Other\=fc-Par,
    Other\=dirsp-Dirs,
    Other\=fp-Cong,
    Other\=fac-Par,
    !.

yes_parenth(Other):-
    Other=f-[Par-par-f];
    Other=sn-par-'''-''';
    Other=f3-Par;
    Other=fc-Par;
    Other=dirsp-Dirs;
    Other=fp-Cong,
    !.

list_check_extract_parent(0, [Other,Sec|NFeats], [Sec|NFeats], [Other]):-
    not_parenth(Sec),
    not_parenth(Other),
    !.
list_check_extract_parent(0, [First|NFeats], R, [First,SN,Sec|Others]):-
    NFeats=[SN,Sec|Rest],nonvar(SN), nonvar(Sec), Rest\=[],
    (Sec=f-[Par-par-f];
%    Sec=sn-par-'''-''';
    Sec=f3-Par;
    Sec=fc-Par;
    Sec=dirsp-Dirs;
    Sec=fp-Cong),
    findall(J,on(fp-J,NFeats),Js),Js\=[],
    length(Js,1),
    list_check_extract_parent(0, Rest, R, Others),
     !.

list_check_extract_parent(0, [First|NFeats], Rest, Sints1):-
    check_extract_parent(0, [First|NFeats], Rest, Sints1),
    !.

filter_parentheticals([First|NFeats],Sints1,Rest):-
   (First=f-[Par-par-f];
    First=sn-par-'''-''';
    First=f3-Par;
    First=dirsp-Dirs;
    First=fp-Cong),
    list_check_extract_parent(0, [First|NFeats], Sints1, Rest),
    !.
filter_parentheticals(NFeats,NFeats,[]).

append_asserts([A|Sints],[A|Resto],Functs1, FunctsO, FunctsOutAll):-
   append_assert(FunctsO, Functs1, FunctsOutAll),
   !.
append_asserts([A|Sints],[],Functs1, FunctsO, FunctsOutAll):-
   append_assert(Functs1, FunctsO, FunctsOutAll),
   !.
append_asserts([A|Sints],[B|Resto],Functs1, FunctsO, FunctsOutAll):-
   A\=B,
   append_assert(Functs1, FunctsO, FunctsOutAll),
   !.

append_assert([], FunctsOutAll, FunctsOutAll):-!.
append_assert(FunctsOutAll, [], FunctsOutAll):-!.

append_assert(Functs1, Functs0, FunctsOutAll):-
   is_list(Functs1),
   length(Functs1,L),
    L=1,
    Functs1=[Fir],
    Fir=fc-FC,
    reverse(FC, [ibar-_|_]),
    Functs0=[fac-Fac],
    append(FC,Functs0,Functs),
    FunctsOutAll=[fc-Functs],
    !.
append_assert(Functs1, FunctsO, FunctsOutAll):-
   is_list(Functs1),
   length(Functs1,L),
   (1<L,
    reverse(Functs1,[First|Rest]),
    First=subj-SUB
     ;
    L=1,
    Functs1=[Fir],
    Fir=subj-SUB,
    SUB=[W-_-_],
    termin(N-[Cat-W]), N<3),
   (FunctsO=[sn-SN|Resto];FunctsO=[subj-SN|Resto]),
   findall(Rel1, (on(ibar-[Rel1|_],Resto);on(vcomp-[Rel1|_],Resto);on(sv3-[Rel1|_],Functs1);on(sv5-[Rel1|_],Resto)),Rels1), Rels1\=[],
    append(SUB,[mod-SN],SUBJ),
    reverse(Rest,Rest1),
    append([subj-SUBJ],Rest1,FunctsOut),
    append(FunctsOut,Resto,FunctsOutAll),
   !.

/*
append_assert(Functs1, FunctsO, FunctsOutAll):-
   is_list(Functs1),
   length(Functs1,L),
   1<L,
   reverse(Functs1,[First|Rest]),
   append_relative([],[First], FunctsO, FunctsOut),
   reverse(Rest,Rest1),
   append(Rest1,FunctsOut,FunctsOutAll),
   !.
*/

append_assert(Functs1, Functs2, FunctsOutAll):-
   appiattisci(Functs2,Functs22),
   findall(Rel1, (on(ibar-[Rel1|_],Functs1);on(vcomp-[Rel1|_],Functs1);on(sv3-[Rel1|_],Functs1);on(sv5-[Rel1|_],Functs1)),Rels1), 
   findall(Rel2, (on(ibar-[Rel1|_],Functs1);on(vcomp-[Rel1|_],Functs1);on(sv3-[Rel1|_],Functs1);on(sv5-[Rel1|_],Functs2)),Rels2), 
   (Rels1=[],Rels2\=[];Rels1\=[],Rels2=[];Rels1\=[],Rels2\=[]),
   append(Functs1, Functs2, FunctsOutAll),
   !.

append_assert(Functs1, Functs2, FunctsOutAll):-
   appiattisci(Functs2,Functs22),
   findall(Rel1, (on(fs-[Rel1|_],Functs1);on(fc-[Rel1|_],Functs1)),Rels1), 
   findall(Rel2, (on(fs-[Rel2|_],Functs22);on(fc-[Rel2|_],Functs22)),Rels2), 
   (Rels1=[],Rels2\=[];Rels1\=[],Rels2=[];Rels1\=[],Rels2\=[]),
   append(Functs1, Functs2, FunctsOutAll),
   !.

/*
append_assert(Functs1, FunctsO, FunctsOutAll):-
   append_relative([],Functs1, FunctsO, FunctsOutAll),
   !.
*/
append_assert(Functs1, Functs2, FunctsOutAll):-
     Functs1=[fac-Fac],
     reverse(Fac,[ibar-Ibar|Rev]),
     reverse(Ibar, [Head-_-_|_]),
    lemmatize_dic_v(Head,Lemma,_),
    coml(Lemma, Subs),
    appiattisci(Subs,Sub),
    (on(fcomp/_,Sub)
     ;
     check_fac_subcat([ibar-Ibar])),
     Functs2=[subj-_,ibar-_|_],
     FunctsOutAll=[Functs1, fac-[fac-[fac-[nil]],Functs2]],
     !.
append_assert(Functs1, Functs2, FunctsOutAll):-
   is_list(Functs1),
   is_list(Functs2),
   append(Functs1, Functs2, FunctsOutAll),
   !.
append_assert(Functs1, Functs2, FunctsOutAll):-
   \+ is_list(Functs1),
   is_list(Functs2),
   append([Functs1], Functs2, FunctsOutAll),
   !.
append_assert(Functs1, Functs2, FunctsOutAll):-
   \+ is_list(Functs2),
   is_list(Functs1),
   append(Functs1, [Functs2], FunctsOutAll),
   !.
append_assert(Functs1, Functs2, FunctsOutAll):-
   \+ is_list(Functs2),
   \+ is_list(Functs1),
   append([Functs1], [Functs2], FunctsOutAll),
   !.

append_fc_fs_if(Fc-Avv, Functs, Functs):-
   (Functs=[fs-[fs-[_-_-_]|_]]
   ;
   Functs=[fc-[fc-[_-_-_]|_]]),
   !.
append_fc_fs_if(Fc-Avv, Functs, FunctsOut):-
   append([Fc-Avv], Functs, FunctsOut),
   length(Functs,L),
   (1=L
   ;
    findall(1,(on(ibar-_, Functs);on(vcomp-_, Functs)),Ff), Ff=[]),
   !.
append_fc_fs_if(Fc-Avv, Functs, [Fc-FunctsOut]):-
   append([Fc-Avv], Functs, FunctsOut),
   length(Functs,L),
   !.


check_said_parenth([ibar-Ibar], Rel, Rel2, Struc, Out, Outs, Rest, Rests):-
     aareverse(Ibar,V),
     verbs_of_saying(V),
     (on(fp-[ - -par-fp], Rel)
       ; on(fp-['"'-par-fp], Rel)),
      Outs=[f2-[f2-Struc]|Out],
     (var(Rest), Rests=[f-Rel2];
      nonvar(Rest),
      append([f-Rel2], Rest,Rests)),
      !.

check_said_parenth([ibar-Ibar], Rel, Rel2, Struc, Out, Outs, Rest, Rest):-
      Outs=[f2-[f2-Struc, f-Rel2]|Out],
      !.

assign_functions([],[],[]):-!.
assign_functions([cp-[_-punto-_]|[]], [], []):-!.

assign_functions([First|NFeats], Sints, FunctsOut):-
   First=F-[Fac],integer(F),
   assign_functions([Fac|NFeats], Sints, FunctsOut),
   !.
assign_functions([First|NFeats], Sints, FunctsOut):-
   First=F-[Fac|Rest],integer(F),
   append(Rest,NFeats,NFeats1),
   assign_functions([Fac|NFeats1], Sints, FunctsOut),
   !.
assign_functions([First|NFeats], Sints, FunctsOut):-
   First=F-_,
   (F=fs;F=fc;F=dirsp;F=fac;F=f2;F=fp;F=par;F=cp;F=f;F=fint),
   assign_funct1([First|NFeats], Sints, FunctsOut),
   !.

assign_functions([First|NFeats], Sints, FunctsOut):-
   First=F-_,
   (F=sn;F=subj;F=sa;F=sq;F=sp;F=spd;F=spda;F=savv;F=fint),
   assign_funct2([First|NFeats], Sints, FunctsOut),
   !.

assign_functions([First|NFeats], Sints, FunctsOut):-
   (First=ibar-_;First=sv2-_;First=sv3-_;First=sv5-_;First=vcomp-_),
   assign_funct3([First|NFeats], Sints, FunctsOut),
   !.

assign_functions([First|NFeats], Sints, FunctsOut):-
   First=mod-Ibar, 
   Ibar=[_-vppt-sv3],
   findall(Rel1, on(ibar-[Rel1|_],NFeats), Rels), Rels=[],
   Firs=ibar-Ibar,
   assign_funct3([Firs|NFeats], Sints, FunctsOut),
   !.
assign_functions([First|NFeats], Sints, FunctsOutAll):-
   assign_functions(NFeats, Sints, FunctsOut),
   append([First],FunctsOut,FunctsOutAll),
   !.


extract_directspeech([subj-Cos, ibar-Cos1|Clause],[],[subj-Cos, ibar-Cos1|Clause]):-!.
extract_directspeech([Cos|Clause],[Cos|NewCl],ResCl):-
    extract_directspeech(Clause,NewCl,ResCl),
    !.

extract_direct_speech(Clause,Rest,NewCl11,ResCl):-
    findall(ibar, member(ibar-_, Clause), I), 
    length(I,L), 1<L,
    nth(Clause,N,ibar-_),
    nth(Clause,N1,ibar-_),
    N\=N1,
    remove(subj-Cost,Clause,FunctsO),
    extract_directspeech(FunctsO,NewCl,ResCl),
    append([subj-Cost],NewCl,NewCl1),
    append(NewCl1,Rest,NewCl11),
    !.
extract_direct_speech(Clause,Rest,Clause,Rest):-
    !.

create_coord_subj(SentNo,IBar,Govern,First,Head-[Lem-Argg-Neg]):-
     find_govern(N,N0,Govern,Head),
     match_lemmatize_head(Head,Ind,First),
     create_subject_rel(Ind, IBar, Valenz, Valenzz, Lem-Argg-Neg),
     !.

check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs):-
     (Clauses\=[],
      remove(M-[Cl,Lem1-Args|_],Clauses,_),
      nonvar(Lem1),
      (atomic(Lem1),Lem=Lem1; Lem1=Lem-_),
      (Govern\=nil,Govern\=Lem, Gov=Govern; Govern=nil,Gov=Lem),
      N2 is N1 + 1,
      assert_gr_fac(N2, Gov,[main-AllArgsAdjs])
      ;
      assert_gr_fac(N1, Govern,[main-AllArgsAdjs])
      ;
       true),
     !.

continue_splitsentences(Clause, ClauseRes,RestFuncs, NewClause):-
     (remove(fac-Body1, Clause, ClauseRest);
      remove(I-[fac-Body1], Clause, ClauseRest), integer(I)),
     (remove(fac-Body2, ClauseRest, ClauseRes);
      remove(I2-[fac-Body2], ClauseRest, ClauseRes), integer(I2)),
      RestFuncs\=[fac-_|_],
     append([fac-Body2], RestFuncs, RestFs),
     (Body1=[that-pk-fac],RestF=RestFs
        ;Body1=[that-rel-f2],RestF=RestFs
        ;Body1\=nil, append([fac-Body1], RestFs, RestF)
       ; Body1=nil, RestF=RestFs),
     (eliminate_dirsp(RestF,NewClause);
       NewClause=RestF),
     !.
continue_splitsentences(Clause, ClauseRest,RestFuncs, NewClause):-
     (remove(fac-Body, Clause, ClauseRest);
      remove(I-[fac-Body], Clause, ClauseRest), integer(I)),
     (Body=[_-pk-fac],RestF=RestFuncs
        ;Body=[_-rel-f2],RestF=RestFuncs
        ;Body\=nil, append([fac-Body], RestFuncs, RestF)
        ; Body=nil, RestF=RestFuncs),
          (eliminate_dirsp(RestF,NewClause);
              NewClause=RestF),
     !.

eliminate_dirsp(FunctsOut,NewClause):-
     findall(F, on(dirsp-F, FunctsOut), Fs),
     length(Fs,L),
     0<L,
     remove_all([dirsp-F], FunctsOut, NewClause),
    !.

create_clause_coord(N1, IBar, FirstArg, [], [], [], [], Lem-[], Neg):-
    IBar\=[],
    FirstArg=[Lem-Argg-Neg],
    current_governor(N1,Lem),
    !.

create_clause_coord(N1, IBar, FirstArg, Clause, ArgsAdjs, Mods, NArgs, Lem-AllArgs, Neg):-
    IBar\=[],
    create_clausecoord(N1, IBar, Clause, Args, Mods, NArgs, Lem-VArgs, Aggs, Neg),
    (VArgs\=[];Aggs\=[], Aggs\= _-[]),
    FirstArg=[Lem-Argg-NegCoord],
    append(Argg,VArgs,AllArgs),
    Aggs=_-Agg,
    assert_mods(N1, Mods,RefMods),
    (Agg=nil, AllAgg=RefMods;
      list(Agg), append(RefMods,Agg,AllAgg)
      ; AllAgg=RefMods),
    appiattisci(AllAgg,AllAggs),
    append(Args,AllAggs,ArgsAdjs),
    !.

create_clause_coord(N1, IBar, FirstArg, Clause, ArgsAdjs, Mods, NArgs, Lem-AllArgs, Neg):-
    IBar=[],
          governor(No,Lemma),
    (Lemma=Lem-I;Lemma=Lem),
    create_clausecoord(N1, [Lem-v-_], Clause, Args, Mods, NArgs, Lem-VArgs, Aggs, Neg),
    (VArgs\=[];Aggs\=[], Aggs\= _-[]),
    FirstArg=[Lem-Argg-NegCoord],
    append(Argg,VArgs,AllArgs),
    Aggs=_-Agg,
    assert_mods(N1, Mods,RefMods),
    (Agg=nil, AllAgg=RefMods;
      list(Agg), append(RefMods,Agg,AllAgg)
      ; AllAgg=RefMods),
    appiattisci(AllAgg,AllAggs),
    append(Args,AllAggs,ArgsAdjs),
    !.

create_clause_coord(SentNo, IBar, FirstArg, Clause, ArgsAdjs, Mods, NArgs, Lem-AllArgs, Neg):-
    splitsent1(SentNo, IBars, Clause, AllClauses),
    remove(M-[Neg,Lem-VArgs,Mods,ArgsAdj,OutAdjs],AllClauses,_),
    append(ArgsAdj,OutAdjs,ArgsAdjs),
    FirstArg=[Lemm-Argg-NegCoord],
    append(Argg,VArgs,AllArgs),
    !.
    
create_clausecoord(N, Ibar, Args, AllArgs, Mods, RArgs, Lem-VArgs, Lem-AllAgg, Neg):-
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     assert_passive(Ibar,Lem),
     maximise_functions(Lem,Args,Valenzes, Valenzz),
     (
      on(Valenz,Valenzz), list(Valenz), Valenze=Valenz
      ; Valenze=Valenzz),
     length(Args,L),
     current_governor(N,Lem),
     assess_arguments1(Valenze,Lem,Args,NewArgs,Vale),
     remove(subj-_,Vale,ValenzCoord),
     crea_argomenti(NewArgs, CatV-L, ValenzCoord, Mods, RArgs, AllArgs, VArgs, AllAgg),
          !.

splitsentences(SentNo, Ibars, [], []):-!.
splitsentences(SentNo, Ibars, FunctsOut, Clauses):-
   (FunctsOut=[A-B|_], A\=fc, A\=fs, A\=cp, A\=coord,FunctsOut=FunctsO
    ;
    appiattisci(FunctsOut,FunctsO),
    FunctsO=[A-B|_], A\=fc, A\=fs, A\=cp, A\=coord),
   splitsent1(SentNo, Ibars, FunctsOut, Clauses), 
   !.

splitsentences(SentNo, Ibars, FunctsOut, [Clause|Clauses]):-
   FunctsOut=[A|Rest],
   on(subj-_,A),on(subj-_,Rest),
   splitsent1(SentNo, Ibars, A, Clause), 
   splitsentences(SentNo, Ibars, Rest, Clauses), 
   !.

splitsentences(SentNo, Ibars, FunctsOut, Clauses):-
   splitsent2(SentNo, Ibars, FunctsOut, Clauses), 
   !.

splitsentences(SentNo, Ibars, FunctsOut, Clauses):-
   splitsent3(SentNo, Ibars, FunctsOut, Clauses), 
   !.

remove_all_sems(FunctsOut, [Sem|Adj],RestFunc):-
     refsems(Sems),
     on(N-Cl-Sem, Sems),
     remove(Sem,FunctsOut, Rest),
     remove_all_sems(Rest, Adj, RestFunc),
     !.
remove_all_sems(RestFunc, [], RestFunc).

evaluate_probable_fac([subj-SN|Functs],Sints, FunctsOut):-
    Functs\=[],
    findall(ibar, member(ibar-_, Functs), Ibars),
    Ibars\=[],
    findall(subj, member(subj-_, Functs), Funs),
    Funs=[],
    append([fac-nil], [subj-SN|Functs], FunctsOu),
    FunctsOut=[fac-FunctsOu],
    !.
evaluate_probable_fac([subj-SN|Functs],Sints, FunctsOut):-
    Functs=[],
    findall(ibar, member(ibar-_, Sints), Ibars),
    Ibars\=[],
    findall(subj, (member(f3-_, Sints);member(fp-_, Sints);member(fc-_, Sints)), Funs),
    Funs\=[],length(Funs,L), 2<L,
    append([fac-nil], [subj-SN|Functs], FunctsOu),
    FunctsOut=[fac-FunctsOu],
    !.

continua_ibar_complements(Ibar,[],[], Ibar):-!.
continua_ibar_complements(Ibar,NFeats,Sints, FunctsAll):-
   NFeats\=[],
   NFeats=[Sec|Rest],
   (
    Sec=Fu-Avv,
    (Fu=savv;
      Fu=sn,
      aareverse(Avv,W),
      nt(W)),
    Rest\=[],
    Rest=[Obj|Resto],
    search_wn_cats(W,Cats),
    \+ on(misura,Cats), \+ on(attivita,Cats),
    Avv=[W1-Art-_|_], Art\=art,
    (Obj=Cos-[Nu-num-_],
      append(Avv,[Nu-num-_],Og),Ogg=[savv-Og], Cont=Resto
      ; Ogg=[savv-Avv], Cont=Rest),
     continua_ibar_complements(Ibar,Cont,Sints, FunctsA),
     append(Ogg, FunctsA,  FunctsAll)   
    ;
    (evaluate_compless(Ibar,Sec, Rest),
    assert_cl,
    retractall(ibar),
    assert(ibar(false)),
    assert(passiv(off)),
    assign_functions(NFeats, Sints, Functs),
    evaluate_probable_fac(Functs,Sints,FunctsOut)
    ;
    evaluate_compl_clause_sn(Ibar,Sec, Rest,NewCost),
    assign_ofunction(Sec, Ogg),
    assignfunctions(NewCost, Sint, FunctsO),
    append_relative(Ibar,Ogg, FunctsO, FunctsOu),
    evaluate_compless_relative(FunctsOu,Sint, Sints,FunctsOut)
    ;
    evaluate_compl_clause_sp(Ibar,Sec, Rest,NewCost),
    assignoblfunctions([],NewCost, Sint, Obl),
    assignfunctions(Sint, Sints, FunctsO),
    append_relative(Ibar, Obl, FunctsO, FunctsOut)
    ;
    assignfunctions(NFeats, Sints, FunctsOut)
    ), 
    append(Ibar, FunctsOut, FunctsAll)),     
   !.


continua_ibar_compls(Ibar,NFeats,Sints, FunctsAll):-
   NFeats\=[],
   NFeats=[Sec|Rest],
   (
    Sec=savv-Avv,
    Rest\=[],
    Rest=[Obj|Resto],
    Avv=[Nt-_-_], nt(Nt),
    search_wn_cats(Nt,Cats),
    \+ on(misura,Cats), \+ on(attivita,Cats),
    Obj=Cos-[Nu-num-_],
    append(Avv,[Nu-num-_],Og),Ogg=[savv-Og],
    assignfunctions(Resto, Sints, FunctsO),
    append_relative(Ibar,Ogg, FunctsO, FunctsOut)
    ;
    evaluate_compl_clause_sp(Ibar,Sec, Rest,NewCost),
    assignoblfunctions([],NewCost, Sint, Obl),
    assignfunctions(Sint, Sints, FunctsO),
    append_relative(Ibar, Obl, FunctsO, FunctsOut)
    ;
    assignfunctions(NFeats, Sints, FunctsOut)
    ), 
    append(Ibar, FunctsOut, FunctsAll),     
   !.
evaluate_dirs_fac(Clauses,NewClauses):-
     appiattisci(Clauses,Claus),
     length(Claus,L),
     2=<L,
     reverse(Claus,RevClauses),
     remove(M-[Cl,Lem-Args|R],RevClauses,Rest),
     nonvar(Lem),
     vcom(Lem),
     assert_gr_fac(N1, Lem,Rest),
     (Rest=[_-Clause|Res],
      append([M-[Cl,Lem-Args|R]],[second-Clause|Res],NewClauses)
      ;
      NewClauses=[M-[Cl,Lem-Args|R]]),
     !.
evaluate_dirs_fac(Clauses,Clauses):-!.

trova_path(Elem,Elem/Path) :-
           rete(Rete),
           ((nodo(n1)::indice::Elem, !,
             Path = nil)
           ;
           (nodo(n1)::path(Path)::indice::Elem, !)
           ;
           (nodo(n1)::path(Cammino)::Elem, !,
             Cammino = Path::indice)).

pesa_lista(PathList,LPesata) :-
     sn_ref(PathList,List),
   /*  maplist(len,List,L3), */
     maplist(punteggio1,List,L4),
     bubblesort(L4,LPesata),!.

lun(Path,1) :- atom(Path).
lun(F/R,1) :- atom(F),
              atom(R).
lun(P::Path,L) :- lun(Path,L1),
                 L is L1 + 1.

sn_ref([],[]).
sn_ref([Ind/Pa|Rest],[Ind/Pa|Altri]) :-
   nodo(N)::indice::Ind,
   nodo(N)::pred::Pred,
   nodo(N)::tab_ref::Tab,
   isa_sn_ref(Pred, Tab),
  sn_ref(Rest,Altri).
sn_ref([Ind/Pa|Rest],Altri) :-
       sn_ref(Rest,Altri).

insert_control(Testa, NArgs, Funz, [], Ind, [controller(Funz-Ind)]):-
     NArgs\=[],
     on(vcomp-Sec,NArgs),
     !.

insert_control(Testa, NArgs, Funz, Valenz, Ind, Valenza):-
     NArgs\=[],
     on(vcomp-Sec,NArgs),
     append(Valenz, [controller(Funz-Ind)], Valenza),!.

insert_control(Testa, NArgs, Funz, Valenz, Ind, Valenz).

semantica_controllo(Rel):-
     Rel=Lem-[Ruolo/Sogg],
     governor(N1,Head1),
     Head1=Lem-Ind,
     assert_controlled_subject(Ruolo,Sogg, Head1),
     !.
semantica_controllo(Rel):-
     Rel=Lem-[Ruolo/Sogg, Role/Id],
     governor(N1,Head1),
     Head1=Lem-Ind,
     assert_controlled_subject(Ruolo,Sogg, Head1),
     !.
semantica_controllo(Rel):-
     Rel=Lem-[agent/arb, Role/Id],
     governor(N1,Head1),
     Head1=Lem-Ind,
     assert_controlled_subject(agent,arb, Head1),
     !.

costruisci_semantica_controllo(Ibar, Sogg, [], Role, Rel,Valenze):-
     assign_funz_role(Ibar,CatV,Lem,Valenza,Feats),
     assert_passive(Ibar,Lem),
     estrai_val(Valenza,Arg),
     remove_subject(Arg,Ruolo,Rest),
     remove_compls(Rest,Role),
     (atomic(Sogg),
     Rel=Lem-[Ruolo/Sogg]
     ;
     Sogg=A-I,
     Rel=Lem-[Ruolo/A]
     ;
      list(Sogg),
     on(controller(_-Index), Sogg),
     Rel=Lem-[Ruolo/Index]
     ;
      list(Sogg),
     Rel=Lem-[Ruolo/Sogg]),
     maximise_functions(Lem,[],Rest, Valenzz),
     (
      on(Valenz,Valenzz), 
         list(Valenz), Valenz=[subj-_|Valenze]
          ; 
          Valenzz=[subj-_|Valenze]
          ;
          \+ on(subj-_,Valenzz),Valenze=Valenzz
      ),
     !.

costruisci_semantica_controllo(Ibar, Sogg, Id, Role, Rel,Valenze):-
     assign_funz_role(Ibar,CatV,Lem,Valenza,Feats),
     assert_passive(Ibar,Lem),
     estrai_val(Valenza,Arg),
     remove_subject(Arg,Ruolo,Rest),
     remove_compls(Rest,Role),
     (atomic(Sogg),
     Rel=Lem-[Ruolo/Sogg, Role/Id]
     ;
     Sogg=A-I,
     Rel=Lem-[Ruolo/A]
     ;
      list(Sogg),
     on(controller(_-Index), Sogg),
     Rel=Lem-[Ruolo/Index, Role/Id]
     ;
      list(Sogg),
     Rel=Lem-[Ruolo/Sogg]),
     maximise_functions(Lem,[],Rest, Valenzz),
     (
      on(Valenz,Valenzz), 
         list(Valenz), Valenz=[subj-_|Valenze]
          ; 
          Valenzz=[subj-_|Valenze]
          ;
          \+ on(subj-_,Valenzz),Valenze=Valenzz
      ),
     !.

costruisci_semantica_controllo(Ibar, Sogg, Id, Role, Rel,Valenze):-
     assign_funz_role(Ibar,CatV,Lem,Valenza,Feats),
     on(Verb-Cat-_,Ibar),
     check_vcat(Cat),
     assert_passive(Ibar,Lem),
     Rel=Lem-[R/Sogg, Role/Id],
     maximise_functions(Lem,[],Valenza, Valenzz),
     on(Fun-Role,Valenzz), Fun\=subj,Fun\=sogg,
     (
      on(Valenz,Valenzz), list(Valenz), 
        Valenz=[subj-R|Valenze]
      ; Valenzz=[subj-R|Valenze]),
     !.

costruisci_semantica_contr(Ibar, Sogg, Id, Role, Rel,Valenze):-
     Ibar=[A],
     on(Verb-Cat-_,Ibar),
     pp_word_cat(Verb, pass, part, Lem),
     assign_funz_role(Ibar,CatV,Lem,Valenza,Feats),
     assert_partpassive(Ibar,Lem),
     Rel=Lem-[Ro/Sogg],
     maximise_functions(Lem,[],Valenza, Valenzz),
     (remove(obj-Ro,Valenzz,Valenze);Ro=theme_aff, Valenze=Valenzz),
     !.

assert_partpassive(Ibar,Lem):-
    on(Verb-Cat-_,Ibar),
    v(Verb,Subs),
    \+ on(i,Subs),
    assert(passiv(on)),
    cl(Cl),
    asserta(funcs(voice, Cl, Verb, passive-Rest)),
    DepGr=..[voice,passive,'_',Lem],
    (dgrs(N,DepGr);
    \+ dgrs(N,DepGr),
    asserta(dgrs(N,DepGr))),
     !.
assert_partpassive(Ibar,Lem):-
    DepGr=..[voice,active,'_',Lem],
    (dgrs(N,DepGr);
    \+ dgrs(N,DepGr),
    asserta(dgrs(N,DepGr))),
    assert(passiv(off)),
     !.

assert_controlled_subject(Ruolo,arb, Govern):-
     governor(N,_),
     (nonvar(N),Nn=N;var(N),Nn=1),
     H=..[voice,passive,'_',Govern],
     Dgr=..[dgrs,N,H],
     (Dgr,Role=theme_aff;Role=Ruolo),
     term_to_atom(subj-Role,FunR),
     DepGr=..[FunR,Govern,arb],
     asserta(dgrs(Nn,DepGr)),
     !.
assert_controlled_subject(Ruolo,Ind, Govern):-
     governor(N,_),
     (nonvar(N),Nn=N;var(N),Nn=1),
     find_govern(1,_,Ve,Gov),
     (Gov=Testa-Ind;
      recover_head_lemm(Ind,Testa)),
     check_testa(Testa,Test),
     H=..[voice,passive,'_',Govern],
     Dgr=..[dgrs,N,H],
     (Dgr,Role=theme_aff;Role=Ruolo),
      term_to_atom(subj-Role,FunR),
      DepGr=..[FunR,Govern,Test-Ind],
     asserta(dgrs(Nn,DepGr)),
     !.

matchheads(Heads,Head):-
       findall(Fun,
       (dgrs(Nn,DepGr),
       (DepGr=..[Fun,Govern,H1-_,Lemma];
        DepGr=..[Fun,Govern,H1-_];
        DepGr=..[Fun,Govern,H2-_,Lemma];
        DepGr=..[Fun,Govern,H2-_]), H1=Heads;H2=Head),
        Funs), Funs\=[],
       !.
matchheads(Heads,Head):-
       findall(Fun,
       (dgrs(Nn,DepGr),
       (DepGr=..[Fun,Govern,H1,Lemma];
        DepGr=..[Fun,Govern,H1];
        DepGr=..[Fun,Govern,H2,Lemma];
        DepGr=..[Fun,Govern,H2]), H1=Heads;H2=Head),
        Funs), Funs\=[],
       !.

recover_head_lemm(Ind,Heads):-
    ref_funcs(Fu, Ind, Heads, First),
    lemmatize_dic(Heads, Head,_),
    dgrs(SentNo,DepGr),
    matchheads(Heads,Head),!.

recover_head_lemm(Ind,Heads):-
    nonvar(Heads), atomic(Heads),
    spy_lower(Heads,LowH,1),
    ref_funcs(Fu, Ind, LowH, First),
    lemmatize_dic(LowH, Head,_),
    dgrs(SentNo,DepGr),
    matchheads(Heads,Head),!.

recover_head_lemm(Ind,Heads):-
    ref_funcs(Fu, Ind, Heads, First),
    atomic(Heads),
    spy_lower(Heads,LowH,1),
    dgrs(SentNo,DepGr),
    matchheads(Heads,LowH),!.

recover_head_lemm(Ind,Heads):-
    ref_funcs(Fu, Ind, Heads, First),
    list(Heads), 
    on(Head,Heads), Head=pron,
    !.


complex_rel_parent(Rest,RestClause,Parent, IBars, NewClause, IBar, RestFuncs, RestIbar,Adjs):-
    (on(fp-_, RestClause);on(f3-_, RestClause)),
     check_extract_parent(1, RestClause, Parent, RestCl),
     append([subj-Rest],RestCl,NewClause),
     extract_clause(IBars, NewClause, Clause, IBar, RestFuncs, RestIbar,Adjs),
     !.

complex_rel_parent(Rest,RestClause,[f2-Parent], IBars, NewClause, RestIbar, [], [],Adjs):-
    (on(fp-_, RestClause);on(f3-_, RestClause)),
    extract_clause(IBars, RestClause, RestCl, IBar, RestFuncs, RestIbar,Adjs),
     append([ibar-IBar],RestCl,Pare),
     append([subj-Rest],Pare,Paren),
     remove(f2-Body1, Adjs, Res),
     append([f2-Body1],Paren,Parent),
     append([subj-Rest],RestFuncs,NewClause),
      !.

verbless_par(fx-Punt,NPs):-!.
verbless_par(dirsp-Punt,NPs):-!.
verbless_par(fc-Punt,NPs):-!.
verbless_par(Cost,NPs):-
    (Cost=f3-Punt;Cost=fp-Punt),
      nth(NPs,N,Cost), 
      nth(NPs,N1,ibar-_),
      N1 < N,
      !.
verbless_par(Cost,NPs):-
    (Cost=f3-Punt;Cost=fp-Punt),
      findall(N,nth(NPs,N,Cost), Ns), Ns=[],
      !.


filter_props([],NPs):-!.
filter_props([Cost-N|Costs],NPs):-
      nth(NPs,N1,ibar-_),
      N1 < N,
      N < 5,
      filter_props(Costs,NPs),
      !.

check_new_proposition(NPs):-
    findall(Cost-N, (
      (Cost=fc-Punt;Cost=fs-Punt;Cost=fp-Punt;Cost=f2-Punt),
       nth(NPs,N,Cost)),Costs), 
      Costs\=[],
      length(Costs,L),
     (L=1,
      on(Cos-N,Costs),
      nth(NPs,N1,ibar-_),
      N1 < N
      ;
      1<L,
      filter_props(Costs,NPs)),
      !.
check_new_proposition(NPs):-
    findall(Cost, (
      (Cost=fc-Punt;Cost=fs-Punt;Cost=fp-Punt;Cost=f2-Punt),
       nth(NPs,N,Cost)),Costs), 
      Costs=[],
      (Cos=sp-Punt;Cos=savv-Punt),
      nth(NPs,N,Cos), 
      nth(NPs,N1,ibar-_),
      N < N1,
      !.

get_tags([],[]):-!.
get_tags([W|X],Xtags):-
    findall_poss(Si),
    on(Pos-[Cat-W|_], Si),
    get_wordtags(Si,Pos,Xtags),
    !.

get_tags(NuovaFrase,Xtags):-
     abolish(termin/1),
     dynamic(termin/1),
     check_lex(0,NuovaFrase),
    findall_poss(Si),
    on(Pos-[Cat-W|_], Si),
    get_wordtags(Si,Pos,Xtags),
    !.

get_wordtags([],Pos,[]):-!.
get_wordtags([Pos-[Cat-W|_]|Si],Pos,[W-Cat|Si]):-
    !.
get_wordtags([P-[Cat-W|_]|Si],Pos,Xtags):-
    get_wordtags(Si,Pos,Xtags),
    !.
negq(no).
negq(none).
negq(not_all).

incorporatetitles(Tops, Mains, SortLowTops):-
   appiattisci(Tops, Alltops),
   appiattisci(Mains, Allmains),
   lowcase_all(Allmains, LowAllmains),
   collectrootstitle(LowAllmains, RootSort),
   filter_func_cont(RootSort, LowMains),
   append(Alltops,LowMains,Alls),
   lowcase_all(Alls, LowTops),
   sort(LowTops, SortLowTops),
   !.

reorder_alltops1(N-Rate, NTops, ReNTops, Reorder):-
   reorderalltops(N-Rate, NTops, RNTops),
   search_higher_first(RNTops, Higher),
   on(High, Higher),
   remove(High-List, RNTops, RList),
   append([High-List], RList, Reorder),
   reorder_tops1(Higher, NTops, ReNTops),
   (ReNTops=[F-First|_],
    dangling_sentence(F-First, Out),
    Out=true
    ;
    Out=false),
   write(c),
   !.

reorder_alltops2(N-Rate, NTops, ReNTops, Reorder):-
   reorderalltops(N-Rate, NTops, RNTops),
   search_higher_first(RNTops, Higher),
   on(High, Higher),
   remove(High-List, RNTops, RList),
   append([High-List], RList, Reorder),
   reorder_tops2(Higher, NTops, ReNTopss),
   ReNTopss=[F-First|Rest],
   dangling_sentence(F-First, Out),
   (Out=true, ReNTops=ReNTopss
    ;
    Out=false,
    Rest=[RInd-_|_],
    reorderhigh(RInd, Reorder, ReorderH),
    append(Rest, [F-First], ReNTops)),
   write(d),
   !.

reorder_alltops2(N-Rate, NTops, NTops, Reorder).

reorderhigh(RInd, Reorder, ReorderH):-
   search_higher(Reorder, Higher),
   !.

reorderhigh(RInd, Reorder, ReorderH):-
   Rin is RInd - 1000,
   name(Rin, [Ri|RList]),
   name(R, [Ri]),
   remove(R-List, Reorder, Reord),
   append([R-List], Reord, ReordH),
   !.

search_higher_first(Reorder, [R]):-
   remove(R-[1|RList], Reorder, Reord),
   !.
search_higher_first(Reorder, Higher):-
   search_higher(Reorder, Higher),
   !.
search_higher([], []):-!.
search_higher([L1-[First|_]], [L1]):-
    !.
search_higher([L1-[First|F], L2-[Sec|C]|RNTops], [High|Higher]):-
   First < Sec,
   High = L1,
   search_higher([L1-[First|F]|RNTops], Higher),
    !.

search_higher([L1-[First|F], L2-[Sec|C]|RNTops], Higher):-
   Sec < First,
   search_higher([L2-[Sec|C]|RNTops], Higher),
    !.

search_higher([L1-[L,First|F], L2-[L,Sec|C]|RNTops], [High|Higher]):-
   First < Sec,
   High = L1,
   search_higher([L1-[First|F]|RNTops], Higher),
    !.

search_higher([L1-[L, First|F], L2-[L, Sec|C]|RNTops], Higher):-
   Sec < First,
   search_higher([L2-[Sec|C]|RNTops], Higher),
    !.

search_higher([L1-[First|F], L2-[]|RNTops], Higher):-
   search_higher([L1-[First|F]|RNTops], Higher),
    !.
search_higher([L1-[]|RNTops], Higher):-
   search_higher(RNTops, Higher),
    !.
search_higher([L1-First, L2-Sec|RNTops], [High|Higher]):-
   High = L1,
   search_higher([L2-Sec|RNTops], Higher),
    !.

reorder_tops1([F|Higher], NTops, ReNTops):-
   F1 is F * 100,
   extract_higher(F1, NTops, ReNTops),
   !.

reorder_tops2([F|Higher], NTops, ReNTops):-
   F1 is F * 100 + 1000,
   extract_higher(F1, NTops, ReNTops),
   !.

extract_higher(F1, NTops, ReNTops):-
    exreorderalltops(F1, NTops, ReNTops),
    !.
exreorderalltops(Rate, [], []):-!.
exreorderalltops(Rate, NTops, ReNTops):-
    exreordertops(Rate, NTops, Rest, ReNTop),
    append(ReNTop, Rest, ReNTops),
    !.
 
exreordertops(Rate, [], [], []):-!.
exreordertops(Rate, [First-Sent|NTops], Rest, [First-Sent|ReNTops]):-
   F is First - Rate,
   F < 100,
   0 < F,
   exreordertops(Rate, NTops, Rest, ReNTops),
   !.
exreordertops(Rate, [First-Sent|NTops], [First-Sent|Rest], ReNTops):-
   exreordertops(Rate, NTops, Rest, ReNTops),
   !.

reorderalltops(N-Rate, [], []):-!.
reorderalltops(N-Rate, NTops, [N-ReNTop|ReNTops]):-
    reordertops(N-Rate, NTops, Rest, ReNTop),
    N1 is N + 1,
    Rate1 is Rate + 100,
    reorderalltops(N1-Rate1, Rest, ReNTops),
    !.
 
reordertops(N-Rate, [], [], []):-!.
reordertops(N-Rate, [First-Sent|NTops], Rest, [F|ReNTops]):-
   F is First - Rate,
   F < 100,
   reordertops(N-Rate, NTops, Rest, ReNTops),
   !.
reordertops(N-Rate, NTops, NTops, []):-!.

wexreordertops(Rate, [], [], []):-!.
wexreordertops(Rate, [First-Sent|NTops], Rest, [F-Sent|ReNTops]):-
   F is First - Rate,
   F < 100,
   0 < F,
   wexreordertops(Rate, NTops, Rest, ReNTops),
   !.
wexreordertops(Rate, [First-Sent|NTops], [First-Sent|Rest], ReNTops):-
   wexreordertops(Rate, NTops, Rest, ReNTops),
   !.

writesentences_xml1(File, [], [], Files):-!.
writesentences_xml1(File, AllWords, [First-List|Reorder], Files):-
   nth(Files, First, FileName),
   Rate is First * 100,
   wexreordertops(Rate, AllWords, Rest, ReNTops),
   writesentencexml(File, ReNTops, FileName),
   writesentences_xml1(File, Rest, Reorder, Files),
   !.   

writesentences_xml2(File, [], [], Files):-!.
writesentences_xml2(File, AllWords, [First-List|Reorder], Files):-
   nth(Files, First, FileName),
   Rate is First * 100 + 1000,
   wexreordertops(Rate, AllWords, Rest, ReNTops),
   writesentencexml(File, ReNTops, FileName),
   writesentences_xml2(File, Rest, Reorder, Files),
   !.   

writesentencexml(File, [], FileName):-!.
writesentencexml(File, N-[], FileName):-!.
writesentencexml(File, [0-[]|AllWords], FileName):-
   writesentencexml(File, AllWords, FileName).
writesentencexml(File, [F-Words|AllWords], FileName):-
   writeinits(File, FileName, F),
   Words=[First|Rest],
   toupper(First, UpF),
   NWords=[UpF|Rest],
   writeseq(File, NWords),
   writeseq(riassunto, NWords),
   nl(riassunto),
   writenl(File, '</s>'),
   writesentencexml(File, AllWords, FileName).

writeinits(Logfile, Name, Num):-
   write(Logfile, '<s docref="'),
   write(Logfile, Name),
   write(Logfile, '" '),
   write(Logfile, 'num="'),
   write(Logfile, Num),
   write(Logfile, '">'),
   !.

writeinit1(Logfile, Name):-
   write(Logfile, '<multi-e size="800" docset="'),
   write(Logfile, Name),
   writenl(Logfile, '">'),
   !.
writeinit2(Logfile, Name):-
   write(Logfile, '<multi-e size="400" docset="'),
   write(Logfile, Name),
   writenl(Logfile, '">'),
   !.

writeinitsent(Logfile, N, N-Top, [File|Files], File):-
   !.
writeinitsent(Logfile, N, N2-Top, [File|Files], File):-
   N1 is N + 1,
   writeinitsent(Logfile, N1, N2-Top, Files),
   !.

/*
<multi-e size="400" docset="d04a">
<s docref="WSJ09054-943439" num="2">
</s>
</multi-e>
*/

writefrasi_extract1(Logfile, ReNTops, Reorder, Name, Files):-
   writeinit1(Logfile, Name),
   writesentences_xml1(Logfile, ReNTops, Reorder, Files),
   writenl(Logfile, '</multi-e>'),
   !.   

writefrasi_extract2(Logfile, ReNTops, Reorder, Name, Files):-
   writeinit2(Logfile, Name),
   writesentences_xml2(Logfile, ReNTops, Reorder, Files),
   writenl(Logfile, '</multi-e>'),
   !.   

senttopsevalall(SortLowTops, Words, NTops400, NTops200):-
   writenl(1),
   sent_tops_evals([800], SortLowTops, Words, NTops400, HighTops),
   writenl(2),
   sent_tops_evals1([400], HighTops, NTops400, NTops200, True),
   !.

reorderalltopics(NTops400, NTops200, ReNTops1, Reorder1, ReNTops2, Reorder2):-
   reorder_alltops1(1-100, NTops400, ReNTops1, Reorder1),
   reorder_alltops2(1-1100, NTops200, ReNTops2, Reorder2),
   !.

evaluate_topics(SortLowTops, Words, ReNTops1, Reorder1, ReNTops2, Reorder2):-
   senttopsevalall(SortLowTops, Words, NTops400, NTops200),
   cursor(down_thumb),
   writenl(3),
   reorderalltopics(NTops400, NTops200, ReNTops1, Reorder1, ReNTops2, Reorder2),
   writenl(4),
   !.


assess_argumens1(Valenze,Lem,Args,NewArgs,Valenze):-
      Args=[First|NewArg],
      (First=fs-_;First=fc-_;First=fp-_;First=ibar-_),
     assess_argumens(Valenze,Lem,NewArg,NewArgs,Valenze),
    !.

assess_argumens1(Valenze,Lem,Args,Args,Valenze):-
      Args=[First|_],
      First=subj-_,!.
assess_argumens1(Valenze,Lem,Args,NewArgs,Valenze):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      ((Func=obj;Func=subj),
        remove(Func-Arg1,MidArgs,RestArgs),
        append([Func-Arg],RestArgs,NewArgs)
        ;
        remove(obj-Arg1,MidArgs,RestArgs),
        append([ncomp-Arg1],RestArgs,NewArg),
        append(NewArg,[Func-Arg],NewArgs)),
      !.
assess_argumens1(Valenze,Lem,Args,NewArgs,Valenze):-
      \+ copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      ((Func=obj;Func=subj),
        remove(Func-Arg1,MidArgs,RestArgs),
        append([Func-Arg],RestArgs,NewArgs)
       ;
        append(MidArgs, [Func-Arg],NewArgs)),
      !.
assess_argumens1(Valenze,Lem,Args,NewArgs,Valenze):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      append([Func-Arg],MidArgs,NewArgs),
      !.
assess_argumens1(Valenze,Lem,Args,NewArgs,Valenze):-
      \+ copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(fint-Arg,Args,MidArgs),
      choose_fint_type([Lem-_-_],Arg,Func),
      append([Func-Arg],MidArgs,NewArgs),
      !.
assess_argumens1(Valenze,Lem,Args,NewArgs,Valenze):-
      Args=[First|_],
      First\=subj-_,
      First\=vcomp-_,
      remove(subj-Arg,Args,MidArgs),
      append([subj-Arg],MidArgs,NewArgs),
      !.
assess_argumens1(Valenze,Lem,Args,NewArgs,Valenz):-
      copl(Lem),
      Args=[First|_],
      First\=subj-_,
      remove(xcomp-Arg,Args,MidArgs),
      append([subj-Arg],MidArgs,NewArgs),
      append([subj-theme_bound],Valenze,Valenz),
      !.
assess_argumens1(Valenze,Lem,Args,Args,Valenze):-!.

assess_arguments1(Valenze,Lem,Args,NewArgs,Valenz):-
    assess_argumens1(Valenze,Lem,Args,Args1,Valenz),
    assess_obls_adjs(Lem,Args1,NewArgs),
     !.



dyn_ext_pron:-
   abolish(ext/2),
   abolish(dsa/2),
   abolish(ante/3),
   dynamic(ext/2),
   abolish(expl/2),
   dynamic(expl/2),
   dynamic(ante/3),
     !.

abolish_ibar:-
     retractall(ibar),
     assert(ibar(nil)),
     assert(ibar(false)),
   !.
abolish_cl:-
     abolish(cl/1),
     assert(cl(0)),
    !.

writesymb_assert(NoFr, Symb):-
   asserta(frase_corrente(NoFr, Symb)),
   writeNoFr(File,Symb),
   !.

writeNoFr(File,Symb):-
   nl,nl,
   writenl(File, '*********************************************************************************'),
   writenl(File, Symb),
   !.

allparsers(NoFr, Frase, Input, Disambs, Tags, Ibars, Scored, Costs, Out, NC):-
    appiattisci(Costs,Cost),
    sortfclause(Cost, Sorted),
    mapftoc(NoFr, Frase, Disambs, Tags, Ibars, Scored, And, Sorted,Out),
    evaluate_count(Scored,Tags),
    !.

/*
allparsers(NoFr, Frase, Input, Disambs, Tags, [], Scored, Costs, Clauses, NC):-
   retag(NoFr, Frase, Tags, FunctsOut,DClauses, Tensed, N, Out),
   (Clauses\=[],Out=[Fu, Clauses];Out=Fu),
   !.
*/

evaluate_count(Parse,Tags):-
   is_list(Parse),
   is_list(Tags),
   length(Parse,LP),
   length(Tags,LT),
   findall(D, dgrs(_,D), Ds),
   length(Ds, LD),
   RatioW is LP / LT,
   0<LD,
   RatioD is LT / LD,
   RatioS is LP/ LD,
   eval_coun_ratios(RatioW,RatioD,RatioS),
   !.
evaluate_count(Parse,Tags):-!.

eval_coun_ratios(RatioW,RatioD,RatioS):-
   RatioW=<RatioD
   ;
   RatioS=<RatioD,
    !.
eval_coun_ratios(RatioW,RatioD,RatioS):-
   write('Ratio Tags/Constituents     '),
   writenl(RatioW),
   write('Ratio Tags/Dependencies     '),
   writenl(RatioD),
   write('Ratio Constituents/Dependencies     '),
   writenl(RatioS),
   nl, nl,
   !.


checkappend_adjs(NoFr,Frase, Disambs, Tags,Ibars, Scored, F, Cost, Costs, Out):-
    Cost=Fu-A,
    checkcosts(Fu),
    Costs=[H-Rest],
    (Rest=Fun-Clause;    Rest=[Fun-Clause];    Rest=Clause),
    append(Clause,[Cost],Claus),
    NCosts=[H-[Fun-Claus]],
    mapftoc(NoFr,Frase, Disambs, Tags, Ibars, Scored, And, NCosts,Out),
    !.
 
checkappend_adjs(NoFr,Frase, Disambs, Tags,Ibars, Scored, F, Cost, Costs, Clauses):-
    Cost=Fu-A,
    checkcosts(Fu),
    Costs\=[H-Rest],
    remove(N-Clause,Costs, Rests),
    integer(N),
    Clause=[Fun-Clau],
    (remove(N1-Clause1,Rests, Restss),
     integer(N1),
     (Clause1=[Fun1-Clau1],
      F=Fu,
      append([Cost],Restss,Secs),
      append(Clau1,Secs,First), F1=Fun1
       ;
      findall(I, on(ibar-I,Clause1), Is), Is\=[],
      append([Cost],Restss,Secs),
      append(Secs,Clause1,First), F1=F)
     ;
    append([Cost],Rests,First), F1=F),
    mapftoc(NoFr,Frase, Disambs, Tags, Ibar, Scored, And, [F1-First],Clauses1),
    mapftoc(NoFr,Frase, Disambs, Tags, Ibarr, Scored, And, Clause,Clauses2),
    append(Ibar,Ibarr,Ibars),
    append(Clauses1,Clauses2,Clauses),
    !.
 
checkappend_adjs(NoFr,Frase, Disambs, Tags,Ibars, Scored, F, Cost1, Costs, Clauses):-
    Costs\=[H-Rest],
    remove(N-Clause,Costs, Rests),
    integer(N),
    Cost1=Fu-Cost, 
    (Clause=[Fun-Clau],
     (remove(N1-Clause1,Rests, Restss),
      integer(N1),
      (Clause1=[Fun1-Clau1];
       findall(I, on(ibar-I,Clause1), Is), Is\=[]),
       append(Cost1,Restss,Secs),
       append(Secs,Clause1,First)
       ;
       (Fu=fc;Fu=fs;Fu=f2;Fu=fac),
       And=Cost1,
       First=Rests
       ;
       append(Cost,Rests,First))
       ;
       list(Clause),
      append(Cost,Rests,First)
     ),
     mapftoc(NoFr,Frase, Disambs, Tags, Ibar, Scored, And, Clause,Clauses1),
     mapftoc(NoFr,Frase, Disambs, Tags, Ibarr, Scored, And, First,Clauses2),
     append(Ibar,Ibarr,Ibars),
     append(Clauses1,Clauses2,Clauses),
    !.

check_clauses_sem(F,Ncl, nil,Clause,And):- And=[];And=fac-[that-pk-fac],!.

check_clauses_sem(F,SentNo, Govern,Clause,And):-
       nonvar(F),
       (F=fac;F=fs;F=fc;F=dirsp),
       governor(N, Lem),
       assert_fac_governor(And,F,SentNo,Govern,Clause,Lem),
       assert_cong_and(SentNo,F,And,Govern,Lem),
       checkneg_congs(SentNo,And,Govern),
       !.
check_clauses_sem(F,SentNo, Gov,Clause,And):-
     governor(N, Lem),
     assert_cong_and(SentNo,F,And,Gov,Lem),
     !.

checkneg_congs(SentNo,And,Lem):-
     And=fc-Cong, Cong=[Sem-_-_], 
     negcongs(Sem),
     DepGr=..[neg,Lem,Sem],
     asserta(dgrs(N,DepGr)),
     !.
     
negcongs(C):-
   nonvar(C),
   negcons(C).

negcons(nor).
negcons(neither).
negcons(not_even).
negcons(not_far).
negcons(not_yet).
negcons(never).

assert_cong_and(SentNo,F,And,Gov,Lem):-
    is_list(And), 
    on(Sub,And), 
    (Sub=A-B, Sub1=Sub, B\=_-_, A\=_-_
      ;
     Sub=A-B-C, Sub1=C-And),
    assert_cong_and(SentNo,F,Sub1,Gov,Lem),
     !.
assert_cong_and(SentNo,F,And,nil,Lem):-
      (And=fs-Cong, Cong=[Sem-_-_], 
           Coord=cmod, Sub=subord
         ;
        And=fp-Cong, Cong=[','-_-_], Sem=and, Coord=coord, Sub=prop
         ;
        And=fc-Cong, Cong=[Sem-_-_], 
          (Sem=and, Coord=coord, Sub=prop
            ;
            Sem\=and, Coord=cmod, Sub=subord)),
      term_to_atom(Coord-Sub,FunR),
      DepGr=..[FunR,Sem,Lem],
       \+ dgrs(_,DepGr),
      asserta(dgrs(SentNo,DepGr)),
    !.

assert_cong_and(SentNo,F,And,Gov-Id1,Lem):-
     (term_to_atom(xcomp-R,FunR),
      Comp=..[FunR,Se, NGov-Id, Gov-Id2],
      Dgr=..[dgrs, N, Comp], 
      Dgr,
      Ind=Id;
       NGov=Gov, Ind=Id1),
      And\=[],
      (And=fs-Cong, Cong=[Sem-_-_], 
           Coord=cmod, Sub=subord
         ;
        And=fp-Cong, Cong=[','-_-_], Sem=and, Coord=coord, Sub=prop
         ;
        And=fc-Cong, Cong=[Sem-_-_], 
          (Sem=and, Coord=coord, Sub=prop
            ;
            Sem\=and, Coord=cmod, Sub=subord)),
      term_to_atom(Coord-Sub,FunR),
      DepGr=..[FunR,Sem,NGov-Ind,Lem],
       \+ dgrs(_,DepGr),
      asserta(dgrs(SentNo,DepGr)),
    !.
assert_cong_and(SentNo,F,And,Gov-Id1,Lem):-
     (term_to_atom(xcomp-R,FunR),
       Xcomp=..[FunR,Se, NGov-Id, Gov-Id2],
       dgrs(N, Xcomp), Ind=Id;
       NGov=Gov, Ind=Id1),
      And=[],
      funcs(sem, Cl-Cl1, [Avv], First),
      (First=fs-Cong, Cong=[Sem-_-_], 
           Coord=cmod, Sub=subord
         ;
        First=fc-Cong, Cong=[Sem-_-_], 
          (Sem=and, Coord=coord, Sub=prop
            ;
            Sem\=and, Coord=cmod, Sub=subord)),
      term_to_atom(Coord-Sub,FunR),
      DepGr=..[FunR,Sem,NGov-Ind,Lem],
             \+ dgrs(_,DepGr),
      asserta(dgrs(SentNo,DepGr)),
    !.
assert_cong_and(SentNo,F,[],Gov,Lem):-!.
assert_cong_and(SentNo,F,And,Gov,Lem):-
      (And=fs-Cong, Cong=[Sem-_-_], 
           Coord=cmod, Sub=subord
         ;
        And=fc-Cong, Cong=[Sem-_-_], 
          (Sem=and, Coord=coord, Sub=prop
            ;
            Sem\=and, Coord=cmod, Sub=subord)),
      term_to_atom(Coord-Sub,FunR),
      DepGr=..[FunR,Sem,Gov,Lem],
       \+ dgrs(_,DepGr),
      asserta(dgrs(SentNo,DepGr)),
    !.
assert_cong_and(SentNo,F,And,Gov,Lem):-!.
     

assert_fac_governor(And,F,SentNo,Govern,Clause,Lem1):-
      Clause\=[],
      (M=comp;M=second),
      appiattisci(Clause,Clauses),
      remove(M-AllArgsAdjs, Clauses,_),
      appiattisci(AllArgsAdjs,All),
      All\=[],
      All=[Cl,Lem1-Args|_],
      nonvar(Lem1),
      (atomic(Lem1),Lem=Lem1; Lem1=Lem-_),
      (Govern\=nil,Govern\=Lem, Gov=Govern; Govern=nil,Gov=Lem; Govern=Lem,Gov=Lem),
     nonvar(F),
     (
      (F=dirsp, Sem=nil; F=fac, Sem=that),
      (And=[],
      term_to_atom(ccomp-prop,FunR),
       DepGr=..[FunR,Sem,Gov,Lem1],
       \+ dgrs(_,DepGr),
       asserta(dgrs(SentNo,DepGr)))
       ;
     true),
    !.
assert_fac_governor(And,F,SentNo,Govern,Clause,Lem1):-
     M=main,
      appiattisci(AllArgsAdjs,All),
      All\=[],
      All=[Cl,Lem1-Args|_],
      nonvar(Lem1),
      (atomic(Lem1),Lem=Lem1; Lem1=Lem-_),
      (Govern\=nil,Govern\=Lem, Gov=Govern; Govern=nil,Gov=Lem; Govern=Lem,Gov=Lem),
     !.
assert_fac_governor(And,F,SentNo,Govern,[],Govern):-
     F=fs;F=fc,!.
assert_fac_governor(And,F,SentNo,Govern,Clause,Lem1):-
      F=fac,
      term_to_atom(ccomp-prop,FunR),
       DepGr=..[FunR,that,Lem1,Govern],
       \+ dgrs(_,DepGr),
       asserta(dgrs(SentNo,DepGr)),
     !.

shallow_parsing(N,Disambs, Tags, Ibars, Parse,[_-dirs-_, _-par-_], [],[]):-!.
shallow_parsing(N,Disambs, Tags,  Ibars, Parse,[_-par-_], [],[]):-!.
shallow_parsing(N,Disambs, Tags,  Ibars, Parse,[_-punt-_], [],[]):-!.
shallow_parsing(N,Tensed, Tags,  Head, Parse,Costs, FunctsOut,Clauses):-
   parse_func(Costs, FunctsOut),
   FunctsOut\=[],
   extract_ibars(Ibars, Head),
   assert_dgrs_ibars(N,Ibars),
   extract_arguments_adjuncts(N, Frase, Tags, Ibars, Tensed,FunctsOut, Clauses),
   (Ibars\=[];
      Ibars=[], 
      remove(_-Clause,Clauses,Rest), 
      appiattisci(Clause,Cl), Cl\=[]),
   !.

parse_func(Costs, Out):-
     abolish_ibar,
%     retractall(funcs(ibar,_,_,_)),
     assign_all_functions(Costs, Rest, FunctsOut),
     search_fpp(FunctsOut, Out),
   !.

extract_arguments_adjuncts(N, Frase, Tags, Ibars,Tensed, FunctsOut, Clauses):-
   Ibars\=[],
   splitsentences(1, Ibars, FunctsOut, Clauses), 
   !.

extract_arguments_adjuncts(N, Frase, Tags, [],Tensed, FunctsOut, Clauses):-
   Tensed=[],
   remove(Vcomp,FunctsOut,Args), 
   Vcomp=vcomp-IBar,
%   cl(J), J=0,
   cond_remove_vcomp(FunctsOut,Rest,ibar-IBar,NIBar),
   assert_v_function(NIBar),
   splitsentences(1, [NIBar], Rest, Clauses), 
   !.

extract_arguments_adjuncts(N, Frase, Tags, [],Tensed, FunctsOut, Clauses):-
   Tensed\=[],
   remove(Vcomp,FunctsOut,Args), 
   Vcomp=vcomp-IBar,
%   cl(J), J=0,
   cond_remove_vcomp(FunctsOut,Rest,ibar-IBar,NIBar),
   assert_v_function(NIBar),
   splitsentences(1, [NIBar], Rest, Clauses), 
   !.

extract_arguments_adjuncts(N, Frase, Tags, [],Tensed, FunctsOut, Clauses):-
   Tensed=[],
   IBar=[is-vc-_],
   assert_v_function(_-ibar-IBar),
   append([ibar-IBar], FunctsOut, NFuncts),
   splitsentences(1, [_-ibar-IBar], NFuncts, Clauses), 
   !.

extract_arguments_adjuncts(N, Frase, Tags, [],Tensed, FunctsOut, Clauses):-
   FunctsOut=[fint-Adj|Functs], 
   remove(Vcomp,FunctsOut,Args), 
   Vcomp=ibar-IBar,
   check_auxiliaries_modals(IBar),
   cond_remove_vcomp(Args,Rest,Vcomp,NIBar),
   assert_v_function(NIBar),
   splitsentences(1, [NIBar], FunctsOut, Clauses), 
   !.

extract_arguments_adjuncts(N, Frase, Tags, Ibars,Tensed, FunctsOut, Clauses):-
   Ibars\=[],
   Tensed\=[],
   appiattisci(FunctsOut, Functs),
   length(Functs,L1), 4=<L1,
%   length(Parse1,L), 10=<L,
   IBar=[is-vc-_],
   assert_v_function(_-ibar-IBar),
   append([ibar-IBar], FunctsOut, NFuncts),
   splitsentences(1, [_-ibar-IBar], NFuncts, Clauses), 
   !.
extract_arguments_adjuncts(N, Frase, Tags, Ibar,Tensed, FunctsOut, Clauses):-
   Ibar=[],
   Tensed\=[],
%    remove(F-Parse,FunctsOut, []),
   parse_func(FunctsOut, Functs),
   extract_ibars(Ibars, Head),
   assert_dgrs_ibars(N, Ibars),
   splitsentences(1, Ibars, Functs, Clauses), 
   !.
/*
extract_arguments_adjuncts(N, Frase, Tags, Ibars,Tensed, FunctsOut, Clauses):-
   splitsentences(1, [], FunctsOut, Clauses), 
   !.
*/

check_testa(Testa,Test):-
     atomic(Testa), Test=Testa,!.
check_testa(Testa,Head):-
     list(Testa),
     (Pron=pron;Pron=poss;Pron=deit;Pron=dim),
     remove(Pron,Testa,Tes),
     Tes=[Test|_],
     prendihead(Test, Head),
     !.

prendihead(W, Lem):-
    filter_pron_q(W, Feats, Lem),
    !.

prendihead(W, Lem):-
    filter_pron_q(W, Feats, Lem),
    !.

prendihead(W, Lem):-
    filter_pron(W, Feats, Lem),
    !.

prendihead(W, Lem):-
    filter_pers(W, Feats, Lem),
    !.

prendihead(W, Lem):-
    filter_int(W, Feats, Lem),
    !.

prendihead(W, Lem):-
    filter_pos_ag(W, Feats, Lem),
    !.

prendihead(W, Lem):-
    filter_dim_ag(Pro,Feats, Lem),
    !.
prendihead(W, Lem):-
    spy_lower(Pron, LowW, 1),
    prendihead(LowW, Lem),
    !.

iobj_ncmod(Verbo-Ind, P, obj2, goal):-
     nonvar(P), P=to,
     ntns1(Verbo,to),
     !.
iobj_ncmod(Verbo-Ind, P, iobj, goal):-
     ntns2(Verbo,P),
     !.
iobj_ncmod(Verbo-Ind, P, iobj, Role):-
    cat_gramm(Verbo, CatGr, CatV, LArgsV),
    prep_extr_args(LArgsV, Cues, Role),
    Cues\=[],
    on(P,Cues),!.

iobj_ncmod(Verbo, P, obj2, goal):-
     nonvar(P), P=to,
     ntns1(Verbo,to),
     !.

iobj_ncmod(Verbo, P, iobj, goal):-
     ntns2(Verbo,P),
     !.
iobj_ncmod(Verbo, P, iobj, Role):-
    cat_gramm(Verbo, CatGr, CatV, LArgsV),
    prep_extr_args(LArgsV, Cues, Role),
    Cues\=[],
    on(P,Cues),!.

iobj_ncmod(Verbo, P, ncmod, theme):-!.

current_governor(N,Lem):-
     var(N),
     retract(governor(_,_)),
     ass_index(Cl),
     asserta(governor(1,Lem-Cl)),
     !.
current_governor(N,Lem):-
     nonvar(N),
     retract(governor(_,_)),
     ass_index(Cl),
     asserta(governor(N,Lem-Cl)),
     !.
ass_index(Ind):-
     gen_sym(cl, Ind),
     !.

compute_no_clauses(LCls,LArg):-
    getallibars(RIBars),
    getallvcomps(IBars),
    append(RIBars,IBars,Als),
    Als\=[],
    length(Als,LCls),
    reffuncs(Args),
    Args\=[],
    length(Args,LArgs),
    LArg is LArgs - LCls,
    !.
compute_no_clauses(1,1).

getallibars(RIBars):-
    findall(First, funcs(ibar, K, Head, ibar-First),
       IBars),
    IBars\=[],
    reverse(IBars,RIBars),!.

getallvcomps(IBars):-
    findall(First, funcs(vcomp, K, Head, [vcomp-First]),
       IBars),
     !.

assign_funroles(Ibar,Sub,Lem,Valenz,P):-
   remove(even-_-ibar, Ibar, NIbar),
   assign_funroles(NIbar,Sub,Lem,Valenz,P),
   !.
assign_funroles(Ibar,Sub,Lem,[],P):-
   remove(Avv-avv-ibar, Ibar, NIbar),
   assign_funroles(NIbar,Sub,Lem,[],P),
   !.
assign_funroles(Ibar,Sub,Lem,[],P):-
   remove(Avv-in-ibar, Ibar, NIbar),
   assign_funroles(NIbar,Sub,Lem,[],P),
   !.
assign_funroles(Ibar,Sub,Lem,[],0):-
   remove(Not-neg-ibar, Ibar, NIbar),
   assign_funzrole(NIbar,Sub,Lem,Feats),
   !.
assign_funroles(Ibar,Sub,Lem,[],0):-
   remove(never-avv-ibar, Ibar, NIbar),
   assign_funzrole(NIbar,Sub,Lem,Feats),
   !.
assign_funroles(Ibar,Sub,Lem,[],1):-
   remove(Avv-avv-ibar, Ibar, NIbar),
   assign_funzrole(NIbar,Sub,Lem,Feats),
   !.
assign_funroles(Ibar,Sub,Lem,[],1):-
   remove(_-par-_,Ibar,NIbar),
   assign_funzrole(NIbar,Sub,Lem,Feats),
   !.
assign_funroles(Ibar,Sub,Lem,[],1):-
   assign_funzrole(Ibar,Sub,Lem,Feats),
   !.

assign_funzrole([s_-Cat-_],[vc],is,[sub=cop, pers=3, num=sing]):-!.
   
assign_funzrole([P-p-_, Modal, Verb-Cat-_|_],Sub,Lem,Feats):-
   prendi_lemma(Verb, Sub,Lem,Feats),
    !.

assign_funzrole([P-p-_, Modal, Verb-Cat-_|_],Sub,Lem,Feats):-
   prendi_lemmas(Verb, Sub, Lem, Valez,Feats),
   check_subjects_subs(Valez,Valenz),
   !.

assign_funzrole([P-p-_, Verb-Cat-_|_],Sub,Lem,Feats):-
   prendi_lemma(Verb, Sub,Lem,Feats),
   !.

assign_funzrole([P-p-_, Verb-Cat-_|_],Sub,Lem,Feats):-
   prendi_lemmas(Verb, Sub, Lem, Valez,Feats),
   check_subjects_subs(Valez,Valenz),
   !.

assign_funzrole([Aux-Ca-_, Modal, Verb-Cat-_, Head-Cv-_],Sub,Lem,Feats):-
   (check_auxbe(Ca);check_auxcat(Cat)),
   prendi_lemma(Head, Sub,Lem,Feats),
   !.
assign_funzrole([Modal1-_-_, Modal2-_-_, Head-Cv-_],Sub,Lem,Feats):-
   support(Modal2),support(Modal1),
   prendi_lemma(Head, Sub,Lem,Feats),
   !.
assign_funzrole([Aux-Ca-_, Verb-Cat-_, Head-Cv-_|_],Sub,Lem,Feats):-
   (check_auxbe(Ca);check_auxcat(Cat)),
   \+ check_auxcat(Cv),
   prendi_lemma(Head, Sub,Lem,Feats),
   !.
assign_funzrole([Aux-Ca-_, A-vsup-_, Head-Cat-_],Sub,Lem,Feats):-
   (A=set_to;A=going_to;A=meant_to),
   (check_auxbe(Ca);check_auxcat(Cat)),
   prendi_lemma(Head, Sub,Lem,Feats),
   !.
assign_funzrole([Aux-Ca-_, P-p-_, Head-Cat-_],Sub,Lem,Feats):-
   (check_auxbe(Ca);check_auxcat(Cat)),
   prendi_lemma(Head, Sub,Lem,Feats),
   !.
assign_funzrole([Modal, Verb-Cat-_, Head-Cv-_],Sub,Lem,Feats):-
   (check_auxbe(Cat);check_auxcat(Cat)),
   prendi_lemma(Head, Sub,Lem,Feats),
   !.

assign_funzrole([Modal, Verb-Cat-_|_],Sub,Lem,Feats):-
   prendi_lemma(Verb, Sub,Lem,Feats),
   !.

assign_funzrole([Modal, Verb-Cat-_|_],Sub,Lem,Feats):-
   prendi_lemmas(Verb, Sub, Lem, Valez,Feats),
   check_subjects_subs(Valez,Valenz),
   !.

assign_funzrole([Verb-vin-_],Sub,Lem,Feats):-
   prendi_lemma(Verb, Sub,Lem,Feats),
   !.

assign_funzrole([Verb-vt-_],Sub,Lem,Feats):-
   prendi_lemma(Verb,Sub, Lem,Feats),
   !.

assign_funzrole([Verb-vc-_],Sub,Lem,Feats):-
   prendi_lemma(Verb,Sub, Lem,Feats),
   !.

assign_funzrole([Verb-Cat-_],Sub,Lem,Feats):-
   prendi_lemma(Verb, Sub,Lem,Feats),
   !.

assign_funzrole([Verb-Cat-_],Sub,Verb,Feats):-
   !.

assign_funzrole(Ibar,Sub,Lem,Feats):-
   remove(Avv-avv-_, Ibar, Rest),
   assign_funzrole(Rest,Sub,Lem,Feats),
   !.
assign_funzrole(Ibar,Sub,Lem,Feats):-
   on(Verb-Cat-_, Ibar),
   check_vcat(Cat),
   prendi_lemma(Verb, Sub,Lem,Feats),
   !.
 
assign_funzrole(Verb-Cat-_,Sub,Lem,Feats):-
   prendi_lemmas(Verb, Sub, Lem, Valenz,Feats),
   !.
assign_funzrole(Ibar,Sub,Lem,Feats):-
   on(Verb-Cat-_, Ibar),
   prendi_lemmas(Verb, Sub, Lem, Val,Feats),
   !.

assert_v_function(_-ibar-Rest):-
    assert_copulative(Rest),
     cl(Cl),
    assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    asserta(funcs(ibar, Cl, Lem, First)),
    assert_passive(Rest,Lem),
    assert_dgrs_ibars(N,[Cl-ibar-Rest]),
    !.

assign_vfunction(First, [First]):-
    once(ibar(false)),
    First=ibar-Rest,
    assert_copulative(Rest),
     cl(Cl),
    assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    assert_passive(Rest,Lem),
    asserta(funcs(ibar, Cl, Lem, First)),
    !.

assign_vfunction(First,[vcomp-Rest]):-
    First=sv5-Rest,
    cl(Cl),
     assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    asserta(funcs(vcomp, Cl, Lem, [vcomp-Rest])),
    retractall(ibar),
    assert(ibar(true)),
    (retract(passiv(_)),
     assert(passiv(off))
     ;
     assert(passiv(off))
     ),
    !.

assign_vfunction(First,[vcomp-Rest]):-
    First=sv2-Rest,
    cl(Cl),
     assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    asserta(funcs(vcomp, Cl, Lem, [vcomp-Rest])),
    retractall(ibar),
    assert(ibar(true)),
    (retract(passiv(_)),
     assert(passiv(off))
     ;
     assert(passiv(off))
     ),
    !.

assign_vfunction(First,[vcomp-Rest]):-
    First=sv3-Rest,
    cl(Cl),
     assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    asserta(funcs(vcomp, Cl, Lem, [vcomp-Rest])),
    retractall(ibar),
    assert(ibar(true)),
    (retract(passiv(_)),
     assert(passiv(off))
     ;
     assert(passiv(off))
     ),
    !.

assign_vfunction(First,[vcomp-Rest]):-
    First=vcomp-Rest,
    cl(Cl),
     assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    asserta(funcs(vcomp, Cl, Lem, [vcomp-Rest])),
    retractall(ibar),
    assert(ibar(true)),
    (retract(passiv(_)),
     assert(passiv(off))
     ;
     assert(passiv(off))
     ),
    !.

collect_rel_clause(Cl, FunctsOut, [RestClause|RestClauses], Functss):-
         FunctsOut=[Cl-RestClause|Functs],
         collect_rel_clause(Cl, Functs, RestClauses, Functss),
         !.
collect_rel_clause(Cl, FunctsOut, [], FunctsOut):-!.

reassert_adjunct(Fun-Obl, Fun-FunctsOut):-
   retract(funcs(Fun, K, Head, [Fun-Obl])),
   asserta(funcs(Fun, K, Head, [Fun-FunctsOut])),
   !.
reassert_adjunct(Fun-Obl, Fu-FunctsOut):-
   retract(funcs(Fun, K, Head, [Fun-Obl])),
   asserta(funcs(Fu, K, Head, [Fu-FunctsOut])),
   !.
reassert_adjunct(Fun-Obl, Fu-FunctsOut):-
   cl(K),
   asserta(funcs(Fu, K, Head, [Fu-FunctsOut])),
   !.

verify_verb_rest_all(Rest):-
   appiattisci(Rest,ARest),
   nth(ARest,N,ibar-Vs),
   (nth(ARest,N1,dirsp-_)
    ;nth(ARest,N1,fp-_)),
    N<N1,!.

verify_verb_rest_all(Rest):-
   appiattisci(Rest,ARest),
   nth(ARest,N,ibar-Vs),
   findall(N1,(nth(ARest,N1,dirsp-_)
    ;nth(ARest,N1,fp-_)), Ns),
   Ns=[],
   !.

/*    
verify_verb_rest(F),
 verify_verb_rest([]):-!,fail.
verify_verb_rest([W|F]):-
       find_pos(W, I, X, Si),
       nogen_member(Cat-W,X),
       check_vcat(Cat),
       !.
verify_verb_rest([W|F]):-
     verify_verb_rest(F),!.
*/

consistent_functions(obj,obj).
consistent_functions(obj,obl).
consistent_functions(obj,xcomp).
consistent_functions(xcomp,obj).
consistent_functionss(subj,xcomp).
consistent_functionss(xcomp,subj).

extract_mproperties(SentNo, Mods, NewRefs, NRefs, RelClause):-
   appiattisci(Mods, NMods),
   (Body=[f2-_|_],
     remove(C-Head-Body, NMods, NNMods),
     build_relative_clause(C,Head,NewRefs, Body,RelClause)
     ;
     NNMods=NMods, RelClause=[]),
   extract_properties(SentNo, NNMods, NewRefs, NRefs),!.

build_relative_clause(Ind, Head,NewRefs, Body,[Cl-[Lem-Args-Neg, RefsRel, [IdGov/Ind], [Lem-Aggs]]]):-
   get_id_gov(NoFr,NewRefs, Ind, IdGov),
   Body=[f2-_|VP],
   appiattisci(VP, Vp),
   Vp=[ibar-Ibar|Resto],
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   current_governor(N,Lem),
   on(Ruolo/_,Arg),
   assert_dep_gram_rels(subj,Ruolo,Head),
   create_arguments(N, Ind, Head,Resto, Valenzz, NArg, RefsRel, Aggs),
   append(Arg, NArg, Args),
   !.
build_relative_clause(Ind, Head,NewRefs, Body,[]):-!.

create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg):-
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     assert_passive(Ibar,Lem),
     assert_dgrsibars(N,Lem,Ibar),
    asserta(funcs(ibar, N, Lem, Ibar)),
     maximise_functions(Lem,[],Valenzes, Valenz),
     remove(subj-Role, Valenz, Valenzz),
     Arg=[Role/Ind],
     !.

create_object_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg):-
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     assert_passive(Ibar,Lem),
     assert_dgrsibars(N,Lem,Ibar),
    asserta(funcs(ibar, N, Lem, Ibar)),
     maximise_functions(Lem,[],Valenzes, Valenz),
     remove(obj-Role, Valenz, Valenzz),
     Arg=[Role/Ind],
     !.

assert_verbcompl(N,Lem,Ibar):-
     assert_passive(Ibar,Lem),
     assert_dgrsibars(N,Lem,Ibar),
     !.

extract_atomic_modifiers(Ind, Head, [],[],[]):-!.
extract_atomic_modifiers(Ind, Head, [A-B|Args],[A-B|Resto],Mods):-
     extract_atomic_modifiers(Ind, Head, Args,Resto,Mods),
     !.
extract_atomic_modifiers(Ind, Head, [A|Args],Resto,[Ind-Head-[A]|Mods]):-
     extract_atomic_modifiers(Ind, Head, Args,Resto,Mods),
     !.

eval_relatives(Ibar,C):-
   refsems(Sems),
   on(N-Cl-Sem, Sems),
   Sem=(f2-_),
   NIbar is Ibar - 1,
   NIbar=C,
   !.

recover_relative_clause([], Rels, NRefs, NAggs, Inds, Inds, Rels, NRefs, NAggs):-!.
recover_relative_clause([Cl-[Lem-Arg-Neg, RefsRel, RelInds, Aggs]], Rels, NRefs, NAggs, Inds, NInds, AllRels, AllRef, AllAggs):-
   append([Cl-[Lem-Arg-Neg]], Rels, AllRels),
   append(RefsRel, NRefs, AllRef),
   append(Aggs, NAggs, AllAggs),
   append(RelInds, Inds, NInds),
   !.

analizza_prenominals(Lemma, Tab,[],[],Tab, Ind):-!.

analizza_prenominals(Lemma, Tab,Resto,[Testa|Pren], Tab1, Ind):-
     Resto\=[],
     remove(Testa-Cat-_, Resto, Res),
     anncats(Cat),
     \+ qm(Testa), Testa\=Lemma,
     analizza_prenominals(Lemma, Tab,Res,Pren, Tab1, Ind),
     !.
analizza_prenominals(Lemma, Tab,Resto,[Testa-Cat-_|Pren], Tab1, Ind):-
     Resto\=[],
     remove(Testa-Cat-_, Resto, Res),
     nncats(Cat),
     \+ qm(Testa), Testa\=Lemma,
     analizza_prenominals(Lemma, Tab,Res,Pren, Tab1, Ind),
     !.

analizza_prenominals(Lemma, Tab,Resto,Pren, Tab2, Ind):-
     Resto\=[],
     remove(Testa-Cat-_, Resto, Res),
     Cat=num, Testa\=Lemma,
     remove(nil,Tab, Refs),
     Refs=[Ref,Def,Part|Tabs],
     Tab1=[Ref,Def,Part,Testa|Tabs],
      asserta_det_lemm(Lemma,Ind,Testa),
     analizza_prenominals(Lemma, Tab1,Res,Pren, Tab2, Ind),
     !.

analizza_prenominals(Lemma, Tab,Resto,Pren, Tab2, Ind):-
     Resto\=[],
     remove(Testa-Cat-_, Resto, Res),
     Testa\=Lemma,
     (qcats(Cat);qm(Testa)),
     remove(nil,Tab, Refs),
     Refs=[Ref,Def|Tabs],
     Tab1=[Ref,Def,Testa|Tabs],
     asserta_det_lemm(Lemma,Ind,Testa),
     analizza_prenominals(Lemma, Tab1,Res,Pren, Tab2, Ind),
     !.

analizza_prenominals(Lemma, Tab,Resto,Pren, Tab2, Ind):-
     Resto\=[],
     remove(Testa-Cat-_, Resto, Res),
     Testa\=Lemma,
     (qcats(Cat);qm(Testa)),
     remove(nil,Tab, Refs),
     Refs=[Ref,Def,Quant|Tabs],
     Tab1=[Ref,Def,Quant,Testa|Tabs],
     asserta_det_lemm(Lemma,Ind,Testa),
     analizza_prenominals(Lemma, Tab1,Res,Pren, Tab2, Ind),
     !.

analizza_prenominals(Lemma, Tab,Resto,[Testa-Cat-_|Pren], Tab1, Ind):-
     Resto\=[],
     remove(Testa-Cat-_, Resto, Res),
     analizza_prenominals(Lemma, Tab,Res,Pren, Tab1, Ind),
     !.

analizza_prenominals(Lemma, Tab,Resto,Pren, Tab1, Ind):-
     Resto\=[],
     remove(Testa, Resto, Res),
     Testa\=A-B,
     analizza_prenominals(Lemma, Tab,Res,Pren, Tab1, Ind),
     !.
analizza_prenominals(Lemma, Tab,Resto,Resto, Tab, Ind):-!.

asserta_det_lemm(Lemma,Ind,Testa):-
     list(Ind),
     on(Id,Ind),
     Lemma=..[and|Heads],
     on(Head,Heads),
    governor(N,_),
     DepGr=..[Id, det,Head,Testa],
     asserta(dgrs(N,DepGr)),
     asserta(ref_funcs(det, Ind, Testa, Testa)),
     !.
asserta_det_lemm(Lemma,Ind,Testa):-
     \+ list(Ind),
    governor(N,_),
     DepGr=..[Ind, det,Lemma,Testa],
     asserta(dgrs(N,DepGr)),
     asserta(ref_funcs(det, Ind, Testa, Testa)),
     !.

match_semantics_adjs(nil, CatAdj, NCatAdj,prop):-
     CatAdj\=[],
     nogen_member(C,CatAdj),
     (NCatAdj=CatAdj
     ;
     nonvar(NCatAdj)).
match_semantics_adjs(CatSem, [Ruolo-CatAdj|Rols], NCatAdj, Ruolo):-
     nonvar(CatAdj),
     controlla_cats(CatAdj,CatSem),
     (NCatAdj=CatSem
     ;
     controlla_cats(NCatAdj,CatSem)
     ;
     Ruolo=specif).
match_semantics_adjs(CatSem, [Ruolo-CatAdj|Rols], NCatAdj, Ruol):-
    match_semantics_adjs(CatSem, Rols, CatSem, Ruol).
    
estrai_val(Valenza,Arg):-
     list(Valenza),
     sort(Valenza,Val),
     on(Cat-Asp-Args,Val),
     remove(Cost/F/R/_,Args, Args1),
     (Args1=[], Arg=[F/R]
      ;
      Args1\=[],
      remove(Cost1/F1/R1,Args1, Args2),
      (
       (Cost1=sn;Cost1=sp),
       Arg=[F-R, F1-R1]
       ;
       Cost1\=sn,Cost1\=sp,
       Arg=[F-R, Cost1/F1]       
      )),!.

estrai_val([Valenza|_],Arg):-
     list(Valenza),
     sort(Valenza,Val),
     on(Cat-Asp-Args,Val),
     remove(Cost/F/R/_,Args, Args1),
     (Args1=[], Arg=[F/R]
      ;
      Args1\=[],
      remove(Cost1/F1/R1,Args1, Args2),
      (
       (Cost1=sn;Cost1=sp),
       Arg=[F-R, F1-R1]
       ;
       Cost1\=sn,Cost1\=sp,
       Arg=[F-R, Cost1/F1]       
      )),!.

estrai_val(Val,Arg):-
     on(Cat-Asp-Args,Val),
     remove(_/F/R/_,Args, Args1),
     (Args1=[], Arg=[F/R]
      ;
      Args1\=[],
      remove(Cost1/F1/R1,Args1, Args2),
      (
       (Cost1=sn;Cost1=sp),
       Arg=[F-R, F1-R1]
       ;
       Cost1\=sn,Cost1\=sp,
       Arg=[F-R, Cost1/F1]       
      )).

estrai_val(Val,Vall):-
     list(Val),
     appiattisci(Val,Vall).

estrai_valenz_list(Lem,Costs,Valenzz,Valenz):-
     (Valenzz=[A,B|_],
     (list(B),
%      on(Valenz,Valenzz)
      unify_all_valenz(Lem,Costs,Valenzz,Valenz); 
      \+ list(B), Valenz=Valenzz)
      ;
      Valenzz=[A|_], list(A), 
%       on(Valenz,Valenzz)
      unify_all_valenz(Lem,Costs,Valenzz,Valenz) 
      ;
      Valenzz=[A|_], \+ list(A), 
      Valenz=Valenzz),
      !.


unify_subj([],[]):-!.
unify_subj([[sogg-Role|Valenz]|Rest],[subj-Role|Subjj]):-
      unify_subj(Rest,Subjj),
     !.
unify_subj([sogg-Role|Rest],[subj-Role|Subjj]):-
      unify_subj(Rest,Subjj),
     !.
unify_subj([[subj-Role|Valenz]|Rest],[subj-Role|Subjj]):-
      unify_subj(Rest,Subjj),
     !.
unify_subj([subj-Role|Rest],[subj-Role|Subjj]):-
      unify_subj(Rest,Subjj),
     !.
unify_subj([Rest],Subjj):-
     list(Rest),
      unify_subj(Rest,Subjj),
     !.
unify_subj([_-Role|Rest],Subjj):-
      unify_subj(Rest,Subjj),
     !.
unify_subj(Rest,[]).

unify_internal(Costs,[],[]):-!.
unify_internal(Costs,[[subj-Role|Valenz]|Rest],[Valenz|Intern]):-
      unify_internal(Costs,Rest,Intern),
     !.
unify_internal(Costs,[subj-Role|Rest],Intern):-
      unify_internal(Costs,Rest,Intern),
     !.
unify_internal(Costs,[Rest],Intern):-
     list(Rest),
      unify_internal(Costs,Rest,Intern),
     !.
unify_internal(Costs,[Valenz|Rest],[Valenz|Intern]):-
      unify_internal(Costs,Rest,Intern),
     !.


extract_valenz(SentNo, IBars, [], [], []):-!.
extract_valenz(SentNo, [Ibar|IBars], Args, [Clause|Clauses], [Agg|Aggs]):-
     assign_funz_roles(Ibar,CatV,Lem,Valenza,Neg),
     estrai_val(Valenza,Valenzz),
     estrai_valenz_list(Lem,Args,Valenzz,Valenz),
     costruisci_all_mods_aggs(SentNo, Valenz, Args, Clause, Rest, Agg),
     No is SentNo +1,
     extract_valenz(No, IBars, Rest, Clauses, Aggs),
     !.
extract_valenz(SentNo, [], [vcomp-VComp|Args], [Clause|Clauses], [Agg|Aggs]):-
     assign_funz_roles(VComp,CatV,Lem,Valenza,Neg),
     costruisci_all_mods_aggs(SentNo, Valenza, Args, Clause, Rests, Agg),
     appiattisci(Args,Argg),
     appiattisci(Rests,Rest),
     length(Argg, La),
     length(Rest, Lr),
     No is SentNo +1,
     extract_valenz(No, [], Rest, Clauses, Aggs),
     !.
extract_valenz(SentNo, [], Args, [Clause|Clauses], [Agg|Aggs]):-
     crea_nvalenze(Args, Valenza),
     costruisci_all_mods_aggs(SentNo, Valenza, Args, Clause, Rests, Agg),
     appiattisci(Args,Argg),
     appiattisci(Rests,Rest),
     length(Argg, La),
     length(Rest, Lr),
     (La=Lr,
      Argg=[First|Resto], Resto\=[],
      extract_valenz(SentNo, [], Resto, Clauses, Aggs)
      ;
      La\=Lr,      
      No is SentNo +1,
      extract_valenz(No, [], Rest, Clauses, Aggs)),
     !.
extract_valenz(SentNo, [], [Arg|Rest], Clauses, Aggs):-
     No is SentNo +1,
     extract_valenz(No, [], Rest, Clauses, Aggs),
     !.
extract_valenz(SentNo, [Ibar|IBars], Args, Clauses, Aggs):-
     No is SentNo +1,
     extract_valenz(No, IBars, Args, Clauses, Aggs),
     !.
crea_nvalenze([], []):-!.
crea_nvalenze([subj-SUBJ|Altri], [subj-Ruolo|Valenz]):-
     crea_nvalenze(Altri, Valenz),!.
crea_nvalenze([obj-SUBJ|Altri], [obj-Ruolo|Valenz]):-
     crea_nvalenze(Altri, Valenz),!.
crea_nvalenze([obl-SUBJ|Altri], [obj2-Ruolo|Valenz]):-
     crea_nvalenze(Altri, Valenz),!.
crea_nvalenze([obl-SUBJ|Altri], [obl-Ruolo|Valenz]):-
     crea_nvalenze(Altri, Valenz),!.
crea_nvalenze([SUBJ|Altri], Valenz):-
     crea_nvalenze(Altri, Valenz),!.

cerca_ruolo_valenza(Valenz, Valenza, Ruolo):-
     remove(_-Ruolo, Valenz, Valenza),
     (nonvar(Ruolo),Role=Ruolo;var(Ruolo),Role=actor),
     !.
cerca_ruolo_valenza(Valenz, Valenza, Ruolo):-
     remove(F/Ruolo/_, Valenz, Valenza),
     (nonvar(Ruolo),Role=Ruolo;var(Ruolo),Role=actor),
     !.
costruisci_all_mods_aggs(SentNo, Valenza, [], [], [], []):-!.
costruisci_all_mods_aggs(SentNo, Valenz, [subj-First|Funcs], [SentNo-[Arg]|Args], RArgs, [Mod1|Mods]):-
     Valenz\=[],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     cerca_ruolo_valenza(Valenz, Valenza, Ruolo),
     Arg=ref_ex(Ind,Lemma,Tab,Tratti,CatSem,Mod,sogg/Role),
     Mod1=Ind-Lemma-Mod,
     asserta(ref_funcs(subj, Ind, Lemma, Resto)),
     costruisci_all_mods_aggs(SentNo, Valenza, Funcs, Args, RArgs, Mods),
     !.
costruisci_all_mods_aggs(SentNo, Valenz, [Funz-First|Funcs], Args, RArgs, Mods):-
     Valenz\=[],
     (There=there;There='There'),
     First=[There-ext-sn],
     costruisci_all_mods_aggs(SentNo, Valenz, Funcs, Args, RArgs, Mods),
     !.

costruisci_all_mods_aggs(SentNo, Valenz, [obj-First|Funcs], [SentNo-[Arg]|Args], RArgs, [Mod1|Mods]):-
     Valenz\=[],
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     cerca_ruolo_valenza(Valenz, Valenza, Ruolo),
     Arg=ref_ex(Ind,Lemma,Tab,Tratti,CatSem,Mod,ogg/Role),
     Mod1=Ind-Lemma-Mod,
     asserta(ref_funcs(obj, Ind, Lemma, Resto)),
     costruisci_all_mods_aggs(SentNo, Valenza, Funcs, Args, RArgs,  Mods),
     !.
costruisci_all_mods_aggs(SentNo, Valenza, [obl-First|Funcs], [SentNo-[Arg]|Args], RArgs, [Mod1|Mods]):-
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_role_obls(Head,CatSem,NCatSem,Ruolo),
     Arg=ref_ex(Ind,Lemma,Tab,Tratti,NCatSem,Mod,obl/Ruolo),
     Mod1=Ind-Lemma-Mod,
     asserta(ref_funcs(obl, Ind, Lemma, Resto)),
     costruisci_all_mods_aggs(SentNo, Valenza, Funcs, Args, RArgs, Mods),
     !.
costruisci_all_mods_aggs(SentNo, Valenza, [obl-First|Funcs], [SentNo-[Arg]|Args], RArgs, [Mod1|Mods]):-
     First=[Head-_-_|Rest],
     costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_role_obls(Head,CatSem,NCatSem,Ruolo),
     Arg=ref_ex(Ind,Lemma,Tab,Tratti,NCatSem,Mod,adj/Ruolo),
     Mod1=Ind-Lemma-Mod,
     asserta(ref_funcs(obl, Ind, Lemma, Resto)),
     costruisci_all_mods_aggs(SentNo, Valenza, Funcs, Args, RArgs, Mods),
     !.
costruisci_all_mods_aggs(SentNo, Valenza, [vcomp-First|Funcs], Args, RArgs, Mods):-
     assign_funz_roles(First,CatV,Lem,Valenzz,Neg),
     estrai_val(Valenzz,Valenzs),
     estrai_valenz_list(Lem,[],Valenzs,Valenz),
     remove(subj-_, Valenz, Valen),
     append(Valen, Valenza, Valenzas),
     costruisci_all_mods_aggs(SentNo, Valenzas, Funcs, Args, RArgs, Mods),
     !.
costruisci_all_mods_aggs(SentNo, Valenza, Funcs, [], Funcs, []):-
     !.
costruisci_all_mods_aggs(SentNo, Valenza, [Funz-First|Funcs], Args, RArgs, Mods):-
     costruisci_all_mods_aggs(SentNo, Valenza, Funcs, Args, RArgs, Mods),
     !.

assegna_tab(avv, There,Resto,[-ref,def0,nil,nil|Tab1]):-
     (There=there;There='There'),
     !.

assegna_tab([], Testa,Resto,[Ref,Def,nil,nil|Tab1]):-
    tabella_ref(npro,Testa,Tab),
    Tab=[Ref|Tab1],
    assegna_def(Cat, Resto, Def, Rest),
    !.

assegna_tab(Cat, Testa,Resto,[Ref,Def,nil,nil|Tab1]):-
    atomic(Cat),
    tabella_ref(Cat,Testa,Tab),
    Tab=[Ref|Tab1],
    assegna_def(Cat, Resto, Def, Rest),
    !.

assegna_tab(Cats, Testa,Resto,[Ref,Def,nil,nil|Tab1]):-
    list(Cats),on(Cat,Cats), 
    tabella_ref(Cat,Testa,Tab),
    Tab=[Ref|Tab1],
    assegna_def(Cat, Resto, Def, Rest),
    !.
assegna_def(Cat, Resto, Def, Resto):-
    (Cat=pron; Cat=pers; Cat=poss; Cat=dim; Cat=deit),
    Def= +def,!.

assegna_def(Cat, Resto, Def, Rest):-
    Resto\=[],
    remove(Art-art-_,Resto,Res),
    myparse(Feats, Art, ''),
    (
     on(type=ind, Feats), Def= -def
    ;
     on(type=def, Feats), Def= +def),
    !.
assegna_def(Cat, Resto, def0, Resto).

individuate_mod(Mod):-
     Mod=Mo-_-_,
     jj(Mo),
    !.

individuate_mod(Mod):-
     Mod=Testa-Cat-_,
     prenoms(Mod),
    !.

individuate_mod(Mod):-
     Mod=Mo-_-_,
     ap_engl(Mo,_,_),
    !.
individuate_mod(Mod):-
     Mod=Mo-Cat-_,
     Cat=ng,
    !.
individuate_mod(Mod):-
     atomic(Mod),
    !.
arts(a).
arts(an).
arts(the).

checksubcn_a(Head,P):-
   pred_a(Head,_,Args),
    Args\=[],
   on(sp/obl/Role/Preps/_, Args),
   (list(Preps), on(P, Preps);Preps=P),!.

/*
checksubcn_a(Head,P):-
   check_subcn_role(Ruolo,Head,P,Role),!.
*/
check_subcn_role(Ruolo,Head,P,Role):-
   sbn(Head, Feats),
   on(Obl, Feats),
   on(P, Obl),
   on(Rol, Obl),
   decode_role(Rol, Role),
   !.

check_subcn_role(Ruolo,Head,P,Role):-
    pred_n(Head,_,_,Args),
    Args\=[],
   on(sp/obl/Role/Preps/_, Args),
   on(P, Preps),!.
check_subcn_role(Role,Head,P,Role).
check_subcn_role(Ruolo,Head,P,Ruolo):-
    Ruolo\=specif,!.
check_subcn_role(Ruolo,Head,of,Ruolo):-
    Ruolo=specif,!.

decode_role('pp-loc', locative).
decode_role('pp-tmp', temporal).
decode_role('pp-dir', loc_direct).
decode_role('pp-LOC', locative).
decode_role('pp-TMP', temporal).
decode_role('pp-DIR', loc_direct).

extract_feats_verb(Feat,Mod,Tempo,Pers,Num):-
      nonvar(Feat),
      nogen_member(mood=Mod, Feat),
      nogen_member(tense=Tempo, Feat),
      get_pers_num(Feat,Pers,Num),!.
extract_feats_verb(Feat,Mod,Tempo,Pers,Num):-
      nonvar(Feat),
      nogen_member(mood=base, Feat),
      nogen_member(tense=base, Feat),
      !.
extract_feats_verb(Feat,Mod,Tempo,Pers,Num):-
      nonvar(Feat),
      nogen_member(mood=part, Feat),
      nogen_member(tense=past, Feat),
      !.
extract_feats_verb(Feat,Mod,Tempo,Pers,Num):-
      var(Feat),!.


getclause(N-[F-Res1], Rev, N, F,And):-
     appiattisci(Res1,Res),
    (F=fint;F=cp;F=dirsp;F=fac;F=fc;F=fs;F=f2;F=f),
    (reverse(Res,[fc-[Con-cong-fc]|Re]), Res=[fs-[Co-cosu-fs]|Rev], And=fs-[Co-cosu-fs]
       ;
     reverse(Res,[fs-[Con-cosu-fs]|Re]), Res=[fc-[Co-cong-fc]|Rev], And=fc-[Co-cong-fc]
       ;
     reverse(Res,[fc-[Con-cong-fc]|Re]), And=fc-[Con-cong-fc],reverse(Re,Rev)
       ;
     reverse(Res,[fs-[Con-cosu-fs]|Re]), And=fs-[Con-cosu-fs],reverse(Re,Rev)
       ;
     reverse(Res,[fc-[Con-ccong-fc],fc-[Co-cong-fc]|Re]), And=fc-[Con-ccong-fc],reverse(Re,Rev)
       ;
     reverse(Res,[fc-[Con-ccong-fc]|Re]), And=fc-[Con-ccong-fc],reverse(Re,Rev)
       ;
     reverse(Res,[fac-[nil]|Re]), And=fac-[nil],reverse(Re,Rev)
       ;
     reverse(Res,[fac-[Con-pk-fac]|Re]), And=fac-[Con-pk-fac],reverse(Re,Rev)
       ;
       Res=[fc-[Con-cong-fc]|Rev], And=fc-[Con-cong-fc]
       ;
       Res=[fs-[Con-cosu-fs]|Rev], And=fs-[Con-cosu-fs]
       ;
       Res=[fc-[Con-ccong-fc],fc-[Co-cong-fc]|Rev], And=fc-[Con-ccong-fc]
       ;
       Res=[fc-[Con-ccong-fc]|Rev], And=fc-[Con-ccong-fc]
       ;
       Res\=[A], Rev=Res
       ;
       Res=[A], (A=F-Clause;list(A)), Rev=Res),
   !.
getclause(F-Res1, Rev, N, F,And):-
     appiattisci(Res1,Res),
    (F=fint;F=cp;F=dirsp;F=fac;F=fc;F=fs;F=f2;F=f),
    (reverse(Res,[fc-[Con-cong-fc]|Re]), Res=[fs-[Co-cosu-fs]|Rev], And=fs-[Co-cosu-fs]
       ;
     reverse(Res,[fs-[Con-cosu-fs]|Re]), Res=[fc-[Co-cong-fc]|Rev], And=fc-[Co-cong-fc]
       ;
     reverse(Res,[fc-[Con-cong-fc]|Re]), And=fc-[Con-cong-fc],reverse(Re,Rev)
       ;
     reverse(Res,[fs-[Con-cosu-fs]|Re]), And=fs-[Con-cosu-fs],reverse(Re,Rev)
       ;
     reverse(Res,[fc-[Con-ccong-fc],fc-[Co-cong-fc]|Re]), And=fc-[Con-ccong-fc],reverse(Re,Rev)
       ;
     reverse(Res,[fc-[Con-ccong-fc]|Re]), And=fc-[Con-ccong-fc],reverse(Re,Rev)
       ;
     reverse(Res,[fac-[Con-pk-fac]|Re]), And=fac-[Con-pk-fac],reverse(Re,Rev)
       ;
       Res=[fc-[Con-cong-fc]|Rev], And=fc-[Con-cong-fc]
       ;
       Res=[fs-[Con-cosu-fs]|Rev], And=fs-[Con-cosu-fs]
       ;
       Res=[fc-[Con-ccong-fc],fc-[Co-cong-fc]|Rev], And=fc-[Con-ccong-fc]
       ;
       Res=[fc-[Con-ccong-fc]|Rev], And=fc-[Con-ccong-fc]
       ;
       Res\=[A], Rev=Res
       ;
       Res=[A], (A=F-Clause;list(A)), Rev=Res),
   !.
getclause(F-Res1, Rev, N, F,And):-
     appiattisci(Res1,Res),
    (F=fint;F=cp;F=f3;F=dirsp;F=fac;F=fc;F=fs;F=f2;F=f),
    (reverse(Res,[fc-[and-cong-fc]|Re]), And=fc-[and-cong-fc],reverse(Re,Rev)
       ;
   Res\=[A], Rev=Res),
   !.

getclause(N-Res1, Rev, N, F,And):-
    integer(N),
     appiattisci(Res1,Res),
    (reverse(Res,[fc-[Con-cong-fc]|Re]), Res=[fs-[Co-cosu-fs]|Rev], And=fs-[Co-cosu-fs], F=fs
       ;
     reverse(Res,[fs-[Con-cosu-fs]|Re]), Res=[fc-[Co-cong-fc]|Rev], And=fc-[Co-cong-fc],F=fc
       ;
     reverse(Res,[fc-[Con-cong-fc]|Re]), And=fc-[Con-cong-fc],reverse(Re,Rev),F=fc
       ;
     reverse(Res,[fs-[Con-cosu-fs]|Re]), And=fs-[Con-cosu-fs],reverse(Re,Rev), F=fs
       ;
     reverse(Res,[fc-[Con-ccong-fc],fc-[Co-cong-fc]|Re]), And=fc-[Con-ccong-fc],reverse(Re,Rev), F=fc
       ;
     reverse(Res,[fc-[Con-ccong-fc]|Re]), And=fc-[Con-ccong-fc],reverse(Re,Rev), F=fc
       ;
     reverse(Res,[fac-[Con-pk-fac]|Re]), And=fac-[Con-pk-fac],reverse(Re,Rev), F=f
       ;
       Res=[fc-[Con-cong-fc]|Rev], And=fc-[Con-cong-fc], F=fc
       ;
       Res=[fs-[Con-cosu-fs]|Rev], And=fs-[Con-cosu-fs], F=fs
       ;
       Res=[fc-[Con-ccong-fc],fc-[Co-cong-fc]|Rev], And=fc-[Con-ccong-fc], F=fc
       ;
       Res=[fc-[Con-ccong-fc]|Rev], And=fc-[Con-ccong-fc], F=fc
       ;
       Res\=[A], Rev=Res
       ;
       Res=[A], (A=F-Clause;list(A)), Rev=Res),
   !.

getclause(F-Res1, Rev, N, f,And):-
     appiattisci(Res1,Res),
    (on(ibar-_,Res);on(vcomp-_,Res)),
     reverse(Res,[fac-Fac|_]),
     remove(fac-Fac,Res,Rev),
     And=fac-Fac,
   !.
     
getclause(F-Res1, Rev, N, f,And):-
     appiattisci(Res1,Res),
    (on(ibar-_,Res);on(vcomp-_,Res)),
    (reverse(Res,[fc-[and-cong-fc]|Re]), And=fc-[and-cong-fc],reverse(Re,Rev)
       ;
     Res\=[A], Rev=Res),
   !.
getclause(N-Res1, [], N, F,And):-
    integer(N),
     appiattisci(Res1,Res),
    Res=[F-[Sub-FS]], (Sub=fc;Sub=fs),
    FS=[A], And=fs-FS,!.

sortfclause(Costs, Costs):-!.
sortfclause(Costs, [N-[f-F]|Sorted]):-
    remove(N-[f-F], Costs,Rest),
    F=[ibar-Ibar|_],
    reverse(Ibar, [V-_-_|_]),
    verbs_of_saying(V),
    togli_doppi(Rest,Sorted),
     !.

sortfclause(Costs, [N-[f-F]|Sorted]):-
    remove(N-[f-F], Costs,Rest),
    F=[subj-SN, ibar-Ibar|_],
    reverse(Ibar, [Head-_-_|_]),
    lemmatize_dic_v(Head,Lemma,_),
    coml(Lemma, Subs),
    appiattisci(Subs,Sub),
    (on(fcomp/_,Sub)
     ;
     check_fac_subcat([ibar-Ibar])),
    togli_doppi(Rest,Sorted),
    !.

sortfclause(Costs, [N-[f-F]|Sorted]):-
    remove(N-[f-F], Costs,Rest),
    F=[subj-SN, ibar-Ibar|_],
    aareverse(Ibar, V),
    verbs_of_saying(V),
    togli_doppi(Rest,Sorted),
     !.
sortfclause(Costs, [N-[f-F]|Sorted]):-
    remove(N-[f-F], Costs,Rest),
    F=[subj-Ibar|_],
    togli_doppi(Rest,Sorted),
     !.

sortfclause(Costs, [N-[f-F]|Sorted]):-
    remove(N-[f-F], Costs,Rest),
    togli_doppi(Rest,Sorted),
     !.
sortfclause(Costs, [N-[f-F]|Sorted]):-
    remove([N-[f-F]], Costs,Rest),
    togli_doppi(Rest,Sorted),
     !.

appos_subj(FunctsOu,FunctsOut):-
     FunctsOu\=[],
     findall(Cost,on(subj-Cost,FunctsOu),Costs),Costs=[],
     remove(appos-Cost,FunctsOu,FunctsO),
     nth(FunctsOu, N, appos-Cost),
     subst_appos_subj(N, FunctsOu, FunctsOut),
     !.
appos_subj(FunctsOut,FunctsOut):-
     !.

subst_appos_subj(1, [A-Cos|Rest],  FunctsO):-
    append([subj-Cos], Rest, FunctsO),
     !.
subst_appos_subj(N, [A-Cos|Rest], [A-Cos|FunctsO]):-
    N1 is N - 1,
    subst_appos_subj(N1, Rest, FunctsO),
   !.
     

costruisci_mmod(Mod, Tab, Cat, Lemma, Testa, Resto, Mod, Tab1, Ind):-
     atomic(Testa),
     qcats(Cat),
     (Resto\=[],remove(Testa-Cat-_, Resto, Res)
      ;
       Res=Resto),
     Testa\=Lemma,
     remove(nil,Tab, Refs),
     Refs=[Ref,Def|Tabs],
     Tab1=[Ref,Def,Testa|Tabs],
     governor(N,_),
     DepGr=..[det,Lemma,Testa],
     asserta(dgrs(N,DepGr)),
     asserta(ref_funcs(det, Ind, Testa, Testa)),
     !.

costruisci_mmod(Mod, Tab, Cat, Lemma, Testa, Resto, Mods, Tab1, Ind):-
     atomic(Testa),
     (Resto\=[],remove(Testa-Cat-_, Resto, Res)
      ;
       Res=Resto),
     analizza_prenominals(Lemma, Tab, Res, Pren, Tab1,Ind),
     (Mod\=[],
      Mod\=Pren,
      append([mod-Mod], Pren, Mods)
      ;
      Mods=Pren),
     !.

costruisci_mmod(Mod, Tab, Cat, Lemma, Testa, Resto, Mod, Tab, Ind):-!.

cmod_topic_assert(N,Lem,Arg,Ruolo,Head,Pron,Fun):-    
     nonvar(Head),
   ( Head=Hea-Ind,
      Hea=..[Pref,[Lemma1,Lemma2]]
     ; 
      Head=..[Pref,[Lemma1,Lemma2]], Hea=Head
       ),
   costruisci_coord_lems(Lemma1,Pref,Lemma2,LCoord),
   current_governor(N,Lem),
   on(Ruolo/_,Arg),
   assert_dep_gram_rels(Fun,Ruolo,LCoord),
   Pron=[Pro-_-_],
      term_to_atom(cmod-topic,FunR),
   DepGr=..[FunR,Pro,LCoord,Lem],
   asserta(dgrs(N,DepGr)),
   asserta(ref_funcs(cmod, Ind, Pro, Pro)),
   !.


cmod_topic_assert(N,Lem,Arg,Ruolo,Head,Pron,Fun):-    
   current_governor(N,Lem),
   on(Ruolo/_,Arg),
   assert_dep_gram_rels(Fun,Ruolo,Head),
   (Pron=[Pro-_-_];Pro=nil),
     term_to_atom(cmod-topic,FunR),
   DepGr=..[FunR,Pro,Head,Lem],
   asserta(dgrs(N,DepGr)),
   asserta(ref_funcs(cmod, Ind, Pro, Pro)),
   !.

continue_adjunct_clause(SentNo, IBars, Lem,Clauses,Parent,[AllArgsAdjs|RestClauses]):-
     N1 is SentNo + 1,
     extract_clause(IBars, Parent, Clause, IBar, RestFuncs, RestIbar,Adjs),
     create_clause_fac(N1, IBar, Clause, ArgsAdjs, Mods, NArgs, NewLem-VArgs, Neg),
     AllArgsAdjs=[Neg,NewLem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(N1, NewLem,Adjs,OutAdjs,ModsAdjs),
     append(Mods,ModsAdjs,Modss),
     splitsentences(N1, RestIbar, RestFuncs, RestClauses),
     assert_gr_fac(N1, NewLem,[main-AllArgsAdjs]),
     !.
continue_adjunct_clause(SentNo, IBars, Lem,Clauses,Parent,[RestClauses]):-
     N1 is SentNo + 1,
     splitsentences(N1, IBars, Parent, RestClauses),
     assert_gr_fac(N1, Lem,RestClauses),
     !.
continue_adjunct_clause(SentNo, IBars, Lem,Clauses,Parent,RefsRel):-
    build_adjuncts(SentNo, Lem, Parent,RefsRel,NewLem),
     !.

extract_clauses(SentNo, IBars, [_-FunctsOut], RestF, RestIbar, secnd-AllArgsAdjs):-
     appiattisci(FunctsOut, Functs),
     separate_into_clauses(Functs, First, RestFun),
     Functs\=RestFun,
     findall(I, nogen_member(ibar-I, First), Is), Is=[],
     (
      extract_clause(IBars, RestFun, Clause, IBar, RestFuncs, RestIbar,Adjs),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
      assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
       append(First, RestFuncs, RestF)
       ;
       extract_clauses(SentNo, IBars, RestFun, RestFuncs, RestIbar,AllArgsAdjs),
      assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      Modss=ModsAdjs,
      AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
      append(First, RestFuncs, RestF)
      ),      
     !.

extract_clauses(SentNo, [Ibar|IBars], FunctsOut, RestFun, IBars, secnd-AllArgsAdjs):-
     appiattisci(FunctsOut, Functs),
     separate_into_clauses(Functs, Clause, RestFun),
     nogen_member(ibar-_, Clause),
     IBar=ibar-Verbs,
     remove(IBar,Clause,Args), 
     Ibar=_-ibar-Verbs,
     create_clause_fac(SentNo, Verbs, Args, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
     !.
extract_clauses(SentNo, [Ibar], FunctsOut, RestFun, IBars, secnd-AllArgsAdjs):-
     appiattisci(FunctsOut, Functs),
     separate_into_clauses(Functs, Clause, RestFun),
     nogen_member(ibar-_, Clause),
     remove(IBar,Clause,Args), 
     Ibar=_-ibar-Verbs,
     IBar=ibar-Verbs,
     create_clause_fac(SentNo, Verbs, Args, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
     !.


extract_clauses(SentNo, IBars, [Fu|FunctsOut], Funcs, Ibar,ArgsAdjs):-
     extract_clauses(SentNo, IBars, FunctsOut, Funcs, Ibar,ArgsAdjs),
     !.

extract_clause([], FunctsOut, Args, Verbs, RestFuncs, [],Adjs):-
    remove(F-Sent,FunctsOut, RestFuncs),
    separate_into_clauses(Sent, Clause, RestFunc),
    IBar=ibar-Verbs,
    remove(IBar,Clause,ArgsAll), 
    (ArgsAll\=[]; ArgsAll=[], checktransit(Verbs)),
    check_args_sems(ArgsAll,Args,Adjs),
    !.

extract_clause([], FunctsOut, Args, Verbs, RestFuncs, [],Adjs):-
    remove(F-Sent,FunctsOut, RestFuncs),
    Sent\=[],
    separate_into_clauses(FunctsOut, Clause, RestFunc),
    IBar=ibar-Verbs,
    remove(IBar,Clause,ArgsAll), 
    (ArgsAll\=[]; ArgsAll=[], checktransit(Verbs)),
    check_args_sems(ArgsAll,Args,Adjs),
    !.


extract_clause([Ibar|IBars], FunctsOut, ArgsA, Verbs, Fc, IBars,Adjss):-
    Ibar\=[],Ibar=_-ibar-Verbs,
    nonvar(Verbs),
    on(ibar-Verbs,FunctsOut),
    findall(F, on(fc-F, FunctsOut), Fs),
    appiattisci(Fs,Fc),
    Fc\=[],
    separate_into_clauses(FunctsOut, Clause, RestFu),
    Ibar1=_-ibar-Verbs1,
    IBars\=[],
    remove(Ibar1,IBars,_),
    IBar1=ibar-Verbs1,
    remove(IBar1,Fc,ArgsAll), 
    check_args_sems(ArgsAll,Args,Adjs),
    check_clause_wellformedness(Args,FunctsOut,NewArgs),
    IBar=ibar-Verbs,
    remove(IBar,Clause,ArgsA), 
    (remove(fc-Fc, RestFu,Rest),
        (Rest=[], Adjss=Adjs; 
          Rest\=[], append(Rest,Adjs,Adjss))
      ;
       append(RestFu,Adjs,Adjss)),
    !.

extract_clause([Ibar|IBars], FunctsOut, ArgsA, Verbs, NewArgs, IBars,Adjs):-
    Ibar\=[],Ibar=_-ibar-Verbs,
    nonvar(Verbs),
    remove(fc-F, FunctsOut, FunctsOu),
    on(ibar-Verbs,F),
    findall(F, on(fc-F, FunctsOut), Fs),
    appiattisci(Fs,Fc),
    Fc\=[],
    separate_into_clauses(FunctsOut, Clause, RestFu),
    Ibar1=_-ibar-Verbs1,
    IBars\=[],
    remove(Ibar1,IBars,_),
    IBar1=ibar-Verbs1,
    remove(IBar1,Fc,ArgsAll), 
    check_args_sems(ArgsAll,Args,Adjs),
    check_clause_wellformedness(Args,FunctsOut,NewArgs),
    IBar=ibar-Verbs,
    remove(IBar,Clause,ArgsA), 
    !.

extract_clause([Ibar|IBars], FunctsOut, ArgsA, Verb, NewArgs, IBars,Adjs):-
    IBars\=[],
    on(IBar,IBars),
    IBar=_-ibar-Verbs,
    nonvar(Verbs),
    remove(fc-F, FunctsOut, FunctsOu),
    nth(FunctsOut,N,ibar-Verbs),
    N1 is N - 1,
    nth(FunctsOut,N1,fc-F),
    reverse(FunctsOut,RevFunctsOut),
    separate_into_clauses(RevFunctsOut, Clause, RestFunc),
    reverse(Clause,RevClause),
    IBa=ibar-Verbs,
    remove(IBa,RevClause,ArgsAll), 
    check_args_sems(ArgsAll,Args,Adjs),
    check_clause_wellformedness(Args,FunctsOut,NewArg),
    append([IBa],NewArg,NewArgs),
    reverse(RestFunc,RestFuncss),
    evaluate_rest_adjs(RestFuncss,RestFuncs,Adjs),
    Ibar\=[],Ibar=_-ibar-Verb,
    IBarr=ibar-Verb,
    remove(IBarr,RestFuncs,ArgsA), 
    !.

extract_clause([Ibar|IBars], FunctsOut, Args, Verbs, RestFuncs, IBars,Adjs):-
    Ibar\=[],
    separate_into_clauses(FunctsOut, Clause, RestFuncs),
    Ibar=_-ibar-Verbs,
    IBar=ibar-Verbs,
    remove(IBar,Clause,ArgsAll), 
    (ArgsAll\=[]; ArgsAll=[], checktransit(Verbs)),
    check_args_sems(ArgsAll,Args,Adjs),
    !.
extract_clause([Ibar], FunctsOut, Args, Verbs, RestFuncs, [],Adjs):-
    Ibar\=[],
    separate_into_clauses(FunctsOut, Clause, RestFuncs),
    Ibar=_-ibar-Verbs,
    IBar=ibar-Verbs,
    remove(IBar,Clause,ArgsAll), 
    (ArgsAll\=[]; ArgsAll=[], checktransit(Verbs)),
    check_args_sems(ArgsAll,Args,Adjs),
    !.

extract_clause([Ibar|IBars], FunctsOut, Args, Verbs, RestFuncs, Iba,Adjs):-
    Ibar\=[],
    IBars\=[],
    extract_clause(IBars,FunctsOut, Args, Verbs, RestFuncs, IBarss,Adjs),
    (Args\=[]; Args=[], checktransit(Verbs)),
    append([Ibar],IBarss,Iba),
    !.

extract_clause([Ibar|IBars], FunctsOut, NewArgs, Verbs, RestFuncs, IBarss,Adjs):-
    Ibar\=[], IBars=[],
    Ibar=_-ibar-Verbs,
    nonvar(Verbs),
    on(ibar-Verbs,FunctsOut),
    nth(FunctsOut,N,ibar-Verbs),
    findall(F, (on(f3-F, FunctsOut);on(fp-F, FunctsOut);on(fc-F, FunctsOut)), Fs),
    Fs\=[], length(Fs,L), 2<L,
    nth(FunctsOut,N1,fc-F),
    N1<N,
    reverse(FunctsOut,RevFunctsOut),
    separate_into_clauses(RevFunctsOut, Clause, RestFunc),
    reverse(Clause,RevClause),
    Ibar=_-ibar-Verbs,
    IBar=ibar-Verbs,
    remove(IBar,RevClause,ArgsAll), 
    check_args_sems(ArgsAll,Args,Adjs),
    check_clause_wellformedness(Args,FunctsOut,NewArgs),
    reverse(RestFunc,RestFuncss),RestFuncss\=[],
    findall(Verbs, on(ibar-Verbs,RestFuncss), Re), Re=[],
    append([IBar],RestFuncss, RestFuncs),
    append([Ibar],IBars, IBarss),
    !.

extract_clause([Ibar|IBars], FunctsOut, NewArgs, Verbs, RestFuncs, IBars,Adjs):-
    Ibar\=[],Ibar=_-ibar-Verbs,
    nonvar(Verbs),
    on(ibar-Verbs,FunctsOut),
    findall(F, (on(f3-F, FunctsOut);on(fp-F, FunctsOut)), Fs),
    Fs\=[],
    reverse(FunctsOut,RevFunctsOut),
    separate_into_clauses(RevFunctsOut, Clause, RestFunc),
    reverse(Clause,RevClause),
    Ibar=_-ibar-Verbs,
    IBar=ibar-Verbs,
    remove(IBar,RevClause,ArgsAll), 
    check_args_sems(ArgsAll,Args,Adjs),
    check_clause_wellformedness(Args,FunctsOut,NewArgs),
    reverse(RestFunc,RestFuncss),RestFuncss\=[],
    evaluate_rest_adjs(RestFuncss,RestFuncs,Adjs),
    !.

extract_clause([Ibar|IBars], FunctsOut, NewArgs, Verbs, RestFuncs, IBars,Adjs):-
    Ibar\=[],Ibar=_-ibar-Verbs,
    nonvar(Verbs),
    on(ibar-Verbs,FunctsOut),
    nth(FunctsOut,N,ibar-Verbs),
    findall(F, on(fc-F, FunctsOut), Fs),
    Fs\=[],
    N1 is N - 1,
    nth(FunctsOut,N1,fc-F),
    reverse(FunctsOut,RevFunctsOut),
    separate_into_clauses(RevFunctsOut, Clause, RestFunc),
    reverse(Clause,RevClause),
    IBar=ibar-Verbs,
    remove(IBar,RevClause,ArgsAll), 
    Ibar=_-ibar-Verbs,
    check_args_sems(ArgsAll,Args,Adjs),
    check_clause_wellformedness(Args,FunctsOut,NewArgs),
    reverse(RestFunc,RestFuncss),
    evaluate_rest_adjs(RestFuncss,RestFuncs,Adjs),
    !.

checktransit(Verbs):-
    reverse(Verbs,[Verb-_-_|_]),
    v(Verb,Trans),
    (on(i,Trans);on(ti,Trans)),
    !.
evaluate_rest_adjs(RestFuncs,RestFuncs,Adjs):-
    on(subj-Verbs,RestFuncs),!.
evaluate_rest_adjs(RestFuncs,RestFuncs,Adjs):-
    on(ibar-Verbs,RestFuncs),!.
evaluate_rest_adjs(RestFuncs,RestFuncs,Adjs):-
    on(vcomp-Verbs,RestFuncs),!.
evaluate_rest_adjs(RestFuncs,[],RestFuncs):-!.

/***************
asserisci(+NoFr, +SnIndex, +Fact)
== Asserisce fatti relativi a individui. In confer_infon/4 viene tenuta traccia della relazione tra un infon e la frase e nodo proposizionale da cui  stato estratto. 
***************/
asserisci(NoFr, SnX, Fact) :-
   gen_sym(infon, Id),
   frase_corrente(NoFr,_),
   Fact=..[Pred | Args],
   FactId=..[Pred, Id | Args],
   nonvar(Pred),
   assert(FactId),
   sn_prop_node(SnX, PropNode),
   assert(confer_infon(Id, NoFr, SnX, PropNode, secondary)).

asserisci_topic(NoFr, Type, Ind, SnX) :-
   nonvar(Ind), nonvar(SnX),
   assert(topic(NoFr, Type, Ind)),
   sn_prop_node(SnX, PropNode),
   assert(confer_topic(NoFr, Type, Ind, SnX, PropNode)),
   !.

asserisci_topic(NoFr, Type, Ind, SnX) :-
   nonvar(Ind), var(SnX),
   assert(topic(NoFr, Type, Ind)),
   assert(confer_topic(NoFr, Type, Ind, nil, PropNode)),
   !.
asserisci_topic(_, _, _, _) .

main_or_expect(NoFr, Topic) :-
   topic(NoFr, Type, Topic),
   (Type=main; Type=expected; Type=secondary).

check_upper_case(Surn,NSurn):-
    frase_corrente(NoFr, File),
    (NoFr=1,
     spy_lower(Surn, LowW, 1),
     NSurn=LowW
     ;
     NSurn=Surn
    ),!.   


quantif(Testa):-
    quant(Testa,_,_,_,_).

match_default_cats(Cats,DefCat):-
   turn_up_wn(DefCat, SCats),
%   c_translwncats(SCats, CatSem, _),
   controlla_cats(Cats,SCats),
   !.

recover_modifiers(Mods, SnX, Mod):-
      on(SnX-Testa-Mod, Mods),
      !.
recover_modifiers(Mods, SnX, Mod):-
      on(ref_ex(SnX,Testa,Tab,Pers,Gen,Num,Cat, Mod,F/Role)/S,Mods),
      !.
recover_modifiers(Mods, SnX, []).

verify_coord_structs(Clause, [fc-[and-cong-fc]|RestClause],NewClause,[]):-
     on(ibar-_,Clause),
     findall(V,(on(ibar-V,RestClause);on(vcomp-V,RestClause)),Vs),
        Vs=[],
     reverse(Clause,[Fun-Cost|RevClause]),
     Fun=xcomp,
     (on(_-ag-_,Cost),
     append(Cost,[and-cong-fc],NewCost),
     RestClause\=[], RestClause=[F-C|Res],
     append(NewCost,C,RCost),
     append(RCost,Res,RevCost),
     append([F-RevCost],RevClause,Rev)
      ;
      on(_-Cat-_,Cost),Cat\=ag,
     append(Cost,[and-cong-fc],NewCost),
     append(NewCost,RestClause,RevCost),
     append([Fun-RevCost],RevClause,Rev)),
     reverse(Rev,NewClause),
     !.
verify_coord_structs(Clause, [fc-[and-cong-fc]|RestClause],NewClause,Restc):-
     on(ibar-_,Clause),
     findall(V,(on(ibar-V,RestClause);on(vcomp-V,RestClause)),Vs),
       Vs=[],
     reverse(Clause,[Fun-Cost|RevClause]),
     Fun\=xcomp,Fun\=obl,
     append(Cost,[and-cong-fc],NewCost),
     RestClause=[F-C|Rest],
     (Rest=[],
      append(NewCost,RestClause,RevCost), Restc=[]
      ;
      append(NewCost,[F-C],RevCost), F=ibar, Restc=Rest
      ;
      F=f3, Restc=Rest, RevCost=Cost),
     append([Fun-RevCost],RevClause,Rev),
     reverse(Rev,NewClause),
     !.

verify_coord_structs(Clause, Rest,Clause,Rest):-!.

separate_into_clauses(NPs, NewClause, Rest):-
    separate_clause(0,NPs, Clause, RestClause),
    Clause\=[],
    extract_direct_speech(Clause,RestClause,NewCl,ResCl),
    verify_coord_structs(NewCl,ResCl,NewClause,Rest),
    !.

separate_clause(N,[], [], []):-!.
separate_clause(0,[Cost|NPs], [Cost|Clause], RestClause):-
    separate_clause(1,NPs, Clause, RestClause),
    nogen_member(ibar-_, Clause),
    !.
separate_clause(0,[Cost|NPs], NewClauses, RestCl):-
    separate_clause(1,NPs, Clause, RestClause),
    findall(ibar, nogen_member(ibar-_, Clause), I), I=[],
    nogen_member(ibar-_, RestClause),
    (Fs=fs-Body;Fs=fc-Body),
    remove(Fs, NPs, NPnew), 
    separate_clause(1,[Cost|NPnew], Clauses, RestCl),
    append(Clauses,[Fs],NewClauses),
    !.
separate_clause(N,[Cost|NPs], [Cost|Clause], RestClause):-
    Cost=ibar-VerbComplex,
    N1 is N + 1,
    separate_clause(N1,NPs, Clause, RestClause),
    !.
separate_clause(N,[Cost,As|NPs], [Cost,As|Clause], RestClause):-
    0 < N,
    Cost\=fs-Conj,
    Cost\=dirsp-Conj,
    Cost\=fc-Punt,
    Cost\=f3-Punt,
    Cost\=_-punt-_,
    As=fs-[as-cosu-fs],
    separate_clause(N,NPs, Clause, RestClause),
    !.

separate_clause(N,[Cost|NPs], [Cost|Clause], RestClause):-
    0 < N,
    Cost\=fs-Conj,
    Cost\=dirsp-Conj,
    Cost\=fc-Punt,
    Cost\=f3-Punt,
    Cost\=_-punt-_,
    separate_clause(N,NPs, Clause, RestClause),
    !.
separate_clause(N,[Cost|NPs], [], [Cost|NPs]):-
%    1 < N,
    0 < N,
    (
    Cost=fs-Conj;
     Cost=fc-Conj),
%     Cost=_-punt-_),
     !.

separate_clause(N,[Cost|NPs], [], NPs):-
    0 < N,
    (Cost=_-punt-_;
     Cost=f3-Punt;
     Cost=dirsp-Punt;
     Cost=fc-Conj;
     Cost=fp-Punt),
    on(ibar-VerbComplex,NPs),
    verbless_par(Cost,NPs), 
    !.
separate_clause(N,[Cost|NPs], Clause, RestClause):-
    0 < N,
    (Cost=_-punt-_;
     Cost=f3-Punt;
     Cost=fp-Punt),
    separate_clause(N,NPs, Clause, RestClause),
    length(NPs,L), L=<4,
    !.

separate_clause(N,Cost, [], Cost):-!.

reorder_words(NuoFrase,[],[]):-!.
reorder_words(NuoFrase,[A],[A]):-!.
reorder_words(NuoFrase,[A,B|Out],[A|Outt]):-
    on(N-[_-A|_],NuoFrase),
    on(N1-[_-B|_],NuoFrase),
    N<N1,(N1 is N + 1;N1 is N + 2),
    reorder_words(NuoFrase,[B|Out],Outt),
     !.
reorder_words(NuoFrase,[A,B|Out],Outt):-
    on(N-[_-A|_],NuoFrase),
    on(N1-[_-B|_],NuoFrase),
    N1<N,(N is N1 + 1;N is N1 + 2),
    reorder_words(NuoFrase,[B,A|Out],Outt),
     !.
/*
reorder_words(NuoFrase,[A,B|Out],[A|Outt]):-
    on(N-[_-A|_],NuoFrase),
    (contr(W, Cat, F, A);
     soggcontr(W, Cat, F, A);
      contr(W, Cat, F, B);
      soggcontr(W, Cat, F, B)),
    reorder_words(NuoFrase,[B|Out],Outt),
     !.
*/
reorder_words(NuoFrase,[A,B|Out],[A,C|Outt]):-
    on(N-[_-W|_],NuoFrase),
    contr(W, Cat, F, A),
    (B=not, Outs=Out, C=B;
      remove(not,Out,Ou), Outs=[B|Ou], C=not
     ),
    reorder_words(NuoFrase,Outs,Outt),
     !.

reorder_words(NuoFrase,[A,B|Out],[A,B|Outt]):-
    on(N-[_-W|_],NuoFrase),
    soggcontr(W, Cat, A, B),
    reorder_words(NuoFrase,Out,Outt),
     !.

reorder_words(NuoFrase,[A|Out],[A|Outt]):-
    \+ on(N-[_-A|_],NuoFrase),
    nt(A),
    reorder_words(NuoFrase,Out,Outt),
     !.
reorder_words(NuoFrase,[A|Out],[A|Outt]):-
    \+ on(N-[_-A|_],NuoFrase),
    recover_descs(A,Pre),
    on(A1,Pre),on(A2,Pre),A1\=A2,
    on(N-[_-A1|_],NuoFrase),
    on(N1-[_-A2|_],NuoFrase),
    N1<N,
    reorder_words(NuoFrase,Out,Outt),
     !.
reorder_words(NuoFrase,[A|Out],[A|Outt]):-
    on(N-[_-A|_],NuoFrase),
    reorder_words(NuoFrase,Out,Outt),
     !.
reorder_words(NuoFrase,[A|Out],[A|Outt]):-
    spy_lower(A,LowA,P),P=1,
    on(N-[_-LowA|_],NuoFrase),
    reorder_words(NuoFrase,Out,Outt),
     !.
nreorder_words([],[]):-!.
nreorder_words([N-[_-LowA|_]|NuoFrase],[A|Outt]):-
    nreorder_words(NuoFrase,Outt),
     !.


recover_head_lems(Out,Outs):-
    findall_poss(NuoFrase),
    nreorder_words(NuoFrase,Outt),
    associate_lems(Outt,Outs),
     !.

associate_lems([],[]):-!.
associate_lems([V|Out],[V-Le|Outs]):-
     funcs(ibar, N, Lem, V1),
     nonvar(V1),V=V1,
     (Lem=A-B, Le=A;Lem\=A-B,Le=Lem),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],[V-Le|Outs]):-
     funcs(ibar, N, Lem, Ibar),
     greplem(V,Ibar,V),
     (Lem=A-B, Le=A;Lem\=A-B,Le=Lem),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],[V-Le|Outs]):-
     ref_funcs(Fun, N, Lem, V1),
     nonvar(V1),V=V1,
     (Lem=A-B, Le=A;Lem\=A-B,Le=Lem),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],[V-Le|Outs]):-
     ref_funcs(Fun, N, V, Cost),
     (V=Lem;greplem(V,Cost,Lem)),
     (Lem=A-B, Le=A;Lem\=A-B,Le=Lem),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],[V-V|Outs]):-
    (grammw(V,S)
     ;
     grw(V);
     fct(V)),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],[V-Lem|Outs]):-
     ref_funcs(Fun, N, Lem, Ibar),
     Fun\= ibar,
     greplem(V,Ibar,V),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],[V-L|Outs]):-
     lemmatize_dic(V,L,S),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],Outs):-
    spy_lower(V,LowA,P),P=1,
    associate_lems([LowA|Out],Outs),
    !.
associate_lems([V|Out],[V-V|Outs]):-
     funcs(Fun, N, Lem, Ibar),
     Fun\= ibar,
     greplem(V,Ibar,V),
    associate_lems(Out,Outs),
    !.
associate_lems([V|Out],[V-V|Outs]):-
    associate_lems(Out,Outs),
    !.

greplem(V,_-Ibar, V):- 
     nonvar(Ibar),Ibar\=[],
     on(V-_-_,Ibar),
     !.
greplem(V,Ibar, V):-
     \+ on(_-A,Ibar),
     list(A)
      ;
     nonvar(Ibar),Ibar\=[],
     on(V-_-_,Ibar),
     !.
greplem(V,Ibar, L):- 
     nonvar(Ibar),Ibar\=[],
     remove(_-A,Ibar,Rest),
     list(A),
     greplem(V,Rest,L),
     !.
greplem(V,[H-Ibar],V):-
     nonvar(H),list(Ibar),
     on(V-_-_,Ibar),
     !.

assert_dgrs_ibars(N,[]):-!.
assert_dgrs_ibars(N,[Cl-ibar-Ibar|Ibars]):-
     funcs(ibar, Cl, Lem, ibar-Ibar),
     assert_dgrsibars(N,Lem,Ibar),
     assert_dgrs_ibars(N,Ibars),
     !.
assert_dgrs_ibars(N,[Cl-ibar-Ibar|Ibars]):-
     assert_dgrs_ibars(N,Ibars),
     !.


assert_dgrsibars(N,Lem,[]):-!.
assert_dgrsibars(N,Lem,[Neg-neg-_|Ibar]):-
     DepGr=..[neg,Lem,Neg],
     asserta(dgrs(N,DepGr)),
     asserta(funcs(ibar, N, Neg, Neg)),
     assert_dgrsibars(N,Lem,Ibar),
     !.

assert_dgrsibars(N,Lem,[even-_-_|Ibar]):-
     term_to_atom(adj-mod,FunR),
     DepGr=..[FunR,Lem,even],
     asserta(dgrs(N,DepGr)),
     asserta(funcs(ibar, N, even, even)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-Cat-_|Ibar]):-
     contr(V, V1),
     DepGr=..[neg,Lem,not],
     asserta(dgrs(N,DepGr)),
     asserta(funcs(ibar, N, not, not)),
     assert_dgrsibars(N,Lem,[V1-Cat-_|Ibar]),
     !.
assert_dgrsibars(N,Lem,[V-_-_|Ibar]):-
     coplbh(V),
     \+ coplbh(Lem),
     aux(V, Aux, _, _, _, _),
     Aux=be,
     on(Verb-_-_, Ibar),
     Verb\=Lem,
     stringof(Gerund,Verb),
     reverse(Gerund, [g,n,i|_]),
     DepGr=..[progr,Lem,Verb],
     asserta(dgrs(N,DepGr)),
     DepGr1=..[aux,Lem,V],
     asserta(funcs(ibar, N, Aux, V)),
     asserta(dgrs(N,DepGr1)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-_-_|Ibar]):-
     coplbh(V),
     \+ coplbh(Lem),
     aux(V, Aux, _, _, _, _),
     Aux=be,
     on(Verb-_-_, Ibar),
     Verb\=Lem,
     (Verb=set_to;Verb=going_to;Verb=meant_to),
     DepGr=..[progr,Lem,Verb],
     asserta(dgrs(N,DepGr)),
     DepGr1=..[aux,Lem,V],
     asserta(funcs(ibar, N, Aux, V)),
     asserta(dgrs(N,DepGr1)),
     assert_dgrsibars(N,Lem,Ibar),
     !.

assert_dgrsibars(N,Lem,[V1-_-_, V2-_-_|Ibar]):-
     coplbh(V1),
     coplbh(V2),
     \+ coplbh(Lem),
     aux(V1, Aux1, _, _, _, _),
     aux(V2, Aux2, _, _, _, _),
     DepGr1=..[aux,Lem,V1],
     asserta(funcs(ibar, N, Aux1, V1)),
     DepGr2=..[aux,Lem,V2],
     asserta(funcs(ibar, N, Aux2, V2)),
     asserta(dgrs(N,DepGr1)),
     asserta(dgrs(N,DepGr2)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-_-_|Ibar]):-
     coplbh(V),
     \+ coplbh(Lem),
     aux(V, Aux, _, _, _, _),
     DepGr=..[aux,Lem,V],
     asserta(funcs(ibar, N, Aux, V)),
     asserta(dgrs(N,DepGr)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-_-_|Ibar]):-
     coplbh(V),
     Lem=do,
     aux(V, Aux, _, _, _, _),
     DepGr=..[aux,Lem,V],
     asserta(funcs(ibar, N, Aux, V)),
     asserta(dgrs(N,DepGr)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-_-_|Ibar]):-
     support(V),
     modal(V, Aux, _, _, _, _),
     DepGr=..[modal,Lem,V],
     asserta(funcs(ibar, N, Aux, V)),
     asserta(dgrs(N,DepGr)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
 
assert_dgrsibars(N,Lem,[In-in-_,V-avv-_|Ibar]):-
     term_to_atom(adj-mod,FunR),
     DepGr=..[FunR,Lem,V],
     asserta(funcs(ibar, N, In, In)),
     asserta(dgrs(N,DepGr)),
     DepGr1=..[FunR,V,In],
     asserta(funcs(ibar, N, V, V)),
     asserta(dgrs(N,DepGr1)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[Sem-avv-_|Ibar]):-
     negcongs(Sem),
     DepGr=..[neg,Lem,Sem],
     asserta(funcs(ibar, N, Sem, Sem)),
     asserta(dgrs(N,DepGr)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-avv-_|Ibar]):-
     term_to_atom(adj-mod,FunR),
     DepGr=..[FunR,Lem,V],
     asserta(funcs(ibar, N, V, V)),
     asserta(dgrs(N,DepGr)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-cong-_|Ibar]):-
     DepGr=..[adj,Lem,V],
     asserta(funcs(ibar, N, V, V)),
     asserta(dgrs(N,DepGr)),
     assert_dgrsibars(N,Lem,Ibar),
     !.
assert_dgrsibars(N,Lem,[V-_-_|Ibar]):-
     assert_dgrsibars(N,Lem,Ibar),
     !.



assign_complements(Sec,Rest, Sints, FunctsOut):-
     assign_ofunction(Sec, Ogg),
     assignfunctions(Rest, Sints, FunctsOu),
     append(Ogg,FunctsOu,FunctsOut),
     !.
assign_complements(Sec, Rest, Sints, FunctsOut):-
     assignfunctions([Sec|Rest], Sints, FunctsOut),
     !.

check_ibar_feats_head([],First):-!.
check_ibar_feats_head(VP,First):-
     VP=[f2-_, subj-_, ibar-Ibar|_],
     !.

check_ibar_feats_head(VP,First):-
     VP=[subj-_, ibar-Ibar|_],
     !.

check_ibar_feats_head(VP,First):-
     on(ibar-Ibar,VP),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     search_ibar_tensed(Ibar,Verb),
     assign_funz_role(Verb,Sub,Lem,Valenz,[_-Feats]),
     (Feats\=[], 
      !,
      check_match_tratti(Tratti, Feats)
      ;
      Feats=[],Verb=[V-_-_],
      lemmatize_dic_v(V,K,L),
      (L=[];L\=[],L\=s,(L=d;L=g))
       ),
     !.

check_ibar_feats_head(VP,First):-!.

evaluate_nominal_compls([SN-Sec], [f2-[f2-[that-rel-f2]|Rest]], [fac-[fac-[that-rel-f2]|Rest]]):-
   (SN=obl;SN=sn;SN=subj),
   aareverse(Sec,Head),
   check_subcn_factive(Head),
   !.

evaluate_nominal_compls(Sec, Functs, Functs):-
   Sec=[SN-_], SN\=ibar, !.

costruisci_coord_lems(Lemma,Pref,Tes,Coord):-
     Tes=..[Pre,[Fir,Sec]],
     Sec=..[Pre1,[Fir1,Sec1]],
     mcon(Lemma,'_', L1),
     mcon(L1,Pref,L2),
     mcon(L2,'_',L3),
     mcon(L3,Fir,L4),
     mcon(L4,'_',L33),
     mcon(L33,Pre,L5),
     mcon(Fir1,'_', L11),
     mcon(L11,Pref1,L22),
     mcon(L22,'_',L13),
     mcon(L13,Fir1,L44),
     mcon(L44,'_',L6),
     mcon(L6,Sec1,Coord),
     !.

costruisci_coord_lems(Lemma,Pref,Tes,Coord):-
     Tes=..[Pre,[Fir,Sec]],
     mcon(Lemma,'_', L1),
     mcon(L1,Pref,L2),
     mcon(L2,'_',L3),
     mcon(L3,Fir,L4),
     mcon(L4,'_',L33),
     mcon(L33,Pre,L5),
     mcon(L5,'_',L6),
     mcon(L6,Sec,Coord),
     !.

costruisci_coord_lems(Lemma,Pref,Tes,Coord):-
     atomic(Lemma),
     mcon(Lemma,'_', L1),
     mcon(L1,Pref,L2),
     mcon(L2,'_',L3),
     mcon(L3,Tes,Coord),
     !.

costruisci_coord_lems(Lemma,Pref,Tes,Coord):-
     Lemma=Lem-Lemm,
     mcon(Lemm,'_', L1),
     mcon(L1,Pref,L2),
     mcon(L2,'_',L3),
     mcon(L3,Tes,Coord),
     !.

search_ibar_tensed([Verb,_,_,Ibar],[Verb]).
search_ibar_tensed([Verb,_,Ibar],[Verb]).
search_ibar_tensed([Verb,Ibar],[Verb]).
search_ibar_tensed([Verb],[Verb]).

check_match_tratti([P,G,N], Feats):-
     on(pers=P1,Feats), P1=P,
     on(num=N1,Feats), N1=N,
     !.
check_match_tratti([P,G,N], Feats):-
     findall(N1,on(num=N1,Feats), Ns),
     Ns=[],!.

evaluate_compless_relative(FunctsOu,[First|NFeats], Sints,[Fun-FunctsAll]):-
    First=ibar-_,
    NFeats\=[],
    NFeats=[Sec|Rest],
    remove(Fun-Body,FunctsOu, Functs),
    remove(f2-[f2-[nil], subj-Se], Body, Res),
    assert(ibar(false)),
    assert(passiv(off)),
    assign_vfunction(First, Ibar),
    retractall(ibar),
    assert(ibar(true)),
    assign_complements(Sec,Rest, Sints, FunctsOut),
    append(Ibar, FunctsOut, Functss),
    append([subj-Se], Functss, Fu),
    append([f2-[nil]], Fu, Fuu),
    append(Res, [f2-Fuu], FunctsAll),
    !.
evaluate_compless_relative(FunctsOu,NFeats, NFeats,FunctsOu):-!.

extract_argsp([],Prep,[]):-!.
extract_argsp(Ibar,Prep,Sub):-
   Ibar=[ibar-Ibars],
   aareverse(Ibars,Testa),
   lemmatize_dic_v(Testa, Lemma, S1),
   shallow_subcat_checksp(Lemma,Prep),Sub=[Prep],
    !.

extract_argsp(Ibar,Prep,Sub):-
   aareverse(Ibar,Testa),
   check_subcn(Testa, Prep),Sub=[Prep],
    !.
extract_argsp(Ibar,Prep,Sub):-
   aareverse(Ibar,Testa),
   lemmatize_dic(Testa, Lemma, S1),
   check_subcn(Lemma, Prep),Sub=[Prep],
    !.
extract_argsp(Ibar,Prep,[]):-
    !.

extract_argsa(Adjs,Prep,Subs):-
   aareverse(Adjs,Testa),
   pred_a(Testa,Cats,Subs),
   on(sp/obl/Ro/Preps/Feats,Subs),
   (list(Preps),on(Prep,Preps);Prep=Preps),
   !.
extract_argsa(Ibar,Prep,[]):-
    !.

evaluate_compless(Ibar,Sec, Rest):-
   extract_ibar(Sec,Rest),
   Ibar=[ibar-Ibars],
   aareverse(Ibars,Testa),
   lemmatize_dic_v(Testa, Lemma, S1),
   cat_gramm(Lemma, CatGr, CatV, LArgsV),
   PredV=pred_v(Lemma,CatGr,CatV,LArgsV),
   shallow_subcat_check(1,PredV),
   !.

evaluate_compless(Ibar,Sec, Rest):-
   extract_ibar(Sec,Rest),
   Ibar=[ibar-[Testa-_-_|_]],
   lemmatize_dic_v(Testa, Lemma, S1),
   cat_gramm(Lemma, CatGr, CatV, LArgsV),
   PredV=pred_v(Lemma,CatGr,CatV,LArgsV),
   shallow_subcat_check(1,PredV),
   !.

extract_ibar(sn-SN,Rest):-
   findall(Verb, on(ibar-Verb, Rest), Vs),
   length(Vs,L),
   2=<L,
   nth(Rest, N, ibar-Verb),
   N < 4,
   (nogen_member(f2-_,Rest);
   nogen_member(fs-_,Rest);
   nogen_member(fac-_,Rest)),
   !.

extract_ibar(sn-SN,Rest):-
   findall(Verb, on(ibar-Verb, Rest), Vs),
   length(Vs,L),
   1=<L,
   nth(Rest, N, ibar-Verb),
   N =< 3,
   !.

extract_ibar(ibar-Ibar,Rest):-
   !.

evaluate_compl_clause_sp(Ibar,T-Sec, [sn-SN, f2-F2|Rest], [T-Sec, sn-SN, fac-F2|Rest]):-
   (T=sp;T=spd;T=spda),
   Ibar=[ibar-Verb],
   assign_funz_role(Verb,Sub,Lem,Valenz,Feats),
   cat_gramm(Lem, CatGr, CatV, LArgsV),
   PredV=pred_v(Lem,CatGr,CatV,LArgsV),
   shallow_subcat_check(2,PredV),
   !.
evaluate_compl_clause_sp(Ibar,T-Sec, [sn-SN, f2-F2|Rest], [T-Sec, sn-SN, f2-F2|Rest]):-
   (T=sp;T=spd;T=spda),
    !.

evaluate_compl_clause_sn(Ibar,sn-Sec, [f2-F2|Rest], [fac-F2|Rest]):-
   Ibar=[ibar-Verb],
   assign_funz_role(Verb,Sub,Lem,Valenz,Feats),
   Lem\=be,
   cat_gramm(Lem, CatGr, CatV, LArgsV),
   PredV=pred_v(Lem,CatGr,CatV,LArgsV),
   shallow_subcat_check(2,PredV),
   !.
evaluate_compl_clause_sn(Ibar,sn-Sec, [sn-Sub|Rest], [fac-[nil],sn-Sub|Rest]):-
   aareverse(Sec,Head),
   check_subcn_factive(Head),
   !.

evaluate_compl_clause_sn(Ibar,sn-Sec, [sn-Subj,ibar-Verb|Rest], [f2-[nil],sn-Subj,ibar-Verb|Rest]):-
   Rest\=[cp-['.'-punto-cp]],
   assign_funz_role(Verb,Sub,Lem,Valenz,Feats),
   \+ sy(Lem),
   v(Lem,Subs), 
   (member(t,Subs);member(ti,Subs)),
   !.

evaluate_compl_clause_sn(Ibar,sn-Sec, Rest, Rest):-
   !.

check_subject_vargs(IBar, VArgs, VArgs):-
   on(Role/I,VArgs),
   w_e_pr(Role,P),
   P=<10,
   !.
check_subject_vargs(IBar, VArgs, [Arg|VArgs]):-
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   find_govern(2,N,Govern,Head),
   (nonvar(N), N1 is N + 1; var(N), N1=1),
   current_governor(N1,Lem),
   on(Ruolo/_,Arg),
   assert_dep_gram_rels(subj,Ruolo,Head),
   !.
   
build_adjuncts(SentNo,I, [],[],[]):-!.
build_adjuncts(SentNo,I, Body,[second-AllArgsAdjs|RefsRel],[Lem|Lems]):-
   appiattisci(Body, Vp),
   (remove(ibar-Ibar,Vp,Resto);remove(_-ibar-Ibar,Vp,Resto)),
   extract_clause([_-ibar-Ibar], Vp, Clause, IBar, RestFuncs, RestIbar,Adjs),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     check_subject_vargs(IBar, VArgs, NVArgs),
     AllArgsAdjs=[Neg,Lem-NVArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     build_adjuncts(N1,I, RestFuncs,RefsRel,Lems),
     !.

build_adjuncts(SentNo,I, Body,RefsRel,Lem):-
   appiattisci(Body, Vp),
   (remove(ibar-Ibar,Vp,Resto);remove(_-ibar-Ibar,Vp,Resto)),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   find_govern(2,N,Govern,Head),
   (nonvar(N), N1 is N + 1; var(N), N1=1),
   current_governor(N1,Lem),
   on(Ruolo/_,Arg),
   assert_dep_gram_rels(subj,Ruolo,Head),
   createarguments(N1, Resto, Lem, Valenzz, VArgs, RefsRel, Aggs),
   !.

build_adjuncts(SentNo,I, Body,Aggs,Lem):-
   appiattisci(Body, Vp),
   remove(vcomp-Ibar,Vp,Resto),
   tensed(Tensed),
   (Tensed=nil;
    list(Tensed),on(V-_,Tensed)),
     on(V-_-_,Ibar),
   append([vcomp-Ibar], Resto, NArgs),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
   find_govern(2,N,I,Head),
   Head=H-Ind,
   current_governor(N,Lem),
   on(Ruolo/_,Arg),
   assert_dep_gram_rels(subj,Ruolo,Head),
   insert_control(nil,NArgs, subj, Valenzz, Ind, Valenza),
   createarguments(N, NArgs, Lem, Valenza, VArgs, RefsRel, Aggs),
   !.

build_adjuncts(N1,Ibars, Adjs,[second-AllArgsAdjs],Lem):-
    nonvar(Ibars),Ibars\=[],
    (Adjs=[Adj]; Adj=Adjs, \+ list(Adjs)),
   (remove(ibar-Ibar,Ibars,Resto);remove(_-ibar-Ibar,Ibars,Resto)),
   create_subject_rel(Ind, Ibar, Valenz, Valenzz, Lem-Arg-Neg),
    assert_gr_adj(N1, Lem, Adj,Rels,Mods),
    Rels\=[],
    (Rels=[Var],nonvar(Var),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,OutAdjs],
     remove(AllArgsAdjs,Rels,_);
     AllArgsAdjs=Rels
      ),
        !.

build_adjuncts(N1,Ibars, Adjs,[second-AllArgsAdjs],Lem):-
    (Adjs=[Adj]; Adj=Adjs, \+ list(Adjs)),
    atomic(Ibars),
    assert_gr_adj(N1, Ibars, Adj,Rels,Mods),
    Rels\=[],
    (Rels=[Var],nonvar(Var),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,OutAdjs],
     remove(AllArgsAdjs,Rels,_);
     AllArgsAdjs=Rels),
        !.

build_adjuncts(N,Ibars, Body,[second-AllArgsAdjs],Lem):-
   (Ibars=[], current_governor(N,be), Lem=be
    ;
    list(Ibars),
    (remove(ibar-Ibar,Ibars,Resto);remove(_-ibar-Ibar,Ibars,Resto)),    
    aareverse(Ibar, Verb),
    lemmatize_dic_v(Verb,Lem,S),
     current_governor(N,Lem)
    ),
   createarguments(N, Body, Lem, [obl-_,adj-_], VArgs, RefsRel, Aggs),
   (RefsRel\=[];Aggs\=[]),
   governor(_,Govern),
   AllArgsAdjs=[1,Govern-VArgs,[], RefsRel,Aggs],
   !.

build_adjuncts(N,Ibars, Adjs,AllArgsAdjs,Lem):-
   governor(_,Govern),
   build_adjunctsres(Govern,N,Ibars, Adjs,AllArgsAdjs,Lem),
   !.
build_adjuncts(SentNo,I, Body,[],[]):-
   Body=[F-A],
   A=[_],
   F\=sn,F\=sa,F\=vcomp,F\=sp,F\=spd,F\=spda,
   !.

build_adjunctsres(Govern,N,Ibars, Body,[second-AllArgsAdjs],Gov):-
   Govern=Gov-Ind,
   createarguments(N, Body, Gov, [obl-_,adj-_], VArgs, RefsRel, Aggs),
   (RefsRel\=[];Aggs\=[], Aggs\=[[]]),
   governor(_,Govern),
   AllArgsAdjs=[1,Govern-VArgs,[], RefsRel,Aggs],
   !.   
build_adjunctsres(Govern,N1,Ibar, Adjs,AllArgsAdjs,Gov):-
    Govern=Gov-Ind,
    (Adjs=[Adj], Mod=[Ind-Gov-Adj]; Adj=Adjs, Mod=[Ind-Gov-Adj]),
    assert_mods(N1, Mod,AllArgsAdjs),
    AllArgsAdjs\=[],AllArgsAdjs\=[[]],
   !.
build_adjunctsres(Govern,N1,Ibar, [Adj|Adjs],AllArgsAdjs,Gov):-
    Govern=Gov-Ind,
    assert_gr_adj(N1,Gov,Adjs,AllArgsAdjs,ModsAdjs),
    AllArgsAdjs\=[],AllArgsAdjs\=[[]],
   !.


remove_valenz(Fun, Valenz,Ruolo):-
     list(Valenz), remove(obj-Ruolo, Valenz, Valenza),!.

remove_valenz(Fun, Valenz,Ruolo):-
     Valenz=obj-Ruolo,!.

remove_valenz(Fun, Valenz,Ruolo):-
     list(Valenz), remove(xcomp-Ruolo, Valenz, Valenza),!.
remove_valenz(Fun, Valenz,Ruolo):-
     Valenz=xcomp-Ruolo,!.
remove_valenz(Fun, Valenz,Ruolo):-
     Fun=obj, Ruolo=theme_aff;
     Fun=xcomp, Ruolo=prop;
      Ruolo=theme.

remove_index(Valenz,Index,Valenza):-
     list(Valenz),
     reverse(Valenz,Vals),
     remove(controller(_-Index), Vals, Valen),
     reverse(Valen,Valenza),
     governor(N,Gov),
     !.

remove_index(Valenz,Index,[]):-
     Valenz=controller(_-Index),!.

remove_index_adj(Valenz,Index,Valenza):-
     list(Valenz),
     reverse(Valenz,Vals),
     remove(controller(subj-Index), Vals, Valen),
     reverse(Valen,Valenza),
     governor(N,Gov),
     !.

remove_index_adj(Valenz,Index,[]):-
     Valenz=controller(subj-Index),!.

reffunctions(Args):-
   findall(Func, (funcs(Func, K, Head, All), 
                    Func\=ibar, Func\=sem, Func\=voice), Heads), 
      sort(Heads, Args),
      !.

append_extract_newvalenz(Func,NewVal,[],Valenza):-
     remove(Func-Role,NewVal,Valenza),
      !.
append_extract_newvalenz(Func,NewVal,Valen,Valenza):-
     Valen\=[],
     remove(Func-Role,NewVal,NewV),
     append(NewV,Valen,Valenza),
      !.
append_extract_newvalenz(Func,NewVal,Valen,Valenza):-
     Valen\=[],
     append(NewVal,Valen,Valenza),
      !.
append_extract_newvalenz(Func,NewVal,[],NewVal):-
      !.

maximise_functions(Lem,Costs,Valenzes, Valenzz):-
   nonvar(Lem),
   reffunctions(Args),
   evaluate_subcats(Args, Valenzes, Subs),
   sort(Subs, Sub),
   reorder_subs(Sub, Valen),
   (Subs\=Sub,
    reverse(Valen, Valenz)
    ;
    Subs=Sub, Valenz=Valen),
   estrai_valenz_list(Lem,Costs,Valenz,Valenzz),
   !.

sort_adjust(Lem,Valenz,Costs,Subjj,Subj):-
    sort(Subjj,SortSubj),
    length(SortSubj,K),
    selectsubj(K,Lem,Valenz,Costs,Subjj,SortSubj,Subj),
    !.

searchpassivesubj(Functs,subj-R):-
    appiattisci(Functs,Funs),
    on(subj-R,Funs),
    R\=agent,!.
    
selectsubj(0,Lem,Valenz,Costs,Subjj,Subj,Subj):-!.
selectsubj(1,Lem,Valenz,Costs,Subjj,Subj,Subj):-!.
selectsubj(K,Lem,Valenz,Costs,Subjj,Functs,[Subj]):-
    passiv(on),
    searchpassivesubj(Functs,Subj),
    !.
selectsubj(K,Lem,Valenz,Costs,Subjj,[Subj|_],[Subj]):-
    1<K,
    findall(Lem,pred_vc(Lem,Sint,Asp,Args),Lems), Lems=[],
    !.
selectsubj(K,Lem,Valenz,Costs,[Subj|_],SortSubj,[Subj]):-
    1<K,
    findall(Lem,pred_vc(Lem,Sint,Asp,Args),Lems), Lems\=[],
    !.

unify_all_valenz(Lem,Costs,Valenz,Valall):-
      unify_subj(Valenz,Subjj),
      sort_adjust(Lem,Valenz,Costs,Subjj,Subj),
      unify_internal(Costs,Valenz,Intern),
      appiattisci(Intern,Inter),
      sort(Inter,Inte),
      linearize_args(Lem,Costs,Inte,Valss),
      sort(Valss,Valsss),
      togli_rdoppi(Valsss, Vals1),
      togli_rdoppi(Vals1, Vals),
      append(Subj,Vals,Valall),
     !.

linearize_args(Lem,[subj-_,Obj1-_,Obj2-_|Cost],Val,[obj2-Role1,obj-Role|Vals]):-
     \+ coplbh(Lem),
     (Obj1=obj,Obj2=obj2;Obj1=obj2,Obj2=obj),
     remove(obj2-Role1,Val, Rest),
     remove(obj-Role,Rest, Res),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,[subj-_,Obj1-_|Cost],Val,[Obj-Role|Vals]):-
     \+ coplbh(Lem),
     (Obj1=obj, Obj=obj;Obj1=obj2, Obj=obj2),
     remove(Obj-Role,Val, Res),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,[subj-_,Obj1-_|Cost],Val,[obl-Role|Vals]):-
     Obj1=obl,
     remove(obl-Role,Val, Res),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,[subj-_,Obj1-_|Cost],Val,[obl2-Role|Vals]):-
     Obj1=obl2,
     remove(obl2-Role,Val, Res),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,[subj-_,Obj1-_|Cost],Val,[xcomp-Role|Vals]):-
     Obj1=xcomp,
     (remove(xcomp-Role,Val, Res);
      remove(acomp-Role,Val, Res);
      remove(ncomp-Role,Val, Res);
      remove(pcomp-Role,Val, Res)),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,[subj-_,Obj1-_|Cost],Val,[xcomp-Role|Vals]):-
     coplbh(Lem),
     Obj1=obj,
     (remove(xcomp-Role,Val, Res);
      remove(acomp-Role,Val, Res);
      remove(ncomp-Role,Val, Res);
      remove(pcomp-Role,Val, Res)),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,[subj-_,Obj1-_|Cost],Val,[iobj-Role|Vals]):-
     Obj1=iobj,
     (remove(obj2-Role,Val, Res),
      remove(iobj-Role,Val, Res),
      remove(obl-Role,Val, Res)),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,[subj-_,Obj1-_|Cost],Val,[vcomp-Role|Vals]):-
     Obj1=vcomp,
     remove(vcomp-Role,Val, Res),
     nonvar(Role),
     linearize_args(Lem,[subj-_|Cost],Res,Vals),
     !.
linearize_args(Lem,Costs,Val,[Fu-Role|Vals]):-
     remove(Fu-Rol,Costs, _),
     remove(Fu-Role,Val, Res),
     nonvar(Role),
     linearize_args(Lem,Costs,Res,Vals),
     !.
linearize_args(Lem,Costs,Val,Vals):-
     remove(fcomp-Role,Val,Res),
     nonvar(Role),
     linearize_args(Lem,Costs,Res,Vals),
     !.

linearize_args(Lem,Costs,Res,Res).

reorder_subs([], []):-!.
reorder_subs([L-Subcat|Sub], [Subcat|Valenz]):-
   reorder_subs(Sub, Valenz),
   !.

evaluate_subcats(Funcs, [], []):-!.
evaluate_subcats(Funcs, [Subcat|Subs], [L1-[Subcat]|Eval]):-
   \+ is_list(Subcat),
   L1 =10,
   evaluate_subcats(Funcs, Subs, Eval),
   !.
   
evaluate_subcats(Funcs, [Subcat|Subs], [L1-Subcat|Eval]):-
   is_list(Subcat),
   extractf(Subcat, SubFuncs),
   intersezione(Funcs, SubFuncs, Out),
   length(Out,L),
   (on(subj-_,Subcat),
    on(obj-_,Subcat),
    L1 is L +2;
    on(subj-_,Subcat),
    L1 is L +1;
       L1=L),
   evaluate_subcats(Funcs, Subs, Eval),
   !.

evaluate_subcats(Funcs, Subcats, [1-Subcats]):-
   Subcats=[Subcat|Subs],
   Subcat=A-B,
   list(B),
   !.
evaluate_subcats(Funcs, Subcats, [L1-Subca|Eval]):-
   is_list(Subcats),
   extractf(Subcats, SubFuncs),
   intersezione(Funcs, SubFuncs, Out),
   length(Out,L),
   (on(subj-_,Subcats),
    on(obj-_,Subcats),
    L1 is L +2;
    on(subj-_,Subcats),
    L1 is L +1;
       L1=L),
   sort(Subcats, Subcat),
   togli_rdoppi(Subcat, Subca),
   evaluate_subcats(Funcs, Subs, Eval),
   !.
evaluate_subcats(Funcs, [Subcat|Subs], Eval):-
   evaluate_subcats(Funcs, Subs, Eval),
   !.

togli_rdoppi([], []).

togli_rdoppi([T-R|Id1], [T-R|Id2]):-
       delete_el(T-_,Id1,Ids),
       togli_rdoppi(Ids, Id2).

togli_rdoppi([_/T/R/_|Id1], [T-R|Id2]):-
       delete_el(T-_,Id1,Ids),
       togli_rdoppi(Ids, Id2).

extractf([], []):-!.
extractf([Funz-_|Subcat], [Funz|SubFuncs]):-
   extractf(Subcat, SubFuncs),
   !.
extractf([_/Funz/_/_|Subcat], [Fun|SubFuncs]):-
   transl_val(Funz,Fun),
   extractf(Subcat, SubFuncs),
   !.

reconstruct_outs(Out,Out):-!.
reconstruct_outs(Out,NewOut):-
   Out\=[],
   reverse(Out,[[A-B], main-[Neg,Pred-Args|R]|RevOut]),
   RevOut\=[],
   Pred\=[],Args\=[],
   sy(Pred),
   modify_comp_main(RevOut,ModOut,Pre),
   append([main-[Neg,Pred-Args|R]],ModOut,NewOu),
   append([A-B],NewOu,NewOut),
   findall(Comp, (dgrs(Cl, DepGr),
                 term_to_atom(ccomp-Comp,FunctR),
                 DepGr=..[FunctR|_]),C),
   C=[],
   term_to_atom(ccomp-prop,FunctR),
   DepGr=..[FunctR,nil,Pred,Pre],
   asserta(dgrs(1,DepGr)),
   !.
reconstruct_outs(Out,NewOut):-
   Out\=[],
   reverse(Out,[main-[Neg,Pred-Args|R]|RevOut]),
   RevOut\=[],
   Pred\=[],Args\=[],
   sy(Pred),
   modify_comp_main(RevOut,ModOut,Pre),
   append([main-[Neg,Pred-Args|R]],ModOut,NewOut),
   findall(Comp, (dgrs(Cl, DepGr), 
                  term_to_atom(ccomp-Comp,FunctR),
                  DepGr=..[FunctR|_]),C),
   C=[],
   term_to_atom(ccomp-prop,FunctR),
   DepGr=..[FunctR,nil,Pred,Pre],
   asserta(dgrs(1,DepGr)),
   !.

modify_comp_main([],[],P):-!.
modify_comp_main(Out,ModOut,Pred):-
   remove(main-[Neg,Pred-Args|R],Out,Rest),
   append([comp-[Neg,Pred-Args|R]],Rest,ModOut),
  !.
modify_comp_main(Out,Out,P):-
  !.

assert_mods(N1, [],[]):-!.
assert_mods(N1, [Mod|Mods],[Ref|Refs]):-
   analyze_mod(N1, Mod, Ref),
   assert_mods(N1, Mods,Refs),
   !.

analyze_mod(N1, Ind-Head-[], []):-!.
analyze_mod(N1, []-[]-Mod, []):-!.
analyze_mod(N1, Ind-[]-Mod, []):-!.
analyze_mod(N1, []-Head-Mod, []):-!.
analyze_mod(N1, Ind-Head-[Mod], []):-var(Mod),!.
analyze_mod(N1, Ind-Head-[Mod-_-_], []):-var(Head),!.
analyze_mod(N1, Ind-Head-Mod, Ref):-
     Head=mod,
     Ind=Id-and(Heads),
     Mods=Id-Heads-Mod,
     analyze_mod(N1, Mods, Ref),
   !.

analyze_mod(N1, Ind-Head-Mod, [RelClause|Refs]):-
    Mod\=[],
    Mod=[F2-Body|VP], 
     (F2=f2;F2=fac),
    list(Body), length(Body,L), 1<L,
    Body=[First|_], First=F2-A, 
%    A=[B],
    VP=[],
    build_relativeclause(Ind,Head,Mod,RelClause,Rest),
    analyze_mod(N1, Ind-Head-Rest, Refs),
    !.
   
analyze_mod(N1, Ind-Head-Mod, [RelClause|Refs]):-
    Mod\=[],
    Mod=[Prep, f2-F2|VP],
    Mod1=[f2-F2|VP],
    VP\=[], \+list(Prep),
    build_relativeclause(Ind,Head,Mod1,RelClause,Rest),
    analyze_mod(N1, Ind-Head-Rest, Refs),
    !.    

analyze_mod(N1, Ind-Head-Mod, [RelClause|Refs]):-
    Mod\=[],
    Mod1=f2-F2,
    remove(Mod1,Mod,Rest),
    list(F2), length(F2,L), 1<L,
    F2=[First|_], First=f2-A, 
%    A=[B],
    build_relativeclause(Ind,Head,[Mod1],RelClause,Rest1),
    append(Rest,Rest1,Rests),
    analyze_mod(N1, Ind-Head-Rests, Refs),
    !.    

analyze_mod(N1, Ind-Head-[Mod|Mods],Refs):-
     Mod=Testa-Cat-_,
     arts(Testa),
    analyze_mod(N1, Ind-Head-Mods, Refs),
    !.    

analyze_mod(N1, Ind-Head-[Mod|Mods],Refs):-
     Mod=pron-Testa-Cat,
     term_to_atom(xadj-top,Func),
     DepGr1=..[Func,Head-Ind,Testa],
     asserta(dgrs(SentNo,DepGr1)),
     asserta(ref_funcs(xadj, Ind, Testa, Testa)),
     analyze_mod(N1, Ind-Head-Mods, Refs),
    !.    

analyze_mod(N1, Ind-Head-[Mod|Mods],[Ref|Refs]):-
    Mod\=[],Mods\=[],
    individuate_mod(Mod),
    assert_dep_gram_rels_mods(N1, ncmod,Ind,Head,[Mod],Ref),
    analyze_mod(N1, Ind-Head-Mods, Refs),
    !.    

analyze_mod(N1, Id-Head-Mod, [Agg,Ref1|Ref]):-
    Mod\=[], 
    (Fun=obl;Fun=mod),
    nogen_member(Fun-Obl,Mod),
    findall(Cong,nogen_member(Cong-cong-_,Obl),Cs),Cs=[],
    findall(Cong,nogen_member(Cong-cong-_,Mod),Css),Css=[],
    remove(Fun-Obl,Mod,Mo),
    remove(Prep,Mo,More),
    (Prep=P-_-_;Prep=fs-Pr,Pr=[P-_-_]) ,
    prepos(P),
    costruisci_mods_aggs(More, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, M),
    nonvar(Ind),Ind\=[],
    analyze_mod(N1, Ind-Lemma-M, Ref1),
    depgrsrols_obl(N1,P,Head,Id,Lemma-Ind,Tab,Tratti,CatSem,M,Testa,adj/ncmod,specif,Agg),
    analyze_mod(N1, Ind-Lemma-Obl, Ref),
    !.    

analyze_mod(N1, Id-Head-Mod, [Agg,Ref1]):-
    Mod\=[],
    (nogen_member(P-_-_,Mod);nogen_member(fs-Pr,Mod)),
    (Modd=P-_-_;Modd=fs-Pr,Pr=[P-_-_]),
    remove(Modd,Mod,Mo),
    prepos(P),
    costruisci_mods_aggs(Mo, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, M),
    Lemma\=[],
    analyze_mod(N1, Ind-Lemma-M, Ref1),
    depgrsrols_obl(N1,P,Head,Id,Lemma-Ind,Tab,Tratti,CatSem,M,Testa,adj/ncmod,specif,Agg),
%    analyze_mod(N1, Ind-Lemma-Mo, Ref),
    !.    

/*
analyze_mod(N1, Id-Head-Mod, [Agg, Ref1|Ref]):-
    Mod\=[],
    (nogen_member(P-_-_,Mod);nogen_member(fs-Pr,Mod)),
    (Modd=[P-_-_|Resto];Modd=[fs-Pr|Resto],Pr=[P-_-_]) ,
    prepos(P),
    remove(Modd,Mod,Mo),
    costruisci_mods_aggs(Resto, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, M),
    Lemma\=[],
    analyze_mod(N1, Ind-Lemma-M, Ref1),
    depgrsrols_obl(N1,P,Head,Id,Lemma-Ind,Tab,Tratti,CatSem,M,Testa,adj/ncmod,specif,Agg),
    analyze_mod(N1, Ind-Lemma-Mo, Ref),
    !.    
*/

analyze_mod(N1, Id-Head-Mod, [Agg, Ref1|Ref]):-
    Mod\=[],
    (Mod=[_-art-_|Resto];Mod=[_-Cat-_|Resto],
    (nncats(Cat);anncats(Cat);proncat(Cat))),
    (Modd=f2-Res;Modd=mod-Res;Modd=obl-Res),
    remove(Modd,Mod,Mo),
    costruisci_mods_aggs(Mod, Testa, Rest, Lemma, CatSem, Tab, Tratti, Ind, M),
    Lemma\=[],
    analyze_mod(N1, Ind-Lemma-M, Ref1),
    depgrsrols_obl(N1,of,Head,Id,Lemma-Ind,Tab,Tratti,CatSem,M,Testa,adj/ncmod,specif,Agg),
    analyze_mod(N1, Id-Head-Mo, Ref),
    !.    

analyze_mod(N1, Ind-Head-Mod, [Ref|Refs]):-
    Mod\=[], (Fu=obl;Fu=mod;Fu=f2),
    remove(Fu-Mo,Mod,Rest),
    reverse(Mo,[than-ccom-_|RevMo]),
    remove(obj-Moo,Rest,[]),
    analyze_mod(N1, Ind-Head-Moo, Ref),
    dgrs(_,DepGr),
    term_to_atom(Fun-_,FunctR),
     (DepGr=..[FunctR,Hea-In,Lemma];
      DepGr=..[FunctR,Sem,Hea-In,Lemma]),
    nonvar(Fun),
    analyze_mod(N1, Ind-Head-Mo, Refs),
    dgrs(_,DepGr1),
    term_to_atom(Fun1-_,FunctR1),
     (DepGr1=..[FunctR1,Head1-_,Lemma1];
      DepGr1=..[FunctR1,Sem1,Head1-_,Lemma1]),
    nonvar(Fun1),
    term_to_atom(adj-compar,FunctR2),
    DepGr2=..[FunctR2,than,Lemma1,Lemma],
    asserta(dgrs(N1,DepGr2)),
    !.  

analyze_mod(N1, Ind-Head-Mod, [Ref|Refs]):-
    Mod\=[], (Fu=sn;Fu=subj;Fu=f2),
    remove(Fu-Mo,Mod,Rest),
    analyze_mod(N1, Ind-Head-Rest, Ref),
    analyze_mod(N1, Ind-Head-Mo, Refs),
    !.    
analyze_mod(N1, Ind-Head-Mod, [Ref|Refs]):-
    Mod\=[], (Fu=obl;Fu=mod),
    remove(Fu-Mo,Mod,Rest),
    analyze_mod(N1, Ind-Head-Rest, Ref),
    analyze_modobl(N1, Ind-Head-Mo, Refs),
    !.    
analyze_mod(N1, Ind-Head-Mod, [Ref|Refs]):-
    Mod\=[], Fu=appos,
    remove(Fu-Mo,Mod,Rest),
    analyze_mod(N1, Ind-Head-Rest, Ref),
    analyze_appos(N1, Ind-Head-Mo, Refs),
    !.    
analyze_mod(N1, Ind-Head-Mod, [AllArgsAdjs|Refs]):-
    Mod\=[], 
    remove(vcomp-_,Mod,Claus),
    appiattisci(Mod, NAdjs),
    remove(ibar-Term, NAdjs, Rest),
    append([_-ibar-Term], IBars, NIBars),
    extract_clause(NIBars, NAdjs, Clause, IBar, RestFuncs, RestIbar, Adjss),
    create_clause_fac(N1, IBar, Clause, ArgsAdjs, Mods, NArgs, Lemm-VArgs, Neg),
    AllArgsAdjs=[Neg, Lemm-VArgs, Modss, ArgsAdjs, Out],
    analyze_mod(N1, Ind-Head-Mods, Refs),
    assert_gr_adj(N1, Lemm,Adjss,Out,Mods1),
     append(Mods,Mods1,Modss),
    !.
  
analyze_mod(N1, Ind-Head-Mod, [AllArgsAdjs|Refs]):-
    Mod\=[], 
    remove(vcomp-IBar,Mod,Clause),
    create_clause_fac(N1, IBar, Clause, ArgsAdjs, Mods, NArgs, Lemm-VArgs, Neg),
    AllArgsAdjs=[Neg, Lemm-VArgs, Modss, ArgsAdjs, Out],
    analyze_mod(N1, Ind-Head-Mods, Refs),
    assert_gr_adj(N1, Lemm,Adjss,Out,Mods1),
     append(Mods,Mods1,Modss),
    !.
  
analyze_mod(N1, Ind-Head-Mod, [AllArgsAdjs|Refs]):-
    Mod\=[],
    remove(fint-_,Mod,_),
    remove(ibar-Term, Mod, Rest),
    append([_-ibar-Term], IBars, NIBars),
    extract_clause(NIBars, Mod, Claus, IBar, RestFuncs, RestIbar, Adjss),
    append(Claus, [ibar-Term], Clause),
    create_clause_fac(N1, IBar, Clause, ArgsAdjs, Mods, NArgs, Lemm-VArgs, Neg),
    AllArgsAdjs=[Neg, Lemm-VArgs, Modss, ArgsAdjs, Out],
    analyze_mod(N1, Ind-Head-Mods, Refs),
    assert_gr_adj(N1, Lemm,Adjss,Out,Mods1),
     append(Mods,Mods1,Modss),
    !.

analyze_mod(N1, Ind-Head-Mod, Clauses):-
    remove(f-Fra,Mod,Res),
    remove(ibar-Term, Fra, Rest),
    N2 is N1 + 1,
    splitsentences(N2,[_-ibar-Term], Fra, Clauses),
    !.

analyze_mod(N1, Ind-Head-Mod, Refs):-
    Mod\=[],
    assert_dep_gram_rels_mods(N1, ncmod,Ind,Head,Mod,Refs),
    !.    
analyze_mod(N1, Ind-Head-Mod, []).

assertdepgramrelsmods(SentNo,ncmod,Ind,Head,Mod,Rols,[Arg]):-
     Mod=[Testa-Cat-_],
     atomic(Testa),
     \+ prenoms(Mod),
     \+ prepos(Testa),
     (Cat=nt, Role=temp; Cat=num, integer(Testa), 1900<Testa, Role=temp; Role=Rols),
     findall(Testa,jj(Testa),Mos),Mos=[],
     genera_tratti(Feats, Testa, Tratti, Lemma, Cat),
     trova_CatSem(Cat, Lemma, CatSem),
     assegna_tab(Cat, Testa, Resto, Tab),
     assign_index(Ind1),
     (fct(Testa),Lemm=Testa;Lemm=Lemma),
     assignCat_roles(Cat,Fun/Rol),
     Arg=ref_ex(Ind1,Lemm,Tab,Tratti,CatSem,[],Fun/Rols),
     asserta(ref_funcs(Fun, Ind1, Lemm, Testa)),
    !.    

analyze_appos(N1, Ind-Head-[], []):-!.
analyze_appos(N1, Ind-Head-Mod, Refs):-
    Mod\=[],
    Mod=[H-_-_],
    assertdepgramrelsmods(N1, ncmod,Ind,Head,Mod,appos,Refs),
    Refs=[Arg|_],
    Arg=ref_ex(Ind1,Lemm,Tab,Tratti,CatSem,Modss,Fun/Rol),
    term_to_atom(ncmod-appos,FunctR2),
    DepGr2=..[FunctR2,'_',Head-Ind,Lemm-Ind1],
    asserta(dgrs(N1,DepGr2)),
    !.  
analyze_appos(N1, Ind-Head-Mod, [Ref|Refs]):-
    Mod\=[], (Fu=sn;Fu=subj;Fu=obl;Fu=mod;Fu=f2),
    remove(Fu-Mo,Mod,Rest),
    analyze_appos(N1, Ind-Head-Rest, Ref),
    (Ref\=[],
     (reverse(Ref,Rev),Rev=[Arg|_],Arg\=[];remove(Arg,Ref,Res), Arg\=[]),
     Arg=ref_ex(Ind1,Lemm,Tab,Tratti,CatSem,Modss,Fun/Rol),
     analyze_mod(N1, Ind1-Lemm-Mo, Refs)
     ;
    Ref=[],
    analyze_mod(N1, Ind-Head-Mo, Refs)),
    !.    
analyze_appos(N1, Ind-Head-Mod, Refs):-
    Mod\=[], is_list(Mod),
    assert_dep_gram_rels_mods(N1, ncmod,Ind,Head,Mod,Refs),
    !.    

analyze_modobl(N1, Ind-Head-[], []):-!.
analyze_modobl(N1, Ind-Head-Mod, Refs):-
    Mod\=[],
    Mod=[H-_-_],
    assert_dep_gram_rels_mods(N1, ncmod,Ind,Head,Mod,Refs),
    !.  
analyze_modobl(N1, Ind-Head-Mod, [Ref|Refs]):-
    Mod\=[], (Fu=sn;Fu=subj;Fu=obl;Fu=mod),
    remove(Fu-Mo,Mod,Rest),
    analyze_modobl(N1, Ind-Head-Rest, Ref),
    (Ref\=[],
     (Ref=[Arg|_],Arg\=[];remove(Arg,Ref,Res), Arg\=[]),
     Arg=ref_ex(Ind1,Lemm,Tab,Tratti,CatSem,Modss,Fun/Rol),
     analyze_mod(N1, Ind1-Lemm-Mo, Refs)
     ;
    Ref=[],
    analyze_mod(N1, Ind-Head-Mo, Refs)),
    !.    
analyze_modobl(N1, Ind-Head-Mod, [Ref|Refs]):-
    Mod\=[], Fu=f2,
    remove(Fu-Mo,Mod,Rest),
    analyze_modobl(N1, Ind-Head-Rest, Ref),
    (Ref\=[],
     (Ref=[Arg|_],Arg\=[];remove(Arg,Ref,Res), Arg\=[]),
     Arg=ref_ex(Ind1,Lemm,Tab,Tratti,CatSem,Modss,Fun/Rol),
     analyze_mod(N1, Ind1-Lemm-Mod, Refs)
     ;
    Ref=[],
    analyze_mod(N1, Ind-Head-Mod, Refs)),
    !.    
analyze_modobl(N1, Ind-Head-[Mod|Mods],[Ref|Refs]):-
    Mod\=[],Mods\=[],
%    individuate_mod(Mod),
    assert_dep_gram_rels_mods(N1, ncmod,Ind,Head,[Mod],Ref),
    analyze_mod(N1, Ind-Head-Mods, Refs),
    !.    

assign_index(Ind):-
     gen_sym(sn, Ind),
     !.

correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',
   Head=Hed-Ind1,
   Dep=Lem-Ind2,
   NFact=..[Hed,Ind1,Pref,Sem,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',
   Head=Hed-Ind1,
   Sem=Lem-Ind2,
   atomic(Dep),
   NFact=..[Lem,Ind2,Pref,Head,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',
   Head=Hed-Ind1,
   atomic(Dep),
   NFact=..[Hed,Ind1,Pref,Sem,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem='_',
   Head=Hed-Ind1,
   NFact=..[Hed,Ind1,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem='_',
   Head=Hed-Ind1,
   atomic(Dep),
   NFact=..[Hed,Ind1,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Head=Hed-Ind1,
   Dep=Lem-Ind2,
   NFact=..[Hed,Ind1,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Head=Hed-Ind1,
   atomic(Dep),
   NFact=..[Hed,Ind1,Pref,Dep],!.

correct_fact(Fact,NFact):-
   Fact=..[Pref,Dep,Sem,Head],
   Sem='_',
   NFact=..[Head,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem='_',
   NFact=..[Head,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   atomic(Dep),
   NFact=..[Head,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',Dep=obj,
   NFact=..[Sem,Pref,Head],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',Dep\=obj,Head=nil,
   NFact=..[Sem,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',Dep\=obj,Head\=nil,
   Pref=cmod-_,
   NFact=..[Dep,Pref,Sem,Head],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Dep,Head],
   Sem\='_',Head\=obj,Dep\=nil, Pref=voice,
   NFact=..[Head,Pref,Sem,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',Dep\=obj,Head\=nil,
   NFact=..[Head,Pref,Sem,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Sem,Head,Dep],
   Sem\='_',Dep\=obj,Head=nil,
   NFact=..[Sem,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Dep=..[Role,Sem,Hea,De],
   Sem='_',
   NFact=..[Hea,Head-Role,De],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Pref\=ext,Pref\=expl,Pref\=dsa,
   Dep=..[Role,Hea,De], Role\='-',
   NFact=..[Hea,Head-Role,De],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Pref\=ext,Pref\=expl,Pref\=dsa,
   atomic(Head),
   Pref=Fun-Role,
   Dep=D-I,
   NFact=..[Head,Pref,Dep],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Dep=..[Role,Sem,Hea,De],
   Sem\='_',De=obj,
   NFact=..[Hea,Head-Role,Sem],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Dep=..[Role,Sem,Hea,De],
   Sem\='_',De\=obj,Hea\=nil,
   NFact=..[Hea,Head-Role,Sem,De],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   Dep=..[Role,Sem,Hea,De],
   Sem\='_',De\=obj,Hea=nil,
   NFact=..[Sem,Head-Role,De],!.
correct_fact(Fact,NFact):-
   Fact=..[Pref,Head,Dep],
   (Pref=ext;Pref=expl;Pref=dsa),
   (atomic(Dep), Pron=Dep;list(Dep),member(Pron,Dep)),
   NFact=..[Pron,Pref,Head],!.
   

writeall_ref_exs(Input,Evals):-
   create_file_name(Input,Path,File),
   write_ref_exs(Path,File,Evals),
    !.

write_ref_exs(Dvol,File,Evals):-
   dvol(Dvol),
   tell(File),
   QEvals=..[evls,Evals],
   writeq(File, QEvals),
   dot,nl,
   told,
    !.

create_file_name(Input,Dvol,Model):-
   fname(Input,K,L),
   Mod='Macintosh HD:dumps',
   concat(Mod,':',Mods),
   concat(Mods,L,Modss),
   concat(Modss,':',Modd),
   concat(Modd,refs,Model),
   concat(Mods,L,Dvol),
   !.

s_included(ach, evt).
s_included(acl, leg).
s_included(act, unb).
s_included(adv, inf).
s_included(amb, lfr).
s_included(anm, lfr).
s_included(atm, evt).
s_included(bod, pho).
s_included(bod, hum).
s_included(btl, evt).
s_included(btl, llc).
s_included(chd, evt).
s_included(chp, evt).
s_included(cmp, tec).
s_included(col, hum).
s_included(edb, fod).
s_included(emt, hum).
s_included(emt, abs).
s_included(evl, abs).
s_included(evn, evt).
s_included(fac, unb).
s_included(fod, mtt).
s_included(hum, lfr).
s_included(hvt, evt).
s_included(lat, inf).
s_included(lat, unb).
s_included(lcg, llc).
s_included(lng, llc).
s_included(loc, llc).
s_included(mab, abs).
s_included(mab, inf).
s_included(mac, unb).
s_included(mac, inf).
s_included(mat, lfr).
s_included(mat, pho).
s_included(mnt, inf).
s_included(mnt, unb).
s_included(mst, abs).
s_included(mst, sts).
s_included(mtf, abs).
s_included(mtf, qun).
s_included(mus, abs).
s_included(mus, unb).
s_included(nat, abs).
s_included(nat, unb).
s_included(nev, evt).
s_included(nfa, inf).
s_included(nfa, unb).
s_included(nfl, unb).
s_included(nft, inf).
s_included(nhm, hum).
s_included(nlg, llc).
s_included(nlg, hum).
s_included(nmf, hum).
s_included(nmm, hum).
s_included(plt, lfr).
s_included(pos, art).
s_included(pro, unb).
s_included(psy, abs).
s_included(qua, qun).
s_included(rel, hum).
s_included(sac, hum).
s_included(sha, abs).
s_included(sta, sts).
s_included(str, art).
s_included(sts, abs).
s_included(sts, unb).
s_included(sub, mtt).
s_included(sur, hum).
s_included(tit, hum).
s_included(tme, llc).
s_included(unr, hum).


uniq(tempo,10843,10989).
uniq(sost,10446,10843).
uniq(state,10035,10446).
uniq(poss,09525,09669).
uniq(shape,09986,10034).
uniq(maths,04597,04622).
uniq(formu,05097,05129).
uniq(quant,09756,09986).
uniq(relat,07356,07693).
uniq(hum,06938,07764).
uniq(fhum,07693,07764).
uniq(thum,05020,05032).
uniq(nhum,05158,05251).
uniq(uhum,06848,06938).
uniq(bod,04055,04345).
uniq(amot,06659,06665).
uniq(anim,00861,02155).
uniq(locs,06262,06659).
uniq(nloc,06700,06848).
uniq(bloc,00821,00860).
uniq(coll,06023,06262).
uniq(edib,05617,05955).
uniq(emot,05560,05617).
uniq(proc,09669,09756).
uniq(nev,07764,07851).
uniq(hev,05363,05560).
uniq(att,00020,00860).
uniq(latt,05251,05363).
uniq(aatt,00558,00577).
uniq(inf,04728,05158).
uniq(abst,00577,00583).
uniq(kabs,04345,04728).
uniq(attr,03642,04055).
uniq(fmat,07851,09525).
uniq(nmat,06666,06700).
uniq(str,02155,03642).

coml_funz_roles(Ibar,Sub,Lem,[subj-actor,fcomp-Role],0,Role):-
   remove(no-neg-ibar, Ibar, NIbar),
   NIbar=Verb-Cat-_,
   prendi_lemma(Verb, Sub,Lem,AllFeats),
   coml(Lem, Subs),
   on(fcomp/Role, Subs),
   !.

coml_funz_roles(Ibar,Sub,Lem,[subj-actor,fcomp-Role],1,Role):-
   on(Verb-Cat-_, Ibar),
   prendi_lemma(Verb, Sub,Lem,AllFeats),
   coml(Lem, Subs),
   on(fcomp/Role, Subs),
   !.

reffuncs(Args):-
   findall(K-All, (funcs(Func, K, Head, All), 
                    Func\=sem, Func\=voice), Heads), 
      sort(Heads, Args),
      !.
refsems(Args):-
   findall(K-All, (funcs(Func, K, Head, All), 
                    Func=sem, All\=fp-_), Heads),
      sort(Heads, Args),
      !.

estrai_una_valenza(Funz, [], []):-
   !.

estrai_una_valenza([], Valenza, Arg):-
   estrai_val(Valenza,Arg),
   !.

estrai_una_valenza(Funz, Valenza, Arg):-
   on(Arg,Valenza),
   on(Funz-_, Arg),!.

estrai_una_valenza(Funz, Valenza, Valenz):-
   remove(Arg,Valenza,Valenz),
   Arg=Funz-_,!.

/*
estrai_una_valenza(vcomp, Valenza, Valenz):-
   remove(Arg,Valenza,Valenz),
   Arg=xcomp-_,!.
*/     

mremove_all([], _, [] ).
mremove_all(_, [], [] ).
mremove_all( RemoveItems, [El|Rest], [El|Rems] ):-
  member( El, RemoveItems ),
  !,
  mremove_all( RemoveItems, Rest, Rems ).
mremove_all( RemoveItems, [First|Rest], [First|Rems] ):-
  atomic(First),
  spy_lower(First, LowAtom, Pol),
  member( LowAtom, RemoveItems ),
  !,
  mremove_all( RemoveItems, Rest, Rems ).
mremove_all( RemoveItems, [El|Rest], Rems ):-
  mremove_all( RemoveItems, Rest, Rems ).


read_frase(File, IWords, I):-
   read(File, T),  
   (T=end_of_file, I=nil,! 
    ;
    T=f(P, I, N, RWords),
    matchfirstfour(IWords, RWords)
    ;
    read_frase(File, IWords, I)
    ).

%assert_gr_fac(SentNo, Govern,Clauses).
assert_gr_fac(SentNo, Govern,[]):-!.
assert_gr_fac(SentNo, Govern,[_-[Pol, Lem-_|_]|Clauses]):-
     funcs(sem, SentNo-Cl1, Cong, First),
     nonvar(Cong),
     Cong=[Sem-_-fac],
     (sy(Govern),Gov=Govern,Lemm=Lem; 
        sy(Lem),Gov=Lem,Lemm=Govern;Gov=Govern,Lemm=Lem),
    term_to_atom(ccomp-prop,FunctR),
     DepGr=..[FunctR,Sem,Gov,Lemm],
     asserta(dgrs(SentNo,DepGr)),
     !.
assert_gr_fac(SentNo, Govern,[_-[Pol, Lem-_|_]|Clauses]):-
     funcs(sem, No-Cl1, Cong, First),
    nonvar(Cong),
     Cong=[Sem-_-fac],
     (nonvar(Sem),Se=Sem;var(Sem),Se=nil),
     (sy(Govern),Gov=Govern,Lemm=Lem; sy(Lem),Gov=Lem,Lemm=Govern;Gov=Govern,Lemm=Lem),
    term_to_atom(ccomp-prop,FunctR),
     DepGr=..[FunctR,Sem,Gov,Lemm],
     \+ dgrs(SentNo,DepGr),
     asserta(dgrs(SentNo,DepGr)),
     !.

assert_gr_fac(SentNo, Govern,[_-[Pol, Lem-_|_]|Clauses]):-
     (sy(Govern),Gov=Govern,Lemm=Lem; sy(Lem),Gov=Lem,Lemm=Govern;Gov=Govern,Lemm=Lem),
    term_to_atom(ccomp-prop,FunctR),
     DepGr=..[FunctR,nil,Gov,Lemm],
     \+ dgrs(SentNo,DepGr),
     asserta(dgrs(SentNo,DepGr)),
     !.

assert_gr_fac(SentNo, Govern,[_-[]|Clauses]):-
   assert_gr_fac(SentNo, Govern,Clauses),
    !.
assert_gr_fac(SentNo, Govern,Clauses):-
    Clauses\=[],
    remove(_-[Pol, Lem-_|_],Clauses,_),
     (sy(Govern),Gov=Govern,Lemm=Lem; sy(Lem),Gov=Lem,Lemm=Govern;Gov=Govern,Lemm=Lem),
    term_to_atom(ccomp-prop,FunctR),
     DepGr=..[FunctR,nil,Gov,Lemm],
     \+ dgrs(SentNo,DepGr),
     asserta(dgrs(SentNo,DepGr)),
     !.


permissible(sp).
permissible(sn).
permissible(sa).
permissible(subj).
permissible(obj).
permissible(obl).
permissible(vcomp).
permissible(subj_vcomp).
permissible(xcomp).
permissible(fac).
permissible(ibar).
permissible(f2).
permissible(cp).

explore_ibars(IBars, [], IBars):-!.
explore_ibars(IBars, [Cl-[Lem-Arg-Neg, RefsRel, [Lem-Aggs]]|_], Resto):-
     IBars=[ibar-Ibar|Resto],
     assign_funz_roles(Ibar,CatV,Lem,Valenzes,Neg),
     !.
explore_ibars(IBars, Refs, IBars):-!.
find_position_verb(V,vcomp):-
     cl(Cl), Cl=1,
    findall_poss(Frase),
    on(Pos-Word,Frase),
    Pos<3,
    on(T-V,Word),!.
find_position_verb(V,ibar).

extract_ibar_fac(Clause,Clause,IBars, NIBars):-
     remove(Vcomp,Clause,Args), 
     Vcomp=ibar-IBar,
     append([_-ibar-IBar],IBars, NIBars),
    !.
extract_ibar_fac(Clause,Claus,IBars, NIBars):-
     appiattisci(Clause,Claus),
     remove(Vcomp,Claus,Args), 
     Vcomp=ibar-IBar,
     (on(_-ibar-IBar,IBars),NIBars=IBars
       ;
     append([_-ibar-IBar],IBars, NIBars)),
    !.
extract_ibar_fac(Clause,Claus,IBars, NIBars):-
     (Fc=fc;Fc=fs),
     remove(Fc-Vcomp,Clause,Args), 
     extract_ibar_fac(Vcomp,Claus,IBars, NIBars),!.

check_extract_parent(0, FunctsOut, Clause, NPar):-
    extract_parent(0,FunctsOut, NewClause, Parent),
    checkextract(FunctsOut, NewClause, Clause, Parent, NPar),
    !.
check_extract_parent(N, FunctsOut, Clause, NPar):-
    extract_parent(N,FunctsOut, NewClause, Parent),
    checkextract(FunctsOut, NewClause, Clause, Parent, NPar),
    !.


checkextract(FunctsOut, Clause, Clause, [dirsp-W|Rest], [dirsp-W|Rest]):-
    Rest\=[],
    on(fac-_,Clause),!.
checkextract(FunctsOut, Clause, Clause, [F-W|Rest], [F-W|Rest]):-
    Rest\=[],
    on(ibar-_,Clause),!.
checkextract(FunctsOut, Clause, Clause, [F-W], [F-W]):-
    F\=subj,F\=obj,F\=obl,!.
checkextract(FunctsOut, NewClause, Clause, [F-W], [savv-Avv]):-
    (F=subj;F=obj;F=obl),
    remove_all([f3-_], FunctsOut, NewClaus),
    remove(savv-Avv,NewClaus,Clause),
    !.
checkextract(FunctsOut, Clause, NewClause, _, [F-W|Rest]):-
    Rest\=[],
    append(Clause,[F-W|Rest], NewClause),
    on(ibar-_,NewClause),!.


extract_parents(N,[], [], []):-!.
extract_parents(N,[f3-F3|Clause], [f3-F3|NewClause], Parent):-
    0 < N,
    N1 is N + 1,
    findall(D, on(dirsp-D,Clause), Ds), 
    (Ds=[]
    ;
    on(dirsp-D,Clause),length(D,1)),
    extract_parent(N1,Clause, NewClause, Parent),
    !.
extract_parents(N,[fp-F3|Clause], [fp-F3|NewClause], Parent):-
    0 < N,
    N1 is N + 1,
    findall(D, on(dirsp-D,Clause), Ds), 
    (Ds=[]
    ;
    on(dirsp-D,Clause),length(D,1)),
%     (Ds=[];length(D,1)),
    extract_parent(N1,Clause, NewClause, Parent),
    !.
extract_parents(N,[dirsp-F3|Clause], [dirsp-F3|NewClause], Parent):-
    0 < N,
    N1 is N + 1,
    extract_parent(N1,Clause, NewClause, Parent),
    !.
extract_parents(N,[f3-F3|Clause], [f3-F3|NewClause], Parent):-
    extract_parents(N,Clause, NewClause, Parent),
    !.
extract_parents(N,[fp-F3|Clause], [fp-F3|NewClause], Parent):-
    extract_parents(N,Clause, NewClause, Parent),
    !.
extract_parents(N,[W|Clause], NewClause, Parent):-
    W=fac-Fac,
    findall(J,on(f3-J,Fac),Js),Js\=[],
    length(Js,1),
    append(Fac,Clause,Cl),
    extract_parents(N,Cl, NewClause, Parent),
    !.

extract_parents(N,[W|Clause], NewClause, [W|Parent]):-
    extract_parents(N,Clause, NewClause, Parent),
    !.
extract_parent(N,[], [], []):-!.
/*
extract_parent(N,[f3-_|Clause], NewClause, Parent):-
    N1 is N + 1,
    extract_parents(N1,Clause, NewClause, Parent),
    !.
extract_parent(N,[fp-_|Clause], NewClause, Parent):-
    N1 is N + 1,
    extract_parents(N1,Clause, NewClause, Parent),
    !.
*/
extract_parent(0,[dirsp-_|Clause], NewClause, Parent):-
    extract_parents_dirs(2,Clause, NewClause, Parent),
    !.
extract_parent(0,[W|Clause], [W|NewClause], Parent):-
    appiattisci(Clause,Claus),
    findall(J,on(f3-J,Claus),Js),Js\=[],
    length(Js,1),
    nth(Claus, N, f3-J), N<2,
    findall(K,on(fac-K,Claus),Ks),Ks=[],
    extract_parents(0,Claus, NewClause, Parent),
    !.
extract_parent(0,[W|Clause], [W|NewClause], Parent):-
    appiattisci(Clause,Claus),
    findall(J,on(fp-J,Claus),Js),Js\=[],
    length(Js,1),
    nth(Claus, N, fp-J), N<2,
    findall(K,on(fac-K,Claus),Ks),Ks=[],
    extract_parents(0,Claus, NewClause, Parent),
    !.    
extract_parent(N,[W|Clause], [W|NewClause], Parent):-
    extract_parent(N,Clause, NewClause, Parent),
    !.
extract_parent(N,[fp-Fp|Clause], Clause, Fp):-
    !.
extract_parents_dirs(N,[], [], []):-!.
extract_parents_dirs(N,[dirsp-_|Clause], NewClause, Parent):-
    1 < N,
    extract_parent(N,Clause, NewClause, Parent),
    !.
extract_parents_dirs(N,[f3-_|Clause], NewClause, Parent):-
    extract_parents_dirs(N,Clause, NewClause, Parent),
    !.
extract_parents_dirs(N,[fp-_|Clause], NewClause, Parent):-
    extract_parents_dirs(N,Clause, NewClause, Parent),
    !.

extract_parents_dirs(N,[W|Clause], NewClause, [W|Parent]):-
    extract_parents_dirs(N,Clause, NewClause, Parent),
    !.

remove_subject(Arg,Ruolo,Rest):-
     (Subj=sogg;Subj=subj),
     remove(Subj-Ruolo, Arg, Rest).
remove_subject(Arg,Ruolo,Rest):-
     (Subj=sogg;Subj=subj),
     remove(Subj/Ruolo, Arg, Rest).
remove_compls(Rest,Role):-
     remove(Arg2-Role,Rest,_).
remove_compls(Rest,Role):-
     remove(Arg2/Role,Rest,_).

assert_subj_vcomp(arb, Head, N):-!.
assert_subj_vcomp(Arg1, Head, N):-
     ref_funcs(Fun1, Arg1, Testa, First),
     check_testa(Testa,Test),
     DepGr2=..[subj-agent,Head,Test],
     asserta(dgrs(N,DepGr2)),
     !.

cond_remove_vcomp(FunctsOut,NRest,ibar-IBar,_-ibar-NIBar):-
     remove(Vcomp, FunctsOut,Rest),
     Vcomp=vcomp-Vcom,
     (Vcom=[_-_-sv5|_];Vcom=[_-_-sv2|_];Vcom=[_-_-sv3|_]),
     Vcom\=IBar,
     append(IBar,Vcom,NIBar),
     append(Rest,[ibar-NIBar],NRest),
     !.
cond_remove_vcomp(FunctsOut,FunctsOut,IBar,NIBar):-
     IBar=ibar-Ibar, NIBar=_-ibar-Ibar,!.

check_auxiliaries_modals([V-Cat-_]):-
    (supporto(V); coplbh(V); Cat=neg; Cat=avv),!.
check_auxiliaries_modals([V-Cat-_|Rest]):-
    (supporto(V); coplbh(V); Cat=neg; Cat=avv),
    check_auxiliaries_modals(Rest),!.
check_auxiliaries_modals([V-Cat-_]):-
    coplbh(V),
    (Cat=ausai;Cat=ausei),!.
check_auxiliaries_modals([V-Cat-_]):-
    coplbh(V),
    (Cat=vppt;Cat=vppin),!.

cond_assert_fint_ibar(Verbs,Costs, NCosts):-
    check_auxiliaries_modals(Verbs),
    (remove(ibar-Ibar, Costs, Feats), Ib=ibar
    ;
     remove(vcomp-Ibar, Costs, Feats), Ib=vcomp),
     cl(Cl),
     append(Verbs,Ibar,Rest),
     assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
     assert_passive(Rest,Lem),
     asserta(funcs(ibar, Cl, Lem, ibar-Rest)),
     nth(Costs,Num,Ib-_),
     substitute1(Costs, Num, ibar-Rest, NCosts),    
    !.
cond_assert_fint_ibar(Rest,Functs,Functs):-
    assert_copulative(Rest),
     cl(Cl),
     assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    assert_passive(Rest,Lem),
    asserta(funcs(ibar, Cl, Lem, ibar-Rest)),
    !.

assignfunctions([],[],[]):-!.
assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=savv-Avv,
   assignfunctions(NFeats, Sints, FunctsO),
   append([savv-Avv],FunctsO,FunctsOut),
   !.
assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=fc-Avv,
   NFeats=[Sec|Rest],
   Sec=Fu-Cos, Fu\=ibar,
   \+ on(ibar-_,NFeats),
   assignfunctions(NFeats, Sints, FunctsO),
   (Avv=[such_as-_-_],
    FunctsO=[Fun-Struc|Res],
    append(Avv,Struc,FunctsOu),
    FunctsOut=[appos-FunctsOu|Res]
    ;
   append([fc-Avv],FunctsO,FunctsOut)),
   !.

assignfunctions([First,Sec|NFeats], Sints, FunctsOut):-
   First=fs-[as-cosu-fs],
    (Sec=sn-Rest;Sec=subj-Rest),
    \+ on(ibar-_,NFeats),
   assignfunctions([Sec|NFeats], Sints, FunctsO),
   (Avv=[as-cosu-fs],
    FunctsO=[Fun-Struc|Res],
    append(Avv,Struc,FunctsOu),
    FunctsOut=[xcomp-FunctsOu|Res]
    ;
   append([fs-[as-cosu-fs]],FunctsO,FunctsOut)),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=ibar-Rest,
   check_auxiliaries_modals(Rest),
   NFeats=[fp-Cong,Sec,fp-Cong|Costs],
   Sec=savv-Avv,
   remove(ibar-Ibar, Costs, Feats),
   Ibar\=Rest,
   \+  check_auxiliaries_modals(Ibar),
   append(Rest,Ibar,Third),
   assign_vfunction(ibar-Third, Ibarr),
   retractall(ibar),
   assert(ibar(true)),
   continua_ibar_complements(Ibarr,Feats,Sints, FunctsAll),
   append([savv-Avv],FunctsAll,FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=ibar-Rest,
   check_auxiliaries_modals(Rest),
   NFeats=[savv-Cong,Sec,ibar-Be|Costs],
   Sec=sp-Avv,
   remove(ibar-Ibar, Costs, Feats),
   Ibar\=Rest,
   \+  check_auxiliaries_modals(Ibar),
   append([will-vsup-_],Ibar,Thir),
   append(Be,Thir,Third),
   append(Cong,Third,Thirdd),
   assign_vfunction(ibar-Thirdd, Ibarr),
     retractall(ibar),
     assert(ibar(true)),
   continua_ibar_complements(Ibarr,Feats,Sints, FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
    First=ibar-Rest,
    check_auxiliaries_modals(Rest),
    check_new_proposition(NFeats),
    NFeats=[F-Cong|Costs],
    F\=sn,F\=sa,F\=sq,
    remove(ibar-Sec,NFeats,Feats),
    Sec\=Rest,
    \+ check_auxiliaries_modals(Sec),
    append(Rest, Sec, Verb),
    assign_vfunction(ibar-Verb, Ibarr),
     retractall(ibar),
     assert(ibar(true)),
   continua_ibar_complements(Ibarr,Feats,Sints, FunctsOut),
    !.

assignfunctions([ibar-First, ibar-Sec|NFeats], Sints, FunctsAll):-
     aareverse(First, X),
     participio(X,Verbo,Gen,Num),
     assign_vfunction(ibar-Sec, Ibar),
     retractall(ibar),
     assert(ibar(true)),
    continua_ibar_complements(Ibar,NFeats,Sints, FunctsA),
    append([mod-First],FunctsA,FunctsAll),
    !.

assignfunctions([First|NFeats], Sints, FunctsAll):-
   assign_vfunction(First, Ibar),
   (First=ibar-_,
     retractall(ibar),
     assert(ibar(true))
    ;
     First\=ibar-_
     ),
   continua_ibar_complements(Ibar,NFeats,Sints, FunctsAll),
   !.

assignfunctions([First|NFeats], Sints, FunctsAll):-
   once(ibar(false)),
   First=mod-Ibars,
   Ibars=[_-vppt-sv3],
   assign_vfunction(ibar-Ibars, Ibar),
   retractall(ibar),
   assert(ibar(true)),
   continua_ibar_complements(Ibar,NFeats,Sints, FunctsAll),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=sp-Prep,
   NFeats\=[],
   NFeats=[Sec|Rest],
   check_noun_subc(Prep,Sec,Rest,Obl,Sin),
   assignoblfunctions(Prep,Sin, Sints, FunctsO),
    append(Obl, FunctsO, FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=sp-Prep,
   NFeats\=[],
   NFeats=[savv-[Month-avv-savv], sn-Sec,fp-[','-punt-fp],sn-[Date-num-sn]|Rest],
   nt(Month),
   append(Sec,[Date-num-sn],Secs),
   assign_oblfunction(savv-[Month-avv-savv], Prep, Obl),
   assignoblfunctions(Prep,Rest, Sints, FunctsO),
   build_dates(savv-[Month-avv-savv],Obl, [sn-Secs], FunctsOut),
   !.
assignfunctions([First|NFeats], Sints, [Pref-FunctsOu]):-
   First=sp-Prep,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=fint-Pron,
   assert(ibar(false)),
   assert(passiv(off)),
   assign_functions([f2-Pron|Rest], Sints, FunctsO),
   (FunctsO=Pref-Body,
     append(Prep, Body, FunctsOu)
   ;
    FunctsO=[Pref-Body|AllFuncs],   
    append(Prep, Body, Functs),
    append(Functs,AllFuncs,FunctsOu)
   ),
    !.

assignfunctions([First|NFeats], Sint, FunctsOut):-
   First=sp-Prep,
   Prep=[Pp|Cost],
   Cost=[Sec|Rest],
   (list(Sec), Se=sn-Sec, Res=Rest; Se=sn-Cost, Res=[]),
   assign_oblfunction(Se, [Pp], Obl),
   assignoblfunctions(Pp,Res, Sints, FunctsO),
   append_relative([],Obl, FunctsO, FunctsOut),
   append(Sints,NFeats,Sint),
   !.

assignfunctions([First|NFeats], Sint, FunctsOut):-
   (First=sp-Prep;
    First=spd-Prep;
    First=spda-Prep),
   Prep=[Pp|Cost],
   Cost=[Sec|Rest],
   (list(Sec), Se=sn-Sec, Res=Rest; Se=sn-Cost, Res=[]),
   assign_oblfunction(Se, [Pp], Obl),
   (assignoblfunctions(Pp,Res, Sints, FunctsO),
    append_relative([],Obl, FunctsO, FunctsOut)
    ;
    Sints=Rest, FunctsOut=Obl),
   append(Sints,NFeats,Sint),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
    once(ibar(true)),
    First=Fu-Avv,
    (Fu=savv;
      Fu=sn,
      aareverse(Avv,W),
      nt(W)),
    NFeats\=[],
    NFeats=[Obj|Resto],
    assign_ofunction(Obj, Ogg),
    assignoblfunctions([],Resto, Sints, FunctsO),
    build_dates(First,Ogg, FunctsO, FunctsOu),
    append(FunctsOu,[savv-Avv],FunctsOut),
    !.

assignfunctions([First|NFeats], Sints, [Fun-FunctsOut]):-
    First=sq-Rest,
    Rest=[Like-ccom-_],
    NFeats\=[],
    NFeats=[Obj|Resto],
    assign_ofunction(Obj, Ogg),
    Ogg=[Fun-Cost],
    append(Rest, Cost, AsCost),
    assignoblfunctions(Like,Resto, Sints, FunctsO),
    append(AsCost, FunctsO, FunctsOut),
    !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=sa-[such-ag-sa],
   NFeats=[Sec|Rest],
   Sec=sn-[a-art-sn|Cost],
   append([such-ag-sa],[a-art-sn|Cost],Fir),
   assign_ffunction(sn-Fir, Functs),
   assignfunctions(Rest, Sints, FunctsO),
   append_relative([],Functs, FunctsO, FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=sn-SN,
   abreverse(SN,Cat),Cat=nt,
   Ogg=[savv-SN],
   assignfunctions(NFeats, Sints, FunctsO),
   append_relative([],Ogg, FunctsO, FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   once(ibar(true)),
   (NFeats=[Sec|Rest],
      Sec\=ibar-_;NFeats=[]),
   assign_ofunction(First, Ogg),
   assignoblfunctions([],NFeats, Sints, FunctsO),
    append_relative([],Ogg, FunctsO, FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   once(ibar(true)),
   First=subj-Subj,
   assignoblfunctions([],NFeats, Sints, FunctsO),
    append_relative([],[First], FunctsO, FunctsOut),
%   append(Ogg, FunctsO, FunctsOut),
   !.
assignfunctions([First|NFeats], Sints, FunctsAll):-
   once(passiv(off)),
   once(ibar(false)),
   First=sn-SN,
   abreverse(SN,Cat),Cat\=nt,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Subj=[subj-SN],
   nprendi_testa(subj, SN, Testa),
   cl(Cl),
   asserta(funcs(subj, Cl, Testa, Subj)),
   (assign_vfunction(Sec, Ibar),
    retractall(ibar),
    assert(ibar(true)),
    assignfunctions(Rest, Sints, FunctsO),
    append(Ibar, FunctsO, FunctsOut)
   ;
    assignfunctions(NFeats, Sints, FunctsOut)
    ),
    append(Subj, FunctsOut, FunctsAll),     
   !.

assignfunctions([First|NFeats], Sints, FunctsAll):-
   First=sa-SA,
   NFeats=[Sec|Resto],
   Sec=sn-SN,
   append(SA, SN, SUBJ),
   Subj=[subj-SUBJ],
   Resto=[Terz|Rest],
   (assign_vfunction(Terz, Ibar),
     retractall(ibar),
     assert(ibar(true)),
     assignfunctions(Rest, Sints, FunctsO),
     append(Ibar, FunctsO, FunctsOut)
    ;
     assignfunctions(Resto, Sints, FunctsOut)
    ),
    append(Subj, FunctsOut, FunctsAll),     
   !.

assignfunctions([fs-[as-cosu-fs], sa-SA,fs-[as-cosu-fs]|NFeats], Sints, FunctsAll):-
   NFeats=[Sec|Resto],
   Sec=sn-SN,
   append(SA, [mod-[fs-[as-cosu-fs],SN]], SUBJ),
   Subj=sa-SUBJ,
   assign_ofunction(Subj, Ogg),
   assignfunctions(Resto, Sints, FunctsO),
   append(Ogg, FunctsO, FunctsAll),     
   !.

assignfunctions([First|NFeats], Sints, [f2-FunctsOut]):-
   First=f2-Cong,
   Cong=[A],
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Cong, First)),
   assert(ibar(false)),
   assert(passiv(off)),
   assign_functions(NFeats, Sints, Functs),
   append([f2-Cong], Functs, FunctsOut),
   assert(ibar(false)),
   assert(passiv(off)),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=fp-Cong,
   NFeats=[Sec|Rest],
   Rest=[fp-Cong|Costs],
   assign_functions(Costs, Sints, FunctsO),
   append_relative([],[Sec], FunctsO, FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, [f-FunctsOut]):-
   First=Fu-Sec,
        areverse(Sec, A),
        nonvar(A),
        A='''-'''-par-sn,
   NFeats\=[],
   NFeats=[Fun-AFunc|Ffuncts],
        areverse(AFunc, B),
        nonvar(B),
        B='''-'''-par-sn,
   append(Sec, [Fun-AFunc|Ffuncts], PFuncts),
   assign_ffunction(First, Functs1),
   assign_ffunction(Fun-AFunc, Functs),
   assignfunctions(Ffuncts, Sints, FunctsO),
   append(Functs1, Functs, Functss),
   append(Functss, FunctsO, FunctsOut),
   assert(ibar(false)),
   assert(passiv(off)),
   !.

assignfunctions([First|NFeats], Sints, [Pref-FunctsOu]):-
   First=sp-Prep,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=fint-Pron,
   assign_functions([f2-Pron|Rest], Sints, FunctsO),
   (FunctsO=Pref-Body,
     append(Prep, Body, FunctsOu)
   ;
    FunctsO=[Pref-Body|AllFuncs],   
    append(Prep, Body, Functs),
    append(Functs,AllFuncs,FunctsOu)
   ),
    !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   First=sp-Prep,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=f-['"'-_-_],
   Rest=[Sec1|Rest1],
   assign_oblfunction(Sec1, Prep, Obl),
   assignoblfunctions(Prep,Rest1, Sints, FunctsO),
   build_dates(Sec,Obl, FunctsO, FunctsOut),
   !.

assignfunctions([First|NFeats], Sints, FunctsOut):-
   findall(I,(on(sv3-_,NFeats);on(ibar-_,NFeats);on(vcomp-_,NFeats)),Is), Is=[],
   (First=f-[Par-par-f];First=fp-Fp;First=dirs-Dirs;First=f3-Dirs),
    assignfunctions(NFeats, Sints, FunctsOut),
    !.
assignfunctions([First|NFeats], Sints, FunctsOut):-
    First=F-[Fac|_],\+ integer(F),
    assign_functions([First|NFeats], Sints, FunctsOut),
    !.
assignfunctions(NFeats, NFeats, []):-
   !.

areverse(Sec, A):-
   appiattisci(Sec,Se),
   reverse(Se, [A|_]),
   !.


assignoblfunctions(P,[First|NFeats], Sint, FunctsOut):-
   First=sp-Prep,
   Prep=[Pp|Cost],
   Cost=[Sec|Rest],
   (list(Sec), Se=sn-Sec, Res=Rest; Se=sn-Cost, Res=[]),
   assign_oblfunction(Se, [Pp], Obl),
   assignoblfunctions(Pp,Res, Sints, FunctsO),
   append_relative([],Obl, FunctsO, FunctsOut),
   append(Sints,NFeats,Sint),
   !.

assignoblfunctions(P,[First|NFeats], Sint, FunctsOut):-
   (First=sp-Prep;
    First=spd-Prep;
    First=spda-Prep),
   Prep=[Pp|Cost],
   Cost=[Sec|Rest],
   (list(Sec), Se=sn-Sec, Res=Rest; Se=sn-Cost, Res=[]),
   assign_oblfunction(Se, [Pp], Obl),
   (assignoblfunctions(Pp,Res, Sints, FunctsO),
    append_relative([],Obl, FunctsO, FunctsOut)
    ;
    Sints=Rest, FunctsOut=Obl),
   append(Sints,NFeats,Sint),
   !.

assignoblfunctions(Prep,[First|NFeats], Sints, FunctsOut):-
    once(ibar(true)),
    First=savv-Avv,
    NFeats=[Obj|Resto],
    assign_ofunction(Obj, Ogg),
    assignoblfunctions([],Resto, Sints, FunctsO),
    append_relative([],Ogg, FunctsO, FunctsOut),
    !.

assignoblfunctions(Prep,[First|NFeats], Sints, [Fun-FunctsOut]):-
    First=sq-Rest,
    Rest=[Like-ccom-_],
    NFeats=[Obj|Resto],
    assign_ofunction(Obj, Ogg),
     Ogg=Fun-Og,
    (Resto=[Fu-_|_], Fu\=vcomp,
     assignoblfunctions(Like,Resto, Sints, FunctsO),
     append(Og, FunctsO, FunctsOu),
     append(Rest, FunctsOu, FunctsOut)
     ;
     append(Rest, Og, FunctsOut), Sints=Resto
     ),
    !.

assignoblfunctions(Prep,[First|NFeats], Sints, [f2-FunctsOut]):-
   First=f2-Cong,
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Cong, First)),
   assert(ibar(false)),
   assert(passiv(off)),
   assign_functions(NFeats, Sints, Functs),
   append([f2-Cong], Functs, FunctsOut),
   assert(ibar(false)),
   assert(passiv(off)),
   !.

assignoblfunctions(Prep,[First|NFeats], Sints, FunctsOut):-
   First=fc-Cong,
   NFeats=[Sec|Rest],
   (Sec=sp-Prep;
    Sec=spd-Prep;
    Sec=spda-Prep),
    assignoblfunctions(Prep,NFeats, Sints, FunctsOu),
    append([Cong], FunctsOu,FunctsOut),
    !.

assignoblfunctions(Prep,[First|NFeats], Sints, FunctsOut):-
   First=fp-Cong,
   NFeats=[Sec|Rest],
   Rest=[fp-Cong|Costs],
   (Costs=[], Sec=_-Cost, FunctsOut=[appos-Cost]
     ; 
    Costs\=[], append([Sec],Costs,Cost),
    assign_functions(Cost, Sints, FunctsOut)),
   !.
   
assignoblfunctions(Prep,[First|NFeats], Sints, [vcomp-Rest|FunctsOut]):-
    First=vcomp-Rest,
    cl(Cl),
     assign_funroles(Rest,CatV,Lem,Valenzes,Neg),
    asserta(funcs(vcomp, Cl, Lem, [vcomp-Rest])),
    assignoblfunctions(Prep,NFeats, Sints, FunctsOut),
   !.


assignoblfunctions(Prep,NFeats, NFeats, []):-
   !.

convert_appos(Adjs,Args,Argss,Adjss):-
    findall(App, on(appos-App,Adjs), Cs),Cs\=[],
    findall(Sub, on(subj-Sub,Args), Ss),Ss=[],
    remove(appos-App,Adjs,Adjss),
    append([subj-App],Args,Argss),
    !.
convert_appos(Adjs,Args,Args,Adjs):-
    !.

convert_double_ibar(Adjs,Args,Argss,Adjs):-
    findall(App, on(ibar-App,Args), Cs),Cs\=[],
    length(Cs,L), 1=<L,
    findall(Sub, on(subj-Sub,Args), Ss),Ss\=[],
    length(Ss,L), 1=L,
    nth(Args,N,ibar-App),
    subst_ibar(N, Args, Argss),
    !.
convert_double_ibar(Adjs,Args,Args,Adjs):-
    !.

subst_ibar(1, [A-Cos|Rest],  FunctsO):-
    append([vcomp-Cos],Rest,FunctsO),
     !.
subst_ibar(N, [A-Cos|Rest], [A-Cos|FunctsO]):-
    N1 is N - 1,
    subst_ibar(N1, Rest, FunctsO),
   !.

conversion_tools(Adjs,Args,Argss,Adjss):-
   convert_appos(Adjs,Args,Args1,Adjs1),
   convert_double_ibar(Adjs1,Args1,Argss,Adjss),
    !.

check_args_sems(ArgsAll,Argss,Adjss):-
    check_argsems(ArgsAll,Args,Adjs),
    conversion_tools(Adjs,Args,Argss,Adjss),
    !.


check_argsems([],[],[]):-!.
check_argsems([[]],[],[]):-!.
check_argsems([fint-W|ArgsAll],[fint-W|Args],[fint-W|Adjs]):-
    W\=['?'-_-_],W\=[],
    check_argsems(ArgsAll,Args,Adjs),
    !.
check_argsems([fint-W|ArgsAll],[fint-W|Args],[fint-W|Adjs]):-
    W\=['?'-_-_],W\=[],
    on(W1-_-_,W),
    (W1=who;W1=which;W1=whom;W1=what),
    check_argsems(ArgsAll,Args,Adjs),
    !.
check_argsems([Fun-W|ArgsAll],[Fun-W|Args],Adjs):-
    W\=[],permissible(Fun),
    check_argsems(ArgsAll,Args,Adjs),
    !.

check_argsems([Fun-W|ArgsAll],Args,[Fun-W|Adjs]):-
    W\=[],\+ permissible(Fun),
    check_argsems(ArgsAll,Args,Adjs),
    !.

check_argsems([Fun|ArgsAll],Args,[Fun|Adjs]):-
    Fun\=[],check_argsems(ArgsAll,Args,Adjs),
    !.

    
assert_gr_adj(SentNo, Lem,[],[],[]):-!.
assert_gr_adj(SentNo, Lem,Adjs,Out,Mods):-
    Adjs\=[],
    remove(_-Punts,Adjs, Rest),
    Punts\=[], Punts=[A],
    nogen_member(Punt-_-_,Punts),
    nonvar(Punt),
    select_punct(Punt, _),
    Punt\='?',
    assert_gr_adj(SentNo, Lem,Rest,Out,Mods),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[AllArgsAdjs,Out],[Mods|Mods1]):-
    Adjs\=[],
    ((Adjs=[N-[fs-Term|VP]], integer(N);
       Adjs=[fs-Term|VP];Adjs=[fs-VP1], remove(fs-Term,VP1, VP))
     ;
    (Adjs=[N-[fc-Term|VP]], integer(N);
     Adjs=[fc-Term|VP];Adjs=[fc-VP1], remove(fc-Term,VP1, VP))
     ;
     Adjs=[xadj-VP]),
    (remove(ibar-Verb,VP, Rest), NClause=Clause;
    remove(vcomp-Verb,VP, Rest), append([ibar-Verb],Clause,NClause)),
    append([_-ibar-Verb],IBars, NIBars),
    extract_clause(NIBars, VP, NClause, IBar, RestFuncs, RestIbar,Adjss),
    create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lemm-VArgs, Neg),
    AllArgsAdjs=[Neg,Lemm-VArgs,Mods, ArgsAdjs,Out],
    N1 is SentNo + 1,
    cmod_adj_subord(Term,SentNo,Lem),
    append(VP,Adjss,NAdjs),
    assert_gr_adj(N1, Lemm,NAdjs,Out,Mods1),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[AllArgsAdjs,Out],[Mods|Mods1]):-
    Adjs\=[],
    ((Adjs=[N-[fs-Term|VP]], integer(N);
      Adjs=[fs-Term|VP];Adjs=[fs-VP1], remove(fs-Term,VP1, VP))
     ;
    (Adjs=[N-[fc-Term|VP]], integer(N);
     Adjs=[fc-Term|VP];Adjs=[fc-VP1], remove(fc-Term,VP1, VP))),
    (remove(ibar-Verb,Term, Rest), NClause=Term;
    remove(vcomp-Verb,Term, Rest), append([ibar-Verb],Rest,NClause)),
    append([_-ibar-Verb],IBars, NIBars),
    extract_clause(NIBars, NClause, Clause, IBar, RestFuncs, RestIbar,Adjss),
    create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lemm-VArgs, Neg),
    AllArgsAdjs=[Neg,Lemm-VArgs,Mods, ArgsAdjs,Out],
    N1 is SentNo + 1,
    cmod_adj_subord(Term,SentNo,Lem),
    append(VP,Adjss,NAdjs),
    assert_gr_adj(N1, Lemm,NAdjs,Out,Mods1),
    !.

assert_gr_adj(SentNo, Lem,Adjs,RelClause,[]):-
    Adjs\=[],
    Adjs=[fs-[fs-[Cong-cosu-_]|VP]],
    (Cong=as;Cong=as_to),
    gen_sym(sn,Ind),
    build_relativeclause(Ind,arb,VP,RelClause,Res),
    !.    
assert_gr_adj(SentNo, Lem,Adjs,RelClause,[]):-
    Adjs\=[],
    Adjs=[f2-[Cong-p-sp|VP]],
    (Cong=as;Cong=as_to),
    gen_sym(sn,Ind),
    build_relativeclause(Ind,arb,VP,RelClause,Res),
    !.    

assert_gr_adj(SentNo, Lem,Adjs,[RelClause|Out],[]):-
    Adjs\=[],
    Adjs=[f2-F|VP],
    F\=[A],
    create_find_head_relative(Hea,Ind),
    assert_gr_adj(SentNo, Lem,VP,Out,Mods1),
    build_relativeclause(Ind,Hea,[f2-F],RelClause,Res),
    !.    

assert_gr_adj(SentNo, Lem,Adjs,RelClause,[]):-
    Adjs\=[],
    Adjs=[f2-F|VP],
    F=[A],
    create_find_head_relative(Hea,Ind),
    build_relativeclause(Ind,Hea,Adjs,RelClause,Res),
    !.    

assert_gr_adj(SentNo, Lem,Adjs,[AllArgsAdjs,Out],[Mods|Mods1]):-
    Adjs\=[],
    appiattisci(Adjs, NAdjs),
    (remove(ibar-Term,NAdjs, Rest);
    remove(vcomp-Term,NAdjs, Rest)),
    append([_-ibar-Term],IBars, NIBars),
    extract_clause(NIBars, NAdjs, Clause, IBar, RestFuncs, RestIbar,Adjss),
    create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lemm-VArgs, Neg),
    AllArgsAdjs=[Neg,Lemm-VArgs,Mods, ArgsAdjs,Out],
    N1 is SentNo + 1,
    assert_gr_adj(N1, Lemm,Adjss,Out,Mods1),
    !.
    
assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,Mods):-
    Adjs\=[],
    remove(subj-Term,Adjs, Rest),
    on(Sem-i-_,Term),
    remove(Adj-Term1,Rest, []),
    on(Govern-_-_,Term1),
    assert_cmod_adj_subord(SentNo,adj,mod,Sem,Govern,Lem),
    assert_gr_adj(SentNo, Lem,Rest,OutAdjs,Mods),
    !.
assert_gr_adj(1, Lem,Adjs,OutAdjs,Mods):-
    Adjs\=[],
    remove(Adj-Term,Adjs,Rest),
    Adj\=fp,Adj\=fint,
    Term\=[],
    on(Sem-_-_,Term),
    nonvar(Sem),
    check_sem_wh(Sem,Pref),
    assert_cmod_adj_subord(1,Pref,mod,Sem,nil,Lem),
    assert_gr_adj(1, Lem,Rest,OutAdjs,Mods),
    !.

assert_gr_adj(1, Lem,Adjs,OutAdjs,Mods):-
    Adjs\=[],
    remove(Adj-Term,Adjs,Rest),
    (Adj=fs, Sub=subord; Adj=fc, Sub=coord),
    (on(Sem-_-_,Term);on(Adj-Ter,Term),on(Sem-_-_,Ter)),
    governor(N, Head),
    (Head=Hea-Id;atomic(Head),Hea=Head),
    (Hea\=Lem, Gov=Hea; Gov=nil), 
    assert_cmod_adj_subord(1,cmod,Sub,Sem,Gov,Lem),
    assert_gr_adj(1, Lem,Rest,OutAdjs,Mods),
    !.

assert_gr_adj(1, Lem,Adjs,[DepGr1|OutAdjs],Mods):-
    Adjs\=[],
    remove(Adj-Term,Adjs,Rest),
    Adj=fint,
    (on(Sem-_-_,Term);on(Adj-Ter,Term),on(Sem-_-_,Ter)),
    Sem\='?',
    assert_cmod_adj_subord(1,cmod,focus,Sem,nil,Lem),
    assert_gr_adj(1, Lem,Rest,OutAdjs,Mods),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[Agg|OutAdjs],Mods):-
    Adjs\=[],
    remove(Sem-_-L,Adjs,Adj),
     \+ list(L),
     find_govern_adj(N,Govern,Head),
     Head\=Lem,
    (Head=Hea-Id;atomic(Head),Hea=Head),
    depgrsrols_obl(SentNo,Sem,Hea,Id,Lem,Tab,[],[],M,Hea,adj/adj,mod,Agg),
    assert_gr_adj(SentNo, Lem,Adj,OutAdjs,Mods),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[obl-[Sem,Lem,Lemma],Agg|OutAdjs],[Mods|Mods1]):-
    Adjs\=[],
    (remove(obl-First,Adjs,Adj);
    remove(sp-First,Adjs,Adj)),
    (P=pd;P=pda;P=p),remove(Sem-P-_,First,Sec), 
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     find_govern_adj(N,Govern,Head),
    (Govern=Lem-Id;atomic(Govern)),
     (nt(Lemma),Type=temporal;
        prendi_ruolo_obls(Sem,CatSem,Type)),
    depgrsrols_obl(SentNo,Sem,Lem,Id,Lemma-Ind,Tab,Tratti,CatSem,M,Testa,obl/adj,Type,Agg),
    assert_gr_adj(SentNo, Lem,Adj,OutAdjs1,Mods1),
    Mods=[Ind-Testa-Mod],
    assert_mods(SentNo, [Ind-Lemma-Mod],OutAdjs2),
    append(OutAdjs1,OutAdjs2,OutAdjs),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[adj-[Sem,Lem,Lemma],Agg|OutAdjs],[Mods|Mods1]):-
    Adjs\=[],
    remove(savv-First,Adjs,Adj),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
     (nt(Lemma),Type=temporal, Sem=in;Type=mod),
     find_govern_adj(N,Govern,Head),
    (Govern=Lem-Id;atomic(Govern)),
    depgrsrols_obl(SentNo,in,Lem,Id,Lemma-Ind,Tab,Tratti,CatSem,M,Testa,adj/adj,Type,Agg),
    Mods=[Ind-Testa-Mod],
    assert_mods(SentNo, [Ind-Lemma-Mod],OutAdjs2),
    assert_gr_adj(SentNo, Lem,Adj,OutAdjs1,Mods1),
    append(OutAdjs1,OutAdjs2,OutAdjs),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[adj-[in,Lem,Lemma],Arg|OutAdjs],[Mods|Mods1]):-
    Adjs\=[],
    remove(savv-First,Adjs,Adj),
    remove(Lemma-avv-_,First,Mod),
     assign_index(Ind),
    dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,adj/adj,mod,Arg),
    assert_gr_adj(SentNo, Lem,Adj,OutAdjs1,Mods1),
    Mods=[Ind-Testa-Mod],
    assert_mods(SentNo, [Ind-Lemma-Mod],OutAdjs2),
    append(OutAdjs1,OutAdjs2,OutAdjs),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[xadj-[Govern,Lem,Lemma],Arg|OutAdjs],[Mods|Mods1]):-
    Adjs\=[],
    remove(subj-First,Adjs,Adj),
     costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
    governor(N,Govern),
    dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,adj/adj,mod,Arg),
    assert_gr_adj(SentNo, Lem,Adj,OutAdjs1,Mods1),
    Mods=[Ind-Testa-Mod],
    assert_mods(SentNo, [Ind-Testa-Mod],OutAdjs2),
    append(OutAdjs1,OutAdjs2,OutAdjs),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[AllArgsAdjs,Out],[Mods|Mods1]):-
    Adjs\=[],
    appiattisci(Adjs, NAdjs),
    (remove(ibar-Term,NAdjs, Rest);
    remove(vcomp-Term,NAdjs, Rest)),
    append([_-ibar-Term],IBars, NIBars),
    create_clause_fac(SentNo, [ibar-Term], Rest, ArgsAdjs, Mods, NArgs, Lemm-VArgs, Neg),
    AllArgsAdjs=[Neg,Lemm-VArgs,Mods, ArgsAdjs,Out],
    N1 is SentNo + 1,
    assert_gr_adj(N1, Lemm,Adjss,Out,Mods1),
    !.
    
assert_gr_adj(SentNo, Lem,Adjs,Agg,Mods):-
    Adjs\=[],
    remove(vcomp-Cost,Adjs,Adj),
    build_adjuncts(SentNo,Lem, Adjs,Agg,Lems),
    !.
    
assert_gr_adj(SentNo, Lem,Adjs,[AllArgsAdjs,Out],[Mods|Mods1]):-
    Adjs\=[],
    remove(fac-Cost,Adjs,Rest),
    N1 is SentNo + 1,
    assert_gr_adj(N1, Lem,Rest,Out,Mods1),
    splitsent2(SentNo, IBars, [fac-Cost], AllArgsAdjs),
    !.
    
assert_gr_adj(SentNo, Lem,Adjs,[xadj-[Govern,Head,Lemma],Arg|OutAdjs],[Mods|Mods1]):-
    Adjs\=[],
    (remove(sn-First,Adjs,Adj);
    remove(appos-First,Adjs,Adj)),
     find_govern_adj(N,Govern,Head),
    costruisci_mods_aggs(First, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
    dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Head,prop/xadj,theme,Arg),
    Mods=[Ind-Testa-Mod],
    assert_mods(SentNo, [Ind-Testa-Mod],OutAdjs2),
    assert_gr_adj(SentNo, Lemma,Adj,OutAdjs1,Mods1),
    append(OutAdjs1,OutAdjs2,OutAdjs),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[xadj-[Govern,Head,Lemma],Arg|OutAdjs],[Mods|Mods1]):-
    Adjs\=[],
    remove(sq-First,Adjs,Adj),
    First=[as-ccom-_|Rest],
     find_govern_adj(N,Govern,Head),
    Adj=[],
    remove(_-Aj,Rest,Ajj),
    costruisci_mods_aggs(Aj, Testa, Resto, Lemma, CatSem, Tab, Tratti, Ind, Mod),
    dep_grs_rols(First,Ind,Lemma,Tab,Tratti,CatSem,Mod,Testa,prop/xadj,theme,Arg),
    assert_gr_adj(SentNo, Lemma,Ajj,OutAdjs1,Mods1),
    Mods=[Ind-Testa-Mod],
    assert_mods(SentNo, [Ind-Testa-Mod],OutAdjs2),
    append(OutAdjs1,OutAdjs2,OutAdjs),
    !.

assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,[Mods|Mods1]):-
    Adjs\=[],
    remove(xadj-Cost,Adjs,Adj),
    remove(vcomp-Verbs,Cost, Rest),
    (remove(_-p-_,Verbs, Verb);Verb=Verbs),
    find_govern_adj(N,Govern,Head),
    remove(B-A-C,Cost,Ajj),
    (Head=Hea-Ind;atomic(Head),
        ref_funcs(Fun, Ind, Head, First)),
    create_subject_rel(Ind, Verb, Valenz, Valenzz, Lemm-Arg1-Neg),
    assert_relative_subject(N,[pPro-pro-_],Head,Ind,Lemm),
    costruisci_semantica_controllo(Verb, Ind, _, Ruolo, Rel, NewVal),
    costruisci_mods_aggs(Rest, Testa, Resto, Lemma, CatSem, Tab, Tratti, Id, Mod),
    dep_grs_rols_vcomp(Rel,Verbs,Rest,Id,Lemma,Tab,Tratti,CatSem,Mod,Testa,xadj/xadj,Ruolo,Argg),
    OutAdjs2=[Neg,Lemm-Arg1,Mod, Argg, Aggs],
    assert_gr_adj(SentNo, Lemm,Adj,OutAdjs1,Mods1),
    append(OutAdjs1,OutAdjs2,OutAdjs),
    !.    

assert_gr_adj(SentNo, Lem,Adjs,[xadj-[Govern,Head,Lemma],[]|OutAdjs],Mods):-
    Adjs\=[],
    (remove(xadj-Cost,Adjs,Adj);
    remove(appos-Cost,Adjs,Adj)),
    remove(Lemma-Cat-_,Cost,Mod),
     find_govern_adj(N,Govern,Head),
     term_to_atom(xadj-mod,FunctR),
     DepGr=..[FunctR,Govern,Head,Lemma],
     asserta(dgrs(SentNo,DepGr)),
    asserta(ref_funcs(xadj, Ind, Lemma, Cost)),
    assert_gr_adj(SentNo, Lem,Adj,OutAdjs,Mods),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[Agg|OutAdjs],Mods):-
    Adjs\=[],
    build_multi_word_adj(Adjs,Sem,Rest),
    N is SentNo-1,
    find_govern_adj(N,Govern,Head),
    depgrsrols_obl(SentNo,Sem,Govern,Id,Lem,Tab,Tratti,CatSem,M,Testa,adj/adj,mod,Agg),
    assert_gr_adj(SentNo, Lem,Rest,OutAdjs,Mods),
    !.

assert_gr_adj(SentNo, Lem,Adjs,[],[]):-!.

create_find_head_relative(Hea,Ind):-
     find_govern_adj(N,Govern,Head),
     (Head=Hea-Id;atomic(Head),Hea=Head),
     ref_funcs(Fun, Ind, Heads, First),
     lemmatize_dic(Heads, Hea1,_),
     Hea=Hea1,
     !.    
create_find_head_relative(Hea,Ind):-
     ref_funcs(Fun, Ind, Heads, First),
     lemmatize_dic(Heads, Hea,_),
     !.    

build_multi_word_adj(Adjs,Sem,Rest):-
    nogen_member(Adj-Term,Adjs),
    remove(Adj-Term,Adjs,Rest),
    remove(Sem-_-_,Term,[]),
    !.
build_multi_word_adj(Adjs,Sem,Rest):-
    nogen_member(Adj-Term,Adjs),
    remove(Adj-Term,Adjs,Rest),
    Adj\=vcomp,
    nogen_member(Sem1-_-_,Term),
    remove(Sem1-_-_,Term,Rest1),
    remove(Sem2-_-_,Rest1,[]),
    concat(Sem1,'_',Ss),
    concat(Ss,Sem2,Sem),
    !.


assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=fc-Avv,
   (NFeats\=[],
     NFeats=[fc-Avv1|Rest], Ress=Rest, append(Avv,Avv1,Avv2)
     ;
    NFeats=[],Avv\=[A], Avv=[fc-Cong|Ress], Avv2=[fc-Cong]
     ;
    NFeats\=[],Avv\=[A], Avv=[fc-Cong|Res], Avv2=[fc-Cong],append(Res,NFeats,Ress) 
     ;
    Ress=NFeats, Avv2=Avv),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   assert(ibar(false)),
   assert(passiv(off)),   
   asserta(funcs(sem, Cl-Cl1, Avv2, First)),
   assign_functions(Ress, Sints, Functs),
   appos_subj(Functs,FunctsO),
   append_fc_fs_if(fc-Avv2, FunctsO, FunctsOut),
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=fs-Avv,
   (NFeats\=[],
     NFeats=[fs-Avv1|Rest], Ress=Rest, append(Avv,Avv1,Avv2)
     ;
    NFeats=[],Avv\=[A], Avv=[fs-Cong|Ress], Avv2=[fs-Cong]
     ;
    NFeats\=[],Avv\=[A], Avv=[fs-Cong|Res], Avv2=[fs-Cong],append(Res,NFeats,Ress) 
     ;
    Ress=NFeats, Avv2=Avv),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   assert(ibar(false)),
   assert(passiv(off)),
   asserta(funcs(sem, Cl-Cl1, Con, First)),
   assign_functions(Ress, Sints, Functs),
   appos_subj(Functs,FunctsO),
   append_fc_fs_if(fs-Avv2, FunctsO, FunctsOut),
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=fac-Avv,
   (NFeats\=[],
     NFeats=[fac-Avv1|Rest], Ress=Rest, append(Avv,Avv1,Avv2)
     ;
    NFeats=[],Avv\=[A], Avv=[fac-Cong|Ress], Avv2=[fac-Cong]
     ;
    NFeats\=[],Avv\=[A], Avv=[fac-Cong|Res], Avv2=[fac-Cong],append(Res,NFeats,Ress) 
     ;
    Ress=NFeats, Avv2=Avv),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   assert(ibar(false)),
   assert(passiv(off)),
   asserta(funcs(sem, Cl-Cl1, Con, First)),
   assign_functions(Ress, Sints, Functs),
   append([fac-Avv2], Functs, FunctsOu),
   appos_subj(FunctsOu,FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=dirsp-Avv,
   (NFeats\=[],
     NFeats=[dirsp-Avv1|Rest], Ress=Rest, append(Avv,Avv1,Avv2)
     ;
    NFeats=[],Avv\=[A], Avv=[dirsp-Cong|Ress], Avv2=[dirsp-Cong]
     ;
    NFeats\=[],Avv\=[A], Avv=[dirsp-Cong|Res], Avv2=[dirsp-Cong],append(Res,NFeats,Ress) 
     ;
    Ress=NFeats, Avv2=Avv),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Con, First)),
   assign_functions(Ress, Sints, Functs),
   append([dirsp-Avv2], Functs, FunctsOut),
   appos_subj(FunctsOu,FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=fp-['"'-par-fp],
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Cong, First)),
   assign_functions(NFeats, Sints, Functs),
   append([dirsp-'"'], Functs, FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Costs, [Sec, FunctsOut]):-
   First=f-[Par-par-f],
   NFeats\=[],
   NFeats=[sa-[that-ag-sa], ibar-[is-ause-ibar]|Rest],
   Rest=[fp-Cong|Costs],
   Sec=savv-[that_is-avv-_],
   assign_functions(Costs, Sints, FunctsOut),
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=f-[Par-par-f],
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Cong, First)),
   assign_functions(NFeats, Sints, FunctsOut),
   end_of_clause,
   !.


assign_funct1([First|NFeats], Sints, []):-
   First=cp-Cong,
   NFeats=[],
   Cong=_-punto-_,
   !.

assign_funct1([First|NFeats], Sints, [fc-[fc-Con, FunctsOut]]):-
   First=cp-Cong,
   (NFeats\=[], NFeat=NFeats, Con=Cong
     ;
     NFeats=[], NFeat=Cong, Cong=[Con|_]),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Con, First)),
   assign_functions(NFeats, Sints, FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=f-Sent,
   Sent\=[A],
   assign_functions(Sent, Sint, FunctsOut),
   append(NFeats,Sint,Sints),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, [fint-Avv, FunctsOut]):-
   First=fint-Avv,
   NFeats\=[],
   (NFeats=[f-[Par-par-f],Sec|Rest];
    NFeats=[Sec,f-[subj-_|Rest]];
    NFeats=[Sec|Rest]),
   Sec=ibar-Ibar,
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Avv, First)),
   cond_assert_fint_ibar(Ibar,Rest,NRest),
   assign_functions(NRest, Sints, FunctsOu),
   (Rest=NRest,
     append([ibar-Ibar],FunctsOu,FunctsOut)
    ;Rest\=NRest, FunctsOut=FunctsOu),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, [fint-NAvv, FunctsOut]):-
   First=fint-Avv,
   NFeats\=[],
   NFeats=[Sec|Rest],
   (Sec=sa-Ibar;Sec=sp-Ibar;Sec=sq-Ibar;Sec=savv-Ibar),
     append(Avv,Ibar,NAvv),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Avv, First)),
   assign_functions(Rest, Sints, FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, [fint-Avv, FunctsOut]):-
   First=fint-Avv,
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Avv, First)),
   assign_functions(NFeats, Sints, FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, [f2-FunctsOut]):-
   First=f2-Cong,
   Cong=[A],
   NFeats\=[],
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Cong, First)),
   assign_functions(NFeats, Sints, Functs),
   append([f2-Cong], Functs, FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], NFeats, [First]):-
   First=f2-Cong,
   Cong\=[A],
   remove(f-F,Cong,_),
      !.

assign_funct1([First|NFeats], Rest, []):-
   First=fp-Cong,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=fp-Cong,
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=fp-Cong,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Rest=[Other|Costs],
   not_parenth(Other),
   assign_functions(NFeats, Sints, FunctsO),
   Sec=Sn-Cost,
   (Sn\=sn, 
    FunctsO=[Fir|Co],
    not_parenth(Fir),
    append([fp-Cong],FunctsO,FunctsOut)
     ;
    Sn\=sn, 
    FunctsO=[Fir|Co],
    yes_parenth(Fir),
    append([fp-Cong],FunctsO,FunctsOut)
     ;
    append([fp-Cong],FunctsO,FunctsOut)
    ),
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=fp-Cong,
   NFeats\=[],
   NFeats=[Sec|Rest],
   not_parenth(Sec),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   assert(ibar(false)),
   assert(passiv(off)),
   asserta(funcs(sem, Cl-Cl1, Cong, First)),
   assign_functions(NFeats, Sints, FunctsOu),
   append([First], FunctsOu, FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, [par-Cong, FunctsOut]):-
   First=par-Cong,
   NFeats\=[],
   NFeats=[Sec|Rest],
   yes_parenth(Sec),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   asserta(funcs(sem, Cl-Cl1, Cong, First)),
   assign_functions(NFeats, Sints, FunctsOut),
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   First=Fu-Sec,
        areverse(Sec, A),
        nonvar(A),
        A='''-'''-par-sn,
   NFeats\=[],
   NFeats=[Fun-AFunc|Ffuncts],
        areverse(AFunc, B),
        nonvar(B),
        B='''-'''-par-sn,
   append(Sec, [Fun-AFunc|Ffuncts], PFuncts),
   assign_ffunction(First, Functs1),
   assign_ffunction(Fun-AFunc, Functs),
   assignfunctions(Ffuncts, Sints, FunctsO),
   append(Functs1, Functs, Functss),
   append(Functss, FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct1([First|NFeats], Sints, FunctsOut):-
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=f2-Prep,
   assign_ffunction(First, Functs),
   (assignfunctions(NFeats, Sints, FunctsO),
   append_relative([],Functs, FunctsO, FunctsOut)
   ;
   assignfunctions(NFeats, Sints, FunctsO),
   append_relative([],Functs, FunctsO, FunctsOut)),
   end_of_clause,
   !.


assign_funct2([First|NFeats], Sints, FunctsOut):-
     (There=there;There='There'),
   First=SN-[There-A-B],
   NFeats\=[],
   NFeats=[Sec|Rest],
   assign_vfunction(Sec, Ibar),
   retractall(ibar),
   assert(ibar(true)),
   Subj=[subj-[there-A-B]],
   cl(Cl),
   asserta(funcs(subj, Cl, there, Subj)),
   (Rest=[fp-['"'-par-fp]|Res];Res=Rest),
   assignfunctions(Res, Sints, FunctsO),
   append(Ibar, FunctsO, FunctsOu),
   append(Subj, FunctsOu, FunctsOut),
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   First=sn-[W-i-_],
   NFeats\=[],
   NFeats=[Sec|Rest],
   yes_parenth(Sec),
   cl(Cl),
   assert_cl,
   cl(Cl1),
   remove(sn-W1,Rest,Res),
   remove(ibar-Verb,Res,Re),
   assign_funz_roles(Verb,CatV,Lem,Valenzes,Neg),
   vcom(Lem),
   append(Res,[First],Ree),
   append([sn-W1],Ree,Feats),
   assign_functions(Feats, Sints, FunctsOu),
   append([Sec], FunctsOu, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=sp-Prep,
   assign_ffunction(First, Functs1),
   (check_noun_subc([],Functs1,NFeats,Functs,Resto),
    assignfunctions(Resto, Sints, FunctsO)
   ;
   assignfunctions(NFeats, Sints, FunctsO),
   Functs1=Functs),
   append_relative([],Functs, FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
     (There=there;There='There'),
   First=SN-[There-A-B],
   NFeats\=[],
   NFeats=[Savv, Sec|Rest],
   (Savv=savv-Avv;Savv=fp-['"'-par-fp]),
   assign_vfunction(Sec, Ibar),
   retractall(ibar),
   assert(ibar(true)),
   Subj=[subj-[there-A-B]],
   cl(Cl),
   asserta(funcs(subj, Cl, there, Subj)),
   (Rest=[fp-['"'-par-fp]|Res];Res=Rest),
   assignfunctions(Res, Sints, FunctsO),
   append(Ibar, FunctsO, FunctsOu),
   (Savv=savv-Avv,
     append([Savv], FunctsOu, FunctsOus)
      ;Savv=fp-['"'-par-fp],
      FunctsOus=FunctsOu),
   append(Subj, FunctsOus, FunctsOut),
   !.

assign_funct2([First|NFeats], Sints, [SAvv|FunctsOut]):-
   First=sn-Cost,
   nprendi_testa(subj, Cost, Testa),
   (avv(Testa, Avv);nt(Testa)),
    search_wn_cats(Testa,Cats),
    \+ on(misura,Cats), \+ on(attivita,Cats),
   SAvv=savv-Cost,
   assign_functions(NFeats, Sints, FunctsOut),
    !.    

assign_funct2([First|NFeats], Sints, FunctsOut):-
   First=sa-[such-ag-sa],
   NFeats=[Sec|Rest],
   Sec=sn-[a-art-sn|Cost],
   append([such-ag-sa],[a-art-sn|Cost],Fir),
   assign_ffunction(sn-Fir, Functs),
   assignfunctions(Rest, Sints, FunctsO),
   append_relative([],Functs, FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
    First=subj-Subj,
    NFeats\=[],
    NFeats=[fc-[and-cong-fc], Fu-SN|Rest],
    (Fu=sn;Fu=subj),
    append(Subj,[and-cong-fc], Subjj),
    append(Subjj,[Fu-SN], Subjs),
    Functs=[subj-Subjs],
    nprendi_testa(subj, Subj, Testa),
    cl(Cl),
    asserta(funcs(subj, Cl, Testa, Functs)),
   assignfunctions(Rest, Sints, FunctsO),
   append_relative([],Functs, FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
    First=subj-Subj,
    Functs=[First],
    nprendi_testa(subj, Subj, Testa),
    cl(Cl),
    asserta(funcs(subj, Cl, Testa, Functs)),
   assignfunctions(NFeats, Sints, FunctsO),
   append_relative([],Functs, FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   assign_ffunction(First, Functs),
   assignfunctions(NFeats, Sints, FunctsO),
   append_relative([],Functs, FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   First=savv-Avv,
   Avv=[Month-avv-_],
   nt(Month),
   tpl(Month,	['n:t:m']),
   NFeats\=[],
   (NFeats=[Sec|Resto],
     Sec=sn-[Num-num-_];
     NFeats=[fp-_,Sec|Resto],
     Sec=sn-[Num-num-_]
     ),
   mcon(Month,'_',Nm),
   mcon(Nm,Num,Date),
   Functs=[obl-[Date-num-_]],
   assign_functions(Resto, Sints, FunctsO),
   append(Functs, FunctsO, FunctsOut),
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   First=savv-Avv,
   assign_functions(NFeats, Sints, FunctsO),
   append([savv-Avv], FunctsO, FunctsOut),
   !.

assign_funct2([First|NFeats], Sints, [Pref-FunctsOu]):-
   First=sp-Prep,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=fint-Pron,
   assert(ibar(false)),
   assert(passiv(off)),
   assign_functions([f2-Pron|Rest], Sints, FunctsO),
   (FunctsO=Pref-Body,
     append(Prep, Body, FunctsOu)
   ;
    FunctsO=[Pref-Body|AllFuncs],   
    append(Prep, Body, Functs),
    append(Functs,AllFuncs,FunctsOu)
   ),
    !.
 
assign_funct2([First|NFeats], Sints, [Pref-FunctsOu]):-
   First=sp-Prep,
   NFeats\=[],
   NFeats=[Sec|Rest],
   Sec=fs-Pron,
   Pron\=[as-cosu-_],
  assert(ibar(false)),
  assert(passiv(off)),
   assign_functions(NFeats, Sints, FunctsO),
   (FunctsO=Pref-Body,
     append(Prep, Body, FunctsOu)
   ;
    FunctsO=[Pref-Body|AllFuncs],   
    append(Prep, Body, Functs),
    append(Functs,AllFuncs,FunctsOu)
   ),
    !.

assign_funct2([First|NFeats], NewSints, FunctsOut):-
   (First=sp-Prep;
    First=spd-Prep;
    First=spda-Prep),
   NFeats\=[],
   (NFeats=[fp-['"'-par-fp], Sec|Rest];
    NFeats=[Sec|Rest]),
   (Sec=sv5-CP;Sec=sv3-CP),
   assign_vfunction(Sec, Ibar),
    Ibar=[Pref-Vcomp],
   assignfunctions(Rest, Sints, FunctsO),
   \+ on(obj-_,FunctsO),
   associate_phrasal_verb(Vcomp,NewVcomp,Sints,NewSints),
   append(Prep, NewVcomp, Iba),
   append([Pref-Iba], FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], NewSints, FunctsOut):-
   (First=sp-Prep;
    First=spd-Prep;
    First=spda-Prep),
    NFeats\=[],
    NFeats=[savv-Avv, Sec|Rest],
    (Sec=sv5-CP;Sec=sv3-CP),
    append(Avv, CP, Ibaa),
    (Sec1=sv5-Ibaa;Sec1=sv3-Ibaa),
    assign_vfunction(Sec1, Ibar),
    Ibar=[Pref-Vcomp],
    assignfunctions(Rest, Sints, FunctsO),
    associate_phrasal_verb(Vcomp,NewVcomp,Sints,NewSints),
   append(Prep, NewVcomp, Iba),
   append([Pref-Iba], FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], NewSints, FunctsOut):-
   (First=sp-Prep;
    First=sq-Prep, Prep=[than-ccom-_];
    First=spd-Prep;
    First=spda-Prep),
    Prep=[A],
   NFeats\=[],
   (NFeats=[fp-['"'-par-fp], Sec|Rest];
   NFeats=[Sec|Rest]),
   (Sec=ibar-CP;Sec=vcomp-CP;Sec=sv3-CP), 
    Seco=sv5-CP,
   assign_vfunction(Seco, Ibar),
    Ibar=[Pref-Vcomp],
   assignfunctions(Rest, Sints, FunctsO),
   associate_phrasal_verb(Vcomp,NewVcomp,Sints,NewSints),
   append(Prep, NewVcomp, Iba),
   append([vcomp-Iba], FunctsO, FunctsOut),
   end_of_clause,
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   (First=sp-Prep;
    First=spd-Prep;
    First=spda-Prep),
    NFeats\=[],
    NFeats=[fc-[and-cong-fc], sn-SN, PP, Sec|Rest],
   (PP=sp-Prep1;
    PP=spd-Prep1;
    PP=spda-Prep1),
   assign_oblfunction(Sec, Prep, Obl),
   assignfunctions([sn-SN, PP, Sec|Rest], Sints, FunctsO),
   append([fc-[and-cong-fc]], FunctsO,FunctsOu),
   append_relative([],Obl, FunctsOu, FunctsOut),
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   (First=sp-Prep;
    First=spd-Prep;
    First=spda-Prep),
   Prep=[Pp|Cost],
   Cost=[Sec|Rest],
   (list(Sec), Se=sn-Sec, Res=Rest; Se=sn-Cost, Res=[]),
   assign_oblfunction(Se, [Pp], Obl),
   assignfunctions(NFeats, Sints, FunctsO),
   append_relative([],Obl, FunctsO, FunctsOut),
   !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   (First=sa-Fir;First=sq-Fir),
    NFeats=[sq-SA|Resto],
    Resto=[F-Sec|Restoo],
   SA=[_-ccom-_],
   (F=sa;F=sn;F=sq),
   append(Fir,SA,Com),
   append(Com,Sec,Comp),
   Subj=[xadj-Comp],
   assign_functions(Restoo, Sints, FunctsO),
   append(Subj, FunctsO, FunctsOut),
    !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   (First=sa-SA;First=sq-SA),
   SA=[_-ccom-_],
   Subj=[adj-SA],
   assign_functions(NFeats, Sints, FunctsO),
   append(Subj, FunctsO, FunctsOut),
    !.

assign_funct2([First|NFeats], Sints, FunctsOut):-
   (First=sa-SA;First=sq-SA),
   Subj=[xadj-SA],
   assign_functions(NFeats, Sints, FunctsO),
   append_relative([],Subj, FunctsO, FunctsOut),
    !.

assign_funct3([First|NFeats], Sints, FunctsOut):-
   funcs(sem, M-Cl1, Avv, Firs),
   Firs=fint-I,
   First=ibar-Fir,
   findall(V, on(fint-I,NFeats), Vs), Vs=[],
   (remove(ibar-Sec,NFeats,Rest),
    nth(NFeats, Num, ibar-Sec), Num<2,
    append(Fir,Sec,NewF)
    ;
    remove(sv2-Sec,NFeats,Rest),
    append(Fir,Sec,NewF)
    ;
    NewF=Fir, Rest=NFeats),
   assign_vfunction(ibar-NewF, Ibar),
   retractall(ibar),
   assert(ibar(true)),
   (Rest=[Subj|Compls],
    assign_ffunction(Subj, Functs),
    continua_ibar_complements([ibar-Ibar],Compls,Sints, FunctsO),
%    assignfunctions(Compls, Sints, FunctsO),
    append(Functs, FunctsO, FunctsOu)
     ;
    continua_ibar_complements([ibar-Ibar],Rest,Sints, FunctsOu)
%    assignfunctions(Rest, Sints, FunctsOu)
    ),
   append(Ibar, FunctsOu, FunctsOut),
   !.

assign_funct3([First|NFeats], Sints, FunctsOut):-
    First=ibar-Rest,
    on(should-_-_,Rest),
    check_auxiliaries_modals(Rest),
    NFeats=[sn-_|Resto],
    Resto=[Ibar-Sec|Restoo],
    (Ibar=ibar;Ibar=sv2),
    remove(Ibar-Sec,NFeats,Feats),
    Sec\=Rest,
%    not check_auxiliaries_modals(Sec),
    retractall(ibar),
    assert(ibar(true)),
    append(Rest, Sec, Verb),
    assert_copulative(Rest),
    cl(Cl),
    assign_funz_roles(Verb,CatV,Lem,Valenzes,Neg),
    assert_passive(Rest,Lem),
    asserta(funcs(ibar, Cl, Lem, ibar-Verb)),
    Feats=[Third|Costs],
    assign_ffunction(Third, FunctsO),
    continua_ibar_complements([ibar-Verb],Costs,Sints, FunctsOu),
%    assignfunctions(Costs, Sints, FunctsOu),
    append(FunctsO, [ibar-Verb], Functs),
    append(Functs, FunctsOu, FunctsOut),
    !.

assign_funct3([First|NFeats], Sints, FunctsOut):-
    cl(Cl), Cl =< 2,
   assign_vfunction(First, Ibar),
   (First=ibar-Rest,
   \+ check_auxiliaries_modals(Rest),
     retractall(ibar),
     assert(ibar(true))
    ;
     First\=ibar-_
     ),
   continua_ibar_complements(Ibar,NFeats,Sints, FunctsOut),
   !.

assign_funct3([First|NFeats], Sints, FunctsOut):-
   cl(Cl), (First=ibar-Rest
%     Cl = 1
    ;First\=ibar-Rest),
   assign_vfunction(First, Ibar),
   (First=ibar-Rest,
   \+ check_auxiliaries_modals(Rest),
     retractall(ibar),
     assert(ibar(true))
    ;
     First\=ibar-_
     ),
   continua_ibar_complements(Ibar,NFeats,Sints, FunctsOu),
   search_subj_clause(Cl, FunctsOu, Sints, FunctsOut),
   !.

assign_funct3([First|NFeats], Sints, FunctsOut):-
    First=ibar-Rest,
    Rest=[V-Cat-_|_],
    check_auxiliaries_modals(Rest),
    NFeats=[F-Cong|Costs],
    check_new_proposition(NFeats),
    F\=sn,F\=sa,F\=sq,
    remove(ibar-Sec,NFeats,Feats),
    Sec\=Rest,
    \+ check_auxiliaries_modals(Sec),
     retractall(ibar),
     assert(ibar(true)),
    append(Rest, Sec, Verb),
    assert_copulative(Rest),
     cl(Cl),
     assign_funz_roles(Verb,CatV,Lem,Valenzes,Neg),
    assert_passive(Rest,Lem),
   find_position_verb(V,Fu),
    asserta(funcs(Fu, Cl, Lem, Verb)),
   assignfunctions(Feats, Sints, FunctsO),
   append([Fu-Verb], FunctsO, FunctsOut),
    !.

assign_funct3([First|NFeats], Sints, FunctsOut):-
    First=ibar-Rest,
    Rest=[V-Cat-_|_],
    assert_copulative(Rest),
     retractall(ibar),
     assert(ibar(true)),
     cl(Cl),
     assign_funz_roles(Rest,CatV,Lem,Valenzes,Neg),
    assert_passive(Rest,Lem),
   find_position_verb(V,Fu),
    asserta(funcs(Fu, Cl, Lem, First)),
   assignfunctions(NFeats, Sints, FunctsO),
   append([Fu-Rest], FunctsO, FunctsOut),
    !.

search_subj_clause(N, [vcomp-Subj|FunctsOu], Sints, [subj_vcomp-Subj|FunctsOu]):-
   N=<2,
   is_list(Sints),
   length(Sints,L), 2<L,
   !.
search_subj_clause(N, FunctsOut, Sints, FunctsOut):-!.

check_build_dates(savv-Sec, Obl,[obl-NewObl],[sn-[Num-num-_]|Rest],NewRest):-
   Rest=[sa-[Year-grad-_]|NewRest],
   Sec=[Month-avv-_],
   nt(Month),
   tpl(Month,	['n:t:m']),
   mcon(Month,'_',Nm),
   mcon(Nm,Num,Nmn),
   mcon(Nmn,'_',Nmd),
   mcon(Nmd,Year,Date),
   Obl=[obl-Ob],
   append(Ob,[Date-num-_],NewObl),
   !.
check_build_dates(savv-Sec, Obl,[obl-NewObl],[sn-[Num-num-_]|Rest],Rest):-
   Sec=[Month-avv-_],
   nt(Month),
   tpl(Month,	['n:t:m']),
   mcon(Month,'_',Nm),
   mcon(Nm,Num,Date),
   Obl=[obl-Ob],
   append(Ob,[Date-num-_],NewObl),
   !.
   
check_build_dates(Sec, Obl,Obl,Rest,Rest):-!.

associate_phrasal_verb([Verb-C-Cc],NewVcomp,[sp-[P-p-_]|NewSints],NewSints):-
   mcon(Verb,'_',VerP),
   mcon(VerP,P,VerbP),
   v(VerbP,K),
   NewVcomp=[VerbP-C-Cc],
   !.
associate_phrasal_verb(Vcomp,Vcomp,Sints,Sints):-!.

assign_ffunction(First, Subj):-
    First\=[],
    First=sn-Rest,
    reverse(Rest,[Last|_]),
    (Last=[W-Cat-_|_], Cat\=nt;Last\=[W-Cat-_|_]),
    cl(Cl),
    Fu=subj,
    Subj=[Fu-Rest],
    nprendi_testa(Fu, Rest, Testa),
    cl(Cl),
    asserta(funcs(Fu, Cl, Testa, Subj)),
    !.

assign_ffunction(First, Subj):-
    First\=[],
    First=sa-Rest,
    Rest=[Head-ag-_],
    filter_dim_ag(Head, Feat, Lem),
    Subj=[subj-Rest],
    nprendi_testa(subj, Rest, Testa),
    cl(Cl),
    asserta(funcs(subj, Cl, Testa, Subj)),
    !.

assign_ffunction(First, Subj):-
    First\=[],
    First=sq-Rest,
    Rest\=[_-ccom-_],
    Subj=[subj-Rest],
    nprendi_testa(subj, Rest, Testa),
    cl(Cl),
    asserta(funcs(subj, Cl, Testa, Subj)),
    !.

assign_ffunctions([First|NFeats], Subj):-
   First=sa-SA,
   NFeats\=[],
   NFeats=[Sec|Resto],
   Sec=sn-SN,
   append(SA, SN, SUBJ),
   Subj=[subj-SUBJ],
    abolish(copul/1), assert(copul(on)),
    nprendi_testa(obj, SA, Testa),
    cl(Cl),
    asserta(funcs(xcomp, Cl, Testa, Subj)),
    !.

assign_ofunction(First, Subj):-
    once(passiv(off)),
    First\=[],
    (First=sn-Rest;First=subj-Rest),
    reverse(Rest,[Last|_]),
    (Last=[W-Cat-_|_], Cat\=nt;Last\=[W-Cat-_|_]),
    (copul(on), Fun=xcomp,    
     retract(copul(_)), assert(copul(off))
    ; Fun=obj),
    Subj=[Fun-Rest],
    nprendi_testa(obj, Rest, Testa),
    cl(Cl),
    asserta(funcs(Fun, Cl, Testa, Subj)),
    !.

assign_ofunction(First, Subj):-
    First\=[],
   (First=sa-SA;First=sn-SA),
   Subj=[xcomp-SA],
     retract(copul(_)), assert(copul(on)),
    nprendi_testa(obj, SA, Testa),
    cl(Cl),
    asserta(funcs(xcomp, Cl, Testa, Subj)),
    !.

assign_ofunction([First|NFeats], Subj):-
   First=sa-SA,
   NFeats\=[],
   NFeats=[Sec|Resto],
   Sec=sn-SN,
   append(SA, SN, SUBJ),
   Subj=[subj-SUBJ],
    !.

assign_oblfunction(First, Prep, Subj):-
    First\=[],
    First=sn-Rest,
    append(Prep, Rest, Obl),
    Subj=[obl-Obl],
    nprendi_testa(obl, Obl, Testa),
    cl(Cl),
    asserta(funcs(obl, Cl, Testa, Subj)),
    !.
assign_oblfunction(First, Prep, Subj):-
    First\=[],
    First=savv-Rest,
    append(Prep, Rest, Obl),
    Subj=[obl-Obl],
    nprendi_testa(obl, Obl, Testa),
    cl(Cl),
    asserta(funcs(adj, Cl, Testa, Subj)),
    !.
assign_oblfunction(First, Prep, Subj):-
    First\=[],
    First=sa-Rest,
    append(Prep, Rest, Obl),
    Subj=[obl-Obl],
    nprendi_testa(obl, Obl, Testa),
    cl(Cl),
    asserta(funcs(adj, Cl, Testa, Subj)),
    !.

assert_copulative([]):-
    assert(copul(off)),
    !.
assert_copulative(Rest):-
    prendi_vtesta(ibar, Rest, Testa),
    coplb(Testa),
    ibar(nil),
    assert(copul(on)),
    !.
assert_copulative(Rest):-
    assert(copul(off)),
    !.
%fwriteseqnl(riassunto,Subj):-!.

prendi_vtesta(Func, Parses, Testa):-
   remove(mod-Mods, Parses, Parse),
   reverse(Parse, RevP),
   RevP=[Testa-Cat-Cost|RevParse],
    check_vcat(Cat),
   !.

prendi_vtesta(Func, Parses, Testa):-
   remove(and-Cong-C, Parses, Parse),
   reverse(Parse, RevP),
   RevP=[Testa-Cat-Cost|RevParse],
    check_vcat(Cat),
   !.

prendi_vtesta(Func, Parses, Testa):-
    reverse(Parses, RevP),
    RevP=[Testa-Cat-Cost|RevParse],
    check_vcat(Cat),
    !.

prendi_vtesta(Func, Parses, Testa):-
    Parses=[Testa-Cat-Cost|RevParse],
    check_vcat(Cat),
    !.

assert_passive([],L):-
    assert(passiv(off)),
    !.
assert_passive(Rest,Lem):-
    Lem\=be,
    remove_part_pass(Rest, NRest),
    on(Testa-Cat-_, NRest),
    (check_auxbe(Cat);
      coplb(Testa)),
    \+ dgrs(N, progr(Lem, _)),
    assert(passiv(on)),
    cl(Cl),
    asserta(funcs(voice, Cl, Testa, passive-Rest)),
    DepGr=..[voice,passive,Testa,Lem],
    (dgrs(N,DepGr);
    \+ dgrs(N,DepGr),
    asserta(dgrs(N,DepGr))),
    assert_tense(NRest,Lem),
    !.
assert_passive(Rest,L):-
    DepGr=..[voice,active,'_',L],
    (dgrs(N,DepGr);
    \+ dgrs(N,DepGr),
    asserta(dgrs(N,DepGr))),
    assert(passiv(off)),
    assert_tense(Rest,L),
    !.

assert_tense([],L):-!.
assert_tense(Rest,L):-
    reverse(Rest, Revr),
%    !,
    nonvar(Revr),
    on(Testa-Cat-_,Revr),
    findall(Te-Mo-L, pp_word_cat(Testa, Te, Mo, Lemma), All),
    on(Tense-Mode-_, All),
    (nonvar(Tense)
     ; var(Tense), nonvar(Mode),
       (Mode=ger, on(Test-Ca-_, Rest),
        findall(Te-Mo-L, pp_word_cat(Testa, Te, Mo, Lemma), All1),
       on(Tense-Mode-_, All1); 
       Mode\=ger, Tense=pres)
     ),
    (Tense=pass, Ten=past;Ten=Tense),
    DepGr=..[tense,Ten,'_',L],
    (dgrs(N,DepGr);
    \+ dgrs(N,DepGr),
    asserta(dgrs(N,DepGr))),
    !.
assert_tense(Rest,L):-
    !.

remove_part_pass(Rest, NRest):-
    on(Testa-Cat-_, Rest),
    check_auxbe(Cat),
    coplb(Testa),
    remove(Testa1-Cat1-_, Rest, NRest),
    Testa1\=Testa,
    buildcheckppast(Testa1),
    !.
remove_part_pass(Rest, NRest):-
    remove(Testa-Cat-_, Rest, NRest),
    check_ppast(Testa,Cat),!.

buildcheckppast(Testa):-
    participio_p(Testa,Verbo,Gen,Num),
    v(Verbo,Cats),
    determine_transitive(Cats),
    !.

determine_transitive(Cats):-
    on(t,Cats);on(ti,Cats);on(tx,Cats);on(tf,Cats);on(tc,Cats),!.


extract_functions([], Sints, []):-
   !.

extract_functions([First|NFeats], Sints, fc-Functs):-
   First=fc-Avv,
   Avv=[f-Sec],
   NFeats=[],
   extract_functions(Sec, Sints, Functs),
   !.
extract_functions([First|NFeats], Sints, [fc-Functs]):-
   First=fc-Rest,
   Rest=[f-Sec],
   extract_functions(NFeats, Sints, FunctsO),
   append(Sec, [FunctsO],Functs),
   !.

extract_functions([First|NFeats], Sints, [fs-Rest]):-
   First=fs-Rest,
   NFeats=[],
   !.

extract_functions([First|NFeats], Sints, [fs-Rest|FunctsOut]):-
   First=fs-Rest,
   NFeats\=[],
   extract_functions(NFeats, Sints, FunctsOut),
   !.

extract_functions([First|NFeats], Sints, f3-Rest):-
   First=f3-Rest,
   NFeats=[],
   !.

extract_functions([First|NFeats], Sints, Functs):-
   First=f3-Rest,
   NFeats\=[],
   extract_functions(NFeats, Sints, FunctsOut),
   append(Rest, [FunctsOut],Functs),
   !.

extract_functions([First|NFeats], Sints, [fac-Rest]):-
   First=fac-Rest,
   NFeats=[],
   !.

extract_functions([First|NFeats], Sints, [fac-Rest|FunctsOut]):-
   First=fac-Rest,
   extract_functions(NFeats, Sints, FunctsOut),
   !.

extract_functions([First|NFeats], Sints, [dirsp-Rest|FunctsOut]):-
   First=dirsp-Rest,
   extract_functions(NFeats, Sints, FunctsOut),
   !.

extract_functions([First|NFeats], Sints, cp-Rest):-
   First=cp-Rest,
   NFeats=[],
   !.

extract_functions([First|NFeats], Sints, [fint-Functs]):-
   First=fint-Rest,
   Rest=[fint-Sec|Res],
   NFeats\=[f-Se|Re],
   extract_functions(Res, Sints, FunctsO),
   extract_functions(NFeats, Sints, FunctsOut),
   append(Sec, [FunctsO],Functs1),
   ( NFeats=[], Functs=[fint-Functs1]
    ;
    NFeats\=[], 
   append([Functs1], [FunctsOut],Functs)),
   !.

extract_functions([First|NFeats], Sints, [fint-Rest|[FunctsO]]):-
   First=fint-Rest,
   Rest=[fint-Sec|Res],
   extract_functions(NFeats, Sints, FunctsO),
   !.

extract_functions([First|NFeats], Sints, f2-Rest):-
   First=f2-Rest,
   NFeats=[],
   !.

extract_functions([First|NFeats], Sints, [f2-Functs]):-
   First=f2-Rest,
   extract_functions(Res, Sints, FunctsO),
   extract_functions(NFeats, Sints, FunctsOut),
   append(Functs0, FunctsOut,Functs),
   !.

extract_functions([First|NFeats], Sints, fp-FunctsOut):-
   First=fp-Rest,
   NFeats=[Sec|Rest],
   Sec\=fp-Cong,
   extract_functions(NFeats, Sints, FunctsOut),
   !.

extract_functions([First|NFeats], Sints, f-Rest):-
   First=f-Rest,
   NFeats=[],
   extract_functions(NFeats, Sints, FunctsOut),
   !.

extract_functions([First|NFeats], Sints, f-Functs1):-
   First=f-Rest,
   NFeats\=[],
   NFeats=[Sec|Res],
   Sec=fint-Se,
   append(Rest, Res,FunctsOut),
   append([fint-Se],[f-FunctsOut], Functs1),
   !.

extract_functions([First|NFeats], Sints, f-Functs):-
   First=f-Rest,
   Rest=[Fu-Sec|Res],
        areverse(Sec, A),
        nonvar(A),
        A='''-'''-par-sn,
   NFeats\=[],
   NFeats=[[f-AFuncts|NFeat]],
   AFuncts=[Fun-AFunc|Ffuncts],
   reverse(AFunc, ['''-'''-par-sn|_]),
        areverse(AFunc, B),
        nonvar(B),
        B='''-'''-par-sn,
   append(Rest, [Fun-AFunc|Ffuncts], PFuncts),
   extract_functions(NFeat, Sints, FunctsOut),
   append([f-PFuncts], [FunctsOut],Functs),
   !.

extract_functions([First|NFeats], Sints, f-Functs):-
   First=f-Rest,
   NFeats\=[],
   extract_functions(NFeats, Sints, FunctsOut),
   append([f-Rest], [FunctsOut],Functs),
   !.

extract_functions([First|NFeats], Sints, f-Functs):-
   First=f-Rest,
   NFeats\=[],
   NFeats=[Sec|[]],
   append(Rest, Sec,Functs),
   !.

extract_functions([First|NFeats], Sints, [ibar-Rest|FunctsOut]):-
   First=ibar-Rest,
   extract_functions(NFeats, Sints, FunctsOut),
   !.

extract_functions([First|NFeats], Sints, Functs):-
   First=[F-Rest],
   extract_functions(Rest, Sints, FunctsOut),
   extract_functions(NFeats, Sints, FunctsO),
   append([FunctsOut], [FunctsO],Functs),
   !.

extract_functions([First|NFeats], Sints, [First|FunctsOut]):-
   extract_functions(NFeats, Sints, FunctsOut),
   !.
check_parents_fac(FunctsOut):-
     FunctsOut\=[],
     appiattisci(FunctsOut,Functs),
     findall(F, on(f3-F, Functs), Fs),
     length(Fs,L),
     L=0,
     !.

match_lemmatize_head(Head,Ind,First):-
     Head=Hea-Ind;
       Head\=_-_, 
       ref_funcs(Fun, Ind, Heads, First),
       (Head=Heads;
          lemmatize_dic(Heads, Heas,_), 
               Heas=Head),
     !.
match_lemmatize_head(LowHead,Ind,First):-
     spy_lower(LowHead, _, 0),
     (LowHead=Hea-Ind;
        LowHead\=_-_, 
        ref_funcs(Fun, Ind, Heads, First),
        atomic(Heads),
       (LowHead=Heads;
        lemmatize_dic(Heads, Head,_),
        spy_lower(Head, Heas, 1), 
            Heas=LowHead)),
     !.
match_lemmatize_head(Head,Ind,First):-
     Head=Hea-Ind;
         Head\=_-_,
         ref_funcs(Fun, Ind, Heads, First),
       (Head=Heads;
         list(Heads), 
         pron_head(Heads,Heas), 
             Heas=Head),
     !.


pron_head([Pro,Head],Head):-
  Pro=pers;Pro=pron,!.



splitsent1(SentNo, Ibars, [], []):-!.
splitsent1(SentNo, [_-ibar-Ibar|IBars], Alls, [second-AllArgsAdjs|Clauses]):-
     (Alls=[Fu-_,ibar-Ibar|FunctsOut],(Fu=savv;Fu=obl;Fu=sp);Alls=[ibar-Ibar|FunctsOut]),
      extract_clause([_-ibar-Ibar|IBars], [ibar-Ibar|FunctsOut], Clause, IBar, RestFuncs, RestIbar,Adjs),
      create_coord_subj(SentNo,Ibar,Govern,First,Head-Arg),
     Arg=[LemCoord-Argg-NegCoord],
     Argg=[RolCoord/In],
     create_clause_coord(SentNo, IBar, Arg, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     assert_dep_gram_rels(subj,RolCoord,Head),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
      assert_gr_adj(SentNo,Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
%     (Rest\=nil, append(Rest, RestFuncs, RestF); RestF=RestFuncs),
     splitsentences(N1, RestIbar, RestFuncs, Clauses),
     current_governor(N1,Lem),
%     (Clauses=[],
      Govern\=Lem,
      term_to_atom(cmod-coord,Fun),
      DepGr=..[Fun,and,Govern,Lem],
      N2 is N1 + 1,
      asserta(dgrs(N2,DepGr)),
%      ;
%      check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs)
%      ),
     !.

splitsent1(SentNo, IBars, [[ibar-Ibar|Rest]|FunctsOut], [second-AllArgsAdjs|Clauses]):-
     extract_clause(IBars, [ibar-Ibar|Rest], Clause, IBar, RestFuncs, RestIbar,Adjs),
     create_coord_subj(SentNo,Ibar,Govern,First,Head-Arg),
     Arg=[LemCoord-Argg-NegCoord],
     Argg=[RolCoord/In],
     create_clause_coord(SentNo, IBar, Arg, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     assert_dep_gram_rels(subj,RolCoord,Head),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
      assert_gr_adj(SentNo,Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     append(RestFuncs, FunctsOut, RestF),
     splitsentences(N1, RestIbar, RestF, Clauses),
     current_governor(N1,Lem),
%    (Clauses=[],
      Govern\=Lem,
      term_to_atom(cmod-coord,Fun),
      DepGr=..[Fun,and,Govern,Lem],
      N2 is N1 + 1,
      asserta(dgrs(N2,DepGr)),
%      ;
%      check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs)
%      ),
     !.
splitsent1(SentNo, IBars, Alls, [second-AllArgsAdjs|Clauses]):-
     (Alls=[Fu-_,ibar-Ibar|FunctsOut],(Fu=savv;Fu=obl;Fu=sp);Alls=[ibar-Ibar|FunctsOut]),
     extract_clause(IBars, [ibar-Ibar|FunctsOut], Clause, IBar, RestFuncs, RestIbar,Adjs),
     create_coord_subj(SentNo,Ibar,Govern,First,Head-Arg),
     Arg=[LemCoord-Argg-NegCoord],
     Argg=[RolCoord/In],
     create_clause_coord(SentNo, IBar, Arg, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     assert_dep_gram_rels(subj,RolCoord,Head),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
      assert_gr_adj(SentNo,Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
%     (Rest\=nil, append(Rest, RestFuncs, RestF); RestF=RestFuncs),
     splitsentences(N1, RestIbar, RestFuncs, Clauses),
     current_governor(N1,Lem),
%     (Clauses=[],
      Govern\=Lem,
      term_to_atom(cmod-coord,Fun),
      DepGr=..[Fun,and,Govern,Lem],
      N2 is N1 + 1,
      asserta(dgrs(N2,DepGr)),
%      ;
%      check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs)
%      ),
     !.

splitsent1(1, [_-ibar-Ibar|IBars], Alls, [main-AllArgsAdjs|Clauses]):-
     (Alls=[Fu-_,ibar-Ibar|FunctsOut],(Fu=savv;Fu=obl;Fu=sp);Alls=[ibar-Ibar|FunctsOut]),
     \+ on(subj-Subj, FunctsOut),
     extract_clause([_-ibar-Ibar|IBars], [ibar-Ibar|FunctsOut], Clause, IBar, RestFuncs, RestIbar,Adjs),
     append([subj-[you-pron-_]],Clause,NewClaus),
     (RestFuncs=[], append(NewClaus,Adjs,NewClause)
       ;
       NewClause=NewClaus),
     create_clause_fac(1, IBar, NewClause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(1, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     splitsentences(2, RestIbar, RestFuncs, Clauses),
     !.
splitsent1(SentNo, IBars, FunctsOut, AllClauses):-
     check_parents_fac(FunctsOut),
     (remove(fac-Body1, FunctsOut, Rest);
      remove(I-[fac-Body1], FunctsOut, Rest), integer(I)),
     (remove(fac-Body2, Body1, Rest1);
      remove(I2-[fac-Body2], Body1, Rest1), integer(I2)),
     remove(fac-Cong, Body2, ClauseRest),
     extract_clause(IBars, ClauseRest, Clause, IBar, RestFuncs, RestIbar,Adjs),
     (governor(N, Govern);Govern=nil),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
     append(Mods,ModsAdjs,Modss),
     append([fac-Rest1],Rest,Rests),
     N1 is SentNo + 1,
     (Rests=[that-pk-fac],RestF=RestFuncs
        ;Rests\=nil, append(Rests, RestFuncs, RestF)
        ; RestF=RestFuncs),
     check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs),
     splitsentences(N1, RestIbar, RestF, Clauses),
     append(Clauses,[comp-AllArgsAdjs], AllClauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, AllClauses):-
     check_parents_fac(FunctsOut),
     (remove(fac-Body1, FunctsOut, Rest);
      remove(I-[fac-Body1], FunctsOut, Rest), integer(I)),
     remove(fac-Cong, Body1, ClauseRest),
     extract_clause(IBars, ClauseRest, Clause, IBar, RestFuncs, RestIbar,Adjs),
     (governor(N, Govern);Govern=nil),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     (Rest=[that-pk-fac],RestF=RestFuncs
        ;Rest\=nil, append(Rest, RestFuncs, RestF)
        ; RestF=RestFuncs),
     check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs),
     splitsentences(N1, RestIbar, RestF, Clauses),
     append(Clauses,[comp-AllArgsAdjs], AllClauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, AllClauses):-
     check_parents_fac(FunctsOut),
     (remove(fac-Body1, FunctsOut, Rest);
      remove(I-[fac-Body1], FunctsOut, Rest), integer(I)),
     remove(fac-Cong, Body1, ClauseRest),
     (ClauseRest=[]; ClauseRest=[A], A=_-[Punt-_-_], punct(Punt)),
     extract_clause(IBars, Rest, Clause, IBar, RestFuncs, RestIbar,Adjs),
     (governor(N, Govern);Govern=nil),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
     append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs),
     splitsentences(N1, RestIbar, Body1, Clauses),
     append(Clauses,[comp-AllArgsAdjs], AllClauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, AllClauses):-
     check_parents_fac(FunctsOut),
     (remove(fac-Body1, FunctsOut, Rest);
      remove(I-[fac-Body1], FunctsOut, Rest), integer(I)),
     remove(fac-Cong, Body1, ClauseRest),
     ClauseRest\=[], ClauseRest=[Fu-_|_], (Fu=fs;Fu=fc;Fu=dirsp),
     extract_clause(IBars, Rest, Clause, IBar, RestFuncs, RestIbar,Adjs),
     (governor(N, Govern);Govern=nil),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
     append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     check_assert_fac(N1,Govern,Clauses,main-AllArgsAdjs),
     splitsentences(N1, RestIbar, ClauseRest, Clauses),
     append(Clauses,[comp-AllArgsAdjs], AllClauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, AllClauses):-
     extract_clause(IBars, FunctsOut, Clause, IBar, RestFuncs, RestIbar,Adjs),
     continue_splitsentences(Clause, ClauseRes,RestFuncs, RestF),
     RestF\=FunctsOut, 
     create_clause_fac(SentNo, IBar, ClauseRes, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     assert_gr_fac(N1, Lem,[main-AllArgsAdjs]),
     splitsentences(N1, RestIbar, RestF, Clauses),
     append([main-AllArgsAdjs],Clauses, AllClauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, AllClauses):-
    on(dirsp-_, FunctsOut),
    check_extract_parent(0, FunctsOut, NewClause, Parent),
    Parent\=[ibar-_],
    splitsentences(SentNo, IBars, NewClause, Clauses),
    (Clauses\=[],
     remove(M-[Cl,Lem-Args|_],Clauses,_),
     nonvar(Lem),
     continue_adjunct_clause(SentNo, IBars, Lem,Clauses,Parent,AllArgsAdjs)
     ;
     governor(N,Lem),
     continue_adjunct_clause(SentNo, IBars, Lem,Clauses,Parent,AllArgsAdjs)
     ),
     append(Clauses,[second-AllArgsAdjs], AllClauses),
    !.

splitsent1(SentNo, IBars, FunctsOut, NewClauses):-
     eliminate_dirsp(FunctsOut,NewClause),
     splitsentences(SentNo, IBars, NewClause, Clauses),
     evaluate_dirs_fac(Clauses,NewClauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, [main-AllArgsAdjs|Clauses]):-
     FunctsOut\=[fac-Adj|FunctsOu],
     extract_clause(IBars, FunctsOut, Clause, IBar, RestFuncs, RestIbar,Adjs),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     splitsentences(N1, RestIbar, RestFuncs, Clauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, AdjClauses):-
    (on(fp-_, FunctsOut);on(f3-_, FunctsOut)),
    check_extract_parent(0, FunctsOut, NewClause, Parent),
    Parent\=[ibar-_],
    splitsentences(SentNo, IBars, NewClause, Clauses),
     N1 is SentNo + 1,
    (
     (on(fs-_, Parent);on(fc-_, Parent);on(f2-_, Parent)),
      splitsentences(SentNo, IBars, Parent, RefsRel),
     switch_append(NewClause, Clauses,RefsRel,AdjClauses)
     ;
     Clauses\=[],
     remove(M-[Cl,Lem-Args|_],Clauses,_),
     nonvar(Lem),
     build_adjuncts(N1,Lem, Parent,RefsRel,NewLem),
     switch_append(NewClause, Clauses,RefsRel,AdjClauses)
     ;
     governor(N,Lem),
     build_adjuncts(N1,Lem, Parent,RefsRel,NewLem),
     switch_append(NewClause, Clauses,RefsRel,AdjClauses)
     ),
     !.

splitsent1(SentNo, IBars, FunctsOut, Clauses):-
     findall(F, (on(f3-F, FunctsOut);on(fp-F, FunctsOut)), Fs),
     length(Fs,L),
     0<L,
     remove_all([f3-F], FunctsOut, NewClause),
     remove_all([fp-F], NewClause, NewClaus),
     splitsentences(SentNo, IBars, NewClaus, Clauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, [second-AllArgsAdjs|Clauses]):-
     appiattisci(FunctsOut, F),
     Body=[f2-_|F2],
     remove(C-Head-Body, F, _),     
     refsems(Sems),
     on(N-Cl-Sem, Sems),
     Sem=(f2-_),
     IBars=[Ibar|_],
     Ibar=Cl-ibar-Verbs,
     reverse(IBars, RevIbars),
     extract_clause(RevIbars, FunctsOut, Clause, IBar, RestFun, RestIb,Adjs),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     Body=[f2-_|F2],
     remove(C-Head-Body, Mods, NNMods),
     build_relativeclause(C,Head,Body,RelClause,Re),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     N2 is SentNo + 2,
     remove(Ibar,RestIb,RestV),
     splitsentences(N2, RestV, RestFun, Clauses),
     !.

splitsent1(SentNo, IBars, FunctsOut, [second-AllArgsAdjs]):-
     FunctsOut=[Fint-_|_], Fint\=fint,
     appiattisci(FunctsOut, F),
     Body=[f2-_|F2],
     remove(C-Head-Body, F, _),     
     refsems(Sems),
     on(N-Cl-Sem, Sems),
     Sem=(f2-_),
     remove(Vcomp,FunctsOut,Args), 
     Vcomp=vcomp-IBar,
     on(V-_,Tensed), on(V-_-_,IBar),
     create_clause_fac(SentNo, IBar, Args, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     !.

switch_append(NewClause, Clauses,[],Clauses):-!.
switch_append([fs-_|NewClause], Clauses,RefsRel,AdjClauses):-
     append(RefsRel,Clauses,AdjClauses),
     !.
switch_append([fc-_|NewClause], Clauses,RefsRel,AdjClauses):-
     append(RefsRel,Clauses,AdjClauses),
     !.
switch_append([fac-_|NewClause], Clauses,RefsRel,AdjClauses):-
     append(RefsRel,Clauses,AdjClauses),
     !.
switch_append(NewClause, Clauses,RefsRel,AdjClauses):-
     append(Clauses,RefsRel,AdjClauses),
     !.

checklengthsent(Sent):-
   appiattisci(Sent, Sen),
   length(Sen,L),
   (2=<L
   ;
   on(Cos-_,Sen),
   (Cos=f;Cos=fc;Cos=fs)
   ),
   !.
choosecoordub(Term,Sent,Term):-
   Sent=[cp-_],
   !.
choosecoordub(Term,Sent,Sent):-
   !.
   
/* splitsent2 */

splitsent2(SentNo, Ibars, [], []):-!.
splitsent2(SentNo, [], [fc-[fc-((:)-dirs-cp),[]]],[]):-!.

splitsent2(SentNo, IBars, [fint-Adj|FunctsOut], [second-AllArgsAdjs|Clauses]):-
     refsems(Sems),
     on(N-Cl-Sem, Sems),
     Sem=(fint-_),
     (
     extract_clause(IBars, FunctsOut, Clause, IBar, RestFuncs, RestIbar,Adjs)
      ;
     remove(Vcomp,FunctsOut,Args), 
     Vcomp=ibar-IBar,
     append([_-ibar-IBar],IBars, NIBars),
     extract_clause(NIBars, FunctsOut, Clause, IBar, RestFuncs, RestIbar,Adjs)
      ),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     append(Adj,Adjs,Adjss),
     assert_gr_adj(SentNo, Lem,Adjss,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N1 is SentNo + 1,
     splitsentences(N1, RestIbar, RestFuncs, Clauses),
     !.

splitsent2(SentNo, IBars, [fint-Adj|FunctsOut], [main-AllArgsAdjs]):-
     refsems(Sems),
     on(N-Cl-Sem, Sems),
     Sem=(fint-_),
     on(N1-Cl1-Sem1, Sems),
     Sem1=(f2-Pron),
     appiattisci(FunctsOut, F),
     remove(Fu-Cost,F,Args), 
     Body=[f2-_|F2],
     remove(f2-Body, Cost, Rest),     
     remove(Vcomp,F2,Arg), 
     Vcomp=ibar-IBar,
     append(Args, [Fu-Rest], RArgs),
     append(RArgs, Arg, Clause),
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs, []],
     create_coord_subj(SentNo,IBar,Lem,First,Lemma),
     current_governor(N2,Lem),
     assert_dep_gram_rels(subj,agent,Lemma),
     Pron=[Pro-_-_],
     assert_cmod_topic(Pro,Lemma,Lem),
     !.

splitsent2(SentNo, IBars, [fs-FunctsOut], Clauses):-
     FunctsOut=[fs-[Term]|Sent],
     Sent\=[],
     once(governor(No,Lemma)),
     splitsentences(SentNo, IBars, Sent, Clauses),
     cmod_adj_subord([Term],SentNo,Lemma),
     !.


splitsent2(SentNo, IBars, [fc-FunctsOut], Clauses):-
     FunctsOut=[fc-[Term]|Sent],
     Sent\=[],
     once(governor(No,Lemma)),
     (checklengthsent(Sent),
      splitsentences(SentNo, IBars, Sent, Clauses),
      cmod_adj_subord([Term],SentNo,Lemma)
      ;
      cmod_adj_subord(Sent,SentNo,Lemma)
      ),
     !.

splitsent2(SentNo, IBars, [fs-Adj|FunctsOut], Clauses):-
     Adj=[fs-[Term]|Sent],
     once(governor(No,Lemma)),
     checklengthsent(Sent),
     on(Sen,Sent),
     \+ on(Sen,FunctsOut),
     splitsentences(SentNo, IBars, [Sent|FunctsOut], Clauses),
     cmod_adj_subord([Term],SentNo,Lemma),
     !.

splitsent2(SentNo, IBars, [fc-Adj|FunctsOut], Clauses):-
     Adj=[fc-[Term]|Sent],
     once(governor(No,Lemma)),
     checklengthsent(Sent),
     on(Sen,Sent),
     \+ on(Sen,FunctsOut),
     splitsentences(SentNo, IBars, [Sent|FunctsOut], Clauses),
     cmod_adj_subord([Term],SentNo,Lemma),
     !.

splitsent2(SentNo, IBars, FunctsOut, Clauses):-
     remove(fs-Adj,FunctsOut,Rest),
     Rest\=[],
     (Adj=[fs-[Term]|Sent],
      once(governor(No,Lemma)),
      splitsentences(SentNo, IBars, Rest, Clause1),
      N1 is SentNo + 1,
      (checklengthsent(Sent),
       splitsentences(N1, IBars, Sent, Clause2),
       append(Clause1,Clause2,Clauses),
       cmod_adj_subord([Term],SentNo,Lemma)
       ;
       choosecoordub(Term,Sent,Ter),
       cmod_adj_subord(Ter,SentNo,Lemma)
       )
       ;
       Adj=[Sem-Cat-fs],
       splitsentences(SentNo, IBars, Rest, Clauses),
       cmod_adj_subord(Adj,SentNo,Lemma)
       ),
     !.

splitsent2(SentNo, IBars, FunctsOut, Clauses):-
     remove(fc-Adj,FunctsOut,Rest),
     Rest\=[],
     (Adj=[fc-[Term]|Sent],
      once(governor(No,Lemma)),
      splitsentences(SentNo, IBars, Rest, Clause1),
      N1 is SentNo + 1,
      (checklengthsent(Sent),
       splitsentences(N1, IBars, Sent, Clause2),
       append(Clause1,Clause2,Clauses),
       cmod_adj_subord([Term],SentNo,Lemma)
       ;
       choosecoordub(Term,Sent,Ter),
       cmod_adj_subord(Ter,SentNo,Lemma)
       )
       ;
       Adj=[Sem-Cat-fc],
       splitsentences(SentNo, IBars, Rest, Clauses),
       cmod_adj_subord(Adj,SentNo,Lemma)
       ),
     !.

splitsent2(SentNo, IBars, [subj-[Yes-i-_], fs-Adj], [second-OutAdjs]):-
     find_govern(1,N,Govern,Lemma),
     assert_gr_adj(SentNo, Govern, [subj-[Yes-i-_], fs-Adj],OutAdjs,ModsAdjs),
     !.

splitsent2(SentNo, IBars, FunctsOut, [comp-AllArgsAdjs|Clauses]):-
     (remove(fac-Body1, FunctsOut, Rest);
      remove(I-[fac-Body1], FunctsOut, Rest), integer(I)),
     remove(fac-Body1, Rest, Clause),
     Clause\=[],
     create_clause_fac(SentNo, IBars, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
      assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
     N is SentNo-1,
     find_govern(1,N,Govern,Lemma),
     N1 is SentNo + 1,
     assert_gr_fac(N1, Govern,[SentNo-AllArgsAdjs]),
     splitsentences(N1, IBars, ClauseRest, Clauses),
     !.

splitsent2(SentNo, IBars, FunctsOut, [comp-AllArgsAdjs|Clauses]):-
     (remove(fac-Body1, FunctsOut, RestClause);
      remove(I-[fac-Body1], FunctsOut, RestClause), integer(I)),
     extract_ibar_fac(RestClause,NewClause,IBars, NIBars),
     extract_clause(NIBars, NewClause, Clause, IBar, RestFuncs, RestIbar,Adjs),
     Clause\=[],
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
     append(Mods,ModsAdjs,Modss),
     N is SentNo-1,
     find_govern(1,N,Govern,Lemma),
     N1 is SentNo + 1,
     assert_gr_fac(N1, Govern,[SentNo-AllArgsAdjs]),
     splitsentences(N1, RestIbar, RestFuncs, Clauses),
     !.

splitsent2(SentNo, IBars, FunctsOut, [second-AllArgsAdjs|Clauses]):-
     remove(subj-Funct,FunctsOut,[]), 
     remove(f2-Body1, Funct, Rest),
     appiattisci(Body1,RestClause),
     complex_rel_parent(Rest,RestClause,Parent, IBars, Clause,IBar, RestFuncs, RestIbar,Adjs),
     Clause\=[],
     create_clause_fac(SentNo, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
     append(Mods,ModsAdjs,Modss),
     VArgs=[_/Ind|_],
     on(ref_ex(Ind,Head,_,_,_,_,_),ArgsAdjs),
     N1 is SentNo + 1,
     analyze_mod(N1, Ind-Head-Parent, Ref),
     splitsentences(N1, RestIbar, RestFuncs, Clauses),
     !.

splitsent2(SentNo, IBars, FunctsOut, [ArgsAdjs1, main-AllArgsAdjs|Clauses]):-
     FunctsOut\=[fac-Adj|FunctsOu],
     extract_clauses(SentNo, IBars, FunctsOut, RestFuncs, RestIbar, ArgsAdjs1),
     extract_clause(RestIbar, RestFuncs, Clause, IBar, RestFun, RestIb,Adjs),
     N1 is SentNo + 1,
     create_clause_fac(N1, IBar, Clause, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     assert_gr_adj(SentNo, Lem,Adjs,OutAdjs,ModsAdjs),
     append(Mods,ModsAdjs,Modss),
     AllArgsAdjs=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
     N2 is N1 + 1,
     splitsentences(N2, RestIb, RestFun, Clauses),
     !.

/* da qui iniziano le chiamate di fail soft */

splitsent2(SentNo, [_-ibar-IBar|RestIbar], FunctsOut, [main-AllArgsAdjs]):-
      remove_all_sems(FunctsOut,Adjs , RestFunc),
      Adjs\=[],
      remove(Vcomp,RestFunc,Clause), 
      Vcomp=ibar-IBar,
      \+ remove(subj-Funct,FunctsOut,[]), 
     create_coord_subj(SentNo,IBar,Lem,First,Head-Arg),
      Arg=[LemAdj-Argg-Neg],     
      (Head\=_-_, Hea=Head;Head=Hea-Ind),
       Subj=[subj-[Hea-n-sn]], 
       append(Subj,Clause,Claus),
%       create_find_head_relative(Hea,Ind), Subj=[subj-[Hea-n-sn]], append(Subj,Clause,Claus)
%        ; Claus=Clause),
      N1 is SentNo + 1,
      create_clause_fac(N1, IBar, Claus, ArgsAdjs, Mods, NArgs, LemAdj-VArgs, Neg),
      assert_gr_adj(SentNo, LemAdj,Adjs,OutAdjs,ModsAdjs),
      append(Mods,ModsAdjs,Modss),
      AllArgsAdjs=[Neg,LemAdj-VArgs,Modss, ArgsAdjs,OutAdjs],
     !.

splitsent2(SentNo, IBars, FunctsOut, [second-AllArgsAdjs]):-
     1 < SentNo,
     remove(Vcomp,FunctsOut,Clause), 
     Vcomp=vcomp-IBar,
     \+ remove(subj-Funct,FunctsOut,[]), 
     create_coord_subj(SentNo,IBar,Lem,First,Head-Arg),
      Arg=[LemAdj-Argg-Neg],     
%     create_find_head_relative(Hea,Ind),
      (Head\=_-_, Hea=Head;Head=Hea-Ind),
       Subj=[subj-[Hea-n-sn]], 
       append(Subj,Clause,Claus),
%        ; Claus=Clause),
     create_clause_fac(SentNo, IBar, Claus, ArgsAdjs, Mods, NArgs, LemAdj-VArgs, Neg),
     AllArgsAdjs=[Neg,LemAdj-VArgs,Mods, ArgsAdjs,[]],
     !.

splitsent2(SentNo, IBars, FunctsOut, Main):-
     1 < SentNo,
      IBars=[],FunctsOut\=[],
%     length(FunctsOut,L), L<4,
     (governor(N,Lem),
%      IBar=[Lemma-v-_],
%      append([ibar-IBar], FunctsOut, NFuncts),
      N1 is SentNo + 1,
      build_adjuncts(N1,Lem, FunctsOut,AllArgsAdjs,NewLem), Main=AllArgsAdjs
      ;
      IBar=[is-vc-_],
      assert_v_function(_-ibar-IBar),
      append([ibar-IBar], FunctsOut, NFuncts),
      N1 is SentNo + 1,
      create_clause_fac(N1, IBar, NFuncts, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
      AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
      Main=[main-AllArgsAdjs]),
     !.

splitsent2(SentNo, IBars, FunctsOut, Second):-
     1 < SentNo, FunctsOut\=[],
%     length(FunctsOut,L), L<4,
      (IBars=[],
      governor(N,Lem),
      N1 is SentNo + 1,
      build_adjuncts(N1,Lem, FunctsOut,AllArgsAdjs,NewLem), 
      AllArgsAdjs\=[],AllArgsAdjs\=[[]],Second=AllArgsAdjs
      ;
      IBars\=[],
      N1 is SentNo + 1,
      build_adjuncts(N1,IBars, FunctsOut,AllArgsAdjs,NewLem), 
      AllArgsAdjs\=[],AllArgsAdjs\=[[]],Second=AllArgsAdjs
      ;
      IBar=[is-vc-_],
      assert_v_function(_-ibar-IBar),
      append([ibar-IBar], FunctsOut, NFuncts),
      N1 is SentNo + 1,
      create_clause_fac(N1, IBar, NFuncts, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
      AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
      AllArgsAdjs\=[],AllArgsAdjs\=[[]],
      Second=[second-AllArgsAdjs]),
     !.
splitsent2(SentNo, IBars, [Adj|FunctsOut], [second-AllArgsAdjs|Clauses]):-
    1 < SentNo,
    is_list(Adj),
    length(Adj,L), 1<L,
    crea_argomenti([Adj],_, [], Mods, Args, AllArgs, VArgs, AllAgg),
    (AllArgs\=[];AllAgg\=[]),
    governor(N,Govern),
    assert_gr_adj(SentNo, Govern,Mods,OutAdjs,ModsAdjs),
    append(Mods,ModsAdjs,Modss),
    assert_mods(SentNo, Mods,RefMods),
    append(AllArgs,AllAgg,ArgsAdjs),
    append(RefMods,OutAdjs,OutAdjsMods),
    AllArgsAdjs=[Neg,Govern-VArgs,Modss, ArgsAdjs,OutAdjsMods],
    explore_ibars(IBars, RefMods, Ibar),
    splitsentences(SentNo, Ibar, FunctsOut, Clauses),
     !.


select_ibar(IBars,FunctsOut, Verbs,RestIbar):-
      remove(Ibar,IBars,RestIbar),
      findall(I, nogen_member(_-ibar-I, FunctsOut), Is), Is=[],
      findall(I1, nogen_member(ibar-I1, FunctsOut), Is1), Is1=[],
      Ibar=_-ibar-Verbs,
      !.

select_ibar(IBars,FunctsOut, Verbs,RestIbar):-
      remove(Ibar,IBars,RestIbar),
      Ibar=_-ibar-Verbs,
      (findall(I, nogen_member(_-ibar-I, FunctsOut), Is), Is\=[], sort(Is,Verb), appiattisci(Verb,Ver);
      findall(I1, nogen_member(ibar-I1, FunctsOut), Is1), Is1\=[], sort(Is1,Verb), appiattisci(Verb,Ver)),
      Ver=Verbs,
      !.
select_ibar(IBars,FunctsOut, Verbs,RestIbar):-
      remove(Ibar,IBars,RestIbar),
      findall(I1, nogen_member(ibar-I1, FunctsOut), Is1), Is1\=[],
      on(Verbs,Is1),
      Ibar=_-ibar-Verbs,
      !.
cmod_adj_subord(Term,SentNo,Lem):-
    on(Sem-Cat-_,Term),
    (Cat=cong, Type=coord;Type=subord),
    governor(N, Govern),
    (Govern=A-_, Gov=A;atomic(Govern), Gov=Govern),
     (Gov\=Lem,Gover=Govern; Gover=nil), 
    assert_cmod_adj_subord(SentNo,cmod,Type,Sem,Lem,Gover),
    !.

cmod_adj_subord(Clause,SentNo,Lem):-
    on(Fc-Term,Clause),
    on(Sem-Cat-_,Term),
    (Cat=cong, Type=coord;Type=subord),
    governor(N, Govern),
    (Govern=A-_, Gov=A;atomic(Govern), Gov=Govern),
     (Gov\=Lem,Gover=Govern; Gover=nil), 
    assert_cmod_adj_subord(SentNo,cmod,Type,Sem,Lem,Gover),
    !.

assert_cmod_adj_subord(SentNo,Pref,Type,Sem,nil,Lem):-
    term_to_atom(Pref-Type,Prefs),
    DepGr1=..[Prefs,Sem,Lem],
    asserta(dgrs(SentNo,DepGr1)),
     !.
assert_cmod_adj_subord(SentNo,Pref,Type,Sem,Govern,Lem):-
    term_to_atom(Pref-Type,Prefs),
    DepGr1=..[Prefs,Sem,Govern,Lem],
    asserta(dgrs(SentNo,DepGr1)),
     !.

process_extract_compls(SentNo,Lem,RestIbar,Adj,FCAdj,Clauses):-
      Adj\=[],
      check_parents_fac(Adj),
     (remove(fac-Body1, Adj, Rest);
      remove(I-[fac-Body1], Adj, Rest), integer(I)),
      remove(fac-Cong, Body1, ClauseRest),
      N1 is SentNo + 1,
      splitsentences(N1, RestIbar, ClauseRest, Clauses),
      Clauses\=[],Clauses\=[[]],
      assert_gr_fac(N1, Lem,Clauses),
     !.
process_extract_compls(SentNo,Lem,RestIbar,Adj,FCAdj,Clauses):-
      Adj\=[],
     (remove(fac-Body, Adj, ClauseR);
      remove(fs-Body, Adj, ClauseR);
      remove(fc-Body, Adj, ClauseR)),
      check_parents_fac(Body),
      remove(fac-Body1, Body, Rest),
      remove(fac-Cong, Body1, ClauseRest),
      N1 is SentNo + 1,
      splitsentences(N1, RestIbar, ClauseRest, Clauses),
      Clauses\=[],Clauses\=[[]],
      assert_gr_fac(N1, Lem,Clauses),
     !.
process_extract_compls(SentNo,Lem,RestIbar,FunctsOut,FCAdj,Clauses):-
     extract_clause([RestIbar], FunctsOut, Clause, IBar, RestFun, RestIb,Adjs),
     splitsentences(SentNo, IBar, RestFun, Clauses),
     !.

process_extract_compls(SentNo,Lem,RestIbar,Adj,FCAdj,Clausess):-
      Adj\=[],
     (remove(fac-Body, Adj, ClauseR),Body\=[A],NewArgs=Body;
       remove(fs-Body, Adj, ClauseR),Body\=[A],NewArgs=Body;
       remove(fc-Body, Adj, ClauseR), Body\=FCAdj,
       remove(fc-Cong, Body, Body1),
       check_clause_wellform(Body1,Adj,NewArgs)),
       N1 is SentNo + 1,
       splitsentences(N1, RestIbar, ClauseR, Clauses),
       assert_gr_adj(N1, Lem, NewArgs, Clause,ModsAdjs),
       AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,Adjs],
       remove(M-AllArgsAdjs,Clauses,Rest),
       append(Adjs,Clause,OutAdjs),
       append(Mods,ModsAdjs,Modss),
       AllArgsAdjs1=[Neg,Lem-VArgs,Modss, ArgsAdjs,OutAdjs],
       append([M-AllArgsAdjs1], Rest, Clausess)
       ;
       splitsentences(SentNo, RestIbar, Adj, Clausess)
%       assert_gr_adj(SentNo, Lem, Adj, Clause,ModsAdjs),
%       append(Clause,ModsAdjs,Clausess)
       ;
      Clausess=[],
     !.
process_extract_compls(SentNo,Lem,RestIbar,Adj,Adj,[]):-!.


check_clause_wellformedness(Args,FunctsOut,Args):-
    on(subj-Verbs,Args),!.
check_clause_wellformedness(Args,FunctsOut,NewArgs):-
    on(fc-Verbs,FunctsOut),
    on(subj-Subj,FunctsOut),
    append([subj-Subj],Args,NewArgs),
    !.

check_clause_wellform(Args,FunctsOut,Args):-
    on(subj-Verbs,Args),!.
check_clause_wellform(Args,FunctsOut,NewArgs):-
    on(fc-Verbs,FunctsOut),
    on(subj-Subj,FunctsOut),
    append([subj-Subj],Args,NewArgs),
    !.
check_clause_wellform(Args,FunctsOut,Args):-
    !.


/* splitsent3 */

splitsent3(SentNo, IBars, FunctsOut, [second-AllArgsAdjs]):-
     remove(Vcomp,FunctsOut,Clause), 
     Vcomp=vcomp-IBar,
      (\+ remove(subj-Funct,FunctsOut,Res), 
       \+ remove(obl-[by-_-_|_],FunctsOut,Res), 
       create_find_head_relative(Hea,Ind), 
       Subj=[subj-[Hea-n-sn]], append(Subj,Clause,Claus)
        ; Claus=Clause),
     create_clause_fac(SentNo, IBar, Claus, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
     AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
     !.

splitsent3(SentNo, IBars, [Adj|FunctsOut], [second-AllArgsAdjs|Clauses]):-
    is_list(Adj), length(Adj,L), 1<L,
    crea_argomenti([Adj],_, [], Mods, Args, AllArgs, VArgs, AllAgg),
    (AllArgs\=[];AllAgg\=[]),
    governor(N,Govern),
    assert_gr_adj(SentNo, Govern,Mods,OutAdjs,ModsAdjs),
    append(Mods,ModsAdjs,Modss),
    assert_mods(SentNo, Mods,RefMods),
    append(RefMods,OutAdjs,OutAdjsMods),
    append(AllArgs,AllAgg,ArgsAdjs),
    AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,OutAdjsMods],
    explore_ibars(IBars, RefMods, Ibar),
    splitsentences(SentNo, Ibar, FunctsOut, Clauses),
     !.

splitsent3(SentNo, IBars, FunctsOut, Main):-
      IBars=[],FunctsOut\=[],
     (governor(N,Lem),
      N1 is SentNo + 1,
      build_adjuncts(N1,Lem, FunctsOut,AllArgsAdjs,NewLem), 
      AllArgsAdjs\=[],AllArgsAdjs\=[[]],Main=AllArgsAdjs
      ;
      \+ on(ibar-IBar,FunctsOut),
      IBar=[is-vc-_],
      assert_v_function(_-ibar-IBar),
      append([ibar-IBar], FunctsOut, NFuncts),
      N1 is SentNo + 1,
      create_clause_fac(N1, IBar, NFuncts, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
      AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
      Main=[main-AllArgsAdjs]),
     !.

splitsent3(SentNo, IBars, FunctsOut, Second):-
      FunctsOut\=[],
      (IBars=[],
      governor(N,Lem),
      N1 is SentNo + 1,
      build_adjuncts(N1,Lem, FunctsOut,AllArgsAdjs,NewLem), 
      AllArgsAdjs\=[],AllArgsAdjs\=[[]],Second=AllArgsAdjs
      ;
      IBars\=[],
      N1 is SentNo + 1,
      build_adjuncts(N1,Lem, FunctsOut,AllArgsAdjs,NewLem), 
      AllArgsAdjs\=[],AllArgsAdjs\=[[]],Second=AllArgsAdjs
      ;
      \+ on(ibar-IBar,FunctsOut),
      IBar=[is-vc-_],
      assert_v_function(_-ibar-IBar),
      append([ibar-IBar], FunctsOut, NFuncts),
      N1 is SentNo + 1,
      create_clause_fac(N1, IBar, NFuncts, ArgsAdjs, Mods, NArgs, Lem-VArgs, Neg),
      AllArgsAdjs=[Neg,Lem-VArgs,Mods, ArgsAdjs,[]],
      AllArgsAdjs\=[],AllArgsAdjs\=[[]],
      Second=[second-AllArgsAdjs]),
     !.

splitsent3(SentNo, IBars, FunctsOut, []):-
   FunctsOut\=[],
   FunctsOut=[F-A],
   A=[_],
   F\=sn,F\=sa,F\=vcomp,F\=sp,F\=spd,F\=spda,
   !.

correct_lem(be,[subj-[there-expl-sn]|Args],there_be):-!.

correct_lem(Lem,Args,Lem):-!.

/*
hypo_parse(NoFr, Symb, Out, N, Input, Alls):-
   dyn_ext_pron,
   tagging_disamb(NoFr, Symb,Disambs, Tags,  Scored, Input,Output,Frase),
   allparsers(NoFr, Frase, Input, Disambs, Tags, Ibars, Scored, Output, Out, N),
   discourse(NoFr, Symb, Input, Scored, Out, Alls),
   told,
     !.
     */
hypo_parse(NoFr, Symb, [Ibas,Tags,Scored,Output], N, Input, Alls):-
   dyn_ext_pron,
   writesymb_assert(NoFr, Symb),
   fp(Symb,Fras),
   tagging_disamb(NoFr, Fras, Disambs, Tags,  Scored, Input,Output,Frase),
   allparsers(NoFr, Frase, Input, Disambs, Tags, Ibars, Scored, Output, Out, No),
   getibarsall(Ibars,Ibas),
   discourse(NoFr, Symb, Input, Scored, Out, WeightedRefs),
   build_dsr(NoFr,Symb, Ibars, DSR,N),
   append([DSR],[WeightedRefs],Alls),
       writepov,
     !.
     
